<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Agreement Studies Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #06B6D4;
            --primary-dark: #0891B2;
            --primary-light: #22D3EE;
            --secondary: #0E7490;
            --accent: #CFFAFE;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --bg-primary: #FFFFFF;
            --bg-secondary: #ECFEFF;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
            --shadow-hover: 0 8px 25px rgba(6, 182, 212, 0.25);

            --gradient-primary: linear-gradient(135deg, #06B6D4, #22D3EE, #67E8F9);
            --gradient-secondary: linear-gradient(135deg, #0E7490, #0891B2, #06B6D4);
            --gradient-bg: linear-gradient(135deg, #ECFEFF, #CFFAFE, #A5F3FC);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #ECFEFF);

            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        [data-theme="dark"] {
            --bg-primary: #164E63;
            --bg-secondary: #155E75;
            --bg-card: #155E75;
            --text-primary: #F3F4F6;
            --text-secondary: #D1D5DB;
            --text-muted: #9CA3AF;
            --border-color: #0E7490;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --gradient-bg: linear-gradient(135deg, #164E63, #155E75, #0E7490);
            --gradient-card: linear-gradient(145deg, #155E75, #0E7490);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        .header {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle { font-size: 1.1rem; color: var(--text-secondary); }

        .theme-toggle, .back-link {
            position: absolute;
            top: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .theme-toggle { right: 1.5rem; }
        .back-link { left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }

        .theme-toggle:hover, .back-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calc-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--gradient-card);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .calc-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calc-tab:hover { border-color: var(--primary); }
        .calc-tab.active { background: var(--gradient-primary); color: white; border-color: var(--primary); }

        .calculator-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .calculator-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-header h3 { font-size: 1.5rem; font-weight: 700; }

        .formula-box {
            background: var(--gradient-secondary);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            font-family: var(--font-mono);
            text-align: center;
            border-radius: var(--radius);
        }

        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h4 { color: var(--primary); margin-bottom: 0.5rem; }
        .info-box p { color: var(--text-secondary); }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 0.5rem; }

        .input-group input, .input-group select {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .input-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .calculate-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .results-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .results-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-main {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-value { font-size: 3.5rem; font-weight: 800; color: white; }
        .result-label { color: rgba(255,255,255,0.9); font-size: 1.1rem; }
        .result-sub { margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: var(--radius); color: white; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .result-card-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .result-card-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

        .interpretation-scale {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .scale-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .scale-poor { background: #FEE2E2; color: #DC2626; }
        .scale-fair { background: #FEF3C7; color: #D97706; }
        .scale-moderate { background: #FEF9C3; color: #CA8A04; }
        .scale-good { background: #D1FAE5; color: #059669; }
        .scale-excellent { background: #DBEAFE; color: #2563EB; }
        .scale-current { border: 3px solid var(--primary); }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container h4 { text-align: center; margin-bottom: 1rem; }
        .chart-wrapper { position: relative; height: 300px; }

        .export-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover { background: #059669; transform: translateY(-1px); }

        .pdf-theme-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.9rem;
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .pdf-theme-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .footer {
            background: var(--gradient-secondary);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
        }

        .footer-love { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .footer-blessing { color: var(--accent); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .logo { flex-direction: column; }
            .back-link, .theme-toggle { position: static; margin: 0.5rem; }
            .header { padding-top: 4rem; }
            .result-value { font-size: 2.5rem; }
            .results-header { flex-direction: column; align-items: flex-start; }
            .export-controls { width: 100%; justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <a href="karmastat_2_0_main.html" class="back-link">
                <span>&#8592;</span> Back to Main
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">&#9790;</span> Theme
            </button>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <div class="logo">
                <div>
                    <h1>Agreement Studies Calculator</h1>
                    <p class="subtitle">Sample size for inter-rater reliability, ICC, and method comparison studies</p>
                </div>
            </div>
        </header>

        <div class="calc-tabs">
            <button class="calc-tab active" data-calc="cohens-kappa" onclick="selectCalc('cohens-kappa')">Cohen's Kappa</button>
            <button class="calc-tab" data-calc="weighted-kappa" onclick="selectCalc('weighted-kappa')">Weighted Kappa</button>
            <button class="calc-tab" data-calc="fleiss-kappa" onclick="selectCalc('fleiss-kappa')">Fleiss' Kappa</button>
            <button class="calc-tab" data-calc="icc" onclick="selectCalc('icc')">ICC</button>
            <button class="calc-tab" data-calc="bland-altman" onclick="selectCalc('bland-altman')">Bland-Altman</button>
            <button class="calc-tab" data-calc="ccc" onclick="selectCalc('ccc')">Lin's CCC</button>
        </div>

        <!-- Cohen's Kappa -->
        <section class="calculator-section active" id="cohens-kappa-calc">
            <div class="section-header">
                <div class="section-icon">&#954;</div>
                <h3>Cohen's Kappa - Two Raters, Categorical Data</h3>
            </div>

            <div class="formula-box">
                &kappa; = (p<sub>o</sub> - p<sub>e</sub>) / (1 - p<sub>e</sub>)<br>
                <small>n = (z<sub>&alpha;</sub> + z<sub>&beta;</sub>)&sup2; &times; 2p<sub>e</sub>(1-p<sub>e</sub>) / [(&kappa;<sub>1</sub> - &kappa;<sub>0</sub>)&sup2;(1-p<sub>e</sub>)&sup2;]</small>
            </div>

            <div class="info-box">
                <h4>Kappa Interpretation (Landis & Koch)</h4>
                <p>
                    <strong>&lt; 0:</strong> Poor |
                    <strong>0.00-0.20:</strong> Slight |
                    <strong>0.21-0.40:</strong> Fair |
                    <strong>0.41-0.60:</strong> Moderate |
                    <strong>0.61-0.80:</strong> Substantial |
                    <strong>0.81-1.00:</strong> Almost Perfect
                </p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected Kappa (&kappa;<sub>1</sub>)</label>
                    <input type="number" id="ck_kappa1" value="0.70" min="0" max="1" step="0.01">
                    <span class="input-hint">Alternative hypothesis value</span>
                </div>
                <div class="input-group">
                    <label>Null Kappa (&kappa;<sub>0</sub>)</label>
                    <input type="number" id="ck_kappa0" value="0.40" min="0" max="1" step="0.01">
                    <span class="input-hint">Minimum acceptable kappa</span>
                </div>
                <div class="input-group">
                    <label>Proportion of Positives (prevalence)</label>
                    <input type="number" id="ck_prev" value="0.50" min="0.01" max="0.99" step="0.01">
                    <span class="input-hint">Expected base rate</span>
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="ck_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="ck_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateCohensKappa(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Weighted Kappa -->
        <section class="calculator-section" id="weighted-kappa-calc">
            <div class="section-header">
                <div class="section-icon">&kappa;<sub>w</sub></div>
                <h3>Weighted Kappa - Ordinal Categories</h3>
            </div>

            <div class="formula-box">
                &kappa;<sub>w</sub> = 1 - &Sigma;w<sub>ij</sub>p<sub>ij</sub> / &Sigma;w<sub>ij</sub>p<sub>e_ij</sub><br>
                <small>For ordinal data with linear or quadratic weights</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Categories</label>
                    <input type="number" id="wk_k" value="4" min="3" max="10" step="1">
                </div>
                <div class="input-group">
                    <label>Expected Weighted Kappa</label>
                    <input type="number" id="wk_kappa1" value="0.70" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Null Weighted Kappa</label>
                    <input type="number" id="wk_kappa0" value="0.50" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Weighting Scheme</label>
                    <select id="wk_weights">
                        <option value="linear" selected>Linear Weights</option>
                        <option value="quadratic">Quadratic Weights</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="wk_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="wk_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateWeightedKappa(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Fleiss' Kappa -->
        <section class="calculator-section" id="fleiss-kappa-calc">
            <div class="section-header">
                <div class="section-icon">&kappa;<sub>F</sub></div>
                <h3>Fleiss' Kappa - Multiple Raters</h3>
            </div>

            <div class="formula-box">
                &kappa; = (P&#772; - P&#772;<sub>e</sub>) / (1 - P&#772;<sub>e</sub>)<br>
                <small>For &gt;2 raters on categorical data</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Raters</label>
                    <input type="number" id="fk_raters" value="5" min="3" max="20" step="1">
                </div>
                <div class="input-group">
                    <label>Number of Categories</label>
                    <input type="number" id="fk_k" value="3" min="2" max="10" step="1">
                </div>
                <div class="input-group">
                    <label>Expected Kappa</label>
                    <input type="number" id="fk_kappa1" value="0.60" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Null Kappa</label>
                    <input type="number" id="fk_kappa0" value="0.40" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="fk_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="fk_alpha">
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateFleissKappa(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- ICC -->
        <section class="calculator-section" id="icc-calc">
            <div class="section-header">
                <div class="section-icon">ICC</div>
                <h3>Intraclass Correlation Coefficient</h3>
            </div>

            <div class="formula-box">
                n = 8z&sup2;(1-&rho;)&sup2;(1+(k-1)&rho;)&sup2; / [k(k-1)(&rho;<sub>1</sub>-&rho;<sub>0</sub>)&sup2;]<br>
                <small>Where k = number of raters/measurements</small>
            </div>

            <div class="info-box">
                <h4>ICC Types</h4>
                <p>
                    <strong>ICC(1,1):</strong> One-way random effects, single measure<br>
                    <strong>ICC(2,1):</strong> Two-way random effects, single measure<br>
                    <strong>ICC(3,1):</strong> Two-way mixed effects, single measure<br>
                    <strong>ICC(2,k)/ICC(3,k):</strong> Average of k measurements
                </p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>ICC Type</label>
                    <select id="icc_type">
                        <option value="1,1">ICC(1,1) - One-way random</option>
                        <option value="2,1" selected>ICC(2,1) - Two-way random</option>
                        <option value="3,1">ICC(3,1) - Two-way mixed</option>
                        <option value="2,k">ICC(2,k) - Two-way random, average</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Number of Raters/Measurements (k)</label>
                    <input type="number" id="icc_k" value="3" min="2" max="20" step="1">
                </div>
                <div class="input-group">
                    <label>Expected ICC (&rho;<sub>1</sub>)</label>
                    <input type="number" id="icc_rho1" value="0.75" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Null ICC (&rho;<sub>0</sub>)</label>
                    <input type="number" id="icc_rho0" value="0.50" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="icc_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="icc_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateICC(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Bland-Altman -->
        <section class="calculator-section" id="bland-altman-calc">
            <div class="section-header">
                <div class="section-icon">BA</div>
                <h3>Bland-Altman Limits of Agreement</h3>
            </div>

            <div class="formula-box">
                LoA = mean<sub>diff</sub> &plusmn; 1.96 &times; SD<sub>diff</sub><br>
                <small>n = 1.96&sup2; &times; 3 &times; SD&sup2; / (acceptable width / 2)&sup2;</small>
            </div>

            <div class="info-box">
                <h4>About Bland-Altman Analysis</h4>
                <p>Used to assess agreement between two quantitative measurement methods. The sample size ensures adequate precision of the limits of agreement.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected SD of Differences</label>
                    <input type="number" id="ba_sd" value="5" min="0.01" step="0.1">
                    <span class="input-hint">Standard deviation of (Method1 - Method2)</span>
                </div>
                <div class="input-group">
                    <label>Acceptable Width of 95% CI for LoA</label>
                    <input type="number" id="ba_width" value="3" min="0.01" step="0.1">
                    <span class="input-hint">Precision of limits of agreement</span>
                </div>
                <div class="input-group">
                    <label>Maximum Acceptable LoA Width</label>
                    <input type="number" id="ba_max_loa" value="20" min="0.01" step="0.1">
                    <span class="input-hint">Clinically acceptable difference</span>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateBlandAltman(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Lin's CCC -->
        <section class="calculator-section" id="ccc-calc">
            <div class="section-header">
                <div class="section-icon">&rho;<sub>c</sub></div>
                <h3>Lin's Concordance Correlation Coefficient</h3>
            </div>

            <div class="formula-box">
                &rho;<sub>c</sub> = 2&rho;&sigma;<sub>x</sub>&sigma;<sub>y</sub> / (&sigma;&sup2;<sub>x</sub> + &sigma;&sup2;<sub>y</sub> + (&mu;<sub>x</sub>-&mu;<sub>y</sub>)&sup2;)<br>
                <small>Based on Fisher z-transformation</small>
            </div>

            <div class="info-box">
                <h4>CCC vs Pearson's r</h4>
                <p>Unlike Pearson's correlation, CCC measures both precision (correlation) and accuracy (closeness to the line of identity). CCC = Pearson's r x Accuracy factor.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected CCC (&rho;<sub>c1</sub>)</label>
                    <input type="number" id="ccc_rho1" value="0.85" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Null CCC (&rho;<sub>c0</sub>)</label>
                    <input type="number" id="ccc_rho0" value="0.70" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="ccc_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="ccc_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateCCC(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results">
            <div class="results-header">
                <h3>Agreement Study Results</h3>
                <div class="export-controls">
                    <select class="pdf-theme-select" id="pdfTheme">
                        <option value="light">Light PDF Theme</option>
                        <option value="dark">Dark PDF Theme</option>
                    </select>
                    <button class="export-btn" onclick="exportToPDF()">
                        <span>&#128196;</span> Export Comprehensive PDF
                    </button>
                </div>
            </div>

            <div class="result-main">
                <div class="result-value" id="mainValue">--</div>
                <div class="result-label" id="mainLabel">Sample Size</div>
                <div class="result-sub" id="mainSub"></div>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <div class="info-box" id="interpretationBox">
                <h4>Agreement Level Interpretation</h4>
                <p id="interpretationText"></p>
                <div class="interpretation-scale" id="interpretationScale">
                    <span class="scale-badge scale-poor">Poor (&lt;0.20)</span>
                    <span class="scale-badge scale-fair">Fair (0.21-0.40)</span>
                    <span class="scale-badge scale-moderate">Moderate (0.41-0.60)</span>
                    <span class="scale-badge scale-good">Substantial (0.61-0.80)</span>
                    <span class="scale-badge scale-excellent">Excellent (&gt;0.80)</span>
                </div>
            </div>

            <div class="chart-container">
                <h4>Sample Size vs. Expected Agreement</h4>
                <div class="chart-wrapper">
                    <canvas id="agreementChart"></canvas>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-love">Made with &#10084; by Karmayogi</div>
            <div class="footer-blessing">&#128591; Jai Shri Ram &#128591;</div>
        </footer>
    </div>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        let agreementChart = null;

        // Global calculation storage for PDF export
        let globalCalculation = {
            studyType: '',
            studyTypeFull: '',
            inputParameters: {},
            formula: '',
            formulaDescription: '',
            calculationSteps: [],
            results: {
                mainValue: 0,
                mainLabel: '',
                details: {}
            },
            interpretation: '',
            agreementLevel: '',
            recommendations: [],
            references: []
        };

        function normalQuantile(p) {
            const a = [-3.969683028665376e+01, 2.209460984245205e+02, -2.759285104469687e+02,
                       1.383577518672690e+02, -3.066479806614716e+01, 2.506628277459239e+00];
            const b = [-5.447609879822406e+01, 1.615858368580409e+02, -1.556989798598866e+02,
                       6.680131188771972e+01, -1.328068155288572e+01];
            const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00,
                       -2.549732539343734e+00, 4.374664141464968e+00, 2.938163982698783e+00];
            const d = [7.784695709041462e-03, 3.224671290700398e-01, 2.445134137142996e+00, 3.754408661907416e+00];
            const pLow = 0.02425, pHigh = 1 - pLow;
            let q, r;
            if (p < pLow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            } else if (p <= pHigh) {
                q = p - 0.5; r = q * q;
                return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q / (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            }
        }

        function selectCalc(calcType) {
            document.querySelectorAll('.calc-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-calc="${calcType}"]`).classList.add('active');
            document.querySelectorAll('.calculator-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${calcType}-calc`).classList.add('active');
            document.getElementById('results').classList.remove('active');
        }

        function getAgreementLevel(value) {
            if (value < 0.20) return { level: 'Poor/Slight', class: 'poor' };
            if (value < 0.40) return { level: 'Fair', class: 'fair' };
            if (value < 0.60) return { level: 'Moderate', class: 'moderate' };
            if (value < 0.80) return { level: 'Substantial/Good', class: 'good' };
            return { level: 'Almost Perfect/Excellent', class: 'excellent' };
        }

        function calculateCohensKappa() {
            const kappa1 = parseFloat(document.getElementById('ck_kappa1').value);
            const kappa0 = parseFloat(document.getElementById('ck_kappa0').value);
            const prev = parseFloat(document.getElementById('ck_prev').value);
            const power = parseFloat(document.getElementById('ck_power').value);
            const alpha = parseFloat(document.getElementById('ck_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            // Calculate expected agreement by chance
            const pe = prev * prev + (1 - prev) * (1 - prev);

            // Sample size formula
            const numerator = Math.pow(zAlpha + zBeta, 2) * 2 * pe * (1 - pe);
            const denominator = Math.pow(kappa1 - kappa0, 2) * Math.pow(1 - pe, 2);
            const n = Math.ceil(numerator / denominator);

            // Store calculation globally
            const agreementInfo = getAgreementLevel(kappa1);
            globalCalculation = {
                studyType: "Cohen's Kappa",
                studyTypeFull: "Cohen's Kappa - Inter-Rater Agreement for Two Raters with Categorical Data",
                inputParameters: {
                    'Expected Kappa (k1)': kappa1,
                    'Null Kappa (k0)': kappa0,
                    'Prevalence/Proportion': prev,
                    'Statistical Power': (power * 100) + '%',
                    'Alpha Level (two-sided)': alpha,
                    'Number of Raters': 2
                },
                formula: "n = (z_alpha + z_beta)^2 x 2*pe*(1-pe) / [(k1 - k0)^2 * (1-pe)^2]",
                formulaDescription: "Where pe = chance agreement, k1 = expected kappa, k0 = null kappa",
                calculationSteps: [
                    `Step 1: Calculate chance agreement (pe) = pi^2 + (1-pi)^2 = ${prev}^2 + ${(1-prev).toFixed(2)}^2 = ${pe.toFixed(4)}`,
                    `Step 2: Get z-values: z_alpha/2 = ${zAlpha.toFixed(4)} (for alpha=${alpha}), z_beta = ${zBeta.toFixed(4)} (for power=${power})`,
                    `Step 3: Calculate numerator = (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 x 2 x ${pe.toFixed(4)} x ${(1-pe).toFixed(4)} = ${numerator.toFixed(4)}`,
                    `Step 4: Calculate denominator = (${kappa1} - ${kappa0})^2 x (1 - ${pe.toFixed(4)})^2 = ${denominator.toFixed(6)}`,
                    `Step 5: Sample size n = ${numerator.toFixed(4)} / ${denominator.toFixed(6)} = ${(numerator/denominator).toFixed(2)}`,
                    `Step 6: Round up to n = ${n} subjects`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Subjects Needed',
                    details: {
                        'Expected Kappa': kappa1.toFixed(3),
                        'Null Kappa': kappa0.toFixed(3),
                        'Prevalence': (prev * 100).toFixed(1) + '%',
                        'Chance Agreement (pe)': pe.toFixed(4),
                        'Power': (power * 100).toFixed(0) + '%',
                        'Alpha': alpha
                    }
                },
                interpretation: `The expected Cohen's Kappa of ${kappa1.toFixed(2)} indicates ${agreementInfo.level} agreement between the two raters. With ${n} subjects, the study will have ${(power*100).toFixed(0)}% power to detect a kappa significantly greater than ${kappa0.toFixed(2)} at a two-sided alpha of ${alpha}.`,
                agreementLevel: agreementInfo.level,
                recommendations: [
                    `Recruit at least ${n} subjects, consider ${Math.ceil(n * 1.1)} to account for dropouts (~10% buffer)`,
                    'Ensure raters are blinded to each other\'s assessments',
                    'Use standardized rating criteria and training for both raters',
                    prev < 0.2 || prev > 0.8 ? 'Note: Extreme prevalence may lead to unstable kappa - consider prevalence-adjusted measures' : 'Prevalence is in acceptable range for stable kappa estimation',
                    'Report both kappa and observed agreement percentage'
                ],
                references: [
                    'Landis JR, Koch GG. The measurement of observer agreement for categorical data. Biometrics. 1977;33(1):159-174.',
                    'Cohen J. A coefficient of agreement for nominal scales. Educational and Psychological Measurement. 1960;20(1):37-46.',
                    'Sim J, Wright CC. The kappa statistic in reliability studies: use, interpretation, and sample size requirements. Physical Therapy. 2005;85(3):257-268.'
                ]
            };

            displayResults(n, 'Subjects Needed', globalCalculation.results.details, 'kappa', kappa1, kappa0);
        }

        function calculateWeightedKappa() {
            const k = parseFloat(document.getElementById('wk_k').value);
            const kappa1 = parseFloat(document.getElementById('wk_kappa1').value);
            const kappa0 = parseFloat(document.getElementById('wk_kappa0').value);
            const weights = document.getElementById('wk_weights').value;
            const power = parseFloat(document.getElementById('wk_power').value);
            const alpha = parseFloat(document.getElementById('wk_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            // Approximation for weighted kappa
            const pe = 1 / k;  // Simplified
            const weightFactor = weights === 'quadratic' ? 0.8 : 0.9;

            const numerator = Math.pow(zAlpha + zBeta, 2) * 2 * pe * (1 - pe) * weightFactor;
            const denominator = Math.pow(kappa1 - kappa0, 2) * Math.pow(1 - pe, 2);
            const n = Math.ceil(numerator / denominator);

            const agreementInfo = getAgreementLevel(kappa1);
            globalCalculation = {
                studyType: "Weighted Kappa",
                studyTypeFull: "Weighted Kappa - Inter-Rater Agreement for Ordinal Categories",
                inputParameters: {
                    'Number of Categories': k,
                    'Expected Weighted Kappa (kw1)': kappa1,
                    'Null Weighted Kappa (kw0)': kappa0,
                    'Weighting Scheme': weights.charAt(0).toUpperCase() + weights.slice(1),
                    'Statistical Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: "kw = 1 - Sum(wij*pij) / Sum(wij*pe_ij)",
                formulaDescription: `Using ${weights} weights: ${weights === 'linear' ? 'w_ij = |i-j|/(k-1)' : 'w_ij = (i-j)^2/(k-1)^2'}`,
                calculationSteps: [
                    `Step 1: Categories k = ${k}, Weight scheme = ${weights}`,
                    `Step 2: Estimated chance agreement pe = 1/k = ${pe.toFixed(4)}`,
                    `Step 3: Weight adjustment factor = ${weightFactor} (for ${weights} weights)`,
                    `Step 4: z_alpha/2 = ${zAlpha.toFixed(4)}, z_beta = ${zBeta.toFixed(4)}`,
                    `Step 5: Numerator = (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 x 2 x ${pe.toFixed(4)} x ${(1-pe).toFixed(4)} x ${weightFactor} = ${numerator.toFixed(4)}`,
                    `Step 6: Denominator = (${kappa1} - ${kappa0})^2 x (1 - ${pe.toFixed(4)})^2 = ${denominator.toFixed(6)}`,
                    `Step 7: Sample size n = ${(numerator/denominator).toFixed(2)}, rounded to ${n}`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Subjects Needed',
                    details: {
                        'Expected Weighted Kappa': kappa1.toFixed(3),
                        'Null Weighted Kappa': kappa0.toFixed(3),
                        'Number of Categories': k,
                        'Weighting Scheme': weights.charAt(0).toUpperCase() + weights.slice(1),
                        'Power': (power * 100).toFixed(0) + '%'
                    }
                },
                interpretation: `The expected Weighted Kappa of ${kappa1.toFixed(2)} with ${weights} weights indicates ${agreementInfo.level} agreement. ${weights === 'quadratic' ? 'Quadratic weights penalize larger disagreements more heavily, suitable when distant categories represent clinically important differences.' : 'Linear weights treat disagreements proportionally by distance.'}`,
                agreementLevel: agreementInfo.level,
                recommendations: [
                    `Recruit at least ${n} subjects (consider ${Math.ceil(n * 1.1)} with 10% dropout buffer)`,
                    `${weights === 'quadratic' ? 'Quadratic weights are preferable when ordinal scale represents interval-like measurements' : 'Linear weights are appropriate for ordinal scales with equal spacing'}`,
                    'Ensure categories are clearly defined with ordering preserved',
                    'Train raters on category boundaries and distinctions',
                    'Report both weighted kappa and the weighting scheme used'
                ],
                references: [
                    'Cohen J. Weighted kappa: nominal scale agreement with provision for scaled disagreement or partial credit. Psychological Bulletin. 1968;70(4):213-220.',
                    'Fleiss JL, Cohen J. The equivalence of weighted kappa and the intraclass correlation coefficient as measures of reliability. Educational and Psychological Measurement. 1973;33:613-619.',
                    'Landis JR, Koch GG. The measurement of observer agreement for categorical data. Biometrics. 1977;33(1):159-174.'
                ]
            };

            displayResults(n, 'Subjects Needed', globalCalculation.results.details, 'kappa', kappa1, kappa0);
        }

        function calculateFleissKappa() {
            const raters = parseFloat(document.getElementById('fk_raters').value);
            const k = parseFloat(document.getElementById('fk_k').value);
            const kappa1 = parseFloat(document.getElementById('fk_kappa1').value);
            const kappa0 = parseFloat(document.getElementById('fk_kappa0').value);
            const power = parseFloat(document.getElementById('fk_power').value);
            const alpha = parseFloat(document.getElementById('fk_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            // Fleiss kappa sample size (simplified)
            const pe = 1 / k;
            const varFactor = 2 / (raters * (raters - 1));

            const numerator = Math.pow(zAlpha + zBeta, 2) * varFactor;
            const denominator = Math.pow(kappa1 - kappa0, 2);
            const n = Math.ceil(numerator / denominator);

            const totalRatings = n * raters;
            const agreementInfo = getAgreementLevel(kappa1);

            globalCalculation = {
                studyType: "Fleiss' Kappa",
                studyTypeFull: "Fleiss' Kappa - Multi-Rater Agreement for Categorical Data",
                inputParameters: {
                    'Number of Raters': raters,
                    'Number of Categories': k,
                    'Expected Kappa (k1)': kappa1,
                    'Null Kappa (k0)': kappa0,
                    'Statistical Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: "kappa = (P_bar - P_e_bar) / (1 - P_e_bar)",
                formulaDescription: "Generalization of Cohen's Kappa for multiple raters, where P_bar = mean observed agreement",
                calculationSteps: [
                    `Step 1: Number of raters m = ${raters}, categories k = ${k}`,
                    `Step 2: Variance factor = 2 / [m(m-1)] = 2 / [${raters} x ${raters-1}] = ${varFactor.toFixed(6)}`,
                    `Step 3: z_alpha/2 = ${zAlpha.toFixed(4)}, z_beta = ${zBeta.toFixed(4)}`,
                    `Step 4: Numerator = (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 x ${varFactor.toFixed(6)} = ${numerator.toFixed(6)}`,
                    `Step 5: Denominator = (${kappa1} - ${kappa0})^2 = ${denominator.toFixed(6)}`,
                    `Step 6: Sample size n = ${(numerator/denominator).toFixed(2)}, rounded to ${n}`,
                    `Step 7: Total ratings required = ${n} x ${raters} = ${totalRatings}`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Subjects Needed',
                    details: {
                        'Number of Raters': raters,
                        'Number of Categories': k,
                        'Expected Kappa': kappa1.toFixed(3),
                        'Null Kappa': kappa0.toFixed(3),
                        'Total Ratings': totalRatings,
                        'Power': (power * 100).toFixed(0) + '%'
                    }
                },
                interpretation: `With ${raters} raters and ${n} subjects, Fleiss' Kappa of ${kappa1.toFixed(2)} indicates ${agreementInfo.level} agreement. Each subject will be rated by all ${raters} raters, yielding ${totalRatings} total ratings. This design provides ${(power*100).toFixed(0)}% power to detect agreement above ${kappa0.toFixed(2)}.`,
                agreementLevel: agreementInfo.level,
                recommendations: [
                    `Recruit ${n} subjects (consider ${Math.ceil(n * 1.1)} for dropout buffer)`,
                    `All ${raters} raters must assess each subject independently`,
                    'Ensure raters are blinded to each other\'s assessments',
                    'Conduct rater training session before study initiation',
                    'Consider rater workload: each rater will complete ' + n + ' assessments',
                    'Report both overall kappa and category-specific agreement if relevant'
                ],
                references: [
                    'Fleiss JL. Measuring nominal scale agreement among many raters. Psychological Bulletin. 1971;76(5):378-382.',
                    'Landis JR, Koch GG. The measurement of observer agreement for categorical data. Biometrics. 1977;33(1):159-174.',
                    'Gwet KL. Handbook of Inter-Rater Reliability. 4th ed. Advanced Analytics, LLC; 2014.'
                ]
            };

            displayResults(n, 'Subjects Needed', globalCalculation.results.details, 'kappa', kappa1, kappa0);
        }

        function calculateICC() {
            const type = document.getElementById('icc_type').value;
            const k = parseFloat(document.getElementById('icc_k').value);
            const rho1 = parseFloat(document.getElementById('icc_rho1').value);
            const rho0 = parseFloat(document.getElementById('icc_rho0').value);
            const power = parseFloat(document.getElementById('icc_power').value);
            const alpha = parseFloat(document.getElementById('icc_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            // ICC sample size formula
            const numerator = 8 * Math.pow(zAlpha + zBeta, 2) * Math.pow(1 - rho0, 2) * Math.pow(1 + (k - 1) * rho0, 2);
            const denominator = k * (k - 1) * Math.pow(rho1 - rho0, 2);
            let n = Math.ceil(numerator / denominator);

            // Ensure minimum
            n = Math.max(n, k + 1);

            const totalMeasurements = n * k;
            const agreementInfo = getAgreementLevel(rho1);

            const iccTypeDescriptions = {
                '1,1': 'One-way random effects, single rater/measurement - each subject rated by different raters from a random sample',
                '2,1': 'Two-way random effects, single rater - subjects and raters both random, assesses absolute agreement',
                '3,1': 'Two-way mixed effects, single rater - raters are fixed (the only raters of interest), assesses consistency',
                '2,k': 'Two-way random effects, average of k raters - reliability of mean ratings when raters are random'
            };

            globalCalculation = {
                studyType: "ICC",
                studyTypeFull: `Intraclass Correlation Coefficient - ICC(${type})`,
                inputParameters: {
                    'ICC Type': `ICC(${type})`,
                    'Number of Raters/Measurements (k)': k,
                    'Expected ICC (rho1)': rho1,
                    'Null ICC (rho0)': rho0,
                    'Statistical Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: "n = 8*z^2*(1-rho0)^2*(1+(k-1)*rho0)^2 / [k*(k-1)*(rho1-rho0)^2]",
                formulaDescription: iccTypeDescriptions[type],
                calculationSteps: [
                    `Step 1: ICC type = ICC(${type}), k = ${k} raters/measurements`,
                    `Step 2: z_alpha/2 = ${zAlpha.toFixed(4)}, z_beta = ${zBeta.toFixed(4)}`,
                    `Step 3: Term A = 8 x (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 = ${(8 * Math.pow(zAlpha + zBeta, 2)).toFixed(4)}`,
                    `Step 4: Term B = (1 - ${rho0})^2 = ${Math.pow(1 - rho0, 2).toFixed(6)}`,
                    `Step 5: Term C = (1 + (${k}-1) x ${rho0})^2 = ${Math.pow(1 + (k-1) * rho0, 2).toFixed(6)}`,
                    `Step 6: Numerator = A x B x C = ${numerator.toFixed(4)}`,
                    `Step 7: Denominator = ${k} x ${k-1} x (${rho1} - ${rho0})^2 = ${denominator.toFixed(6)}`,
                    `Step 8: n = ${(numerator/denominator).toFixed(2)}, rounded to ${n}`,
                    `Step 9: Total measurements = ${n} x ${k} = ${totalMeasurements}`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Subjects Needed',
                    details: {
                        'ICC Type': `ICC(${type})`,
                        'Number of Raters/Measures': k,
                        'Expected ICC': rho1.toFixed(3),
                        'Null ICC': rho0.toFixed(3),
                        'Total Measurements': totalMeasurements,
                        'Power': (power * 100).toFixed(0) + '%',
                        'Alpha': alpha
                    }
                },
                interpretation: `The ICC(${type}) study with ${k} raters/measurements requires ${n} subjects. Expected ICC of ${rho1.toFixed(2)} indicates ${agreementInfo.level} reliability. ${type.includes('k') ? 'This ICC represents reliability of the average of ' + k + ' measurements.' : 'This ICC represents reliability of a single measurement.'}`,
                agreementLevel: agreementInfo.level,
                recommendations: [
                    `Recruit ${n} subjects (consider ${Math.ceil(n * 1.15)} for 15% dropout/missing data buffer)`,
                    type === '1,1' ? 'Each subject rated by different raters - suitable for situations where rater assignment is random' :
                    type === '2,1' ? 'Use when both subjects and raters are random samples from larger populations' :
                    type === '3,1' ? 'Use when specific raters are of interest (fixed raters)' :
                    'Report both single-measure and average-measure ICC for completeness',
                    `Each subject needs ${k} measurements - plan for logistical feasibility`,
                    'Standardize measurement conditions across all raters/timepoints',
                    'For test-retest reliability, maintain consistent time intervals between measurements',
                    'Report 95% confidence intervals for ICC'
                ],
                references: [
                    'Shrout PE, Fleiss JL. Intraclass correlations: uses in assessing rater reliability. Psychological Bulletin. 1979;86(2):420-428.',
                    'McGraw KO, Wong SP. Forming inferences about some intraclass correlation coefficients. Psychological Methods. 1996;1(1):30-46.',
                    'Koo TK, Li MY. A guideline of selecting and reporting intraclass correlation coefficients for reliability research. Journal of Chiropractic Medicine. 2016;15(2):155-163.'
                ]
            };

            displayResults(n, 'Subjects Needed', globalCalculation.results.details, 'icc', rho1, rho0);
        }

        function calculateBlandAltman() {
            const sd = parseFloat(document.getElementById('ba_sd').value);
            const width = parseFloat(document.getElementById('ba_width').value);
            const maxLoa = parseFloat(document.getElementById('ba_max_loa').value);

            // Sample size for precision of limits of agreement
            // SE(limit) = sqrt(3) * SD / sqrt(n)
            // n = 3 * SD^2 * 1.96^2 / (width/2)^2
            const halfWidth = width / 2;
            const n = Math.ceil(3 * sd * sd * 1.96 * 1.96 / (halfWidth * halfWidth));

            const expectedLoaWidth = 2 * 1.96 * sd;
            const ciWidth = 2 * 1.96 * Math.sqrt(3) * sd / Math.sqrt(n);
            const acceptable = expectedLoaWidth < maxLoa;

            globalCalculation = {
                studyType: "Bland-Altman",
                studyTypeFull: "Bland-Altman Limits of Agreement Analysis",
                inputParameters: {
                    'Expected SD of Differences': sd,
                    'Acceptable 95% CI Width for LoA': width,
                    'Maximum Acceptable LoA Width': maxLoa,
                    'Confidence Level': '95%'
                },
                formula: "LoA = mean_diff +/- 1.96 x SD_diff; n = 3 x SD^2 x 1.96^2 / (width/2)^2",
                formulaDescription: "Sample size ensures adequate precision (narrow 95% CI) around the limits of agreement",
                calculationSteps: [
                    `Step 1: Expected SD of differences = ${sd}`,
                    `Step 2: Desired 95% CI half-width for LoA = ${width}/2 = ${halfWidth}`,
                    `Step 3: Using SE(LoA) = sqrt(3) x SD / sqrt(n)`,
                    `Step 4: For 95% CI width = 2 x 1.96 x SE(LoA) = ${width}`,
                    `Step 5: n = 3 x ${sd}^2 x 1.96^2 / ${halfWidth}^2`,
                    `Step 6: n = ${(3 * sd * sd).toFixed(4)} x ${(1.96*1.96).toFixed(4)} / ${(halfWidth * halfWidth).toFixed(4)}`,
                    `Step 7: n = ${(3 * sd * sd * 1.96 * 1.96 / (halfWidth * halfWidth)).toFixed(2)}, rounded to ${n}`,
                    `Step 8: Expected LoA width = 2 x 1.96 x ${sd} = ${expectedLoaWidth.toFixed(3)}`,
                    `Step 9: Achieved 95% CI width = ${ciWidth.toFixed(3)}`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Subjects Needed',
                    details: {
                        'SD of Differences': sd.toFixed(3),
                        'Expected LoA Width': expectedLoaWidth.toFixed(3),
                        '95% CI Width for LoA': ciWidth.toFixed(3),
                        'Max Acceptable LoA': maxLoa.toFixed(3),
                        'Acceptable': acceptable ? 'Yes' : 'No'
                    }
                },
                interpretation: `With ${n} paired observations, the 95% limits of agreement will span approximately ${expectedLoaWidth.toFixed(2)} units (mean +/- ${(1.96*sd).toFixed(2)}). The 95% CI around each limit will have width ${ciWidth.toFixed(2)}. ${acceptable ? 'The expected LoA width is within clinical acceptability.' : 'WARNING: Expected LoA width exceeds clinical acceptability threshold - methods may not be interchangeable.'}`,
                agreementLevel: acceptable ? 'Acceptable' : 'Needs Review',
                recommendations: [
                    `Recruit ${n} subjects with paired measurements from both methods`,
                    'Measure each subject with both methods under similar conditions',
                    'Plot differences against means (Bland-Altman plot) to check for proportional bias',
                    'Check normality of differences before applying limits',
                    acceptable ? 'Expected agreement appears clinically acceptable' : 'Consider whether the LoA width is clinically acceptable for interchangeability',
                    'Report mean difference (bias), SD of differences, and 95% LoA with CIs',
                    'If proportional bias exists, consider regression-based limits'
                ],
                references: [
                    'Bland JM, Altman DG. Statistical methods for assessing agreement between two methods of clinical measurement. Lancet. 1986;1(8476):307-310.',
                    'Bland JM, Altman DG. Measuring agreement in method comparison studies. Statistical Methods in Medical Research. 1999;8(2):135-160.',
                    'Giavarina D. Understanding Bland Altman analysis. Biochemia Medica. 2015;25(2):141-151.'
                ]
            };

            displayResults(n, 'Subjects Needed', globalCalculation.results.details, 'ba', 0.8, 0.5);
        }

        function calculateCCC() {
            const rho1 = parseFloat(document.getElementById('ccc_rho1').value);
            const rho0 = parseFloat(document.getElementById('ccc_rho0').value);
            const power = parseFloat(document.getElementById('ccc_power').value);
            const alpha = parseFloat(document.getElementById('ccc_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            // Fisher z-transformation
            const z1 = 0.5 * Math.log((1 + rho1) / (1 - rho1));
            const z0 = 0.5 * Math.log((1 + rho0) / (1 - rho0));

            // Sample size using Fisher z
            const n = Math.ceil(Math.pow((zAlpha + zBeta) / (z1 - z0), 2) + 3);

            const agreementInfo = getAgreementLevel(rho1);
            globalCalculation = {
                studyType: "Lin's CCC",
                studyTypeFull: "Lin's Concordance Correlation Coefficient - Method Comparison",
                inputParameters: {
                    'Expected CCC (rho_c1)': rho1,
                    'Null CCC (rho_c0)': rho0,
                    'Statistical Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: "rho_c = 2*rho*sigma_x*sigma_y / (sigma_x^2 + sigma_y^2 + (mu_x - mu_y)^2)",
                formulaDescription: "CCC = Pearson r x Accuracy factor (C_b). Sample size via Fisher z-transformation.",
                calculationSteps: [
                    `Step 1: Expected CCC rho1 = ${rho1}, Null CCC rho0 = ${rho0}`,
                    `Step 2: Fisher z-transform of rho1: z1 = 0.5 x ln((1+${rho1})/(1-${rho1})) = ${z1.toFixed(4)}`,
                    `Step 3: Fisher z-transform of rho0: z0 = 0.5 x ln((1+${rho0})/(1-${rho0})) = ${z0.toFixed(4)}`,
                    `Step 4: z_alpha/2 = ${zAlpha.toFixed(4)}, z_beta = ${zBeta.toFixed(4)}`,
                    `Step 5: n = ((${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)}) / (${z1.toFixed(4)} - ${z0.toFixed(4)}))^2 + 3`,
                    `Step 6: n = (${(zAlpha + zBeta).toFixed(4)} / ${(z1 - z0).toFixed(4)})^2 + 3`,
                    `Step 7: n = ${Math.pow((zAlpha + zBeta) / (z1 - z0), 2).toFixed(2)} + 3 = ${(Math.pow((zAlpha + zBeta) / (z1 - z0), 2) + 3).toFixed(2)}`,
                    `Step 8: Rounded n = ${n} paired observations`
                ],
                results: {
                    mainValue: n,
                    mainLabel: 'Paired Observations Needed',
                    details: {
                        'Expected CCC': rho1.toFixed(3),
                        'Null CCC': rho0.toFixed(3),
                        'Fisher z (expected)': z1.toFixed(4),
                        'Fisher z (null)': z0.toFixed(4),
                        'Power': (power * 100).toFixed(0) + '%',
                        'Alpha': alpha
                    }
                },
                interpretation: `Lin's CCC of ${rho1.toFixed(2)} indicates ${agreementInfo.level} concordance between the two measurement methods. Unlike Pearson's r, CCC accounts for both precision (how closely data follow a line) and accuracy (how close that line is to the 45-degree line of perfect agreement). With ${n} paired observations, the study has ${(power*100).toFixed(0)}% power to detect CCC > ${rho0.toFixed(2)}.`,
                agreementLevel: agreementInfo.level,
                recommendations: [
                    `Collect ${n} paired measurements (consider ${Math.ceil(n * 1.1)} for dropout buffer)`,
                    'Each subject measured once by each method under identical conditions',
                    'CCC < Pearson r indicates systematic bias between methods',
                    'Report both CCC and its components: Pearson r (precision) and C_b (accuracy)',
                    'Plot data with line of identity (45-degree line) and reduced major axis regression',
                    'Consider Bland-Altman analysis as complementary assessment',
                    'CCC interpretation: <0.90 poor, 0.90-0.95 moderate, 0.95-0.99 substantial, >0.99 almost perfect'
                ],
                references: [
                    'Lin LI. A concordance correlation coefficient to evaluate reproducibility. Biometrics. 1989;45(1):255-268.',
                    'Lin LI. Assay validation using the concordance correlation coefficient. Biometrics. 1992;48(2):599-604.',
                    'McBride GB. A proposal for strength-of-agreement criteria for Lin\'s concordance correlation coefficient. NIWA Client Report. 2005.'
                ]
            };

            displayResults(n, 'Paired Observations Needed', globalCalculation.results.details, 'ccc', rho1, rho0);
        }

        function displayResults(mainValue, mainLabel, details, type, agreement1, agreement0) {
            document.getElementById('results').classList.add('active');
            document.getElementById('mainValue').textContent = mainValue;
            document.getElementById('mainLabel').textContent = mainLabel;

            const detectable = agreement1 - agreement0;
            document.getElementById('mainSub').textContent = `Detectable difference: ${detectable.toFixed(3)}`;

            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            for (const [key, val] of Object.entries(details)) {
                grid.innerHTML += `
                    <div class="result-card">
                        <div class="result-card-label">${key}</div>
                        <div class="result-card-value">${val}</div>
                    </div>
                `;
            }

            // Interpretation
            let scaleClass = '';
            if (agreement1 < 0.20) scaleClass = 'poor';
            else if (agreement1 < 0.40) scaleClass = 'fair';
            else if (agreement1 < 0.60) scaleClass = 'moderate';
            else if (agreement1 < 0.80) scaleClass = 'good';
            else scaleClass = 'excellent';

            document.getElementById('interpretationText').textContent =
                `The expected agreement level (${agreement1.toFixed(2)}) falls in the "${scaleClass}" range. A sample of ${mainValue} subjects will provide ${details['Power'] || '80%'} power to detect this level of agreement vs. the null value of ${agreement0.toFixed(2)}.`;

            // Update scale highlighting
            document.querySelectorAll('.scale-badge').forEach(b => b.classList.remove('scale-current'));
            const currentScale = document.querySelector(`.scale-${scaleClass}`);
            if (currentScale) currentScale.classList.add('scale-current');

            drawAgreementChart(type, agreement0, details);

            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function drawAgreementChart(type, nullValue, details) {
            const ctx = document.getElementById('agreementChart').getContext('2d');

            if (agreementChart) agreementChart.destroy();

            const labels = [];
            const data = [];

            const power = parseFloat(details['Power'] || '80') / 100;
            const alpha = parseFloat(details['Alpha'] || '0.05');
            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);

            for (let kappa = nullValue + 0.05; kappa <= 0.95; kappa += 0.05) {
                labels.push(kappa.toFixed(2));

                let n;
                if (type === 'icc') {
                    const k = parseFloat(details['Number of Raters/Measures'] || 3);
                    const numerator = 8 * Math.pow(zAlpha + zBeta, 2) * Math.pow(1 - nullValue, 2) * Math.pow(1 + (k - 1) * nullValue, 2);
                    const denominator = k * (k - 1) * Math.pow(kappa - nullValue, 2);
                    n = Math.ceil(numerator / denominator);
                } else {
                    const pe = 0.5;
                    const numerator = Math.pow(zAlpha + zBeta, 2) * 2 * pe * (1 - pe);
                    const denominator = Math.pow(kappa - nullValue, 2) * Math.pow(1 - pe, 2);
                    n = Math.ceil(numerator / denominator);
                }

                data.push(Math.min(n, 1000));
            }

            agreementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sample Size',
                        data: data,
                        borderColor: '#06B6D4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Expected Agreement' } },
                        y: { title: { display: true, text: 'Sample Size' }, min: 0 }
                    }
                }
            });
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('karmastat-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                document.getElementById('themeIcon').innerHTML = saved === 'dark' ? '&#9728;' : '&#9790;';
            }
        });

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pdfTheme = document.getElementById('pdfTheme').value;

            // Theme colors
            const colors = pdfTheme === 'dark' ? {
                bg: [22, 78, 99],           // Dark cyan background
                headerBg: [14, 116, 144],   // Darker cyan
                primary: [6, 182, 212],     // Cyan
                text: [243, 244, 246],      // Light gray
                textSecondary: [209, 213, 219],
                textMuted: [156, 163, 175],
                accent: [207, 250, 254],
                white: [255, 255, 255],
                cardBg: [21, 94, 117],
                border: [14, 116, 144]
            } : {
                bg: [255, 255, 255],        // White background
                headerBg: [236, 254, 255],  // Light cyan
                primary: [6, 182, 212],     // Cyan
                text: [31, 41, 55],         // Dark gray
                textSecondary: [75, 85, 99],
                textMuted: [107, 114, 128],
                accent: [207, 250, 254],
                white: [255, 255, 255],
                cardBg: [236, 254, 255],
                border: [229, 231, 235]
            };

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;
            let yPos = 0;

            // Helper function to add new page if needed
            function checkPageBreak(requiredSpace) {
                if (yPos + requiredSpace > pageHeight - 25) {
                    doc.addPage();
                    yPos = 20;
                    if (pdfTheme === 'dark') {
                        doc.setFillColor(...colors.bg);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    return true;
                }
                return false;
            }

            // Background for dark theme
            if (pdfTheme === 'dark') {
                doc.setFillColor(...colors.bg);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
            }

            // ==================== HEADER ====================
            // Header background
            doc.setFillColor(...colors.headerBg);
            doc.roundedRect(margin, 10, contentWidth, 40, 3, 3, 'F');

            // Cyan accent bar at top
            doc.setFillColor(...colors.primary);
            doc.rect(margin, 10, contentWidth, 4, 'F');

            // Logo circle
            doc.setFillColor(...colors.primary);
            doc.circle(margin + 15, 30, 10, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('K', margin + 15, 34, { align: 'center' });

            // Title
            doc.setTextColor(...colors.primary);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('KARMASTAT', margin + 30, 26);

            doc.setTextColor(...colors.text);
            doc.setFontSize(12);
            doc.text('Agreement Studies Calculator', margin + 30, 34);

            doc.setTextColor(...colors.textMuted);
            doc.setFontSize(9);
            doc.text('Inter-Rater Reliability & Method Comparison Analysis', margin + 30, 42);

            yPos = 58;

            // ==================== STUDY TYPE ====================
            doc.setFillColor(...colors.primary);
            doc.roundedRect(margin, yPos, contentWidth, 16, 2, 2, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(globalCalculation.studyTypeFull, margin + 5, yPos + 10);
            yPos += 24;

            // ==================== INPUT PARAMETERS ====================
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, 8 + Object.keys(globalCalculation.inputParameters).length * 7, 2, 2, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('INPUT PARAMETERS', margin + 5, yPos + 6);
            yPos += 12;

            doc.setTextColor(...colors.text);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');

            const params = Object.entries(globalCalculation.inputParameters);
            const midPoint = Math.ceil(params.length / 2);

            for (let i = 0; i < params.length; i++) {
                const [key, value] = params[i];
                const xOffset = i < midPoint ? margin + 5 : margin + contentWidth/2;
                const yOffset = i < midPoint ? i : i - midPoint;

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.textSecondary);
                doc.text(`${key}:`, xOffset, yPos + yOffset * 7);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...colors.text);
                doc.text(` ${value}`, xOffset + doc.getTextWidth(`${key}: `), yPos + yOffset * 7);
            }
            yPos += midPoint * 7 + 8;

            // ==================== FORMULA ====================
            checkPageBreak(35);
            doc.setFillColor(...colors.headerBg);
            doc.roundedRect(margin, yPos, contentWidth, 28, 2, 2, 'F');

            // Formula header bar
            doc.setFillColor(...colors.primary);
            doc.rect(margin, yPos, contentWidth, 8, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('FORMULA USED', margin + 5, yPos + 5.5);

            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            doc.setFont('courier', 'bold');
            doc.text(globalCalculation.formula, margin + 5, yPos + 16);

            doc.setFont('helvetica', 'italic');
            doc.setFontSize(8);
            doc.setTextColor(...colors.textMuted);
            doc.text(globalCalculation.formulaDescription, margin + 5, yPos + 23);
            yPos += 36;

            // ==================== CALCULATION STEPS ====================
            checkPageBreak(15 + globalCalculation.calculationSteps.length * 6);
            doc.setFillColor(...colors.cardBg);
            const stepsHeight = 12 + globalCalculation.calculationSteps.length * 6;
            doc.roundedRect(margin, yPos, contentWidth, stepsHeight, 2, 2, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('STEP-BY-STEP CALCULATION', margin + 5, yPos + 6);
            yPos += 12;

            doc.setTextColor(...colors.text);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');

            globalCalculation.calculationSteps.forEach((step, index) => {
                checkPageBreak(8);
                const lines = doc.splitTextToSize(step, contentWidth - 15);
                lines.forEach((line, lineIndex) => {
                    doc.text(line, margin + 8, yPos);
                    yPos += 5;
                });
                yPos += 1;
            });
            yPos += 6;

            // ==================== RESULTS ====================
            checkPageBreak(50);
            // Main result box
            doc.setFillColor(...colors.primary);
            doc.roundedRect(margin, yPos, contentWidth, 30, 3, 3, 'F');

            doc.setTextColor(...colors.white);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text(globalCalculation.results.mainValue.toString(), pageWidth / 2, yPos + 15, { align: 'center' });

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(globalCalculation.results.mainLabel, pageWidth / 2, yPos + 24, { align: 'center' });
            yPos += 38;

            // Detail cards
            const details = Object.entries(globalCalculation.results.details);
            const cardWidth = (contentWidth - 10) / 3;
            const cardHeight = 18;

            for (let i = 0; i < details.length; i++) {
                const [key, value] = details[i];
                const col = i % 3;
                const row = Math.floor(i / 3);

                if (col === 0 && row > 0) {
                    checkPageBreak(cardHeight + 5);
                }

                const cardX = margin + col * (cardWidth + 5);
                const cardY = yPos + row * (cardHeight + 5);

                doc.setFillColor(...colors.cardBg);
                doc.roundedRect(cardX, cardY, cardWidth, cardHeight, 2, 2, 'F');

                doc.setTextColor(...colors.textMuted);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(key, cardX + cardWidth/2, cardY + 6, { align: 'center' });

                doc.setTextColor(...colors.primary);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(value.toString(), cardX + cardWidth/2, cardY + 14, { align: 'center' });
            }
            yPos += Math.ceil(details.length / 3) * (cardHeight + 5) + 8;

            // ==================== INTERPRETATION ====================
            checkPageBreak(40);
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, 35, 2, 2, 'F');

            // Left accent bar
            doc.setFillColor(...colors.primary);
            doc.rect(margin, yPos, 3, 35, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('INTERPRETATION', margin + 8, yPos + 7);

            doc.setTextColor(...colors.text);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const interpLines = doc.splitTextToSize(globalCalculation.interpretation, contentWidth - 15);
            doc.text(interpLines, margin + 8, yPos + 14);

            // Agreement level badge
            doc.setFillColor(...colors.primary);
            doc.roundedRect(margin + 8, yPos + 27, 50, 6, 1, 1, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.text(`Agreement: ${globalCalculation.agreementLevel}`, margin + 33, yPos + 31, { align: 'center' });
            yPos += 43;

            // ==================== RECOMMENDATIONS ====================
            checkPageBreak(15 + globalCalculation.recommendations.length * 8);
            doc.setFillColor(...colors.cardBg);
            const recsHeight = 12 + globalCalculation.recommendations.length * 7;
            doc.roundedRect(margin, yPos, contentWidth, recsHeight, 2, 2, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RECOMMENDATIONS', margin + 5, yPos + 7);
            yPos += 13;

            doc.setTextColor(...colors.text);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');

            globalCalculation.recommendations.forEach((rec, index) => {
                checkPageBreak(10);
                doc.setFillColor(...colors.primary);
                doc.circle(margin + 8, yPos - 1, 1.5, 'F');
                const recLines = doc.splitTextToSize(rec, contentWidth - 20);
                doc.text(recLines, margin + 13, yPos);
                yPos += recLines.length * 4 + 3;
            });
            yPos += 6;

            // ==================== REFERENCES ====================
            checkPageBreak(15 + globalCalculation.references.length * 12);
            doc.setFillColor(...colors.headerBg);
            const refsHeight = 12 + globalCalculation.references.length * 10;
            doc.roundedRect(margin, yPos, contentWidth, refsHeight, 2, 2, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('REFERENCES', margin + 5, yPos + 7);
            yPos += 13;

            doc.setTextColor(...colors.textSecondary);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');

            globalCalculation.references.forEach((ref, index) => {
                checkPageBreak(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`[${index + 1}]`, margin + 5, yPos);
                doc.setFont('helvetica', 'normal');
                const refLines = doc.splitTextToSize(ref, contentWidth - 20);
                doc.text(refLines, margin + 13, yPos);
                yPos += refLines.length * 3.5 + 3;
            });
            yPos += 8;

            // ==================== FOOTER ====================
            // Add footer on each page
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);

                // Footer background
                doc.setFillColor(...colors.headerBg);
                doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');

                // Cyan accent line
                doc.setFillColor(...colors.primary);
                doc.rect(0, pageHeight - 20, pageWidth, 2, 'F');

                // Footer text
                doc.setTextColor(...colors.textMuted);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');

                const timestamp = new Date().toLocaleString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                doc.text(`Generated: ${timestamp}`, margin, pageHeight - 10);

                doc.setTextColor(...colors.primary);
                doc.setFont('helvetica', 'bold');
                doc.text('Generated by KARMASTAT - Crafted by Karmayogi', pageWidth / 2, pageHeight - 10, { align: 'center' });

                doc.setTextColor(...colors.textMuted);
                doc.setFont('helvetica', 'normal');
                doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            }

            // Save the PDF
            const filename = `KARMASTAT_${globalCalculation.studyType.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
