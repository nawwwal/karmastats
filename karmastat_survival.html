<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Analysis - KARMASTAT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #EF4444;
            --primary-dark: #DC2626;
            --primary-light: #F87171;
            --secondary: #991B1B;
            --accent: #FEE2E2;
            --bg-gradient-start: #FEF2F2;
            --bg-gradient-end: #FEE2E2;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.95);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent: #4a1c1c;
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 1.1rem; }

        .nav-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .card h2 { color: var(--primary); margin-bottom: 1.5rem; }

        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }

        .tab {
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .tab:hover { border-color: var(--primary); }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: var(--primary);
        }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover { border-color: var(--primary); }

        .btn-export {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .btn-export:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .results {
            display: none;
            margin-top: 2rem;
            padding: 2rem;
            background: var(--accent);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .results.show { display: block; }

        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-top: 1rem; }

        .result-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .result-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .result-label { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; }

        .formula-box {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .formula-box h4 { color: var(--primary); margin-bottom: 0.75rem; }

        .formula {
            font-family: 'Courier New', monospace;
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .interpretation-box {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .interpretation-box h4 { color: var(--primary); margin-bottom: 0.75rem; }

        .interpretation-box p { color: var(--text-secondary); margin-bottom: 0.5rem; }

        .step-box {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .step-box h4 { color: var(--primary); margin-bottom: 1rem; }

        .step-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--accent);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .export-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .pdf-theme-select {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pdf-theme-select label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .pdf-theme-select select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .theme-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .footer { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .footer a { color: var(--primary); text-decoration: none; }
        .help-text { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .container { padding: 1rem; }
            .result-value { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="header">
        <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
            <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                      fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                <circle cx="20" cy="20" r="3" fill="white"/>
                <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
            </svg>
            <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
        </div>
        <h1>Survival Analysis Calculator</h1>
        <p>Sample size for time-to-event studies and survival comparisons</p>
        <div class="nav-buttons">
            <a href="karmastat_2_0_main.html" class="nav-btn">Back to Main</a>
            <a href="karmastat_clinical_trials.html" class="nav-btn">Clinical Trials</a>
            <a href="karmastat_references.html" class="nav-btn">References</a>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="logrank">Log-rank Test</button>
            <button class="tab" data-tab="hazard">Cox/Hazard Ratio</button>
            <button class="tab" data-tab="exponential">Exponential Survival</button>
        </div>

        <!-- Log-rank Test -->
        <div class="card tab-content" id="logrank-content">
            <h2>Log-rank Test Sample Size</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Sample size for comparing two survival curves using the log-rank test (Schoenfeld formula).</p>

            <div class="form-row">
                <div class="form-group">
                    <label>Hazard Ratio (HR)</label>
                    <input type="number" id="lr-hr" value="1.5" min="1.01" step="0.1">
                    <p class="help-text">Expected HR (treatment vs control), HR > 1 means higher risk in treatment</p>
                </div>
                <div class="form-group">
                    <label>Probability of Event (Control)</label>
                    <input type="number" id="lr-p0" value="0.3" min="0.05" max="0.95" step="0.05">
                    <p class="help-text">Event probability in control group during study</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Allocation Ratio (n2/n1)</label>
                    <select id="lr-ratio">
                        <option value="1">1:1 (Equal)</option>
                        <option value="2">1:2</option>
                        <option value="0.5">2:1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Alpha (two-sided)</label>
                    <select id="lr-alpha">
                        <option value="0.05">0.05 (5%)</option>
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.10">0.10 (10%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Power (1-beta)</label>
                    <select id="lr-power">
                        <option value="0.80">80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="calcLogrank(this)">
    <span class="btn-text">Calculate Sample Size</span>
    <span class="karma-spinner">
        <svg viewBox="0 0 24 24">
            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
    </span>
</button>

            <div class="results" id="lr-results">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Results</h3>
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-value" id="lr-events">-</div>
                        <div class="result-label">Required Events</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="lr-n1">-</div>
                        <div class="result-label">Group 1 (n1)</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="lr-n2">-</div>
                        <div class="result-label">Group 2 (n2)</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="lr-total">-</div>
                        <div class="result-label">Total Sample</div>
                    </div>
                </div>

                <div class="step-box" id="lr-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <div id="lr-step-content"></div>
                </div>

                <div class="formula-box">
                    <h4>Formula (Schoenfeld)</h4>
                    <div class="formula">
                        E = 4 x (z_alpha/2 + z_beta)^2 / (log(HR))^2<br><br>
                        n = E / p_bar<br>
                        Where p_bar = weighted overall event probability
                    </div>
                </div>

                <div class="interpretation-box" id="lr-interpretation">
                    <h4>Interpretation</h4>
                    <div id="lr-interp-content"></div>
                </div>

                <div class="export-section">
                    <div class="pdf-theme-select">
                        <label>PDF Theme:</label>
                        <select id="lr-pdf-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <button class="btn btn-export" onclick="exportLogrankPDF()">Export PDF Report</button>
                </div>
            </div>
        </div>

        <!-- Cox/Hazard Ratio -->
        <div class="card tab-content hidden" id="hazard-content">
            <h2>Cox Regression / Hazard Ratio Comparison</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Sample size for detecting a specified hazard ratio in Cox proportional hazards model.</p>

            <div class="form-row">
                <div class="form-group">
                    <label>Hazard Ratio to Detect</label>
                    <input type="number" id="cox-hr" value="1.5" min="1.01" step="0.1">
                    <p class="help-text">Minimum clinically important HR</p>
                </div>
                <div class="form-group">
                    <label>Proportion Exposed (p)</label>
                    <input type="number" id="cox-pexp" value="0.5" min="0.1" max="0.9" step="0.05">
                    <p class="help-text">Proportion in exposed/treatment group</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Overall Event Probability</label>
                    <input type="number" id="cox-event" value="0.3" min="0.05" max="0.95" step="0.05">
                    <p class="help-text">Expected proportion experiencing event</p>
                </div>
                <div class="form-group">
                    <label>Alpha (two-sided)</label>
                    <select id="cox-alpha">
                        <option value="0.05">0.05 (5%)</option>
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.10">0.10 (10%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Power (1-beta)</label>
                    <select id="cox-power">
                        <option value="0.80">80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="calcCox(this)">
    <span class="btn-text">Calculate Sample Size</span>
    <span class="karma-spinner">
        <svg viewBox="0 0 24 24">
            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
    </span>
</button>

            <div class="results" id="cox-results">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Results</h3>
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-value" id="cox-events">-</div>
                        <div class="result-label">Required Events</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="cox-n">-</div>
                        <div class="result-label">Total Sample Size</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="cox-exposed">-</div>
                        <div class="result-label">Exposed Group</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="cox-unexposed">-</div>
                        <div class="result-label">Unexposed Group</div>
                    </div>
                </div>

                <div class="step-box" id="cox-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <div id="cox-step-content"></div>
                </div>

                <div class="formula-box">
                    <h4>Formula (Freedman)</h4>
                    <div class="formula">
                        E = (z_alpha/2 + z_beta)^2 / [p(1-p) x (log(HR))^2]<br><br>
                        n = E / event_probability<br>
                        Where p = proportion exposed
                    </div>
                </div>

                <div class="interpretation-box" id="cox-interpretation">
                    <h4>Interpretation</h4>
                    <div id="cox-interp-content"></div>
                </div>

                <div class="export-section">
                    <div class="pdf-theme-select">
                        <label>PDF Theme:</label>
                        <select id="cox-pdf-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <button class="btn btn-export" onclick="exportCoxPDF()">Export PDF Report</button>
                </div>
            </div>
        </div>

        <!-- Exponential Survival -->
        <div class="card tab-content hidden" id="exponential-content">
            <h2>Exponential Survival Comparison</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Sample size based on median survival times assuming exponential distribution.</p>

            <div class="form-row">
                <div class="form-group">
                    <label>Median Survival - Control (months)</label>
                    <input type="number" id="exp-m0" value="12" min="1" step="1">
                    <p class="help-text">Expected median survival in control arm</p>
                </div>
                <div class="form-group">
                    <label>Median Survival - Treatment (months)</label>
                    <input type="number" id="exp-m1" value="18" min="1" step="1">
                    <p class="help-text">Expected median survival in treatment arm</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Accrual Period (months)</label>
                    <input type="number" id="exp-accrual" value="24" min="1" step="1">
                    <p class="help-text">Duration of patient enrollment</p>
                </div>
                <div class="form-group">
                    <label>Follow-up Period (months)</label>
                    <input type="number" id="exp-followup" value="12" min="1" step="1">
                    <p class="help-text">Additional follow-up after accrual ends</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Allocation Ratio</label>
                    <select id="exp-ratio">
                        <option value="1">1:1 (Equal)</option>
                        <option value="2">1:2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Alpha (two-sided)</label>
                    <select id="exp-alpha">
                        <option value="0.05">0.05 (5%)</option>
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.10">0.10 (10%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Power (1-beta)</label>
                    <select id="exp-power">
                        <option value="0.80">80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" onclick="calcExponential(this)">
    <span class="btn-text">Calculate Sample Size</span>
    <span class="karma-spinner">
        <svg viewBox="0 0 24 24">
            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
    </span>
</button>

            <div class="results" id="exp-results">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Results</h3>
                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-value" id="exp-hr">-</div>
                        <div class="result-label">Implied Hazard Ratio</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="exp-events">-</div>
                        <div class="result-label">Required Events</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="exp-n1">-</div>
                        <div class="result-label">Control Group</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="exp-n2">-</div>
                        <div class="result-label">Treatment Group</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="exp-n">-</div>
                        <div class="result-label">Total Sample Size</div>
                    </div>
                </div>

                <div class="step-box" id="exp-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <div id="exp-step-content"></div>
                </div>

                <div class="formula-box">
                    <h4>Formula (Lakatos/Rubinstein)</h4>
                    <div class="formula">
                        lambda = log(2) / median_survival<br>
                        HR = lambda_treatment / lambda_control<br><br>
                        E = 4 x (z_alpha/2 + z_beta)^2 / (log(HR))^2<br>
                        n = E / p_bar (weighted average event probability)
                    </div>
                </div>

                <div class="interpretation-box" id="exp-interpretation">
                    <h4>Interpretation</h4>
                    <div id="exp-interp-content"></div>
                </div>

                <div class="export-section">
                    <div class="pdf-theme-select">
                        <label>PDF Theme:</label>
                        <select id="exp-pdf-theme">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <button class="btn btn-export" onclick="exportExponentialPDF()">Export PDF Report</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Made with love by Karmayogi | <a href="karmastat_references.html">References</a></p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Jai Shri Ram</p>
    </footer>

    <button class="theme-toggle" onclick="toggleTheme()">&#127769;</button>

    <script>
        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        // Global storage for calculation results
        let globalCalcData = {
            logrank: null,
            cox: null,
            exponential: null
        };

        // Z-values lookup
        function getZ(alpha) {
            const z = { '0.05': 1.96, '0.01': 2.576, '0.10': 1.645 };
            return z[alpha] || 1.96;
        }

        function getZBeta(power) {
            const z = { '0.80': 0.842, '0.90': 1.282, '0.95': 1.645 };
            return z[power] || 0.842;
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? '' : 'dark');
            document.querySelector('.theme-toggle').innerHTML = isDark ? '&#127769;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('karmastat-theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').innerHTML = '&#9728;';
            }
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(this.dataset.tab + '-content').classList.remove('hidden');
            });
        });

        // Log-rank Test Calculation
        function calcLogrank(btn) {
            withLoader(btn, function() {
            const hr = parseFloat(document.getElementById('lr-hr').value);
            const p0 = parseFloat(document.getElementById('lr-p0').value);
            const r = parseFloat(document.getElementById('lr-ratio').value);
            const alphaVal = document.getElementById('lr-alpha').value;
            const powerVal = document.getElementById('lr-power').value;
            const za = getZ(alphaVal);
            const zb = getZBeta(powerVal);

            // Schoenfeld formula
            const logHR = Math.log(hr);
            const events = Math.ceil(4 * Math.pow(za + zb, 2) / Math.pow(logHR, 2));

            // Estimate treatment group event probability
            const p1 = 1 - Math.pow(1 - p0, hr);
            const pbar = (p0 + r * p1) / (1 + r);

            const n1 = Math.ceil(events / (pbar * (1 + r)));
            const n2 = Math.ceil(n1 * r);
            const total = n1 + n2;

            // Store calculation data
            globalCalcData.logrank = {
                studyType: 'Log-rank Test',
                inputs: {
                    hazardRatio: hr,
                    eventProbControl: p0,
                    eventProbTreatment: p1.toFixed(4),
                    allocationRatio: r === 1 ? '1:1' : (r === 2 ? '1:2' : '2:1'),
                    alpha: alphaVal,
                    power: powerVal,
                    zAlpha: za,
                    zBeta: zb
                },
                results: {
                    requiredEvents: events,
                    group1: n1,
                    group2: n2,
                    total: total,
                    weightedEventProb: pbar.toFixed(4)
                },
                formula: 'Schoenfeld Formula',
                steps: [
                    `Step 1: Calculate log(HR) = log(${hr}) = ${logHR.toFixed(4)}`,
                    `Step 2: Calculate required events: E = 4 x (${za} + ${zb})^2 / (${logHR.toFixed(4)})^2`,
                    `Step 3: E = 4 x ${(za + zb).toFixed(4)}^2 / ${Math.pow(logHR, 2).toFixed(4)} = ${events}`,
                    `Step 4: Estimate treatment event prob: p1 = 1 - (1 - ${p0})^${hr} = ${p1.toFixed(4)}`,
                    `Step 5: Calculate weighted event prob: p_bar = (${p0} + ${r} x ${p1.toFixed(4)}) / (1 + ${r}) = ${pbar.toFixed(4)}`,
                    `Step 6: Calculate n1 = ${events} / (${pbar.toFixed(4)} x (1 + ${r})) = ${n1}`,
                    `Step 7: Calculate n2 = ${n1} x ${r} = ${n2}`,
                    `Step 8: Total sample size = ${n1} + ${n2} = ${total}`
                ]
            };

            // Display results
            document.getElementById('lr-events').textContent = events;
            document.getElementById('lr-n1').textContent = n1;
            document.getElementById('lr-n2').textContent = n2;
            document.getElementById('lr-total').textContent = total;

            // Display steps
            let stepsHtml = '';
            globalCalcData.logrank.steps.forEach(step => {
                stepsHtml += `<div class="step-item">${step}</div>`;
            });
            document.getElementById('lr-step-content').innerHTML = stepsHtml;

            // Display interpretation
            const hrDirection = hr > 1 ? 'higher' : 'lower';
            const interpHtml = `
                <p><strong>Study Design:</strong> This survival study requires ${total} participants (${n1} in group 1, ${n2} in group 2) with ${events} events expected to observe.</p>
                <p><strong>Hazard Ratio:</strong> A HR of ${hr} indicates ${hrDirection} hazard in the treatment/exposed group compared to control.</p>
                <p><strong>Statistical Power:</strong> With ${(parseFloat(powerVal) * 100)}% power and alpha=${alphaVal}, there is a ${(parseFloat(powerVal) * 100)}% chance of detecting the specified hazard ratio if it truly exists.</p>
                <p><strong>Recommendation:</strong> Consider adding 10-20% to account for dropout and loss to follow-up. Monitor accrual rates and event rates during the study.</p>
            `;
            document.getElementById('lr-interp-content').innerHTML = interpHtml;

            document.getElementById('lr-results').classList.add('show');
            });
        }

        // Cox/Hazard Ratio Calculation
        function calcCox(btn) {
            withLoader(btn, function() {
            const hr = parseFloat(document.getElementById('cox-hr').value);
            const pexp = parseFloat(document.getElementById('cox-pexp').value);
            const eventProb = parseFloat(document.getElementById('cox-event').value);
            const alphaVal = document.getElementById('cox-alpha').value;
            const powerVal = document.getElementById('cox-power').value;
            const za = getZ(alphaVal);
            const zb = getZBeta(powerVal);

            const logHR = Math.log(hr);
            const events = Math.ceil(Math.pow(za + zb, 2) / (pexp * (1 - pexp) * Math.pow(logHR, 2)));
            const n = Math.ceil(events / eventProb);
            const nExposed = Math.ceil(n * pexp);
            const nUnexposed = n - nExposed;

            // Store calculation data
            globalCalcData.cox = {
                studyType: 'Cox Regression / Hazard Ratio Comparison',
                inputs: {
                    hazardRatio: hr,
                    proportionExposed: pexp,
                    eventProbability: eventProb,
                    alpha: alphaVal,
                    power: powerVal,
                    zAlpha: za,
                    zBeta: zb
                },
                results: {
                    requiredEvents: events,
                    total: n,
                    exposed: nExposed,
                    unexposed: nUnexposed
                },
                formula: 'Freedman Formula',
                steps: [
                    `Step 1: Calculate log(HR) = log(${hr}) = ${logHR.toFixed(4)}`,
                    `Step 2: Calculate variance term: p(1-p) = ${pexp} x (1-${pexp}) = ${(pexp * (1 - pexp)).toFixed(4)}`,
                    `Step 3: Calculate required events: E = (${za} + ${zb})^2 / [${(pexp * (1 - pexp)).toFixed(4)} x (${logHR.toFixed(4)})^2]`,
                    `Step 4: E = ${Math.pow(za + zb, 2).toFixed(4)} / ${(pexp * (1 - pexp) * Math.pow(logHR, 2)).toFixed(6)} = ${events}`,
                    `Step 5: Calculate total sample: n = ${events} / ${eventProb} = ${n}`,
                    `Step 6: Exposed group: n_exposed = ${n} x ${pexp} = ${nExposed}`,
                    `Step 7: Unexposed group: n_unexposed = ${n} - ${nExposed} = ${nUnexposed}`
                ]
            };

            // Display results
            document.getElementById('cox-events').textContent = events;
            document.getElementById('cox-n').textContent = n;
            document.getElementById('cox-exposed').textContent = nExposed;
            document.getElementById('cox-unexposed').textContent = nUnexposed;

            // Display steps
            let stepsHtml = '';
            globalCalcData.cox.steps.forEach(step => {
                stepsHtml += `<div class="step-item">${step}</div>`;
            });
            document.getElementById('cox-step-content').innerHTML = stepsHtml;

            // Display interpretation
            const interpHtml = `
                <p><strong>Study Design:</strong> This Cox regression study requires ${n} total participants (${nExposed} exposed, ${nUnexposed} unexposed) with ${events} events needed.</p>
                <p><strong>Hazard Ratio:</strong> The study is powered to detect a hazard ratio of ${hr} between exposed and unexposed groups.</p>
                <p><strong>Event Rate:</strong> With an overall event probability of ${eventProb * 100}%, approximately ${events} events are expected during follow-up.</p>
                <p><strong>Recommendation:</strong> Ensure proportional hazards assumption is reasonable. Consider sensitivity analyses with different HR values. Add buffer for loss to follow-up.</p>
            `;
            document.getElementById('cox-interp-content').innerHTML = interpHtml;

            document.getElementById('cox-results').classList.add('show');
            });
        }

        // Exponential Survival Calculation
        function calcExponential(btn) {
            withLoader(btn, function() {
            const m0 = parseFloat(document.getElementById('exp-m0').value);
            const m1 = parseFloat(document.getElementById('exp-m1').value);
            const accrual = parseFloat(document.getElementById('exp-accrual').value);
            const followup = parseFloat(document.getElementById('exp-followup').value);
            const r = parseFloat(document.getElementById('exp-ratio').value);
            const alphaVal = document.getElementById('exp-alpha').value;
            const powerVal = document.getElementById('exp-power').value;
            const za = getZ(alphaVal);
            const zb = getZBeta(powerVal);

            // Hazard rates (exponential)
            const lambda0 = Math.log(2) / m0;
            const lambda1 = Math.log(2) / m1;
            const hr = lambda0 / lambda1; // Control vs treatment (lower lambda = better survival)

            // Average follow-up and event probability
            const totalStudyTime = accrual + followup;
            const avgFollowup = accrual / 2 + followup;

            // Event probabilities using exponential distribution
            const p0 = 1 - Math.exp(-lambda0 * avgFollowup);
            const p1 = 1 - Math.exp(-lambda1 * avgFollowup);
            const pbar = (p0 + r * p1) / (1 + r);

            const logHR = Math.log(hr);
            const events = Math.ceil(4 * Math.pow(za + zb, 2) / Math.pow(logHR, 2));
            const n1 = Math.ceil(events / (pbar * (1 + r)));
            const n2 = Math.ceil(n1 * r);
            const total = n1 + n2;

            // Store calculation data
            globalCalcData.exponential = {
                studyType: 'Exponential Survival Comparison',
                inputs: {
                    medianSurvivalControl: m0 + ' months',
                    medianSurvivalTreatment: m1 + ' months',
                    accrualPeriod: accrual + ' months',
                    followupPeriod: followup + ' months',
                    totalStudyDuration: totalStudyTime + ' months',
                    allocationRatio: r === 1 ? '1:1' : '1:2',
                    alpha: alphaVal,
                    power: powerVal,
                    zAlpha: za,
                    zBeta: zb
                },
                results: {
                    impliedHR: hr.toFixed(3),
                    hazardRateControl: lambda0.toFixed(4) + '/month',
                    hazardRateTreatment: lambda1.toFixed(4) + '/month',
                    eventProbControl: (p0 * 100).toFixed(1) + '%',
                    eventProbTreatment: (p1 * 100).toFixed(1) + '%',
                    weightedEventProb: (pbar * 100).toFixed(1) + '%',
                    requiredEvents: events,
                    controlGroup: n1,
                    treatmentGroup: n2,
                    total: total
                },
                formula: 'Lakatos/Rubinstein Method',
                steps: [
                    `Step 1: Calculate hazard rate (control): lambda0 = ln(2) / ${m0} = ${lambda0.toFixed(4)}/month`,
                    `Step 2: Calculate hazard rate (treatment): lambda1 = ln(2) / ${m1} = ${lambda1.toFixed(4)}/month`,
                    `Step 3: Calculate implied HR: HR = ${lambda0.toFixed(4)} / ${lambda1.toFixed(4)} = ${hr.toFixed(3)}`,
                    `Step 4: Calculate average follow-up: ${accrual}/2 + ${followup} = ${avgFollowup} months`,
                    `Step 5: Event prob (control): p0 = 1 - exp(-${lambda0.toFixed(4)} x ${avgFollowup}) = ${(p0 * 100).toFixed(1)}%`,
                    `Step 6: Event prob (treatment): p1 = 1 - exp(-${lambda1.toFixed(4)} x ${avgFollowup}) = ${(p1 * 100).toFixed(1)}%`,
                    `Step 7: Weighted event prob: p_bar = (${p0.toFixed(4)} + ${r} x ${p1.toFixed(4)}) / (1 + ${r}) = ${pbar.toFixed(4)}`,
                    `Step 8: Required events: E = 4 x (${za} + ${zb})^2 / (ln(${hr.toFixed(3)}))^2 = ${events}`,
                    `Step 9: Control group: n1 = ${events} / (${pbar.toFixed(4)} x (1 + ${r})) = ${n1}`,
                    `Step 10: Treatment group: n2 = ${n1} x ${r} = ${n2}`,
                    `Step 11: Total sample: ${n1} + ${n2} = ${total}`
                ]
            };

            // Display results
            document.getElementById('exp-hr').textContent = hr.toFixed(2);
            document.getElementById('exp-events').textContent = events;
            document.getElementById('exp-n1').textContent = n1;
            document.getElementById('exp-n2').textContent = n2;
            document.getElementById('exp-n').textContent = total;

            // Display steps
            let stepsHtml = '';
            globalCalcData.exponential.steps.forEach(step => {
                stepsHtml += `<div class="step-item">${step}</div>`;
            });
            document.getElementById('exp-step-content').innerHTML = stepsHtml;

            // Survival improvement
            const survivalImprovement = ((m1 - m0) / m0 * 100).toFixed(1);

            // Display interpretation
            const interpHtml = `
                <p><strong>Study Design:</strong> This time-to-event study requires ${total} participants (${n1} control, ${n2} treatment) over ${totalStudyTime} months total duration.</p>
                <p><strong>Survival Improvement:</strong> Treatment improves median survival by ${survivalImprovement}% (from ${m0} to ${m1} months), corresponding to HR = ${hr.toFixed(2)}.</p>
                <p><strong>Expected Events:</strong> With ${(pbar * 100).toFixed(1)}% overall event probability, approximately ${events} events will be observed.</p>
                <p><strong>Accrual:</strong> Over ${accrual} months of enrollment with ${followup} months additional follow-up after last patient enrolled.</p>
                <p><strong>Recommendation:</strong> Validate exponential assumption with historical data. Consider Weibull or other distributions if hazard is not constant. Plan for interim analyses if study duration is long.</p>
            `;
            document.getElementById('exp-interp-content').innerHTML = interpHtml;

            document.getElementById('exp-results').classList.add('show');
            });
        }

        // PDF Export Functions
        function exportLogrankPDF() {
            if (!globalCalcData.logrank) {
                alert('Please calculate results first.');
                return;
            }
            exportPDF('logrank', globalCalcData.logrank, document.getElementById('lr-pdf-theme').value);
        }

        function exportCoxPDF() {
            if (!globalCalcData.cox) {
                alert('Please calculate results first.');
                return;
            }
            exportPDF('cox', globalCalcData.cox, document.getElementById('cox-pdf-theme').value);
        }

        function exportExponentialPDF() {
            if (!globalCalcData.exponential) {
                alert('Please calculate results first.');
                return;
            }
            exportPDF('exponential', globalCalcData.exponential, document.getElementById('exp-pdf-theme').value);
        }

        function exportPDF(type, data, theme) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Theme colors
            const isDark = theme === 'dark';
            const bgColor = isDark ? [31, 41, 55] : [255, 255, 255];
            const textColor = isDark ? [241, 245, 249] : [30, 41, 59];
            const primaryColor = [239, 68, 68]; // Red #EF4444
            const secondaryColor = isDark ? [148, 163, 184] : [71, 85, 105];
            const accentBg = isDark ? [74, 28, 28] : [254, 226, 226];

            // Set background
            if (isDark) {
                doc.setFillColor(...bgColor);
                doc.rect(0, 0, 210, 297, 'F');
            }

            let y = 15;

            // Header with red bar
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 35, 'F');

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('KARMASTAT', 105, 15, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Survival Analysis Sample Size Calculator', 105, 23, { align: 'center' });

            doc.setFontSize(10);
            doc.text(data.studyType, 105, 31, { align: 'center' });

            y = 45;

            // Study Type Section
            doc.setFillColor(...(isDark ? [55, 65, 81] : [243, 244, 246]));
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Study Parameters', 15, y + 3);

            y += 15;

            // Input Parameters
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            const inputs = data.inputs;
            const inputKeys = Object.keys(inputs);
            let col = 0;
            inputKeys.forEach((key, index) => {
                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const value = inputs[key];
                const xPos = col === 0 ? 15 : 110;

                doc.setFont('helvetica', 'bold');
                doc.text(label + ':', xPos, y);
                doc.setFont('helvetica', 'normal');
                doc.text(String(value), xPos + 50, y);

                col = 1 - col;
                if (col === 0) y += 7;
            });
            if (col === 1) y += 7;

            y += 5;

            // Formula Section
            doc.setFillColor(...(isDark ? [55, 65, 81] : [243, 244, 246]));
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Formula: ' + data.formula, 15, y + 3);

            y += 15;

            // Step-by-Step Calculation
            doc.setFillColor(...(isDark ? [55, 65, 81] : [243, 244, 246]));
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Step-by-Step Calculation', 15, y + 3);

            y += 15;

            doc.setTextColor(...textColor);
            doc.setFontSize(9);
            doc.setFont('courier', 'normal');

            data.steps.forEach((step, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }

                // Light background for steps
                doc.setFillColor(...accentBg);
                doc.rect(12, y - 4, 186, 8, 'F');

                doc.setTextColor(...textColor);
                const lines = doc.splitTextToSize(step, 180);
                doc.text(lines, 15, y);
                y += 6 * lines.length + 2;
            });

            y += 5;

            // Results Section
            if (y > 220) {
                doc.addPage();
                y = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(...primaryColor);
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('FINAL RESULTS', 15, y + 3);

            y += 15;

            // Results in boxes
            const results = data.results;
            const resultKeys = Object.keys(results);
            doc.setFontSize(11);

            resultKeys.forEach((key, index) => {
                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const value = results[key];

                // Result box
                doc.setFillColor(...(isDark ? [55, 65, 81] : [254, 226, 226]));
                doc.rect(15, y - 4, 85, 10, 'F');
                doc.rect(100, y - 4, 95, 10, 'F');

                doc.setTextColor(...secondaryColor);
                doc.setFont('helvetica', 'normal');
                doc.text(label + ':', 18, y + 2);

                doc.setTextColor(...primaryColor);
                doc.setFont('helvetica', 'bold');
                doc.text(String(value), 103, y + 2);

                y += 12;
            });

            y += 5;

            // Interpretation Section
            if (y > 220) {
                doc.addPage();
                y = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(...(isDark ? [55, 65, 81] : [243, 244, 246]));
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Interpretation & Recommendations', 15, y + 3);

            y += 15;

            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            const interpretations = getInterpretation(type, data);
            interpretations.forEach(text => {
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }
                const lines = doc.splitTextToSize(text, 180);
                doc.text(lines, 15, y);
                y += 6 * lines.length + 3;
            });

            y += 5;

            // Reference Citation
            if (y > 250) {
                doc.addPage();
                y = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(...(isDark ? [55, 65, 81] : [243, 244, 246]));
            doc.rect(10, y - 5, 190, 12, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Reference', 15, y + 3);

            y += 15;

            doc.setTextColor(...secondaryColor);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            const reference = getReference(type);
            const refLines = doc.splitTextToSize(reference, 180);
            doc.text(refLines, 15, y);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Footer bar
                doc.setFillColor(...primaryColor);
                doc.rect(0, 280, 210, 17, 'F');

                // Footer text
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');

                const timestamp = new Date().toLocaleString();
                doc.text('Generated: ' + timestamp, 15, 287);
                doc.text('Page ' + i + ' of ' + pageCount, 105, 287, { align: 'center' });
                doc.text('Generated by KARMASTAT - Crafted by Karmayogi', 195, 287, { align: 'right' });

                doc.setFontSize(7);
                doc.text('Jai Shri Ram', 105, 293, { align: 'center' });
            }

            // Save PDF
            const filename = 'KARMASTAT_Survival_' + type + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            doc.save(filename);
        }

        function getInterpretation(type, data) {
            const interpretations = [];

            if (type === 'logrank') {
                interpretations.push('STUDY DESIGN: This log-rank test study requires ' + data.results.total + ' total participants (' + data.results.group1 + ' in group 1, ' + data.results.group2 + ' in group 2) with ' + data.results.requiredEvents + ' events needed for analysis.');
                interpretations.push('HAZARD RATIO: The study is designed to detect a hazard ratio of ' + data.inputs.hazardRatio + '. A HR > 1 indicates increased risk in the comparison group relative to control.');
                interpretations.push('STATISTICAL POWER: With ' + (parseFloat(data.inputs.power) * 100) + '% power at alpha = ' + data.inputs.alpha + ', there is high probability of detecting the specified effect if it truly exists.');
                interpretations.push('RECOMMENDATION: Consider inflating sample size by 10-20% to account for dropout, loss to follow-up, and protocol deviations. Implement robust data collection procedures for time-to-event data.');
            } else if (type === 'cox') {
                interpretations.push('STUDY DESIGN: This Cox proportional hazards study requires ' + data.results.total + ' participants (' + data.results.exposed + ' exposed, ' + data.results.unexposed + ' unexposed) with ' + data.results.requiredEvents + ' events needed.');
                interpretations.push('EXPOSURE EFFECT: The analysis is powered to detect a hazard ratio of ' + data.inputs.hazardRatio + ' between exposed and unexposed groups.');
                interpretations.push('PROPORTIONAL HAZARDS: This calculation assumes proportional hazards. Verify this assumption using Schoenfeld residuals or log-log plots during analysis.');
                interpretations.push('RECOMMENDATION: Plan for sensitivity analyses with different HR assumptions. Consider stratification if important confounders are present. Add buffer for loss to follow-up.');
            } else if (type === 'exponential') {
                interpretations.push('STUDY DESIGN: This survival study requires ' + data.results.total + ' participants (' + data.results.controlGroup + ' control, ' + data.results.treatmentGroup + ' treatment) with ' + data.results.requiredEvents + ' events expected over the study duration.');
                interpretations.push('SURVIVAL IMPROVEMENT: Treatment extends median survival from ' + data.inputs.medianSurvivalControl + ' to ' + data.inputs.medianSurvivalTreatment + ', corresponding to implied HR = ' + data.results.impliedHR + '.');
                interpretations.push('STUDY TIMELINE: Total study duration is ' + data.inputs.totalStudyDuration + ' with ' + data.inputs.accrualPeriod + ' accrual and ' + data.inputs.followupPeriod + ' additional follow-up.');
                interpretations.push('EXPONENTIAL ASSUMPTION: This calculation assumes constant hazard rates. Validate with historical data. Consider Weibull or piecewise exponential if hazard varies over time.');
                interpretations.push('RECOMMENDATION: Plan interim analyses for long studies. Monitor accrual rates closely. Consider adaptive designs if there is uncertainty in survival estimates.');
            }

            return interpretations;
        }

        function getReference(type) {
            if (type === 'logrank') {
                return 'Schoenfeld DA. Sample-size formula for the proportional-hazards regression model. Biometrics. 1983;39(2):499-503. doi:10.2307/2531021';
            } else if (type === 'cox') {
                return 'Freedman LS. Tables of the number of patients required in clinical trials using the logrank test. Statistics in Medicine. 1982;1(2):121-129. doi:10.1002/sim.4780010204';
            } else {
                return 'Lakatos E. Sample sizes based on the log-rank statistic in complex clinical trials. Biometrics. 1988;44(1):229-241. Rubinstein LV, Gail MH, Santner TJ. Planning the duration of a comparative clinical trial with loss to follow-up and a period of continued observation. Journal of Chronic Diseases. 1981;34(9-10):469-479.';
            }
        }
    </script>
</body>
</html>
