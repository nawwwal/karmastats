<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Cluster & Multi-level Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #F59E0B;
            --primary-dark: #D97706;
            --primary-light: #FBBF24;
            --secondary: #B45309;
            --accent: #FEF3C7;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --bg-primary: #FFFFFF;
            --bg-secondary: #FFFBEB;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
            --shadow-hover: 0 8px 25px rgba(245, 158, 11, 0.25);

            --gradient-primary: linear-gradient(135deg, #F59E0B, #FBBF24, #FCD34D);
            --gradient-secondary: linear-gradient(135deg, #B45309, #D97706, #F59E0B);
            --gradient-bg: linear-gradient(135deg, #FFFBEB, #FEF3C7, #FDE68A);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #FFFBEB);

            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        [data-theme="dark"] {
            --bg-primary: #292524;
            --bg-secondary: #44403C;
            --bg-card: #44403C;
            --text-primary: #F3F4F6;
            --text-secondary: #D1D5DB;
            --text-muted: #9CA3AF;
            --border-color: #57534E;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --gradient-bg: linear-gradient(135deg, #292524, #44403C, #57534E);
            --gradient-card: linear-gradient(145deg, #44403C, #57534E);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        .header {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle { font-size: 1.1rem; color: var(--text-secondary); }

        .theme-toggle, .back-link {
            position: absolute;
            top: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .theme-toggle { right: 1.5rem; }
        .back-link { left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }

        .theme-toggle:hover, .back-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calc-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--gradient-card);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .calc-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calc-tab:hover { border-color: var(--primary); }
        .calc-tab.active { background: var(--gradient-primary); color: white; border-color: var(--primary); }

        .calculator-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .calculator-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-header h3 { font-size: 1.5rem; font-weight: 700; }

        .formula-box {
            background: var(--gradient-secondary);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            font-family: var(--font-mono);
            text-align: center;
            border-radius: var(--radius);
        }

        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h4 { color: var(--primary); margin-bottom: 0.5rem; }
        .info-box p { color: var(--text-secondary); }

        .icc-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .icc-preset {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .icc-preset:hover { border-color: var(--primary); }
        .icc-preset.active { border-color: var(--primary); background: var(--accent); }
        .icc-preset-value { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .icc-preset-label { font-size: 0.85rem; color: var(--text-muted); }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 0.5rem; }

        .input-group input, .input-group select {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .input-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .calculate-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .results-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .results-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-main {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-value { font-size: 3.5rem; font-weight: 800; color: white; }
        .result-label { color: rgba(255,255,255,0.9); font-size: 1.1rem; }
        .result-sub { margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: var(--radius); color: white; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .result-card-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .result-card-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container h4 { text-align: center; margin-bottom: 1rem; }
        .chart-wrapper { position: relative; height: 300px; }

        .export-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pdf-theme-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover { background: #059669; transform: translateY(-1px); }

        .footer {
            background: var(--gradient-secondary);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
        }

        .footer-love { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .footer-blessing { color: var(--accent); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .logo { flex-direction: column; }
            .back-link, .theme-toggle { position: static; margin: 0.5rem; }
            .header { padding-top: 4rem; }
            .result-value { font-size: 2.5rem; }
            .results-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <a href="karmastat_2_0_main.html" class="back-link">
                <span>&#8592;</span> Back to Main
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">&#9790;</span> Theme
            </button>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <div class="logo">
                <div>
                    <h1>Cluster & Multi-level Calculator</h1>
                    <p class="subtitle">Sample size calculations for clustered and hierarchical study designs</p>
                </div>
            </div>
        </header>

        <div class="calc-tabs">
            <button class="calc-tab active" data-calc="crt" onclick="selectCalc('crt')">Cluster RCT</button>
            <button class="calc-tab" data-calc="stepped-wedge" onclick="selectCalc('stepped-wedge')">Stepped Wedge</button>
            <button class="calc-tab" data-calc="multilevel" onclick="selectCalc('multilevel')">Multi-level Longitudinal</button>
            <button class="calc-tab" data-calc="school-hospital" onclick="selectCalc('school-hospital')">School/Hospital Studies</button>
        </div>

        <!-- Cluster RCT Calculator -->
        <section class="calculator-section active" id="crt-calc">
            <div class="section-header">
                <div class="section-icon">&#128736;</div>
                <h3>Cluster Randomized Trial (CRT)</h3>
            </div>

            <div class="formula-box">
                n<sub>total</sub> = n<sub>standard</sub> &times; DEFF<br>
                DEFF = 1 + (m - 1) &times; ICC
                <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                    Where m = cluster size, ICC = intraclass correlation
                </div>
            </div>

            <div class="info-box">
                <h4>ICC Presets by Study Setting</h4>
                <p>Select a preset or enter a custom ICC value below.</p>
            </div>

            <div class="icc-presets">
                <div class="icc-preset active" data-icc="0.05" onclick="selectICC(this, 'crt')">
                    <div class="icc-preset-value">0.05</div>
                    <div class="icc-preset-label">Primary Care</div>
                </div>
                <div class="icc-preset" data-icc="0.02" onclick="selectICC(this, 'crt')">
                    <div class="icc-preset-value">0.02</div>
                    <div class="icc-preset-label">Hospital Patients</div>
                </div>
                <div class="icc-preset" data-icc="0.10" onclick="selectICC(this, 'crt')">
                    <div class="icc-preset-value">0.10</div>
                    <div class="icc-preset-label">Schools (Academic)</div>
                </div>
                <div class="icc-preset" data-icc="0.15" onclick="selectICC(this, 'crt')">
                    <div class="icc-preset-value">0.15</div>
                    <div class="icc-preset-label">Schools (Behavior)</div>
                </div>
                <div class="icc-preset" data-icc="0.01" onclick="selectICC(this, 'crt')">
                    <div class="icc-preset-value">0.01</div>
                    <div class="icc-preset-label">Community</div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Individual Sample Size (without clustering)</label>
                    <input type="number" id="crt_n_ind" value="200" min="10" step="1">
                    <span class="input-hint">From standard power calculation</span>
                </div>
                <div class="input-group">
                    <label>Cluster Size (individuals per cluster)</label>
                    <input type="number" id="crt_m" value="20" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Intraclass Correlation (ICC)</label>
                    <input type="number" id="crt_icc" value="0.05" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Coefficient of Variation of Cluster Size</label>
                    <input type="number" id="crt_cv" value="0" min="0" max="1" step="0.01">
                    <span class="input-hint">0 for equal cluster sizes, 0.3-0.5 typical</span>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateCRT(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Cluster Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Stepped Wedge Design -->
        <section class="calculator-section" id="stepped-wedge-calc">
            <div class="section-header">
                <div class="section-icon">&#128200;</div>
                <h3>Stepped Wedge Design</h3>
            </div>

            <div class="formula-box">
                DE = (1 + (m-1)&rho;) &times; 3(1-r&sup2;) / (2t(t-1/(t+1)))<br>
                <small>Where t = number of steps, r = within-cluster correlation over time</small>
            </div>

            <div class="info-box">
                <h4>About Stepped Wedge Designs</h4>
                <p>In a stepped wedge design, clusters sequentially cross over from control to intervention at different time points. This design is useful when the intervention cannot be withdrawn.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Steps/Time Periods</label>
                    <input type="number" id="sw_t" value="5" min="2" max="20" step="1">
                </div>
                <div class="input-group">
                    <label>Clusters per Step</label>
                    <input type="number" id="sw_clusters" value="4" min="1" step="1">
                </div>
                <div class="input-group">
                    <label>Individuals per Cluster per Period</label>
                    <input type="number" id="sw_m" value="20" min="5" step="1">
                </div>
                <div class="input-group">
                    <label>ICC</label>
                    <input type="number" id="sw_icc" value="0.05" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Within-Cluster Correlation Over Time (r)</label>
                    <input type="number" id="sw_r" value="0.8" min="0" max="1" step="0.01">
                    <span class="input-hint">How correlated outcomes are within clusters over time</span>
                </div>
                <div class="input-group">
                    <label>Expected Effect Size (d)</label>
                    <input type="number" id="sw_d" value="0.3" min="0.01" step="0.01">
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateSteppedWedge(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Stepped Wedge Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Multi-level Longitudinal -->
        <section class="calculator-section" id="multilevel-calc">
            <div class="section-header">
                <div class="section-icon">&#128203;</div>
                <h3>Multi-level Longitudinal Design</h3>
            </div>

            <div class="formula-box">
                n = n<sub>standard</sub> &times; DEFF<sub>cluster</sub> &times; DEFF<sub>time</sub><br>
                <small>Three-level: measurements within patients within clusters</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Clusters</label>
                    <input type="number" id="ml_k" value="20" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Individuals per Cluster</label>
                    <input type="number" id="ml_m" value="15" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Time Points per Individual</label>
                    <input type="number" id="ml_t" value="4" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>ICC (Cluster Level)</label>
                    <input type="number" id="ml_icc_cluster" value="0.05" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>ICC (Individual Level - Within Person)</label>
                    <input type="number" id="ml_icc_ind" value="0.50" min="0" max="1" step="0.01">
                    <span class="input-hint">Correlation of repeated measures within individuals</span>
                </div>
                <div class="input-group">
                    <label>Expected Effect Size (d)</label>
                    <input type="number" id="ml_d" value="0.3" min="0.01" step="0.01">
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateMultilevel(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Multi-level Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- School/Hospital Studies -->
        <section class="calculator-section" id="school-hospital-calc">
            <div class="section-header">
                <div class="section-icon">&#127979;</div>
                <h3>School / Hospital Based Studies</h3>
            </div>

            <div class="info-box">
                <h4>Typical ICC Values</h4>
                <p>
                    <strong>Schools (academic outcomes):</strong> ICC = 0.05 - 0.20<br>
                    <strong>Schools (behavioral):</strong> ICC = 0.10 - 0.25<br>
                    <strong>Hospitals (clinical):</strong> ICC = 0.01 - 0.10<br>
                    <strong>Primary care:</strong> ICC = 0.01 - 0.05
                </p>
            </div>

            <div class="icc-presets">
                <div class="icc-preset active" data-icc="0.10" data-setting="school" onclick="selectSettingICC(this)">
                    <div class="icc-preset-value">&#127979; School</div>
                    <div class="icc-preset-label">ICC = 0.10</div>
                </div>
                <div class="icc-preset" data-icc="0.05" data-setting="hospital" onclick="selectSettingICC(this)">
                    <div class="icc-preset-value">&#127973; Hospital</div>
                    <div class="icc-preset-label">ICC = 0.05</div>
                </div>
                <div class="icc-preset" data-icc="0.03" data-setting="clinic" onclick="selectSettingICC(this)">
                    <div class="icc-preset-value">&#128137; Clinic</div>
                    <div class="icc-preset-label">ICC = 0.03</div>
                </div>
                <div class="icc-preset" data-icc="0.02" data-setting="community" onclick="selectSettingICC(this)">
                    <div class="icc-preset-value">&#127968; Community</div>
                    <div class="icc-preset-label">ICC = 0.02</div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Individual Sample Size (from power calculation)</label>
                    <input type="number" id="sh_n_ind" value="300" min="10" step="1">
                </div>
                <div class="input-group">
                    <label>Average Students/Patients per Site</label>
                    <input type="number" id="sh_m" value="30" min="5" step="1">
                </div>
                <div class="input-group">
                    <label>ICC</label>
                    <input type="number" id="sh_icc" value="0.10" min="0" max="1" step="0.01">
                </div>
                <div class="input-group">
                    <label>Target Power</label>
                    <select id="sh_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateSchoolHospital(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results">
            <div class="results-header">
                <h3>Calculation Results</h3>
                <div class="export-controls">
                    <select id="pdfTheme" class="pdf-theme-select">
                        <option value="light">Light PDF Theme</option>
                        <option value="dark">Dark PDF Theme</option>
                    </select>
                    <button class="export-btn" onclick="exportToPDF()">
                        <span>&#128196;</span> Export Comprehensive PDF
                    </button>
                </div>
            </div>

            <div class="result-main">
                <div class="result-value" id="mainValue">--</div>
                <div class="result-label" id="mainLabel">Result</div>
                <div class="result-sub" id="mainSub"></div>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <div class="chart-container">
                <h4>Design Effect vs. Cluster Size</h4>
                <div class="chart-wrapper">
                    <canvas id="deffChart"></canvas>
                </div>
            </div>

            <div class="info-box" id="interpretationBox">
                <h4>Interpretation</h4>
                <p id="interpretationText"></p>
            </div>

            <div class="info-box" id="iccBox">
                <h4>ICC Considerations & Recommendations</h4>
                <p id="iccText"></p>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-love">Made with &#10084; by Karmayogi</div>
            <div class="footer-blessing">&#128591; Jai Shri Ram &#128591;</div>
        </footer>
    </div>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        let deffChart = null;

        // Global calculation storage for PDF export
        let globalCalculation = {
            designType: '',
            designName: '',
            inputs: {},
            formula: '',
            formulaDescription: '',
            steps: [],
            results: {},
            mainResult: { value: 0, label: '' },
            interpretation: '',
            iccConsiderations: '',
            timestamp: ''
        };

        function selectCalc(calcType) {
            document.querySelectorAll('.calc-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-calc="${calcType}"]`).classList.add('active');
            document.querySelectorAll('.calculator-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${calcType}-calc`).classList.add('active');
            document.getElementById('results').classList.remove('active');
        }

        function selectICC(el, calcType) {
            const container = el.parentElement;
            container.querySelectorAll('.icc-preset').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            const icc = el.dataset.icc;
            document.getElementById(`${calcType}_icc`).value = icc;
        }

        function selectSettingICC(el) {
            document.querySelectorAll('#school-hospital-calc .icc-preset').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('sh_icc').value = el.dataset.icc;
        }

        function calculateCRT() {
            const nInd = parseFloat(document.getElementById('crt_n_ind').value);
            const m = parseFloat(document.getElementById('crt_m').value);
            const icc = parseFloat(document.getElementById('crt_icc').value);
            const cv = parseFloat(document.getElementById('crt_cv').value);

            // Basic design effect
            let deff = 1 + (m - 1) * icc;
            let deffBase = deff;

            // Adjustment for variable cluster sizes
            if (cv > 0) {
                deff = deff * (1 + cv * cv);
            }

            const nTotal = Math.ceil(nInd * deff);
            const nClusters = Math.ceil(nTotal / m);
            const effectiveN = nTotal / deff;

            // Store in global calculation
            globalCalculation = {
                designType: 'crt',
                designName: 'Cluster Randomized Trial (CRT)',
                inputs: {
                    'Individual Sample Size (n_standard)': nInd,
                    'Cluster Size (m)': m,
                    'Intraclass Correlation (ICC)': icc,
                    'Coefficient of Variation (CV)': cv
                },
                formula: 'DEFF = 1 + (m - 1) x ICC\nn_total = n_standard x DEFF',
                formulaDescription: 'The Design Effect (DEFF) quantifies how clustering increases variance compared to simple random sampling. It represents the factor by which sample size must be inflated.',
                steps: [
                    `Step 1: Calculate base Design Effect\nDEFF = 1 + (m - 1) x ICC\nDEFF = 1 + (${m} - 1) x ${icc}\nDEFF = 1 + ${m - 1} x ${icc}\nDEFF = 1 + ${((m - 1) * icc).toFixed(4)}\nDEFF = ${deffBase.toFixed(4)}`,
                    cv > 0 ? `Step 2: Adjust for variable cluster sizes\nDEFF_adjusted = DEFF x (1 + CV^2)\nDEFF_adjusted = ${deffBase.toFixed(4)} x (1 + ${cv}^2)\nDEFF_adjusted = ${deffBase.toFixed(4)} x ${(1 + cv * cv).toFixed(4)}\nDEFF_adjusted = ${deff.toFixed(4)}` : null,
                    `Step ${cv > 0 ? 3 : 2}: Calculate total sample size\nn_total = n_standard x DEFF\nn_total = ${nInd} x ${deff.toFixed(4)}\nn_total = ${(nInd * deff).toFixed(2)}\nn_total = ${nTotal} (rounded up)`,
                    `Step ${cv > 0 ? 4 : 3}: Calculate number of clusters\nNumber of clusters = n_total / m\nNumber of clusters = ${nTotal} / ${m}\nNumber of clusters = ${(nTotal / m).toFixed(2)}\nNumber of clusters = ${nClusters} (rounded up)`,
                    `Step ${cv > 0 ? 5 : 4}: Calculate effective sample size\nEffective N = n_total / DEFF\nEffective N = ${nTotal} / ${deff.toFixed(4)}\nEffective N = ${effectiveN.toFixed(2)}`
                ].filter(Boolean),
                results: {
                    'Design Effect (DEFF)': deff.toFixed(3),
                    'Individual N (standard)': nInd,
                    'Cluster Size (m)': m,
                    'ICC': icc.toFixed(3),
                    'Number of Clusters': nClusters,
                    'Clusters per Arm': Math.ceil(nClusters / 2),
                    'Effective Sample Size': Math.round(effectiveN),
                    'Inflation Factor': deff.toFixed(2) + 'x'
                },
                mainResult: { value: nTotal, label: 'Total Sample Size Needed' },
                timestamp: new Date().toLocaleString()
            };

            // Generate interpretation
            const deffNum = deff;
            let interpretation = '';
            if (deffNum < 1.5) {
                interpretation = `The design effect of ${deffNum.toFixed(2)} indicates relatively low clustering impact. The ICC of ${icc} is small enough that clustering has a modest effect on sample size requirements. You need approximately ${deffNum.toFixed(1)}x more participants than a simple randomized design.`;
            } else if (deffNum < 2.5) {
                interpretation = `The design effect of ${deffNum.toFixed(2)} indicates moderate clustering impact. You need ${deffNum.toFixed(1)} times more participants than a simple randomized design. With ${nClusters} clusters of ${m} individuals each, you achieve adequate statistical power while accounting for within-cluster correlation.`;
            } else {
                interpretation = `The design effect of ${deffNum.toFixed(2)} indicates substantial clustering impact. Consider reducing cluster size or using more clusters. The effective sample size is only ${((100/deffNum)).toFixed(0)}% of the total. This significant inflation may impact study feasibility and budget.`;
            }
            globalCalculation.interpretation = interpretation;

            // ICC Considerations
            let iccText = '';
            if (icc < 0.02) {
                iccText = `With ICC = ${icc}, clustering has minimal impact. This is typical for community-based studies or large healthcare systems. Consider if clustering adjustment is necessary, but it's prudent to include for conservative estimates.`;
            } else if (icc < 0.05) {
                iccText = `ICC = ${icc} is in the low-to-moderate range, typical for hospital or primary care settings. The design effect is manageable. Consider pilot data or published ICC values from similar studies for validation.`;
            } else if (icc < 0.10) {
                iccText = `ICC = ${icc} is moderate, often seen in school-based academic interventions or clinic-level healthcare studies. This level requires careful attention to cluster-level power and may benefit from stratified randomization.`;
            } else {
                iccText = `ICC = ${icc} is high, typical for behavioral outcomes in schools or organizational interventions. Consider increasing the number of clusters rather than cluster size. The number of clusters is often more important than total sample size for achieving adequate power.`;
            }
            iccText += `\n\nRecommendation: When possible, use ICC estimates from pilot studies or published meta-analyses of similar interventions (Hayes & Moulton 2017). Consider sensitivity analyses with ICC values +/- 50% of your estimate.`;
            globalCalculation.iccConsiderations = iccText;

            displayResults(nTotal, 'Total Sample Size Needed', globalCalculation.results, { m, icc, nInd });
        }

        function calculateSteppedWedge() {
            const t = parseFloat(document.getElementById('sw_t').value);
            const clustersPerStep = parseFloat(document.getElementById('sw_clusters').value);
            const m = parseFloat(document.getElementById('sw_m').value);
            const icc = parseFloat(document.getElementById('sw_icc').value);
            const r = parseFloat(document.getElementById('sw_r').value);
            const d = parseFloat(document.getElementById('sw_d').value);

            const totalClusters = clustersPerStep * t;
            const totalN = totalClusters * m * t;

            // Stepped wedge design effect (simplified)
            const clusterDeff = 1 + (m - 1) * icc;
            const timeDeff = 3 * (1 - r * r) / (2 * t * (t - 1 / (t + 1)));
            const deff = clusterDeff * timeDeff;

            const effectiveN = totalN / deff;

            // Power approximation
            const se = Math.sqrt(2 * deff / totalN);
            const z = d / se;
            const power = normalCDF(z - 1.96);

            // Store in global calculation
            globalCalculation = {
                designType: 'stepped-wedge',
                designName: 'Stepped Wedge Design',
                inputs: {
                    'Number of Steps (t)': t,
                    'Clusters per Step': clustersPerStep,
                    'Individuals per Cluster per Period (m)': m,
                    'ICC': icc,
                    'Within-Cluster Time Correlation (r)': r,
                    'Expected Effect Size (d)': d
                },
                formula: 'DEFF_cluster = 1 + (m - 1) x ICC\nDEFF_time = 3(1 - r^2) / (2t(t - 1/(t+1)))\nDEFF_total = DEFF_cluster x DEFF_time',
                formulaDescription: 'The stepped wedge design effect combines cluster-level correlation with temporal correlation across measurement periods. The time component accounts for the sequential crossover structure.',
                steps: [
                    `Step 1: Calculate total clusters\nTotal clusters = Clusters per step x Number of steps\nTotal clusters = ${clustersPerStep} x ${t}\nTotal clusters = ${totalClusters}`,
                    `Step 2: Calculate total observations\nTotal N = Total clusters x m x t\nTotal N = ${totalClusters} x ${m} x ${t}\nTotal N = ${totalN}`,
                    `Step 3: Calculate cluster design effect\nDEFF_cluster = 1 + (m - 1) x ICC\nDEFF_cluster = 1 + (${m} - 1) x ${icc}\nDEFF_cluster = ${clusterDeff.toFixed(4)}`,
                    `Step 4: Calculate time design effect\nDEFF_time = 3(1 - r^2) / (2t(t - 1/(t+1)))\nDEFF_time = 3(1 - ${r}^2) / (2 x ${t} x (${t} - 1/${t + 1}))\nDEFF_time = 3 x ${(1 - r * r).toFixed(4)} / (${2 * t} x ${(t - 1/(t+1)).toFixed(4)})\nDEFF_time = ${timeDeff.toFixed(4)}`,
                    `Step 5: Calculate combined design effect\nDEFF_total = DEFF_cluster x DEFF_time\nDEFF_total = ${clusterDeff.toFixed(4)} x ${timeDeff.toFixed(4)}\nDEFF_total = ${deff.toFixed(4)}`,
                    `Step 6: Calculate effective sample size\nEffective N = Total N / DEFF_total\nEffective N = ${totalN} / ${deff.toFixed(4)}\nEffective N = ${effectiveN.toFixed(2)}`,
                    `Step 7: Approximate power calculation\nSE = sqrt(2 x DEFF / Total N) = ${se.toFixed(4)}\nZ = d / SE = ${d} / ${se.toFixed(4)} = ${z.toFixed(4)}\nPower = ${(power * 100).toFixed(1)}%`
                ],
                results: {
                    'Clusters per Step': clustersPerStep,
                    'Number of Steps': t,
                    'Individuals per Cluster per Period': m,
                    'Total Observations': totalN,
                    'Cluster Design Effect': clusterDeff.toFixed(3),
                    'Time Design Effect': timeDeff.toFixed(3),
                    'Combined DEFF': deff.toFixed(3),
                    'Effective Sample Size': Math.round(effectiveN),
                    'Approximate Power': (power * 100).toFixed(1) + '%'
                },
                mainResult: { value: totalClusters, label: 'Total Clusters Needed' },
                timestamp: new Date().toLocaleString()
            };

            // Generate interpretation
            let interpretation = `This stepped wedge design requires ${totalClusters} clusters crossing over sequentially across ${t} time periods. `;
            interpretation += `With ${m} individuals per cluster per period, you will collect ${totalN} total observations. `;
            interpretation += `The combined design effect of ${deff.toFixed(2)} accounts for both within-cluster correlation (DEFF=${clusterDeff.toFixed(2)}) and temporal correlation (DEFF=${timeDeff.toFixed(2)}). `;
            if (power >= 0.80) {
                interpretation += `The estimated power of ${(power * 100).toFixed(1)}% meets the conventional threshold for adequate statistical power.`;
            } else {
                interpretation += `The estimated power of ${(power * 100).toFixed(1)}% is below 80%. Consider increasing clusters, cluster size, or the number of time periods.`;
            }
            globalCalculation.interpretation = interpretation;

            // ICC Considerations
            let iccText = `In stepped wedge designs, both ICC and temporal correlation (r) affect power. `;
            iccText += `Your ICC of ${icc} produces a cluster DEFF of ${clusterDeff.toFixed(2)}, while the temporal correlation of ${r} contributes to the time DEFF of ${timeDeff.toFixed(2)}. `;
            iccText += `\n\nKey considerations:\n`;
            iccText += `- Higher r (temporal stability) generally improves efficiency\n`;
            iccText += `- The number of steps affects statistical efficiency\n`;
            iccText += `- Consider secular trends that may confound treatment effects\n`;
            iccText += `\nRecommendation: Stepped wedge designs benefit from careful planning of measurement periods and robust analysis methods (Hussey & Hughes 2007, Hemming et al. 2015).`;
            globalCalculation.iccConsiderations = iccText;

            displayResults(totalClusters, 'Total Clusters Needed', globalCalculation.results, { m, icc });
        }

        function calculateMultilevel() {
            const k = parseFloat(document.getElementById('ml_k').value);
            const m = parseFloat(document.getElementById('ml_m').value);
            const t = parseFloat(document.getElementById('ml_t').value);
            const iccCluster = parseFloat(document.getElementById('ml_icc_cluster').value);
            const iccInd = parseFloat(document.getElementById('ml_icc_ind').value);
            const d = parseFloat(document.getElementById('ml_d').value);

            // Design effects at each level
            const deffCluster = 1 + (m - 1) * iccCluster;
            const deffTime = 1 + (t - 1) * iccInd;

            const totalN = k * m * t;
            const effectiveN = totalN / (deffCluster * deffTime);

            // Variance partitioning
            const varCluster = iccCluster;
            const varInd = (1 - iccCluster) * iccInd;
            const varResidual = (1 - iccCluster) * (1 - iccInd);

            // Store in global calculation
            globalCalculation = {
                designType: 'multilevel',
                designName: 'Multi-level Longitudinal Design',
                inputs: {
                    'Number of Clusters (k)': k,
                    'Individuals per Cluster (m)': m,
                    'Time Points per Individual (t)': t,
                    'ICC (Cluster Level)': iccCluster,
                    'ICC (Individual Level)': iccInd,
                    'Expected Effect Size (d)': d
                },
                formula: 'DEFF_cluster = 1 + (m - 1) x ICC_cluster\nDEFF_time = 1 + (t - 1) x ICC_individual\nn_effective = n_total / (DEFF_cluster x DEFF_time)',
                formulaDescription: 'Three-level hierarchical design with measurements (Level 1) nested within individuals (Level 2) nested within clusters (Level 3). Each level contributes to variance partitioning.',
                steps: [
                    `Step 1: Calculate total observations\nTotal N = k x m x t\nTotal N = ${k} x ${m} x ${t}\nTotal N = ${totalN}`,
                    `Step 2: Calculate cluster-level design effect\nDEFF_cluster = 1 + (m - 1) x ICC_cluster\nDEFF_cluster = 1 + (${m} - 1) x ${iccCluster}\nDEFF_cluster = 1 + ${m - 1} x ${iccCluster}\nDEFF_cluster = ${deffCluster.toFixed(4)}`,
                    `Step 3: Calculate time-level design effect\nDEFF_time = 1 + (t - 1) x ICC_individual\nDEFF_time = 1 + (${t} - 1) x ${iccInd}\nDEFF_time = 1 + ${t - 1} x ${iccInd}\nDEFF_time = ${deffTime.toFixed(4)}`,
                    `Step 4: Calculate effective sample size\nEffective N = Total N / (DEFF_cluster x DEFF_time)\nEffective N = ${totalN} / (${deffCluster.toFixed(4)} x ${deffTime.toFixed(4)})\nEffective N = ${totalN} / ${(deffCluster * deffTime).toFixed(4)}\nEffective N = ${effectiveN.toFixed(2)}`,
                    `Step 5: Variance partitioning\nCluster variance = ICC_cluster = ${(varCluster * 100).toFixed(1)}%\nIndividual variance = (1 - ICC_cluster) x ICC_ind = ${(varInd * 100).toFixed(1)}%\nResidual variance = (1 - ICC_cluster) x (1 - ICC_ind) = ${(varResidual * 100).toFixed(1)}%`
                ],
                results: {
                    'Number of Clusters': k,
                    'Individuals per Cluster': m,
                    'Time Points': t,
                    'Total Observations': totalN,
                    'Cluster DEFF': deffCluster.toFixed(3),
                    'Time DEFF': deffTime.toFixed(3),
                    'Effective Sample Size': Math.round(effectiveN),
                    'Variance - Cluster Level': (varCluster * 100).toFixed(1) + '%',
                    'Variance - Individual Level': (varInd * 100).toFixed(1) + '%',
                    'Variance - Residual': (varResidual * 100).toFixed(1) + '%'
                },
                mainResult: { value: k * m, label: 'Total Individuals Needed' },
                timestamp: new Date().toLocaleString()
            };

            // Generate interpretation
            let interpretation = `This three-level design includes ${k} clusters, ${m} individuals per cluster, and ${t} repeated measurements per individual, yielding ${totalN} total observations. `;
            interpretation += `Variance is partitioned as: ${(varCluster * 100).toFixed(1)}% between clusters, ${(varInd * 100).toFixed(1)}% between individuals within clusters, and ${(varResidual * 100).toFixed(1)}% within individuals over time. `;
            interpretation += `The combined design effects reduce effective sample size from ${totalN} to ${Math.round(effectiveN)} observations.`;
            globalCalculation.interpretation = interpretation;

            // ICC Considerations
            let iccText = `In multi-level longitudinal designs, two ICC values capture different sources of correlation:\n\n`;
            iccText += `1. Cluster-level ICC (${iccCluster}): Measures similarity of individuals within the same cluster. `;
            if (iccCluster > 0.10) {
                iccText += `This high value suggests strong cluster effects - consider cluster-level interventions or stratification.\n`;
            } else {
                iccText += `This moderate/low value indicates manageable cluster effects.\n`;
            }
            iccText += `\n2. Individual-level ICC (${iccInd}): Measures stability of repeated measures within individuals. `;
            if (iccInd > 0.50) {
                iccText += `High within-person correlation means fewer time points may be needed.\n`;
            } else {
                iccText += `Lower values suggest more measurement occasions may improve precision.\n`;
            }
            iccText += `\nRecommendation: Use multilevel modeling (MLM/HLM) for analysis to properly account for the hierarchical structure. Consider random slopes if treatment effects may vary across clusters (Raudenbush & Bryk 2002).`;
            globalCalculation.iccConsiderations = iccText;

            displayResults(k * m, 'Total Individuals Needed', globalCalculation.results, { m, icc: iccCluster });
        }

        function calculateSchoolHospital() {
            const nInd = parseFloat(document.getElementById('sh_n_ind').value);
            const m = parseFloat(document.getElementById('sh_m').value);
            const icc = parseFloat(document.getElementById('sh_icc').value);
            const power = parseFloat(document.getElementById('sh_power').value);

            const deff = 1 + (m - 1) * icc;
            const nTotal = Math.ceil(nInd * deff);
            const nSites = Math.ceil(nTotal / m);

            // Adjust for power if not 80%
            let powerMultiplier = 1;
            let powerLabel = '80%';
            if (power === 0.90) { powerMultiplier = 1.21; powerLabel = '90%'; }
            else if (power === 0.95) { powerMultiplier = 1.46; powerLabel = '95%'; }

            const adjustedN = Math.ceil(nTotal * powerMultiplier);
            const adjustedSites = Math.ceil(adjustedN / m);

            // Store in global calculation
            globalCalculation = {
                designType: 'school-hospital',
                designName: 'School/Hospital Based Study',
                inputs: {
                    'Individual Sample Size (from power calc)': nInd,
                    'Average per Site (m)': m,
                    'ICC': icc,
                    'Target Power': powerLabel
                },
                formula: 'DEFF = 1 + (m - 1) x ICC\nn_total = n_standard x DEFF x power_multiplier',
                formulaDescription: 'Sample size is inflated by the design effect to account for clustering within sites (schools, hospitals, clinics), with additional adjustment for power levels above 80%.',
                steps: [
                    `Step 1: Calculate Design Effect\nDEFF = 1 + (m - 1) x ICC\nDEFF = 1 + (${m} - 1) x ${icc}\nDEFF = 1 + ${m - 1} x ${icc}\nDEFF = ${deff.toFixed(4)}`,
                    `Step 2: Calculate base clustered sample size\nn_clustered = n_standard x DEFF\nn_clustered = ${nInd} x ${deff.toFixed(4)}\nn_clustered = ${nTotal}`,
                    `Step 3: Calculate number of sites (base)\nNumber of sites = n_clustered / m\nNumber of sites = ${nTotal} / ${m}\nNumber of sites = ${nSites}`,
                    power !== 0.80 ? `Step 4: Adjust for ${powerLabel} power\nPower multiplier for ${powerLabel} = ${powerMultiplier}\nn_adjusted = ${nTotal} x ${powerMultiplier}\nn_adjusted = ${adjustedN}` : null,
                    power !== 0.80 ? `Step 5: Recalculate sites needed\nSites needed = ${adjustedN} / ${m}\nSites needed = ${adjustedSites}` : null,
                    `Final: Effective sample size\nEffective N = n_total / DEFF\nEffective N = ${adjustedN} / ${deff.toFixed(4)}\nEffective N = ${Math.round(adjustedN / deff)}`
                ].filter(Boolean),
                results: {
                    'Design Effect': deff.toFixed(3),
                    'Base Individual N': nInd,
                    'Average per Site': m,
                    'ICC': icc.toFixed(3),
                    'Number of Sites': adjustedSites,
                    'Sites per Arm': Math.ceil(adjustedSites / 2),
                    'Target Power': powerLabel,
                    'Effective Sample Size': Math.round(adjustedN / deff)
                },
                mainResult: { value: adjustedN, label: 'Total Participants Needed' },
                timestamp: new Date().toLocaleString()
            };

            // Generate interpretation
            let interpretation = `For a school/hospital study with ${powerLabel} power, you need ${adjustedN} total participants across ${adjustedSites} sites (${Math.ceil(adjustedSites / 2)} per arm). `;
            interpretation += `The design effect of ${deff.toFixed(2)} means you need ${deff.toFixed(1)}x more participants than a simple randomized design. `;
            interpretation += `With an average of ${m} participants per site and ICC of ${icc}, the effective sample size is ${Math.round(adjustedN / deff)}.`;
            if (adjustedSites < 10) {
                interpretation += ` Note: Having fewer than 10 sites per arm may limit power at the cluster level.`;
            }
            globalCalculation.interpretation = interpretation;

            // ICC Considerations based on setting
            let settingType = 'general';
            const activePreset = document.querySelector('#school-hospital-calc .icc-preset.active');
            if (activePreset) {
                settingType = activePreset.dataset.setting || 'general';
            }

            let iccText = '';
            if (settingType === 'school') {
                iccText = `School-based studies typically show ICCs of 0.05-0.20 for academic outcomes and 0.10-0.25 for behavioral outcomes. `;
                iccText += `Your ICC of ${icc} is ${icc < 0.10 ? 'on the lower end' : icc < 0.15 ? 'moderate' : 'on the higher end'} for this setting. `;
                iccText += `\n\nConsiderations for school studies:\n`;
                iccText += `- School-level randomization is often necessary for implementation\n`;
                iccText += `- Consider classroom-level clustering if relevant\n`;
                iccText += `- Academic outcomes tend to have lower ICC than behavioral/social outcomes`;
            } else if (settingType === 'hospital') {
                iccText = `Hospital-based studies typically show ICCs of 0.01-0.10 for clinical outcomes. `;
                iccText += `Your ICC of ${icc} is ${icc < 0.03 ? 'low' : icc < 0.07 ? 'moderate' : 'relatively high'} for this setting. `;
                iccText += `\n\nConsiderations for hospital studies:\n`;
                iccText += `- Provider-level clustering may be important\n`;
                iccText += `- Consider patient case-mix differences between hospitals\n`;
                iccText += `- Clinical outcomes often have lower ICC than process measures`;
            } else if (settingType === 'clinic') {
                iccText = `Clinic-based studies in primary care typically show ICCs of 0.01-0.05. `;
                iccText += `Your ICC of ${icc} is ${icc < 0.02 ? 'low' : icc < 0.04 ? 'moderate' : 'higher than typical'} for this setting. `;
                iccText += `\n\nConsiderations for clinic studies:\n`;
                iccText += `- Provider and practice-level effects both contribute\n`;
                iccText += `- Patient panels within practices are often similar\n`;
                iccText += `- Consider provider-level randomization if feasible`;
            } else {
                iccText = `Community-based studies typically show lower ICCs (0.01-0.03) due to heterogeneity within communities. `;
                iccText += `Your ICC of ${icc} is ${icc < 0.02 ? 'typical' : 'higher than expected'} for this setting. `;
                iccText += `\n\nConsiderations for community studies:\n`;
                iccText += `- Geographic clustering may be important\n`;
                iccText += `- Consider contamination between intervention and control\n`;
                iccText += `- Social network effects may increase true ICC`;
            }
            iccText += `\n\nRecommendation: Consult published ICC databases and meta-analyses (Campbell et al. 2001, Adams et al. 2004) for evidence-based ICC estimates in your specific outcome domain.`;
            globalCalculation.iccConsiderations = iccText;

            displayResults(adjustedN, 'Total Participants Needed', globalCalculation.results, { m, icc, nInd });
        }

        function normalCDF(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
            const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            const t = 1 / (1 + p * x);
            const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1) * t * Math.exp(-x*x);
            return 0.5 * (1 + sign * y);
        }

        function displayResults(mainValue, mainLabel, details, params) {
            document.getElementById('results').classList.add('active');
            document.getElementById('mainValue').textContent = mainValue;
            document.getElementById('mainLabel').textContent = mainLabel;

            const deff = details['Design Effect'] || details['Combined DEFF'] || details['Cluster DEFF'];
            document.getElementById('mainSub').textContent = `Design Effect = ${deff}`;

            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            for (const [key, val] of Object.entries(details)) {
                grid.innerHTML += `
                    <div class="result-card">
                        <div class="result-card-label">${key}</div>
                        <div class="result-card-value">${val}</div>
                    </div>
                `;
            }

            // Interpretation
            document.getElementById('interpretationText').textContent = globalCalculation.interpretation;

            // ICC Considerations
            document.getElementById('iccText').textContent = globalCalculation.iccConsiderations;

            // Draw chart
            drawDeffChart(params.m, params.icc);

            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function drawDeffChart(currentM, currentICC) {
            const ctx = document.getElementById('deffChart').getContext('2d');

            if (deffChart) deffChart.destroy();

            const labels = [];
            const data1 = []; // Current ICC
            const data2 = []; // ICC = 0.05
            const data3 = []; // ICC = 0.15

            for (let m = 5; m <= 100; m += 5) {
                labels.push(m);
                data1.push((1 + (m - 1) * currentICC).toFixed(2));
                data2.push((1 + (m - 1) * 0.05).toFixed(2));
                data3.push((1 + (m - 1) * 0.15).toFixed(2));
            }

            deffChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `ICC = ${currentICC} (Your value)`,
                            data: data1,
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            fill: false
                        },
                        {
                            label: 'ICC = 0.05 (Low)',
                            data: data2,
                            borderColor: '#10B981',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'ICC = 0.15 (High)',
                            data: data3,
                            borderColor: '#EF4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Cluster Size (m)' } },
                        y: { title: { display: true, text: 'Design Effect (DEFF)' }, min: 1 }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                point1: {
                                    type: 'point',
                                    xValue: currentM,
                                    yValue: 1 + (currentM - 1) * currentICC,
                                    backgroundColor: '#F59E0B',
                                    radius: 8
                                }
                            }
                        }
                    }
                }
            });
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('karmastat-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                document.getElementById('themeIcon').innerHTML = saved === 'dark' ? '&#9728;' : '&#9790;';
            }
        });

        function exportToPDF() {
            if (!globalCalculation.designName) {
                alert('Please perform a calculation first before exporting.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pdfTheme = document.getElementById('pdfTheme').value;

            // Theme colors
            const colors = pdfTheme === 'dark' ? {
                bg: [41, 37, 36],
                headerBg: [245, 158, 11],
                text: [243, 244, 246],
                textSecondary: [156, 163, 175],
                accent: [245, 158, 11],
                cardBg: [68, 64, 60],
                border: [87, 83, 78]
            } : {
                bg: [255, 255, 255],
                headerBg: [245, 158, 11],
                text: [31, 41, 55],
                textSecondary: [75, 85, 99],
                accent: [245, 158, 11],
                cardBg: [255, 251, 235],
                border: [229, 231, 235]
            };

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;
            let yPos = 0;

            // Helper function to add new page if needed
            function checkNewPage(neededSpace) {
                if (yPos + neededSpace > pageHeight - 30) {
                    doc.addPage();
                    if (pdfTheme === 'dark') {
                        doc.setFillColor(...colors.bg);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    yPos = 20;
                    return true;
                }
                return false;
            }

            // Background for dark theme
            if (pdfTheme === 'dark') {
                doc.setFillColor(...colors.bg);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
            }

            // Header with gradient effect
            doc.setFillColor(...colors.headerBg);
            doc.rect(0, 0, pageWidth, 45, 'F');

            // Logo circle
            doc.setFillColor(255, 255, 255);
            doc.circle(25, 22, 10, 'F');
            doc.setTextColor(...colors.headerBg);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('K', 22, 26);

            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('KARMASTAT', 40, 20);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Cluster & Multi-level Sample Size Calculator', 40, 28);

            // Design type badge
            doc.setFontSize(10);
            doc.setFillColor(255, 255, 255, 0.2);
            const designBadge = globalCalculation.designName;
            doc.text(designBadge, 40, 38);

            yPos = 55;

            // Section: Study Design
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, 20, 3, 3, 'F');
            doc.setDrawColor(...colors.accent);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, margin, yPos + 20);

            doc.setTextColor(...colors.accent);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Study Design', margin + 5, yPos + 8);

            doc.setTextColor(...colors.text);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(globalCalculation.designName, margin + 5, yPos + 16);

            yPos += 28;

            // Section: Input Parameters
            doc.setFillColor(...colors.cardBg);
            const inputKeys = Object.keys(globalCalculation.inputs);
            const inputBoxHeight = 12 + inputKeys.length * 7;
            doc.roundedRect(margin, yPos, contentWidth, inputBoxHeight, 3, 3, 'F');
            doc.setDrawColor(...colors.accent);
            doc.line(margin, yPos, margin, yPos + inputBoxHeight);

            doc.setTextColor(...colors.accent);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Input Parameters', margin + 5, yPos + 8);

            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            let inputY = yPos + 16;
            for (const [key, val] of Object.entries(globalCalculation.inputs)) {
                doc.setFont('helvetica', 'normal');
                doc.text(`${key}:`, margin + 5, inputY);
                doc.setFont('helvetica', 'bold');
                doc.text(`${val}`, margin + 90, inputY);
                inputY += 7;
            }

            yPos += inputBoxHeight + 8;

            // Section: Formula Used
            checkNewPage(50);
            doc.setFillColor(...colors.headerBg);
            doc.roundedRect(margin, yPos, contentWidth, 35, 3, 3, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Formula Used', margin + 5, yPos + 8);

            doc.setFontSize(10);
            doc.setFont('courier', 'normal');
            const formulaLines = globalCalculation.formula.split('\n');
            let formulaY = yPos + 16;
            formulaLines.forEach(line => {
                doc.text(line, margin + 5, formulaY);
                formulaY += 6;
            });

            yPos += 43;

            // Formula description
            doc.setTextColor(...colors.textSecondary);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            const descLines = doc.splitTextToSize(globalCalculation.formulaDescription, contentWidth - 10);
            doc.text(descLines, margin + 5, yPos);
            yPos += descLines.length * 5 + 8;

            // Section: Step-by-Step Calculation
            checkNewPage(60);
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, 12, 3, 3, 'F');
            doc.setDrawColor(...colors.accent);
            doc.line(margin, yPos, margin, yPos + 12);

            doc.setTextColor(...colors.accent);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Step-by-Step Calculation', margin + 5, yPos + 8);
            yPos += 18;

            doc.setTextColor(...colors.text);
            doc.setFontSize(9);
            doc.setFont('courier', 'normal');

            globalCalculation.steps.forEach((step, index) => {
                const stepLines = step.split('\n');
                const stepHeight = stepLines.length * 5 + 8;

                checkNewPage(stepHeight + 5);

                // Step background
                doc.setFillColor(pdfTheme === 'dark' ? 55 : 250, pdfTheme === 'dark' ? 51 : 250, pdfTheme === 'dark' ? 48 : 250);
                doc.roundedRect(margin + 2, yPos, contentWidth - 4, stepHeight, 2, 2, 'F');

                let stepY = yPos + 6;
                stepLines.forEach(line => {
                    if (line.startsWith('Step')) {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...colors.accent);
                    } else {
                        doc.setFont('courier', 'normal');
                        doc.setTextColor(...colors.text);
                    }
                    doc.text(line, margin + 6, stepY);
                    stepY += 5;
                });

                yPos += stepHeight + 4;
            });

            yPos += 5;

            // Section: Final Results
            checkNewPage(60);
            doc.setFillColor(...colors.headerBg);
            doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('FINAL RESULTS', margin + 5, yPos + 10);

            // Main result
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text(String(globalCalculation.mainResult.value), pageWidth / 2, yPos + 28, { align: 'center' });

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(globalCalculation.mainResult.label, pageWidth / 2, yPos + 38, { align: 'center' });

            yPos += 58;

            // Results grid
            checkNewPage(50);
            const resultKeys = Object.keys(globalCalculation.results);
            const cols = 2;
            const rows = Math.ceil(resultKeys.length / cols);
            const cellWidth = (contentWidth - 5) / cols;
            const cellHeight = 14;
            const gridHeight = rows * cellHeight + 5;

            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, gridHeight, 3, 3, 'F');

            let gridY = yPos + 8;
            resultKeys.forEach((key, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                const x = margin + 5 + col * cellWidth;
                const y = yPos + 8 + row * cellHeight;

                doc.setTextColor(...colors.textSecondary);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(key, x, y);

                doc.setTextColor(...colors.accent);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(String(globalCalculation.results[key]), x, y + 6);
            });

            yPos += gridHeight + 10;

            // Section: Interpretation
            checkNewPage(40);
            doc.setFillColor(...colors.cardBg);
            const interpLines = doc.splitTextToSize(globalCalculation.interpretation, contentWidth - 15);
            const interpHeight = interpLines.length * 5 + 15;
            doc.roundedRect(margin, yPos, contentWidth, interpHeight, 3, 3, 'F');
            doc.setDrawColor(...colors.accent);
            doc.line(margin, yPos, margin, yPos + interpHeight);

            doc.setTextColor(...colors.accent);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Interpretation', margin + 5, yPos + 8);

            doc.setTextColor(...colors.text);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(interpLines, margin + 5, yPos + 16);

            yPos += interpHeight + 8;

            // Section: ICC Considerations
            checkNewPage(50);
            const iccLines = doc.splitTextToSize(globalCalculation.iccConsiderations, contentWidth - 15);
            const iccHeight = iccLines.length * 4.5 + 15;

            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, iccHeight, 3, 3, 'F');
            doc.setDrawColor(16, 185, 129); // Green accent
            doc.line(margin, yPos, margin, yPos + iccHeight);

            doc.setTextColor(16, 185, 129);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('ICC Considerations & Recommendations', margin + 5, yPos + 8);

            doc.setTextColor(...colors.text);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(iccLines, margin + 5, yPos + 16);

            yPos += iccHeight + 10;

            // Section: References
            checkNewPage(45);
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(margin, yPos, contentWidth, 40, 3, 3, 'F');
            doc.setDrawColor(59, 130, 246); // Blue accent
            doc.line(margin, yPos, margin, yPos + 40);

            doc.setTextColor(59, 130, 246);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('References', margin + 5, yPos + 8);

            doc.setTextColor(...colors.text);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            const references = [
                '1. Hayes RJ, Moulton LH (2017). Cluster Randomised Trials. 2nd ed. Chapman and Hall/CRC.',
                '2. Hemming K, Haines TP, Chilton PJ, et al. (2015). The stepped wedge cluster randomised trial:',
                '   rationale, design, analysis, and reporting. BMJ 350:h391.',
                '3. Campbell MK, Grimshaw JM, Elbourne DR (2004). Intracluster correlation coefficients in cluster',
                '   randomized trials. BMJ 328:702-708.',
                '4. Raudenbush SW, Bryk AS (2002). Hierarchical Linear Models. 2nd ed. Sage Publications.'
            ];
            let refY = yPos + 16;
            references.forEach(ref => {
                doc.text(ref, margin + 5, refY);
                refY += 5;
            });

            yPos += 48;

            // Footer
            checkNewPage(25);
            doc.setFillColor(...colors.headerBg);
            doc.rect(0, pageHeight - 25, pageWidth, 25, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Generated by KARMASTAT - Crafted by Karmayogi', pageWidth / 2, pageHeight - 16, { align: 'center' });

            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Report generated: ${globalCalculation.timestamp}`, pageWidth / 2, pageHeight - 9, { align: 'center' });

            // Add footer to all pages
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);

                // Only add footer if not already on last page content
                if (i < totalPages || yPos < pageHeight - 30) {
                    doc.setFillColor(...colors.headerBg);
                    doc.rect(0, pageHeight - 25, pageWidth, 25, 'F');

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Generated by KARMASTAT - Crafted by Karmayogi', pageWidth / 2, pageHeight - 16, { align: 'center' });

                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Report generated: ${globalCalculation.timestamp} | Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 9, { align: 'center' });
                }
            }

            // Save the PDF
            const filename = `KARMASTAT_${globalCalculation.designType}_analysis_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
