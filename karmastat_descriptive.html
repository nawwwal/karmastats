<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descriptive Studies Calculator - KARMASTAT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --primary-light: #34D399;
            --primary-lighter: #6EE7B7;
            --secondary: #065F46;
            --accent: #D1FAE5;
            --accent-light: #ECFDF5;
            --bg-gradient-start: #ECFDF5;
            --bg-gradient-mid: #D1FAE5;
            --bg-gradient-end: #A7F3D0;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-bg-solid: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --input-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #0f172a;
            --bg-gradient-mid: #1e293b;
            --bg-gradient-end: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-bg-solid: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --border-light: #1e293b;
            --accent: #064e3b;
            --accent-light: #022c22;
            --input-bg: #0f172a;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: -0.5px;
        }

        .header .subtitle {
            font-size: 1.15rem;
            opacity: 0.95;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        .header .brand {
            font-size: 0.9rem;
            margin-top: 1rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow);
        }

        .card-title {
            flex: 1;
        }

        .card-title h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .card-title p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Tabs */
        .tabs-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 180px;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: var(--accent-light);
            color: var(--primary);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group .required::after {
            content: ' *';
            color: #ef4444;
        }

        .input-wrapper {
            position: relative;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .form-group input:hover,
        .form-group select:hover {
            border-color: var(--primary-light);
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .help-text::before {
            content: 'i';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--border-color);
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* Button Styles */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 180px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--card-bg-solid);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--accent-light);
        }

        .btn-export {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        /* Results Section */
        .results {
            display: none;
            margin-top: 2rem;
            animation: slideIn 0.4s ease;
        }

        .results.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .results-header h3 {
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: linear-gradient(135deg, var(--accent-light), var(--accent));
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--primary-light);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .result-card.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
        }

        .result-card.primary .result-value,
        .result-card.primary .result-label {
            color: white;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-dark);
            line-height: 1.2;
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Formula Box */
        .formula-section {
            background: var(--card-bg-solid);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .formula-section h4 {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .formula-box {
            background: var(--accent-light);
            padding: 1.25rem;
            border-radius: 12px;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 1rem;
            line-height: 1.8;
            border-left: 4px solid var(--primary);
            overflow-x: auto;
        }

        .formula-main {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .formula-explanation {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Step by Step */
        .steps-section {
            margin-top: 1.5rem;
        }

        .steps-section h4 {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step {
            background: var(--card-bg-solid);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .step-calc {
            font-family: 'Courier New', monospace;
            color: var(--primary-dark);
            background: var(--accent-light);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        /* Interpretation Box */
        .interpretation-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        [data-theme="dark"] .interpretation-box {
            background: linear-gradient(135deg, #78350f, #92400e);
            border-color: #f59e0b;
        }

        .interpretation-box h4 {
            color: #92400e;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        [data-theme="dark"] .interpretation-box h4 {
            color: #fde68a;
        }

        .interpretation-box p {
            color: #78350f;
            line-height: 1.7;
        }

        [data-theme="dark"] .interpretation-box p {
            color: #fef3c7;
        }

        /* Export Card */
        .export-card {
            background: linear-gradient(135deg, var(--card-bg), var(--accent-light));
            border: 2px dashed var(--primary);
        }

        .export-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--card-bg-solid);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--border-light);
        }

        .theme-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .theme-option {
            padding: 1.5rem;
            border: 3px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .theme-option:hover {
            border-color: var(--primary-light);
        }

        .theme-option.selected {
            border-color: var(--primary);
            background: var(--accent-light);
        }

        .theme-option-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .theme-option-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2.5rem 2rem;
            color: var(--text-secondary);
            background: var(--card-bg);
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .footer-brand {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer-tagline {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            font-style: italic;
            color: var(--text-muted);
        }

        /* Hidden content class */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .tabs-container {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .result-value {
                font-size: 2rem;
            }

            .theme-options {
                grid-template-columns: 1fr;
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            background: var(--card-bg-solid);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            border-left: 4px solid var(--primary);
            z-index: 1001;
            animation: toastSlide 0.3s ease;
            display: none;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <h1>Descriptive Studies Calculator</h1>
            <p class="subtitle">Cross-sectional surveys, prevalence studies, and population parameter estimation with comprehensive statistical analysis</p>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <nav class="nav-buttons">
                <a href="index.html" class="nav-btn">Back to Main</a>
                <a href="karmastat_power_analysis.html" class="nav-btn">Power Analysis</a>
                <a href="karmastat_references.html" class="nav-btn">References</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Tab Navigation -->
        <div class="tabs-container">
            <button class="tab active" data-tab="prevalence">
                <span class="tab-icon">%</span>
                Prevalence Estimation
            </button>
            <button class="tab" data-tab="mean">
                <span class="tab-icon">x</span>
                Mean Estimation
            </button>
            <button class="tab" data-tab="finite">
                <span class="tab-icon">N</span>
                Finite Population
            </button>
        </div>

        <!-- Prevalence Estimation -->
        <section class="card tab-content" id="prevalence-content">
            <div class="card-header">
                <div class="card-icon">%</div>
                <div class="card-title">
                    <h2>Prevalence Estimation Sample Size</h2>
                    <p>Calculate sample size for estimating a population proportion with specified precision</p>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Expected Prevalence (P)</label>
                    <input type="number" id="prev-p" value="0.5" min="0.01" max="0.99" step="0.01">
                    <p class="help-text">Use 0.5 if unknown (most conservative estimate)</p>
                </div>
                <div class="form-group">
                    <label class="required">Precision / Margin of Error (d)</label>
                    <input type="number" id="prev-d" value="0.05" min="0.01" max="0.2" step="0.01">
                    <p class="help-text">Absolute precision (e.g., 0.05 = plus or minus 5%)</p>
                </div>
                <div class="form-group">
                    <label class="required">Confidence Level</label>
                    <select id="prev-conf">
                        <option value="1.96" data-level="95%">95% (Z = 1.96)</option>
                        <option value="2.576" data-level="99%">99% (Z = 2.576)</option>
                        <option value="1.645" data-level="90%">90% (Z = 1.645)</option>
                    </select>
                    <p class="help-text">Standard confidence level for interval estimation</p>
                </div>
                <div class="form-group">
                    <label>Design Effect (DEFF)</label>
                    <input type="number" id="prev-deff" value="1" min="1" max="5" step="0.1">
                    <p class="help-text">Use 1 for simple random sampling; higher for cluster sampling</p>
                </div>
                <div class="form-group">
                    <label>Expected Non-response Rate (%)</label>
                    <input type="number" id="prev-nr" value="10" min="0" max="50" step="1">
                    <p class="help-text">Percentage of participants expected not to respond</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculatePrevalence(this)">
                    <span class="btn-text">Calculate Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="btn btn-secondary" onclick="resetForm('prevalence')">
                    <span>Reset</span>
                </button>
            </div>

            <div class="results" id="prev-results">
                <div class="results-header">
                    <span style="font-size: 1.5rem;">*</span>
                    <h3>Calculation Results</h3>
                </div>

                <div class="result-grid">
                    <div class="result-card primary">
                        <div class="result-value" id="prev-n">-</div>
                        <div class="result-label">Required Sample Size</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="prev-n-adj">-</div>
                        <div class="result-label">Adjusted for Non-response</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="prev-ci">-</div>
                        <div class="result-label">Expected CI Width</div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>Formula Used</h4>
                    <div class="formula-box">
                        <div class="formula-main">n = (Z^2 x P x (1-P)) / d^2 x DEFF</div>
                        <div class="formula-explanation">
                            Where:<br>
                            Z = Z-score for the selected confidence level<br>
                            P = Expected prevalence (proportion)<br>
                            d = Desired precision (margin of error)<br>
                            DEFF = Design effect for complex sampling designs
                        </div>
                    </div>
                </div>

                <div class="steps-section" id="prev-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <!-- Steps will be populated by JavaScript -->
                </div>

                <div class="interpretation-box" id="prev-interpretation">
                    <h4>Interpretation</h4>
                    <p id="prev-interpretation-text">-</p>
                </div>
            </div>
        </section>

        <!-- Mean Estimation -->
        <section class="card tab-content hidden" id="mean-content">
            <div class="card-header">
                <div class="card-icon">x</div>
                <div class="card-title">
                    <h2>Mean Estimation Sample Size</h2>
                    <p>Calculate sample size for estimating a population mean with specified precision</p>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Population Standard Deviation (sigma)</label>
                    <input type="number" id="mean-sd" value="10" min="0.1" step="0.1">
                    <p class="help-text">Estimate from pilot study or published literature</p>
                </div>
                <div class="form-group">
                    <label class="required">Desired Precision (d)</label>
                    <input type="number" id="mean-d" value="2" min="0.1" step="0.1">
                    <p class="help-text">Half-width of the confidence interval</p>
                </div>
                <div class="form-group">
                    <label class="required">Confidence Level</label>
                    <select id="mean-conf">
                        <option value="1.96" data-level="95%">95% (Z = 1.96)</option>
                        <option value="2.576" data-level="99%">99% (Z = 2.576)</option>
                        <option value="1.645" data-level="90%">90% (Z = 1.645)</option>
                    </select>
                    <p class="help-text">Standard confidence level for interval estimation</p>
                </div>
                <div class="form-group">
                    <label>Expected Non-response Rate (%)</label>
                    <input type="number" id="mean-nr" value="10" min="0" max="50" step="1">
                    <p class="help-text">Percentage of participants expected not to respond</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateMean(this)">
                    <span class="btn-text">Calculate Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="btn btn-secondary" onclick="resetForm('mean')">
                    <span>Reset</span>
                </button>
            </div>

            <div class="results" id="mean-results">
                <div class="results-header">
                    <span style="font-size: 1.5rem;">*</span>
                    <h3>Calculation Results</h3>
                </div>

                <div class="result-grid">
                    <div class="result-card primary">
                        <div class="result-value" id="mean-n">-</div>
                        <div class="result-label">Required Sample Size</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="mean-n-adj">-</div>
                        <div class="result-label">Adjusted for Non-response</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="mean-se">-</div>
                        <div class="result-label">Expected Standard Error</div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>Formula Used</h4>
                    <div class="formula-box">
                        <div class="formula-main">n = (Z x sigma / d)^2</div>
                        <div class="formula-explanation">
                            Where:<br>
                            Z = Z-score for the selected confidence level<br>
                            sigma = Population standard deviation<br>
                            d = Desired precision (half-width of CI)
                        </div>
                    </div>
                </div>

                <div class="steps-section" id="mean-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <!-- Steps will be populated by JavaScript -->
                </div>

                <div class="interpretation-box" id="mean-interpretation">
                    <h4>Interpretation</h4>
                    <p id="mean-interpretation-text">-</p>
                </div>
            </div>
        </section>

        <!-- Finite Population -->
        <section class="card tab-content hidden" id="finite-content">
            <div class="card-header">
                <div class="card-icon">N</div>
                <div class="card-title">
                    <h2>Finite Population Correction</h2>
                    <p>Adjust sample size when sampling from a known finite population</p>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="required">Initial Sample Size (n0)</label>
                    <input type="number" id="finite-n0" value="385" min="10" step="1">
                    <p class="help-text">Sample size calculated assuming infinite population</p>
                </div>
                <div class="form-group">
                    <label class="required">Population Size (N)</label>
                    <input type="number" id="finite-N" value="1000" min="100" step="1">
                    <p class="help-text">Total size of the target population</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateFinite(this)">
                    <span class="btn-text">Calculate Adjusted Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="btn btn-secondary" onclick="resetForm('finite')">
                    <span>Reset</span>
                </button>
            </div>

            <div class="results" id="finite-results">
                <div class="results-header">
                    <span style="font-size: 1.5rem;">*</span>
                    <h3>Calculation Results</h3>
                </div>

                <div class="result-grid">
                    <div class="result-card primary">
                        <div class="result-value" id="finite-n">-</div>
                        <div class="result-label">Adjusted Sample Size</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="finite-frac">-</div>
                        <div class="result-label">Sampling Fraction</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value" id="finite-reduction">-</div>
                        <div class="result-label">Sample Reduction</div>
                    </div>
                </div>

                <div class="formula-section">
                    <h4>Formula Used</h4>
                    <div class="formula-box">
                        <div class="formula-main">n = n0 / (1 + (n0 - 1) / N)</div>
                        <div class="formula-explanation">
                            Where:<br>
                            n0 = Initial sample size (assuming infinite population)<br>
                            N = Known population size<br>
                            This correction reduces sample size when sampling fraction is significant
                        </div>
                    </div>
                </div>

                <div class="steps-section" id="finite-steps">
                    <h4>Step-by-Step Calculation</h4>
                    <!-- Steps will be populated by JavaScript -->
                </div>

                <div class="interpretation-box" id="finite-interpretation">
                    <h4>Interpretation</h4>
                    <p id="finite-interpretation-text">-</p>
                </div>
            </div>
        </section>

        <!-- Export Card -->
        <section class="card export-card">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">PDF</div>
                <div class="card-title">
                    <h2>Export Results</h2>
                    <p>Generate a comprehensive PDF report with all calculation details</p>
                </div>
            </div>

            <div class="export-options">
                <button class="btn btn-export" onclick="openExportModal()">
                    <span>Export PDF Report</span>
                </button>
                <button class="btn btn-secondary" onclick="copyResults()">
                    <span>Copy to Clipboard</span>
                </button>
            </div>
        </section>
    </main>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Export PDF Report</h3>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Choose the theme for your PDF report:</p>
            <div class="theme-options">
                <div class="theme-option selected" data-theme="light" onclick="selectPdfTheme('light')">
                    <div class="theme-option-icon">*</div>
                    <div class="theme-option-label">Light Theme</div>
                    <div class="theme-option-desc">Clean white background</div>
                </div>
                <div class="theme-option" data-theme="dark" onclick="selectPdfTheme('dark')">
                    <div class="theme-option-icon">@</div>
                    <div class="theme-option-label">Dark Theme</div>
                    <div class="theme-option-desc">Dark background</div>
                </div>
            </div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="exportPDF()" style="flex: 1;">
                    <span>Generate PDF</span>
                </button>
                <button class="btn btn-secondary" onclick="closeExportModal()">
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">Results copied to clipboard!</div>

    <footer class="footer">
        <p class="footer-brand">KARMASTAT - Professional Statistical Calculator</p>
        <p>Made with love by <strong>Karmayogi</strong> | <a href="karmastat_references.html">References & Citations</a></p>
        <p class="footer-tagline">Jai Shri Ram</p>
    </footer>

    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode" aria-label="Toggle theme">
        <span id="theme-icon">@</span>
    </button>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        // ============================================
        // GLOBAL STATE FOR CALCULATION RESULTS
        // ============================================
        let lastCalculation = null;
        let selectedPdfTheme = 'light';

        // ============================================
        // THEME MANAGEMENT
        // ============================================
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? '' : 'dark');
            document.getElementById('theme-icon').textContent = isDark ? '@' : '*';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('karmastat-theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = '*';
            }
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function initializeTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(this.dataset.tab + '-content').classList.remove('hidden');
                });
            });
        }

        // ============================================
        // FORM RESET
        // ============================================
        function resetForm(type) {
            if (type === 'prevalence') {
                document.getElementById('prev-p').value = '0.5';
                document.getElementById('prev-d').value = '0.05';
                document.getElementById('prev-conf').value = '1.96';
                document.getElementById('prev-deff').value = '1';
                document.getElementById('prev-nr').value = '10';
                document.getElementById('prev-results').classList.remove('show');
            } else if (type === 'mean') {
                document.getElementById('mean-sd').value = '10';
                document.getElementById('mean-d').value = '2';
                document.getElementById('mean-conf').value = '1.96';
                document.getElementById('mean-nr').value = '10';
                document.getElementById('mean-results').classList.remove('show');
            } else if (type === 'finite') {
                document.getElementById('finite-n0').value = '385';
                document.getElementById('finite-N').value = '1000';
                document.getElementById('finite-results').classList.remove('show');
            }
        }

        // ============================================
        // Z-SCORE TO CONFIDENCE LEVEL MAPPING
        // ============================================
        function getConfidenceLevel(zScore) {
            const z = parseFloat(zScore);
            if (z === 1.96) return '95%';
            if (z === 2.576) return '99%';
            if (z === 1.645) return '90%';
            return z.toFixed(3);
        }

        // ============================================
        // PREVALENCE CALCULATION
        // ============================================
        function calculatePrevalence(btn) {
            withLoader(btn, function() {
            const p = parseFloat(document.getElementById('prev-p').value);
            const d = parseFloat(document.getElementById('prev-d').value);
            const z = parseFloat(document.getElementById('prev-conf').value);
            const deff = parseFloat(document.getElementById('prev-deff').value);
            const nr = parseFloat(document.getElementById('prev-nr').value) / 100;

            // Validation
            if (p <= 0 || p >= 1) {
                alert('Prevalence must be between 0 and 1 (exclusive)');
                return;
            }
            if (d <= 0 || d >= 0.5) {
                alert('Precision must be between 0 and 0.5');
                return;
            }

            // Step-by-step calculation
            const step1 = z * z;
            const step2 = p * (1 - p);
            const step3 = d * d;
            const step4 = (step1 * step2) / step3;
            const n = Math.ceil(step4 * deff);
            const nAdj = Math.ceil(n / (1 - nr));
            const ciWidth = (2 * d * 100).toFixed(1);

            // Update display
            document.getElementById('prev-n').textContent = n.toLocaleString();
            document.getElementById('prev-n-adj').textContent = nAdj.toLocaleString();
            document.getElementById('prev-ci').textContent = '+/-' + ciWidth + '%';
            document.getElementById('prev-results').classList.add('show');

            // Generate steps HTML
            const stepsHTML = `
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Calculate Z-squared</div>
                        <div class="step-calc">Z^2 = ${z}^2 = ${step1.toFixed(4)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Calculate P x (1-P)</div>
                        <div class="step-calc">${p} x (1 - ${p}) = ${p} x ${(1-p).toFixed(4)} = ${step2.toFixed(4)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Calculate d-squared (precision squared)</div>
                        <div class="step-calc">d^2 = ${d}^2 = ${step3.toFixed(6)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Apply the formula: (Z^2 x P x (1-P)) / d^2</div>
                        <div class="step-calc">(${step1.toFixed(4)} x ${step2.toFixed(4)}) / ${step3.toFixed(6)} = ${step4.toFixed(2)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">Apply Design Effect (DEFF)</div>
                        <div class="step-calc">${step4.toFixed(2)} x ${deff} = ${(step4 * deff).toFixed(2)} -> Rounded up: ${n}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <div class="step-title">Adjust for Non-response (${(nr * 100).toFixed(0)}%)</div>
                        <div class="step-calc">${n} / (1 - ${nr.toFixed(2)}) = ${n} / ${(1-nr).toFixed(2)} = ${(n / (1-nr)).toFixed(2)} -> Rounded up: ${nAdj}</div>
                    </div>
                </div>
            `;
            document.getElementById('prev-steps').innerHTML = '<h4>Step-by-Step Calculation</h4>' + stepsHTML;

            // Generate interpretation
            const confLevel = getConfidenceLevel(z);
            const interpretationText = `To estimate a population prevalence of ${(p * 100).toFixed(1)}% with a precision of +/-${(d * 100).toFixed(1)}% at a ${confLevel} confidence level${deff > 1 ? `, accounting for a design effect of ${deff}` : ''}, you need a minimum sample size of ${n} participants. After adjusting for an expected non-response rate of ${(nr * 100).toFixed(0)}%, the recommended sample size is ${nAdj} participants. This sample size will provide a ${confLevel} confidence interval with a total width of ${ciWidth}% around your point estimate.`;
            document.getElementById('prev-interpretation-text').textContent = interpretationText;

            // Store calculation for export
            lastCalculation = {
                type: 'prevalence',
                studyType: 'Descriptive Study - Prevalence Estimation',
                method: 'Cochran\'s Formula for Proportion',
                inputs: {
                    'Expected Prevalence (P)': p,
                    'Precision / Margin of Error (d)': d,
                    'Confidence Level': confLevel,
                    'Z-score': z,
                    'Design Effect (DEFF)': deff,
                    'Non-response Rate': (nr * 100).toFixed(0) + '%'
                },
                formula: 'n = (Z^2 x P x (1-P)) / d^2 x DEFF',
                formulaExplanation: 'Z = Z-score for confidence level | P = Expected prevalence | d = Precision | DEFF = Design effect',
                steps: [
                    { title: 'Calculate Z-squared', calc: `Z^2 = ${z}^2 = ${step1.toFixed(4)}` },
                    { title: 'Calculate P x (1-P)', calc: `${p} x (1 - ${p}) = ${step2.toFixed(4)}` },
                    { title: 'Calculate d-squared', calc: `d^2 = ${d}^2 = ${step3.toFixed(6)}` },
                    { title: 'Apply the formula', calc: `(${step1.toFixed(4)} x ${step2.toFixed(4)}) / ${step3.toFixed(6)} = ${step4.toFixed(2)}` },
                    { title: 'Apply Design Effect', calc: `${step4.toFixed(2)} x ${deff} = ${(step4 * deff).toFixed(2)} -> ${n}` },
                    { title: 'Adjust for Non-response', calc: `${n} / ${(1-nr).toFixed(2)} = ${nAdj}` }
                ],
                results: {
                    'Required Sample Size': n,
                    'Adjusted for Non-response': nAdj,
                    'Expected CI Width': '+/-' + ciWidth + '%'
                },
                interpretation: interpretationText,
                recommendations: [
                    'Ensure random sampling methodology to maintain validity',
                    'Consider stratification if population is heterogeneous',
                    deff > 1 ? 'Design effect > 1 suggests cluster sampling - ensure adequate number of clusters' : 'Simple random sampling assumed with DEFF = 1',
                    'Plan for data quality checks and potential exclusions'
                ],
                reference: 'Cochran, W. G. (1977). Sampling Techniques (3rd ed.). John Wiley & Sons.'
            };
            });
        }

        // ============================================
        // MEAN ESTIMATION CALCULATION
        // ============================================
        function calculateMean(btn) {
            withLoader(btn, function() {
            const sd = parseFloat(document.getElementById('mean-sd').value);
            const d = parseFloat(document.getElementById('mean-d').value);
            const z = parseFloat(document.getElementById('mean-conf').value);
            const nr = parseFloat(document.getElementById('mean-nr').value) / 100;

            // Validation
            if (sd <= 0) {
                alert('Standard deviation must be greater than 0');
                return;
            }
            if (d <= 0) {
                alert('Precision must be greater than 0');
                return;
            }

            // Step-by-step calculation
            const step1 = z * sd;
            const step2 = step1 / d;
            const step3 = step2 * step2;
            const n = Math.ceil(step3);
            const nAdj = Math.ceil(n / (1 - nr));
            const se = (sd / Math.sqrt(n)).toFixed(3);

            // Update display
            document.getElementById('mean-n').textContent = n.toLocaleString();
            document.getElementById('mean-n-adj').textContent = nAdj.toLocaleString();
            document.getElementById('mean-se').textContent = se;
            document.getElementById('mean-results').classList.add('show');

            // Generate steps HTML
            const stepsHTML = `
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Multiply Z-score by Standard Deviation</div>
                        <div class="step-calc">Z x sigma = ${z} x ${sd} = ${step1.toFixed(4)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Divide by Desired Precision</div>
                        <div class="step-calc">${step1.toFixed(4)} / ${d} = ${step2.toFixed(4)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Square the Result</div>
                        <div class="step-calc">(${step2.toFixed(4)})^2 = ${step3.toFixed(2)} -> Rounded up: ${n}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Adjust for Non-response (${(nr * 100).toFixed(0)}%)</div>
                        <div class="step-calc">${n} / (1 - ${nr.toFixed(2)}) = ${n} / ${(1-nr).toFixed(2)} = ${(n / (1-nr)).toFixed(2)} -> Rounded up: ${nAdj}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">Calculate Expected Standard Error</div>
                        <div class="step-calc">SE = sigma / sqrt(n) = ${sd} / sqrt(${n}) = ${sd} / ${Math.sqrt(n).toFixed(4)} = ${se}</div>
                    </div>
                </div>
            `;
            document.getElementById('mean-steps').innerHTML = '<h4>Step-by-Step Calculation</h4>' + stepsHTML;

            // Generate interpretation
            const confLevel = getConfidenceLevel(z);
            const interpretationText = `To estimate a population mean with a precision of +/-${d} units at a ${confLevel} confidence level, assuming a standard deviation of ${sd}, you need a minimum sample size of ${n} participants. After adjusting for an expected non-response rate of ${(nr * 100).toFixed(0)}%, the recommended sample size is ${nAdj} participants. The expected standard error of the mean will be ${se}, resulting in a ${confLevel} confidence interval of approximately +/-${(z * parseFloat(se)).toFixed(3)} units around the sample mean.`;
            document.getElementById('mean-interpretation-text').textContent = interpretationText;

            // Store calculation for export
            lastCalculation = {
                type: 'mean',
                studyType: 'Descriptive Study - Mean Estimation',
                method: 'Sample Size Formula for Continuous Variables',
                inputs: {
                    'Population Standard Deviation (sigma)': sd,
                    'Desired Precision (d)': d,
                    'Confidence Level': confLevel,
                    'Z-score': z,
                    'Non-response Rate': (nr * 100).toFixed(0) + '%'
                },
                formula: 'n = (Z x sigma / d)^2',
                formulaExplanation: 'Z = Z-score for confidence level | sigma = Population standard deviation | d = Desired precision',
                steps: [
                    { title: 'Multiply Z by sigma', calc: `Z x sigma = ${z} x ${sd} = ${step1.toFixed(4)}` },
                    { title: 'Divide by precision', calc: `${step1.toFixed(4)} / ${d} = ${step2.toFixed(4)}` },
                    { title: 'Square the result', calc: `(${step2.toFixed(4)})^2 = ${step3.toFixed(2)} -> ${n}` },
                    { title: 'Adjust for Non-response', calc: `${n} / ${(1-nr).toFixed(2)} = ${nAdj}` },
                    { title: 'Calculate Standard Error', calc: `SE = ${sd} / sqrt(${n}) = ${se}` }
                ],
                results: {
                    'Required Sample Size': n,
                    'Adjusted for Non-response': nAdj,
                    'Expected Standard Error': se
                },
                interpretation: interpretationText,
                recommendations: [
                    'Verify standard deviation estimate from pilot study or literature',
                    'Consider using conservative (larger) SD estimate if uncertain',
                    'Ensure measurement instrument has adequate precision',
                    'Plan for potential outliers and data cleaning'
                ],
                reference: 'Daniel, W. W. (2009). Biostatistics: A Foundation for Analysis in the Health Sciences (9th ed.). Wiley.'
            };
            });
        }

        // ============================================
        // FINITE POPULATION CALCULATION
        // ============================================
        function calculateFinite(btn) {
            withLoader(btn, function() {
            const n0 = parseFloat(document.getElementById('finite-n0').value);
            const N = parseFloat(document.getElementById('finite-N').value);

            // Validation
            if (n0 <= 0) {
                alert('Initial sample size must be greater than 0');
                return;
            }
            if (N <= 0) {
                alert('Population size must be greater than 0');
                return;
            }
            if (n0 > N) {
                alert('Initial sample size cannot exceed population size');
                return;
            }

            // Step-by-step calculation
            const step1 = n0 - 1;
            const step2 = step1 / N;
            const step3 = 1 + step2;
            const nExact = n0 / step3;
            const n = Math.ceil(nExact);
            const frac = ((n / N) * 100).toFixed(1);
            const reduction = n0 - n;
            const reductionPct = ((reduction / n0) * 100).toFixed(1);

            // Update display
            document.getElementById('finite-n').textContent = n.toLocaleString();
            document.getElementById('finite-frac').textContent = frac + '%';
            document.getElementById('finite-reduction').textContent = '-' + reduction.toLocaleString();
            document.getElementById('finite-results').classList.add('show');

            // Generate steps HTML
            const stepsHTML = `
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Calculate (n0 - 1)</div>
                        <div class="step-calc">${n0} - 1 = ${step1}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Divide by Population Size (N)</div>
                        <div class="step-calc">${step1} / ${N} = ${step2.toFixed(6)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">Add 1 to get the correction factor</div>
                        <div class="step-calc">1 + ${step2.toFixed(6)} = ${step3.toFixed(6)}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Divide Initial Sample Size by Correction Factor</div>
                        <div class="step-calc">${n0} / ${step3.toFixed(6)} = ${nExact.toFixed(2)} -> Rounded up: ${n}</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">Calculate Sampling Fraction</div>
                        <div class="step-calc">${n} / ${N} = ${(n/N).toFixed(4)} = ${frac}%</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <div class="step-title">Calculate Sample Reduction</div>
                        <div class="step-calc">${n0} - ${n} = ${reduction} (${reductionPct}% reduction)</div>
                    </div>
                </div>
            `;
            document.getElementById('finite-steps').innerHTML = '<h4>Step-by-Step Calculation</h4>' + stepsHTML;

            // Generate interpretation
            const interpretationText = `When sampling from a finite population of ${N.toLocaleString()}, the initial sample size of ${n0.toLocaleString()} (calculated assuming infinite population) can be reduced to ${n.toLocaleString()} participants. This represents a reduction of ${reduction.toLocaleString()} participants (${reductionPct}%). The sampling fraction is ${frac}%, meaning you will be sampling ${frac}% of the total population. ${parseFloat(frac) > 10 ? 'Note: With a sampling fraction > 10%, the finite population correction provides meaningful sample size reduction.' : 'With a sampling fraction <= 10%, the finite population correction provides modest reduction.'}`;
            document.getElementById('finite-interpretation-text').textContent = interpretationText;

            // Store calculation for export
            lastCalculation = {
                type: 'finite',
                studyType: 'Descriptive Study - Finite Population Correction',
                method: 'Finite Population Correction Factor',
                inputs: {
                    'Initial Sample Size (n0)': n0,
                    'Population Size (N)': N
                },
                formula: 'n = n0 / (1 + (n0 - 1) / N)',
                formulaExplanation: 'n0 = Initial sample size (infinite population) | N = Known population size',
                steps: [
                    { title: 'Calculate (n0 - 1)', calc: `${n0} - 1 = ${step1}` },
                    { title: 'Divide by N', calc: `${step1} / ${N} = ${step2.toFixed(6)}` },
                    { title: 'Add 1', calc: `1 + ${step2.toFixed(6)} = ${step3.toFixed(6)}` },
                    { title: 'Apply correction', calc: `${n0} / ${step3.toFixed(6)} = ${nExact.toFixed(2)} -> ${n}` },
                    { title: 'Sampling fraction', calc: `${n} / ${N} = ${frac}%` },
                    { title: 'Sample reduction', calc: `${n0} - ${n} = ${reduction} (${reductionPct}%)` }
                ],
                results: {
                    'Adjusted Sample Size': n,
                    'Sampling Fraction': frac + '%',
                    'Sample Reduction': reduction + ' (' + reductionPct + '%)'
                },
                interpretation: interpretationText,
                recommendations: [
                    'Use FPC when sampling fraction exceeds 5-10% of population',
                    'Ensure accurate population size estimate',
                    'Consider whether population may change during study period',
                    'Document the correction in your methodology section'
                ],
                reference: 'Kish, L. (1965). Survey Sampling. John Wiley & Sons.'
            };
            });
        }

        // ============================================
        // EXPORT MODAL
        // ============================================
        function openExportModal() {
            if (!lastCalculation) {
                alert('Please perform a calculation first before exporting.');
                return;
            }
            document.getElementById('export-modal').classList.add('show');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.remove('show');
        }

        function selectPdfTheme(theme) {
            selectedPdfTheme = theme;
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('selected');
        }

        // ============================================
        // PDF EXPORT
        // ============================================
        function exportPDF() {
            if (!lastCalculation) {
                alert('Please perform a calculation first before exporting.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const calc = lastCalculation;
            const isDark = selectedPdfTheme === 'dark';

            // Color scheme based on theme
            const colors = isDark ? {
                bg: [30, 41, 59],
                headerBg: [16, 185, 129],
                primary: [16, 185, 129],
                primaryDark: [5, 150, 105],
                text: [241, 245, 249],
                textSecondary: [148, 163, 184],
                cardBg: [51, 65, 85],
                accent: [6, 78, 59],
                border: [71, 85, 105]
            } : {
                bg: [255, 255, 255],
                headerBg: [16, 185, 129],
                primary: [16, 185, 129],
                primaryDark: [5, 150, 105],
                text: [30, 41, 59],
                textSecondary: [71, 85, 105],
                cardBg: [241, 245, 249],
                accent: [209, 250, 229],
                border: [226, 232, 240]
            };

            // Set background
            if (isDark) {
                doc.setFillColor(...colors.bg);
                doc.rect(0, 0, 210, 297, 'F');
            }

            let y = 15;

            // Header
            doc.setFillColor(...colors.headerBg);
            doc.rect(0, 0, 210, 45, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('KARMASTAT', 105, 18, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Professional Statistical Calculator', 105, 27, { align: 'center' });

            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Descriptive Studies - Sample Size Calculation', 105, 38, { align: 'center' });

            y = 55;

            // Study Type & Method
            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(15, y, 180, 22, 3, 3, 'F');

            doc.setTextColor(...colors.primary);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Study Type:', 20, y + 8);
            doc.setTextColor(...colors.text);
            doc.setFont('helvetica', 'normal');
            doc.text(calc.studyType, 55, y + 8);

            doc.setTextColor(...colors.primary);
            doc.setFont('helvetica', 'bold');
            doc.text('Method:', 20, y + 16);
            doc.setTextColor(...colors.text);
            doc.setFont('helvetica', 'normal');
            doc.text(calc.method, 45, y + 16);

            y += 30;

            // Input Parameters
            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('INPUT PARAMETERS', 105, y + 6, { align: 'center' });
            y += 12;

            doc.setFillColor(...colors.cardBg);
            const inputKeys = Object.keys(calc.inputs);
            const inputHeight = inputKeys.length * 7 + 6;
            doc.roundedRect(15, y, 180, inputHeight, 3, 3, 'F');

            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            let inputY = y + 6;
            inputKeys.forEach(key => {
                doc.setFont('helvetica', 'bold');
                doc.text(key + ':', 20, inputY);
                doc.setFont('helvetica', 'normal');
                const value = String(calc.inputs[key]);
                doc.text(value, 100, inputY);
                inputY += 7;
            });

            y += inputHeight + 8;

            // Formula
            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('FORMULA', 105, y + 6, { align: 'center' });
            y += 12;

            doc.setFillColor(...colors.accent);
            doc.roundedRect(15, y, 180, 18, 3, 3, 'F');

            doc.setTextColor(...colors.primaryDark);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(calc.formula, 105, y + 7, { align: 'center' });

            doc.setTextColor(...colors.textSecondary);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(calc.formulaExplanation, 105, y + 14, { align: 'center' });

            y += 26;

            // Step-by-Step Calculation
            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('STEP-BY-STEP CALCULATION', 105, y + 6, { align: 'center' });
            y += 12;

            calc.steps.forEach((step, index) => {
                if (y > 250) {
                    doc.addPage();
                    if (isDark) {
                        doc.setFillColor(...colors.bg);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                    y = 20;
                }

                doc.setFillColor(...colors.cardBg);
                doc.roundedRect(15, y, 180, 14, 2, 2, 'F');

                // Step number circle
                doc.setFillColor(...colors.primary);
                doc.circle(23, y + 7, 4, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(String(index + 1), 23, y + 8.5, { align: 'center' });

                doc.setTextColor(...colors.text);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(step.title, 30, y + 5);

                doc.setTextColor(...colors.primaryDark);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text(step.calc, 30, y + 11);

                y += 16;
            });

            y += 4;

            // Results
            if (y > 220) {
                doc.addPage();
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }
                y = 20;
            }

            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('RESULTS', 105, y + 6, { align: 'center' });
            y += 12;

            const resultKeys = Object.keys(calc.results);
            const resultWidth = 180 / resultKeys.length;

            resultKeys.forEach((key, index) => {
                const x = 15 + (index * resultWidth);
                const isPrimary = index === 0;

                if (isPrimary) {
                    doc.setFillColor(...colors.primary);
                } else {
                    doc.setFillColor(...colors.cardBg);
                }
                doc.roundedRect(x + 2, y, resultWidth - 4, 22, 3, 3, 'F');

                if (isPrimary) {
                    doc.setTextColor(255, 255, 255);
                } else {
                    doc.setTextColor(...colors.primaryDark);
                }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(String(calc.results[key]), x + resultWidth / 2, y + 10, { align: 'center' });

                if (isPrimary) {
                    doc.setTextColor(255, 255, 255);
                } else {
                    doc.setTextColor(...colors.textSecondary);
                }
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(key, x + resultWidth / 2, y + 18, { align: 'center' });
            });

            y += 30;

            // Interpretation
            if (y > 220) {
                doc.addPage();
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }
                y = 20;
            }

            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('INTERPRETATION', 105, y + 6, { align: 'center' });
            y += 12;

            doc.setFillColor(isDark ? [120, 53, 15] : [254, 243, 199]);
            const interpretLines = doc.splitTextToSize(calc.interpretation, 170);
            const interpretHeight = interpretLines.length * 5 + 8;
            doc.roundedRect(15, y, 180, interpretHeight, 3, 3, 'F');

            doc.setTextColor(isDark ? [254, 243, 199] : [120, 53, 15]);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(interpretLines, 20, y + 6);

            y += interpretHeight + 8;

            // Recommendations
            if (y > 230) {
                doc.addPage();
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }
                y = 20;
            }

            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('RECOMMENDATIONS', 105, y + 6, { align: 'center' });
            y += 12;

            doc.setFillColor(...colors.cardBg);
            const recHeight = calc.recommendations.length * 7 + 6;
            doc.roundedRect(15, y, 180, recHeight, 3, 3, 'F');

            doc.setTextColor(...colors.text);
            doc.setFontSize(9);
            let recY = y + 6;
            calc.recommendations.forEach((rec, index) => {
                doc.setFont('helvetica', 'normal');
                doc.text('* ' + rec, 20, recY);
                recY += 7;
            });

            y += recHeight + 8;

            // Reference
            if (y > 260) {
                doc.addPage();
                if (isDark) {
                    doc.setFillColor(...colors.bg);
                    doc.rect(0, 0, 210, 297, 'F');
                }
                y = 20;
            }

            doc.setFillColor(...colors.primary);
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('REFERENCE', 105, y + 6, { align: 'center' });
            y += 12;

            doc.setFillColor(...colors.cardBg);
            doc.roundedRect(15, y, 180, 12, 3, 3, 'F');
            doc.setTextColor(...colors.textSecondary);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text(calc.reference, 20, y + 7);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Footer background
                doc.setFillColor(...colors.primary);
                doc.rect(0, 280, 210, 17, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');

                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

                doc.text('Generated: ' + timestamp, 15, 287);
                doc.text('Theme: ' + (isDark ? 'Dark' : 'Light'), 85, 287);
                doc.text('Page ' + i + ' of ' + pageCount, 195, 287, { align: 'right' });

                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Generated by KARMASTAT - Crafted by Karmayogi', 105, 293, { align: 'center' });
            }

            // Save PDF
            const filename = 'KARMASTAT_' + calc.type + '_' + new Date().toISOString().split('T')[0] + '.pdf';
            doc.save(filename);

            closeExportModal();
            showToast('PDF exported successfully!');
        }

        // ============================================
        // COPY TO CLIPBOARD
        // ============================================
        function copyResults() {
            if (!lastCalculation) {
                alert('Please perform a calculation first before copying.');
                return;
            }

            const calc = lastCalculation;
            let text = '='.repeat(60) + '\n';
            text += 'KARMASTAT - Descriptive Studies Calculator\n';
            text += '='.repeat(60) + '\n\n';

            text += 'STUDY TYPE: ' + calc.studyType + '\n';
            text += 'METHOD: ' + calc.method + '\n\n';

            text += '-'.repeat(40) + '\n';
            text += 'INPUT PARAMETERS\n';
            text += '-'.repeat(40) + '\n';
            for (const [key, value] of Object.entries(calc.inputs)) {
                text += key + ': ' + value + '\n';
            }

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'FORMULA\n';
            text += '-'.repeat(40) + '\n';
            text += calc.formula + '\n';
            text += calc.formulaExplanation + '\n';

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'STEP-BY-STEP CALCULATION\n';
            text += '-'.repeat(40) + '\n';
            calc.steps.forEach((step, index) => {
                text += (index + 1) + '. ' + step.title + '\n';
                text += '   ' + step.calc + '\n';
            });

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'RESULTS\n';
            text += '-'.repeat(40) + '\n';
            for (const [key, value] of Object.entries(calc.results)) {
                text += key + ': ' + value + '\n';
            }

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'INTERPRETATION\n';
            text += '-'.repeat(40) + '\n';
            text += calc.interpretation + '\n';

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'RECOMMENDATIONS\n';
            text += '-'.repeat(40) + '\n';
            calc.recommendations.forEach(rec => {
                text += '* ' + rec + '\n';
            });

            text += '\n' + '-'.repeat(40) + '\n';
            text += 'REFERENCE\n';
            text += '-'.repeat(40) + '\n';
            text += calc.reference + '\n';

            text += '\n' + '='.repeat(60) + '\n';
            text += 'Generated by KARMASTAT - Crafted by Karmayogi\n';
            text += 'Timestamp: ' + new Date().toLocaleString() + '\n';
            text += '='.repeat(60) + '\n';

            navigator.clipboard.writeText(text).then(() => {
                showToast('Results copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please try again.');
            });
        }

        // ============================================
        // TOAST NOTIFICATION
        // ============================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            initializeTabs();

            // Close modal on outside click
            document.getElementById('export-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeExportModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeExportModal();
                }
            });
        });
    </script>
</body>
</html>
