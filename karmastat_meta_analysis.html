<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Meta-Analysis Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #4338CA;
            --accent: #E0E7FF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --bg-primary: #FFFFFF;
            --bg-secondary: #EEF2FF;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            --shadow-hover: 0 8px 25px rgba(99, 102, 241, 0.25);

            --gradient-primary: linear-gradient(135deg, #6366F1, #818CF8, #A5B4FC);
            --gradient-secondary: linear-gradient(135deg, #4338CA, #6366F1, #818CF8);
            --gradient-bg: linear-gradient(135deg, #EEF2FF, #E0E7FF, #C7D2FE);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #EEF2FF);

            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        [data-theme="dark"] {
            --bg-primary: #1E1B4B;
            --bg-secondary: #312E81;
            --bg-card: #312E81;
            --text-primary: #F3F4F6;
            --text-secondary: #D1D5DB;
            --text-muted: #9CA3AF;
            --border-color: #4C4290;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1E1B4B, #312E81, #3730A3);
            --gradient-card: linear-gradient(145deg, #312E81, #3730A3);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        .header {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .theme-toggle, .back-link {
            position: absolute;
            top: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
        }

        .theme-toggle { right: 1.5rem; }
        .back-link { left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }

        .theme-toggle:hover, .back-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calc-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--gradient-card);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .calc-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .calc-tab:hover { border-color: var(--primary); }
        .calc-tab.active { background: var(--gradient-primary); color: white; border-color: var(--primary); }

        .calculator-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .calculator-section.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-header h3 { font-size: 1.5rem; font-weight: 700; }

        .formula-box {
            background: var(--gradient-secondary);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            font-family: var(--font-mono);
            text-align: center;
            border-radius: var(--radius);
        }

        .formula-box small { display: block; margin-top: 0.5rem; opacity: 0.9; }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group { display: flex; flex-direction: column; }

        .input-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .input-group input, .input-group select {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .input-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .calculate-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .results-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .results-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-main {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-value { font-size: 3.5rem; font-weight: 800; color: white; }
        .result-label { color: rgba(255,255,255,0.9); font-size: 1.1rem; }
        .result-sub { margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: var(--radius); color: white; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .result-card-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .result-card-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h4 { color: var(--primary); margin-bottom: 0.75rem; }
        .info-box p { color: var(--text-secondary); }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container h4 { text-align: center; margin-bottom: 1rem; color: var(--text-primary); }
        .chart-wrapper { position: relative; height: 300px; }

        .export-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover { background: #059669; transform: translateY(-2px); }

        .pdf-theme-select {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .pdf-theme-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .reference-box {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .reference-box h4 { color: var(--primary); margin-bottom: 1rem; }
        .reference-box ul { list-style: none; }
        .reference-box li { padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.9rem; }
        .reference-box li:last-child { border-bottom: none; }

        .recommendations-box {
            background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        [data-theme="dark"] .recommendations-box {
            background: linear-gradient(135deg, #3730A3, #4338CA);
        }

        .recommendations-box h4 { color: var(--primary); margin-bottom: 1rem; }
        .recommendations-box ul { list-style: disc; margin-left: 1.5rem; }
        .recommendations-box li { padding: 0.4rem 0; color: var(--text-secondary); }

        .footer {
            background: var(--gradient-secondary);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
        }

        .footer-love { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .footer-blessing { color: var(--accent); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .logo { flex-direction: column; }
            .back-link, .theme-toggle { position: static; margin: 0.5rem; }
            .header { padding-top: 4rem; }
            .result-value { font-size: 2.5rem; }
            .export-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <a href="karmastat_2_0_main.html" class="back-link">
                <span>&#8592;</span> Back to Main
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">&#9790;</span> Theme
            </button>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <div class="logo">
                <div>
                    <h1>Meta-Analysis Sample Size</h1>
                    <p class="subtitle">Calculate sample size requirements for systematic reviews and meta-analyses</p>
                </div>
            </div>
        </header>

        <div class="calc-tabs">
            <button class="calc-tab active" data-calc="num-studies-fixed" onclick="selectCalc('num-studies-fixed')">Studies (Fixed Effects)</button>
            <button class="calc-tab" data-calc="num-studies-random" onclick="selectCalc('num-studies-random')">Studies (Random Effects)</button>
            <button class="calc-tab" data-calc="sample-per-study" onclick="selectCalc('sample-per-study')">Sample per Study</button>
            <button class="calc-tab" data-calc="meta-power" onclick="selectCalc('meta-power')">Meta-Analysis Power</button>
            <button class="calc-tab" data-calc="heterogeneity" onclick="selectCalc('heterogeneity')">Heterogeneity Impact</button>
        </div>

        <!-- Fixed Effects: Number of Studies -->
        <section class="calculator-section active" id="num-studies-fixed-calc">
            <div class="section-header">
                <div class="section-icon">k</div>
                <h3>Number of Studies Needed (Fixed Effects Model)</h3>
            </div>

            <div class="formula-box">
                k = (z<sub>&alpha;/2</sub> / SE<sub>target</sub>)&sup2; &times; v&#772;<br>
                <small>Where v&#772; is the average within-study variance</small>
            </div>

            <div class="info-box">
                <h4>When to Use Fixed Effects</h4>
                <p>Use the fixed effects model when you assume all studies share a common true effect size and any variation is due to sampling error alone. This is appropriate when studies are functionally identical.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected Effect Size (Cohen's d or SMD)</label>
                    <input type="number" id="fe_effect" value="0.5" min="0.01" step="0.01">
                    <span class="input-hint">Standardized mean difference</span>
                </div>
                <div class="input-group">
                    <label>Target Standard Error</label>
                    <input type="number" id="fe_se" value="0.05" min="0.01" step="0.01">
                    <span class="input-hint">Precision of pooled estimate</span>
                </div>
                <div class="input-group">
                    <label>Average Study Sample Size (n per group)</label>
                    <input type="number" id="fe_n" value="50" min="10" step="1">
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="fe_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                        <option value="0.10">0.10</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateFixedEffects(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Number of Studies</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Random Effects: Number of Studies -->
        <section class="calculator-section" id="num-studies-random-calc">
            <div class="section-header">
                <div class="section-icon">k</div>
                <h3>Number of Studies Needed (Random Effects Model)</h3>
            </div>

            <div class="formula-box">
                k = ((z<sub>&alpha;/2</sub> + z<sub>&beta;</sub>)&sup2; &times; (&tau;&sup2; + v&#772;)) / &delta;&sup2;<br>
                <small>Accounts for between-study heterogeneity (&tau;&sup2;)</small>
            </div>

            <div class="info-box">
                <h4>When to Use Random Effects</h4>
                <p>Use the random effects model when you expect true effect sizes to vary across studies due to differences in populations, interventions, or settings. This is the more conservative and commonly used approach.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected Effect Size</label>
                    <input type="number" id="re_effect" value="0.5" min="0.01" step="0.01">
                </div>
                <div class="input-group">
                    <label>Between-Study Variance (&tau;&sup2;)</label>
                    <input type="number" id="re_tau2" value="0.04" min="0" step="0.01">
                    <span class="input-hint">Heterogeneity variance</span>
                </div>
                <div class="input-group">
                    <label>Average Study Sample Size (n per group)</label>
                    <input type="number" id="re_n" value="50" min="10" step="1">
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="re_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="re_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                        <option value="0.10">0.10</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateRandomEffects(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Number of Studies</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Sample Size per Study -->
        <section class="calculator-section" id="sample-per-study-calc">
            <div class="section-header">
                <div class="section-icon">n</div>
                <h3>Sample Size per Study</h3>
            </div>

            <div class="formula-box">
                n = 2(z<sub>&alpha;/2</sub> + z<sub>&beta;</sub>)&sup2; / (k &times; d&sup2;)<br>
                <small>Given k studies, calculate n per study for desired precision</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Studies (k)</label>
                    <input type="number" id="sp_k" value="10" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Minimum Clinically Important Difference (MCID)</label>
                    <input type="number" id="sp_mcid" value="0.3" min="0.01" step="0.01">
                    <span class="input-hint">Smallest meaningful effect size</span>
                </div>
                <div class="input-group">
                    <label>Power</label>
                    <select id="sp_power">
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="sp_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateSamplePerStudy(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size per Study</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Meta-Analysis Power -->
        <section class="calculator-section" id="meta-power-calc">
            <div class="section-header">
                <div class="section-icon">&#946;</div>
                <h3>Power of Existing Meta-Analysis</h3>
            </div>

            <div class="formula-box">
                Power = &Phi;(&delta;&radic;(k/v&#772;) - z<sub>&alpha;/2</sub>)<br>
                <small>Calculate power given k studies and expected effect</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Number of Studies (k)</label>
                    <input type="number" id="mp_k" value="15" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Expected Effect Size</label>
                    <input type="number" id="mp_effect" value="0.3" min="0.01" step="0.01">
                </div>
                <div class="input-group">
                    <label>Average Study Sample Size (n per group)</label>
                    <input type="number" id="mp_n" value="40" min="10" step="1">
                </div>
                <div class="input-group">
                    <label>Between-Study Variance (&tau;&sup2;)</label>
                    <input type="number" id="mp_tau2" value="0.02" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <label>Alpha Level</label>
                    <select id="mp_alpha">
                        <option value="0.01">0.01</option>
                        <option value="0.05" selected>0.05</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateMetaPower(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Power</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Heterogeneity Impact -->
        <section class="calculator-section" id="heterogeneity-calc">
            <div class="section-header">
                <div class="section-icon">I&sup2;</div>
                <h3>Heterogeneity Impact Analysis</h3>
            </div>

            <div class="formula-box">
                I&sup2; = (Q - df) / Q &times; 100%<br>
                <small>&tau;&sup2; = (Q - df) / C where C = &Sigma;w<sub>i</sub> - &Sigma;w<sub>i</sub>&sup2;/&Sigma;w<sub>i</sub></small>
            </div>

            <div class="info-box">
                <h4>I&sup2; Interpretation</h4>
                <p>I&sup2; represents the percentage of variability due to heterogeneity rather than chance: <strong>25%</strong> = low, <strong>50%</strong> = moderate, <strong>75%</strong> = high heterogeneity.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected I&sup2; (%)</label>
                    <input type="number" id="het_i2" value="50" min="0" max="100" step="1">
                    <span class="input-hint">Percentage of variance due to heterogeneity</span>
                </div>
                <div class="input-group">
                    <label>Baseline Number of Studies</label>
                    <input type="number" id="het_k" value="10" min="2" step="1">
                </div>
                <div class="input-group">
                    <label>Average Study Sample Size</label>
                    <input type="number" id="het_n" value="50" min="10" step="1">
                </div>
                <div class="input-group">
                    <label>Expected Effect Size</label>
                    <input type="number" id="het_effect" value="0.4" min="0.01" step="0.01">
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateHeterogeneity(this)">
                <span class="btn-text"><span>&#9889;</span> Analyze Heterogeneity Impact</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results">
            <div class="results-header">
                <h3>Calculation Results</h3>
                <div class="export-controls">
                    <select class="pdf-theme-select" id="pdfTheme">
                        <option value="light">Light PDF Theme</option>
                        <option value="dark">Dark PDF Theme</option>
                    </select>
                    <button class="export-btn" onclick="exportToPDF()">
                        <span>&#128196;</span> Export Comprehensive PDF
                    </button>
                </div>
            </div>

            <div class="result-main">
                <div class="result-value" id="mainValue">--</div>
                <div class="result-label" id="mainLabel">Result</div>
                <div class="result-sub" id="mainSub"></div>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <div class="chart-container" id="chartContainer" style="display: none;">
                <h4 id="chartTitle">Analysis Chart</h4>
                <div class="chart-wrapper">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>

            <div class="info-box" id="interpretationBox">
                <h4>Interpretation</h4>
                <p id="interpretationText"></p>
            </div>

            <div class="recommendations-box" id="recommendationsBox">
                <h4>Recommendations for Systematic Review Planning</h4>
                <ul id="recommendationsList"></ul>
            </div>

            <div class="reference-box">
                <h4>Key References</h4>
                <ul>
                    <li>Borenstein, M., Hedges, L. V., Higgins, J. P., & Rothstein, H. R. (2009). <em>Introduction to Meta-Analysis.</em> Wiley.</li>
                    <li>Hedges, L. V., & Pigott, T. D. (2001). The power of statistical tests in meta-analysis. <em>Psychological Methods, 6</em>(3), 203-217.</li>
                    <li>Higgins, J. P., & Thompson, S. G. (2002). Quantifying heterogeneity in a meta-analysis. <em>Statistics in Medicine, 21</em>(11), 1539-1558.</li>
                    <li>Hedges, L. V., & Pigott, T. D. (2004). The power of statistical tests for moderators in meta-analysis. <em>Psychological Methods, 9</em>(4), 426-445.</li>
                </ul>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-love">Made with &#10084; by Karmayogi</div>
            <div class="footer-blessing">&#128591; Jai Shri Ram &#128591;</div>
        </footer>
    </div>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        let analysisChart = null;

        // Global calculation storage for PDF export
        let lastCalculation = {
            type: null,
            analysisName: '',
            inputParams: {},
            formula: '',
            formulaExplanation: '',
            steps: [],
            results: {},
            mainValue: '',
            mainLabel: '',
            interpretation: '',
            recommendations: []
        };

        function normalCDF(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
            const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            const t = 1 / (1 + p * x);
            const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1) * t * Math.exp(-x*x);
            return 0.5 * (1 + sign * y);
        }

        function normalQuantile(p) {
            const a = [-3.969683028665376e+01, 2.209460984245205e+02, -2.759285104469687e+02,
                       1.383577518672690e+02, -3.066479806614716e+01, 2.506628277459239e+00];
            const b = [-5.447609879822406e+01, 1.615858368580409e+02, -1.556989798598866e+02,
                       6.680131188771972e+01, -1.328068155288572e+01];
            const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00,
                       -2.549732539343734e+00, 4.374664141464968e+00, 2.938163982698783e+00];
            const d = [7.784695709041462e-03, 3.224671290700398e-01, 2.445134137142996e+00, 3.754408661907416e+00];
            const pLow = 0.02425, pHigh = 1 - pLow;
            let q, r;
            if (p < pLow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            } else if (p <= pHigh) {
                q = p - 0.5; r = q * q;
                return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q / (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            }
        }

        function selectCalc(calcType) {
            document.querySelectorAll('.calc-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-calc="${calcType}"]`).classList.add('active');
            document.querySelectorAll('.calculator-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${calcType}-calc`).classList.add('active');
            document.getElementById('results').classList.remove('active');
        }

        function calculateFixedEffects() {
            const effect = parseFloat(document.getElementById('fe_effect').value);
            const targetSE = parseFloat(document.getElementById('fe_se').value);
            const n = parseFloat(document.getElementById('fe_n').value);
            const alpha = parseFloat(document.getElementById('fe_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const withinVar = 2/n + (effect*effect)/(2*n);
            const k = Math.pow(zAlpha/targetSE, 2) * withinVar;
            const kCeiled = Math.ceil(k);
            const ciWidth = 2 * 1.96 * targetSE;

            // Store calculation details for PDF
            lastCalculation = {
                type: 'fixed',
                analysisName: 'Number of Studies Needed (Fixed Effects Model)',
                inputParams: {
                    'Expected Effect Size (d)': effect,
                    'Target Standard Error': targetSE,
                    'Average Sample Size per Group': n,
                    'Alpha Level': alpha
                },
                formula: 'k = (z_alpha/2 / SE_target)^2 x v_bar',
                formulaExplanation: 'Where v_bar is the average within-study variance, calculated as 2/n + d^2/(2n)',
                steps: [
                    `Step 1: Calculate critical z-value for alpha = ${alpha}: z_alpha/2 = ${zAlpha.toFixed(4)}`,
                    `Step 2: Calculate within-study variance: v_bar = 2/${n} + ${effect}^2/(2 x ${n}) = ${withinVar.toFixed(6)}`,
                    `Step 3: Apply formula: k = (${zAlpha.toFixed(4)} / ${targetSE})^2 x ${withinVar.toFixed(6)}`,
                    `Step 4: Calculate: k = ${Math.pow(zAlpha/targetSE, 2).toFixed(4)} x ${withinVar.toFixed(6)} = ${k.toFixed(4)}`,
                    `Step 5: Round up to whole number: k = ${kCeiled} studies`
                ],
                results: {
                    'Expected Effect Size': effect.toFixed(3),
                    'Target Standard Error': targetSE.toFixed(4),
                    'Within-Study Variance': withinVar.toFixed(4),
                    'Average n per Group': n,
                    'Critical z-value': zAlpha.toFixed(3),
                    'Precision (95% CI width)': ciWidth.toFixed(4)
                },
                mainValue: kCeiled,
                mainLabel: 'Studies Needed (Fixed Effects)',
                interpretation: `A meta-analysis of approximately ${kCeiled} studies is needed to achieve the target precision (SE = ${targetSE}) for an effect size of ${effect} using a fixed effects model. This assumes homogeneous effects across all studies, meaning variation is attributed solely to sampling error.`,
                recommendations: [
                    'Ensure included studies are methodologically similar and measure the same construct',
                    'Consider pre-registration of your systematic review protocol',
                    'Plan for potential publication bias assessment (funnel plot, Egger\'s test)',
                    `With ${n} participants per group, each study should be adequately powered`,
                    'Document inclusion/exclusion criteria clearly before searching',
                    'Use PRISMA guidelines for reporting your systematic review'
                ]
            };

            displayResults(kCeiled, 'Studies Needed (Fixed Effects)', lastCalculation.results, 'fixed', { effect, n, alpha, targetSE });
        }

        function calculateRandomEffects() {
            const effect = parseFloat(document.getElementById('re_effect').value);
            const tau2 = parseFloat(document.getElementById('re_tau2').value);
            const n = parseFloat(document.getElementById('re_n').value);
            const power = parseFloat(document.getElementById('re_power').value);
            const alpha = parseFloat(document.getElementById('re_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);
            const withinVar = 2/n + (effect*effect)/(2*n);
            const k = (Math.pow(zAlpha + zBeta, 2) * (tau2 + withinVar)) / (effect * effect);
            const kCeiled = Math.ceil(k);
            const i2 = tau2 / (tau2 + withinVar) * 100;
            const totalVar = tau2 + withinVar;

            // Store calculation details for PDF
            lastCalculation = {
                type: 'random',
                analysisName: 'Number of Studies Needed (Random Effects Model)',
                inputParams: {
                    'Expected Effect Size (d)': effect,
                    'Between-Study Variance (tau^2)': tau2,
                    'Average Sample Size per Group': n,
                    'Desired Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: 'k = ((z_alpha/2 + z_beta)^2 x (tau^2 + v_bar)) / delta^2',
                formulaExplanation: 'This formula accounts for both within-study variance (v_bar) and between-study heterogeneity (tau^2)',
                steps: [
                    `Step 1: Calculate critical z-value for alpha = ${alpha}: z_alpha/2 = ${zAlpha.toFixed(4)}`,
                    `Step 2: Calculate z-value for power = ${(power*100).toFixed(0)}%: z_beta = ${zBeta.toFixed(4)}`,
                    `Step 3: Calculate within-study variance: v_bar = 2/${n} + ${effect}^2/(2 x ${n}) = ${withinVar.toFixed(6)}`,
                    `Step 4: Calculate total variance: tau^2 + v_bar = ${tau2} + ${withinVar.toFixed(6)} = ${totalVar.toFixed(6)}`,
                    `Step 5: Apply formula: k = (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 x ${totalVar.toFixed(6)} / ${effect}^2`,
                    `Step 6: Calculate: k = ${Math.pow(zAlpha + zBeta, 2).toFixed(4)} x ${totalVar.toFixed(6)} / ${(effect*effect).toFixed(6)} = ${k.toFixed(4)}`,
                    `Step 7: Round up to whole number: k = ${kCeiled} studies`
                ],
                results: {
                    'Expected Effect Size': effect.toFixed(3),
                    'Between-Study Variance (tau^2)': tau2.toFixed(4),
                    'Within-Study Variance': withinVar.toFixed(4),
                    'Estimated I-squared': i2.toFixed(1) + '%',
                    'Target Power': (power * 100).toFixed(0) + '%',
                    'Alpha Level': alpha
                },
                mainValue: kCeiled,
                mainLabel: 'Studies Needed (Random Effects)',
                interpretation: `Under random effects assumptions with tau-squared = ${tau2}, approximately ${kCeiled} studies are needed to achieve ${(power*100).toFixed(0)}% power to detect an effect of ${effect}. The estimated I-squared of ${i2.toFixed(1)}% indicates ${i2 < 30 ? 'low' : i2 < 60 ? 'moderate' : 'substantial'} heterogeneity, which increases the required sample size compared to a fixed effects model.`,
                recommendations: [
                    'Random effects model is generally preferred when studies come from different populations',
                    `With I-squared = ${i2.toFixed(1)}%, consider subgroup analyses to explore sources of heterogeneity`,
                    'Plan sensitivity analyses excluding outlier studies',
                    'Consider meta-regression if sufficient studies are available (typically k > 10)',
                    'Use prediction intervals in addition to confidence intervals for interpretation',
                    'Document your heterogeneity assessment strategy in the protocol'
                ]
            };

            displayResults(kCeiled, 'Studies Needed (Random Effects)', lastCalculation.results, 'random', { effect, tau2, n, alpha, power });
        }

        function calculateSamplePerStudy() {
            const k = parseFloat(document.getElementById('sp_k').value);
            const mcid = parseFloat(document.getElementById('sp_mcid').value);
            const power = parseFloat(document.getElementById('sp_power').value);
            const alpha = parseFloat(document.getElementById('sp_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const zBeta = normalQuantile(power);
            const n = (2 * Math.pow(zAlpha + zBeta, 2)) / (k * mcid * mcid);
            const nCeiled = Math.ceil(n);
            const totalN = nCeiled * 2 * k;

            // Store calculation details for PDF
            lastCalculation = {
                type: 'sample',
                analysisName: 'Sample Size per Study for Meta-Analysis',
                inputParams: {
                    'Number of Studies (k)': k,
                    'Minimum Clinically Important Difference (MCID)': mcid,
                    'Desired Power': (power * 100) + '%',
                    'Alpha Level': alpha
                },
                formula: 'n = 2(z_alpha/2 + z_beta)^2 / (k x d^2)',
                formulaExplanation: 'Given k studies, this calculates the required sample size per group in each study to detect the MCID with specified power',
                steps: [
                    `Step 1: Calculate critical z-value for alpha = ${alpha}: z_alpha/2 = ${zAlpha.toFixed(4)}`,
                    `Step 2: Calculate z-value for power = ${(power*100).toFixed(0)}%: z_beta = ${zBeta.toFixed(4)}`,
                    `Step 3: Calculate (z_alpha/2 + z_beta)^2 = (${zAlpha.toFixed(4)} + ${zBeta.toFixed(4)})^2 = ${Math.pow(zAlpha + zBeta, 2).toFixed(4)}`,
                    `Step 4: Apply formula: n = 2 x ${Math.pow(zAlpha + zBeta, 2).toFixed(4)} / (${k} x ${mcid}^2)`,
                    `Step 5: Calculate: n = ${(2 * Math.pow(zAlpha + zBeta, 2)).toFixed(4)} / ${(k * mcid * mcid).toFixed(6)} = ${n.toFixed(4)}`,
                    `Step 6: Round up to whole number: n = ${nCeiled} per group`,
                    `Step 7: Total participants per study: ${nCeiled} x 2 = ${nCeiled * 2}`,
                    `Step 8: Total across meta-analysis: ${nCeiled * 2} x ${k} = ${totalN} participants`
                ],
                results: {
                    'Number of Studies': k,
                    'Minimum Detectable Effect (MCID)': mcid.toFixed(3),
                    'Total Participants per Study': nCeiled * 2,
                    'Total Participants across Meta-Analysis': totalN,
                    'Target Power': (power * 100).toFixed(0) + '%',
                    'Alpha Level': alpha
                },
                mainValue: nCeiled,
                mainLabel: 'Sample Size per Group per Study',
                interpretation: `Each of the ${k} studies in the meta-analysis should include at least ${nCeiled} participants per group (${nCeiled * 2} total per study) to achieve ${(power*100).toFixed(0)}% power to detect an effect of ${mcid} (MCID). The total sample across all studies would be ${totalN} participants.`,
                recommendations: [
                    'Ensure each individual study is adequately powered for its primary outcome',
                    'Consider dropout rates when planning - typically add 10-20% to account for attrition',
                    'Document sample size calculations for each study in the protocol',
                    'Plan for standardized outcome measures across studies',
                    'Consider individual patient data (IPD) meta-analysis if feasible',
                    'Establish data sharing agreements early in the planning process'
                ]
            };

            displayResults(nCeiled, 'Sample Size per Group per Study', lastCalculation.results, 'sample', { k, mcid, power, alpha });
        }

        function calculateMetaPower() {
            const k = parseFloat(document.getElementById('mp_k').value);
            const effect = parseFloat(document.getElementById('mp_effect').value);
            const n = parseFloat(document.getElementById('mp_n').value);
            const tau2 = parseFloat(document.getElementById('mp_tau2').value);
            const alpha = parseFloat(document.getElementById('mp_alpha').value);

            const zAlpha = normalQuantile(1 - alpha/2);
            const withinVar = 2/n + (effect*effect)/(2*n);
            const totalVar = tau2 + withinVar/k;
            const se = Math.sqrt(totalVar);
            const ncp = effect / se;
            const power = normalCDF(ncp - zAlpha);
            const powerPct = (power * 100).toFixed(1);
            const i2 = tau2 / (tau2 + withinVar) * 100;

            // Store calculation details for PDF
            lastCalculation = {
                type: 'power',
                analysisName: 'Statistical Power of Meta-Analysis',
                inputParams: {
                    'Number of Studies (k)': k,
                    'Expected Effect Size (d)': effect,
                    'Average Sample Size per Group': n,
                    'Between-Study Variance (tau^2)': tau2,
                    'Alpha Level': alpha
                },
                formula: 'Power = Phi(delta x sqrt(k/v_bar) - z_alpha/2)',
                formulaExplanation: 'Where Phi is the standard normal CDF and the non-centrality parameter reflects the expected effect relative to the standard error',
                steps: [
                    `Step 1: Calculate critical z-value for alpha = ${alpha}: z_alpha/2 = ${zAlpha.toFixed(4)}`,
                    `Step 2: Calculate within-study variance: v_bar = 2/${n} + ${effect}^2/(2 x ${n}) = ${withinVar.toFixed(6)}`,
                    `Step 3: Calculate total variance: tau^2 + v_bar/k = ${tau2} + ${withinVar.toFixed(6)}/${k} = ${totalVar.toFixed(6)}`,
                    `Step 4: Calculate standard error: SE = sqrt(${totalVar.toFixed(6)}) = ${se.toFixed(6)}`,
                    `Step 5: Calculate non-centrality parameter: NCP = ${effect} / ${se.toFixed(6)} = ${ncp.toFixed(4)}`,
                    `Step 6: Calculate power: Power = Phi(${ncp.toFixed(4)} - ${zAlpha.toFixed(4)}) = Phi(${(ncp - zAlpha).toFixed(4)})`,
                    `Step 7: Result: Power = ${powerPct}%`
                ],
                results: {
                    'Number of Studies': k,
                    'Expected Effect Size': effect.toFixed(3),
                    'Between-Study Variance': tau2.toFixed(4),
                    'Estimated I-squared': i2.toFixed(1) + '%',
                    'Standard Error': se.toFixed(4),
                    'Non-Centrality Parameter': ncp.toFixed(3),
                    'Alpha Level': alpha
                },
                mainValue: powerPct + '%',
                mainLabel: 'Statistical Power',
                interpretation: power < 0.5
                    ? `The meta-analysis has very low power (${powerPct}%). This means there is less than a 50% chance of detecting a true effect of ${effect} if it exists. Consider including more studies or accepting that smaller effects may not be detectable.`
                    : power < 0.8
                    ? `The meta-analysis has moderate power (${powerPct}%). More studies would improve the ability to detect the expected effect of ${effect}. The current design may miss true effects.`
                    : `The meta-analysis has good power (${powerPct}%) to detect an effect size of ${effect}. This provides confidence that a significant result would likely be detected if the true effect exists.`,
                recommendations: power < 0.8
                    ? [
                        'Consider expanding search criteria to include more studies',
                        'Check for grey literature and unpublished studies',
                        'Consider contacting authors for unpublished data',
                        'Clearly report the power limitation in your discussion',
                        'Consider updating the meta-analysis when more studies are available',
                        'Focus interpretation on the effect size and confidence interval'
                    ]
                    : [
                        'Document the power calculation in your methods section',
                        'Proceed with confidence in the statistical validity of results',
                        'Still consider potential publication bias effects',
                        'Report both statistical significance and clinical significance',
                        'Consider sensitivity analyses to test robustness',
                        'Use GRADE approach for assessing quality of evidence'
                    ]
            };

            displayResults(powerPct + '%', 'Statistical Power', lastCalculation.results, 'power', { k, effect, n, tau2, alpha });
        }

        function calculateHeterogeneity() {
            const i2 = parseFloat(document.getElementById('het_i2').value) / 100;
            const k = parseFloat(document.getElementById('het_k').value);
            const n = parseFloat(document.getElementById('het_n').value);
            const effect = parseFloat(document.getElementById('het_effect').value);

            const withinVar = 2/n + (effect*effect)/(2*n);
            const tau2 = i2 * withinVar / (1 - i2 + 0.0001);
            const deNoHet = k * effect * effect / withinVar;
            const deWithHet = k * effect * effect / (tau2 + withinVar);
            const inflationFactor = deNoHet / deWithHet;
            const additionalStudies = Math.ceil(k * (inflationFactor - 1));
            const effectiveK = k / inflationFactor;

            // Store calculation details for PDF
            lastCalculation = {
                type: 'heterogeneity',
                analysisName: 'Heterogeneity Impact Analysis',
                inputParams: {
                    'Expected I-squared (%)': (i2 * 100).toFixed(1),
                    'Baseline Number of Studies': k,
                    'Average Sample Size per Group': n,
                    'Expected Effect Size (d)': effect
                },
                formula: 'Inflation Factor = (tau^2 + v_bar) / v_bar',
                formulaExplanation: 'tau^2 is derived from I^2 using: tau^2 = I^2 x v_bar / (1 - I^2)',
                steps: [
                    `Step 1: Calculate within-study variance: v_bar = 2/${n} + ${effect}^2/(2 x ${n}) = ${withinVar.toFixed(6)}`,
                    `Step 2: Convert I^2 to tau^2: tau^2 = ${(i2*100).toFixed(1)}% x ${withinVar.toFixed(6)} / (1 - ${(i2*100).toFixed(1)}%)`,
                    `Step 3: Calculate tau^2 = ${tau2.toFixed(6)}`,
                    `Step 4: Calculate design effect without heterogeneity: DE_no_het = ${k} x ${effect}^2 / ${withinVar.toFixed(6)} = ${deNoHet.toFixed(4)}`,
                    `Step 5: Calculate design effect with heterogeneity: DE_het = ${k} x ${effect}^2 / (${tau2.toFixed(6)} + ${withinVar.toFixed(6)}) = ${deWithHet.toFixed(4)}`,
                    `Step 6: Inflation factor = ${deNoHet.toFixed(4)} / ${deWithHet.toFixed(4)} = ${inflationFactor.toFixed(4)}`,
                    `Step 7: Additional studies needed = ${k} x (${inflationFactor.toFixed(4)} - 1) = ${additionalStudies}`
                ],
                results: {
                    'I-squared': (i2 * 100).toFixed(1) + '%',
                    'Estimated tau-squared': tau2.toFixed(4),
                    'Within-Study Variance': withinVar.toFixed(4),
                    'Effective k (with heterogeneity)': effectiveK.toFixed(1),
                    'Additional Studies Needed': additionalStudies
                },
                mainValue: inflationFactor.toFixed(2) + 'x',
                mainLabel: 'Sample Size Inflation Factor',
                interpretation: `With ${(i2*100).toFixed(0)}% heterogeneity (I-squared), you need approximately ${inflationFactor.toFixed(2)}x the number of studies compared to a homogeneous analysis. This means the effective number of studies is reduced from ${k} to approximately ${effectiveK.toFixed(1)}. ${i2 > 0.5 ? 'High heterogeneity substantially reduces the effective sample size and may indicate important differences between studies that should be explored.' : 'This level of heterogeneity is manageable but should still be investigated through subgroup analyses.'}`,
                recommendations: i2 > 0.5
                    ? [
                        'Investigate sources of heterogeneity through subgroup analyses',
                        'Consider meta-regression to identify moderating variables',
                        'Report prediction intervals alongside confidence intervals',
                        'Consider whether pooling is appropriate given high heterogeneity',
                        'Explore potential outlier studies using influence diagnostics',
                        'Document all sensitivity analyses in supplementary materials'
                    ]
                    : [
                        'The level of heterogeneity is acceptable for pooled analysis',
                        'Still report I-squared and tau-squared in results',
                        'Consider pre-specified subgroup analyses',
                        'Use random effects model as standard practice',
                        'Conduct sensitivity analyses to confirm robustness',
                        'Report the heterogeneity assessment method used'
                    ]
            };

            displayResults(inflationFactor.toFixed(2) + 'x', 'Sample Size Inflation Factor', lastCalculation.results, 'heterogeneity', { i2, k, n, effect, tau2 });
        }

        function displayResults(mainValue, mainLabel, details, type, params) {
            document.getElementById('results').classList.add('active');
            document.getElementById('mainValue').textContent = mainValue;
            document.getElementById('mainLabel').textContent = mainLabel;

            let subText = '';
            if (type === 'fixed' || type === 'random') {
                subText = `With ${params.n} participants per group in each study`;
            } else if (type === 'sample') {
                subText = `Across ${params.k} studies in the meta-analysis`;
            } else if (type === 'power') {
                subText = `For detecting effect size of ${params.effect}`;
            } else if (type === 'heterogeneity') {
                subText = `Due to ${(params.i2 * 100).toFixed(0)}% heterogeneity`;
            }
            document.getElementById('mainSub').textContent = subText;

            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            for (const [key, val] of Object.entries(details)) {
                grid.innerHTML += `
                    <div class="result-card">
                        <div class="result-card-label">${key}</div>
                        <div class="result-card-value">${val}</div>
                    </div>
                `;
            }

            // Display interpretation
            document.getElementById('interpretationText').textContent = lastCalculation.interpretation;

            // Display recommendations
            const recList = document.getElementById('recommendationsList');
            recList.innerHTML = '';
            lastCalculation.recommendations.forEach(rec => {
                recList.innerHTML += `<li>${rec}</li>`;
            });

            // Draw chart
            drawChart(type, params);

            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function drawChart(type, params) {
            const container = document.getElementById('chartContainer');
            const ctx = document.getElementById('analysisChart').getContext('2d');

            if (analysisChart) analysisChart.destroy();

            if (type === 'fixed' || type === 'random') {
                container.style.display = 'block';
                document.getElementById('chartTitle').textContent = 'Studies Needed vs. Effect Size';

                const labels = [];
                const data = [];

                for (let d = 0.1; d <= 1.0; d += 0.1) {
                    labels.push(d.toFixed(1));
                    const withinVar = 2/params.n + (d*d)/(2*params.n);

                    if (type === 'fixed') {
                        const zAlpha = normalQuantile(1 - params.alpha/2);
                        const targetSE = params.targetSE || 0.05;
                        const k = Math.pow(zAlpha/targetSE, 2) * withinVar;
                        data.push(Math.ceil(k));
                    } else {
                        const zAlpha = normalQuantile(1 - params.alpha/2);
                        const zBeta = normalQuantile(params.power);
                        const k = (Math.pow(zAlpha + zBeta, 2) * (params.tau2 + withinVar)) / (d * d);
                        data.push(Math.ceil(k));
                    }
                }

                analysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Studies Needed',
                            data: data,
                            borderColor: '#6366F1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Effect Size (d)' } },
                            y: { title: { display: true, text: 'Number of Studies' }, min: 0 }
                        }
                    }
                });
            } else if (type === 'heterogeneity') {
                container.style.display = 'block';
                document.getElementById('chartTitle').textContent = 'Impact of Heterogeneity on Required Studies';

                const labels = ['0%', '25%', '50%', '75%', '90%'];
                const i2Values = [0, 0.25, 0.50, 0.75, 0.90];
                const data = [];

                const withinVar = 2/params.n + (params.effect*params.effect)/(2*params.n);

                i2Values.forEach(i2 => {
                    const tau2 = i2 * withinVar / (1 - i2 + 0.0001);
                    const factor = (tau2 + withinVar) / withinVar;
                    data.push((params.k * factor).toFixed(1));
                });

                analysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Effective Studies Needed',
                            data: data,
                            backgroundColor: ['#10B981', '#84CC16', '#F59E0B', '#EF4444', '#DC2626'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'I-squared (Heterogeneity)' } },
                            y: { title: { display: true, text: 'Effective Studies Needed' }, min: 0 }
                        }
                    }
                });
            } else if (type === 'power') {
                container.style.display = 'block';
                document.getElementById('chartTitle').textContent = 'Power vs. Number of Studies';

                const labels = [];
                const data = [];
                const zAlpha = normalQuantile(1 - params.alpha/2);
                const withinVar = 2/params.n + (params.effect*params.effect)/(2*params.n);

                for (let kVal = 5; kVal <= 50; kVal += 5) {
                    labels.push(kVal.toString());
                    const totalVar = params.tau2 + withinVar/kVal;
                    const se = Math.sqrt(totalVar);
                    const ncp = params.effect / se;
                    const powerVal = normalCDF(ncp - zAlpha) * 100;
                    data.push(powerVal.toFixed(1));
                }

                analysisChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Power (%)',
                            data: data,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Number of Studies (k)' } },
                            y: { title: { display: true, text: 'Statistical Power (%)' }, min: 0, max: 100 }
                        }
                    }
                });
            } else {
                container.style.display = 'none';
            }
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('karmastat-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                document.getElementById('themeIcon').innerHTML = saved === 'dark' ? '&#9728;' : '&#9790;';
            }
        });

        function exportToPDF() {
            if (!lastCalculation.type) {
                alert('Please perform a calculation first before exporting.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pdfTheme = document.getElementById('pdfTheme').value;

            // Theme colors
            const isDarkTheme = pdfTheme === 'dark';
            const bgColor = isDarkTheme ? [30, 27, 75] : [255, 255, 255];
            const headerBgColor = isDarkTheme ? [49, 46, 129] : [99, 102, 241];
            const textColor = isDarkTheme ? [243, 244, 246] : [31, 41, 55];
            const mutedColor = isDarkTheme ? [156, 163, 175] : [107, 114, 128];
            const accentColor = [99, 102, 241];
            const successColor = [16, 185, 129];

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            let yPos = 0;

            // Background for dark theme
            if (isDarkTheme) {
                doc.setFillColor(...bgColor);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
            }

            // === HEADER SECTION ===
            doc.setFillColor(...headerBgColor);
            doc.rect(0, 0, pageWidth, 45, 'F');

            // Logo circle
            doc.setFillColor(255, 255, 255);
            doc.circle(25, 22, 10, 'F');
            doc.setFontSize(14);
            doc.setTextColor(...accentColor);
            doc.setFont('helvetica', 'bold');
            doc.text('K', 22, 26);

            // Title
            doc.setFontSize(22);
            doc.setTextColor(255, 255, 255);
            doc.text('KARMASTAT', 40, 20);

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('Meta-Analysis Sample Size Calculator', 40, 28);

            doc.setFontSize(9);
            doc.text('Professional Statistical Analysis Report', 40, 36);

            yPos = 55;

            // === ANALYSIS TYPE ===
            doc.setFillColor(...(isDarkTheme ? [67, 56, 202] : [224, 231, 255]));
            doc.roundedRect(margin, yPos, pageWidth - 2*margin, 12, 3, 3, 'F');
            doc.setFontSize(12);
            doc.setTextColor(...accentColor);
            doc.setFont('helvetica', 'bold');
            doc.text(lastCalculation.analysisName, margin + 5, yPos + 8);
            yPos += 20;

            // === INPUT PARAMETERS ===
            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Input Parameters', margin, yPos);
            yPos += 2;
            doc.setDrawColor(...accentColor);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos, margin + 40, yPos);
            yPos += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            for (const [key, value] of Object.entries(lastCalculation.inputParams)) {
                doc.setTextColor(...mutedColor);
                doc.text(key + ':', margin + 5, yPos);
                doc.setTextColor(...textColor);
                doc.text(String(value), margin + 80, yPos);
                yPos += 6;
            }
            yPos += 5;

            // === FORMULA ===
            doc.setFillColor(...(isDarkTheme ? [55, 48, 163] : [238, 242, 255]));
            doc.roundedRect(margin, yPos, pageWidth - 2*margin, 20, 3, 3, 'F');
            doc.setFontSize(11);
            doc.setTextColor(...accentColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Formula:', margin + 5, yPos + 7);
            doc.setFont('courier', 'normal');
            doc.setTextColor(...textColor);
            doc.text(lastCalculation.formula, margin + 5, yPos + 14);
            yPos += 28;

            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(...mutedColor);
            const explanationLines = doc.splitTextToSize(lastCalculation.formulaExplanation, pageWidth - 2*margin - 10);
            doc.text(explanationLines, margin + 5, yPos);
            yPos += explanationLines.length * 5 + 8;

            // === STEP-BY-STEP CALCULATION ===
            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Step-by-Step Calculation', margin, yPos);
            yPos += 2;
            doc.setDrawColor(...accentColor);
            doc.line(margin, yPos, margin + 55, yPos);
            yPos += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            lastCalculation.steps.forEach((step, index) => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    if (isDarkTheme) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    yPos = 20;
                }
                doc.setTextColor(...mutedColor);
                const stepLines = doc.splitTextToSize(step, pageWidth - 2*margin - 10);
                doc.text(stepLines, margin + 5, yPos);
                yPos += stepLines.length * 4 + 3;
            });
            yPos += 5;

            // === MAIN RESULT ===
            if (yPos > pageHeight - 60) {
                doc.addPage();
                if (isDarkTheme) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                }
                yPos = 20;
            }

            doc.setFillColor(...headerBgColor);
            doc.roundedRect(margin, yPos, pageWidth - 2*margin, 30, 5, 5, 'F');
            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text(String(lastCalculation.mainValue), pageWidth/2, yPos + 14, { align: 'center' });
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(lastCalculation.mainLabel, pageWidth/2, yPos + 24, { align: 'center' });
            yPos += 40;

            // === DETAILED RESULTS ===
            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Detailed Results', margin, yPos);
            yPos += 2;
            doc.setDrawColor(...accentColor);
            doc.line(margin, yPos, margin + 40, yPos);
            yPos += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const resultEntries = Object.entries(lastCalculation.results);
            const colWidth = (pageWidth - 2*margin) / 2;

            resultEntries.forEach((entry, index) => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    if (isDarkTheme) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    yPos = 20;
                }
                const col = index % 2;
                const xPos = margin + col * colWidth;

                doc.setFillColor(...(isDarkTheme ? [49, 46, 129] : [238, 242, 255]));
                doc.roundedRect(xPos, yPos - 4, colWidth - 5, 14, 2, 2, 'F');

                doc.setTextColor(...mutedColor);
                doc.setFontSize(8);
                doc.text(entry[0], xPos + 3, yPos + 2);
                doc.setTextColor(...accentColor);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(String(entry[1]), xPos + 3, yPos + 8);
                doc.setFont('helvetica', 'normal');

                if (col === 1) yPos += 18;
            });
            if (resultEntries.length % 2 === 1) yPos += 18;
            yPos += 5;

            // === INTERPRETATION ===
            if (yPos > pageHeight - 50) {
                doc.addPage();
                if (isDarkTheme) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                }
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Interpretation', margin, yPos);
            yPos += 2;
            doc.setDrawColor(...successColor);
            doc.setLineWidth(1);
            doc.line(margin, yPos, margin + 3, yPos);
            doc.setLineWidth(0.5);
            yPos += 6;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            const interpLines = doc.splitTextToSize(lastCalculation.interpretation, pageWidth - 2*margin - 10);
            interpLines.forEach(line => {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    if (isDarkTheme) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    yPos = 20;
                }
                doc.text(line, margin + 5, yPos);
                yPos += 5;
            });
            yPos += 8;

            // === RECOMMENDATIONS ===
            if (yPos > pageHeight - 60) {
                doc.addPage();
                if (isDarkTheme) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                }
                yPos = 20;
            }

            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont('helvetica', 'bold');
            doc.text('Recommendations for Systematic Review Planning', margin, yPos);
            yPos += 2;
            doc.setDrawColor(...accentColor);
            doc.line(margin, yPos, margin + 85, yPos);
            yPos += 8;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            lastCalculation.recommendations.forEach((rec, index) => {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    if (isDarkTheme) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    }
                    yPos = 20;
                }
                doc.setTextColor(...accentColor);
                doc.text((index + 1) + '.', margin + 3, yPos);
                doc.setTextColor(...textColor);
                const recLines = doc.splitTextToSize(rec, pageWidth - 2*margin - 15);
                doc.text(recLines, margin + 12, yPos);
                yPos += recLines.length * 4 + 3;
            });
            yPos += 8;

            // === REFERENCES ===
            if (yPos > pageHeight - 60) {
                doc.addPage();
                if (isDarkTheme) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                }
                yPos = 20;
            }

            doc.setFillColor(...(isDarkTheme ? [49, 46, 129] : [238, 242, 255]));
            doc.roundedRect(margin, yPos, pageWidth - 2*margin, 55, 3, 3, 'F');

            doc.setFontSize(10);
            doc.setTextColor(...accentColor);
            doc.setFont('helvetica', 'bold');
            doc.text('References', margin + 5, yPos + 8);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(...mutedColor);

            const references = [
                'Borenstein, M., Hedges, L. V., Higgins, J. P., & Rothstein, H. R. (2009). Introduction to Meta-Analysis. Wiley.',
                'Hedges, L. V., & Pigott, T. D. (2001). The power of statistical tests in meta-analysis. Psychological Methods, 6(3), 203-217.',
                'Higgins, J. P., & Thompson, S. G. (2002). Quantifying heterogeneity in a meta-analysis. Statistics in Medicine, 21(11), 1539-1558.',
                'Hedges, L. V., & Pigott, T. D. (2004). The power of statistical tests for moderators in meta-analysis. Psychological Methods, 9(4), 426-445.'
            ];

            let refY = yPos + 15;
            references.forEach(ref => {
                const refLines = doc.splitTextToSize('- ' + ref, pageWidth - 2*margin - 15);
                doc.text(refLines, margin + 5, refY);
                refY += refLines.length * 3.5 + 2;
            });

            yPos += 62;

            // === FOOTER ===
            const addFooter = (pageNum) => {
                doc.setFillColor(...headerBgColor);
                doc.rect(0, pageHeight - 25, pageWidth, 25, 'F');

                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('Generated by KARMASTAT - Crafted by Karmayogi', pageWidth/2, pageHeight - 16, { align: 'center' });

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                const timestamp = new Date().toLocaleString('en-US', {
                    dateStyle: 'full',
                    timeStyle: 'short'
                });
                doc.text(timestamp, pageWidth/2, pageHeight - 10, { align: 'center' });

                doc.setFontSize(8);
                doc.text('Page ' + pageNum, pageWidth - margin, pageHeight - 10, { align: 'right' });
            };

            // Add footer to all pages
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                addFooter(i);
            }

            // Save the PDF
            const filename = `KARMASTAT_MetaAnalysis_${lastCalculation.type}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
