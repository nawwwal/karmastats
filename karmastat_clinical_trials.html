<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Clinical Trials Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #F59E0B;
            --primary-dark: #D97706;
            --primary-light: #FBBF24;
            --secondary: #B45309;
            --accent: #FEF3C7;
            --success: #10B981;
            --warning: #EF4444;
            --danger: #DC2626;
            --info: #3B82F6;

            --bg-primary: #FFFFFF;
            --bg-secondary: #FFFBEB;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
            --shadow-hover: 0 8px 25px rgba(245, 158, 11, 0.25);

            --gradient-primary: linear-gradient(135deg, #F59E0B, #FBBF24, #FCD34D);
            --gradient-secondary: linear-gradient(135deg, #B45309, #D97706, #F59E0B);
            --gradient-bg: linear-gradient(135deg, #FFFBEB, #FEF3C7, #FDE68A);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #FFFBEB);

            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        [data-theme="dark"] {
            --bg-primary: #1C1917;
            --bg-secondary: #292524;
            --bg-card: #292524;
            --text-primary: #F3F4F6;
            --text-secondary: #D1D5DB;
            --text-muted: #9CA3AF;
            --border-color: #57534E;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1C1917, #292524, #3D3530);
            --gradient-card: linear-gradient(145deg, #292524, #3D3530);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        .header {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .back-link {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Trial Type Selection */
        .trial-selection {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .trial-selection h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .trial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .trial-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            position: relative;
        }

        .trial-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .trial-card.active {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        .trial-card.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .trial-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .trial-card-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .trial-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Calculator Section */
        .calculator-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .calculator-section.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Outcome Type Tabs */
        .outcome-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: var(--radius);
        }

        .outcome-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .outcome-tab:hover {
            background: var(--bg-card);
        }

        .outcome-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Formula Display */
        .formula-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .formula-toggle {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .formula-toggle:hover {
            background: var(--bg-secondary);
        }

        .formula-toggle-icon {
            margin-right: 0.75rem;
            transition: transform 0.3s ease;
            color: var(--primary);
        }

        .formula-toggle.active .formula-toggle-icon {
            transform: rotate(90deg);
        }

        .formula-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .formula-content.active {
            max-height: 1000px;
        }

        .formula-display {
            background: var(--gradient-secondary);
            color: white;
            padding: 1.5rem;
            margin: 1rem;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            text-align: center;
            border-radius: var(--radius);
        }

        .formula-explanation {
            padding: 1rem 1.5rem;
        }

        .formula-explanation ul {
            list-style: none;
        }

        .formula-explanation li {
            padding: 0.5rem 0;
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .formula-explanation li:last-child {
            border-bottom: none;
        }

        .formula-var {
            font-family: var(--font-mono);
            font-weight: bold;
            color: var(--primary);
            min-width: 120px;
        }

        /* Input Grid */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group label .help-icon {
            cursor: help;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Button Group */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .reset-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .reset-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Results Section */
        .results-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .results-title h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .sample-size-display {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .sample-size-value {
            font-size: 4rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .sample-size-label {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
            font-weight: 500;
        }

        .sample-breakdown {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .breakdown-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }

        .breakdown-value {
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }

        .breakdown-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .result-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Interpretation Guide */
        .interpretation-guide {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .interpretation-guide h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .interpretation-guide p {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* ICH Compliance Section */
        .ich-compliance {
            background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
            border: 1px solid #93C5FD;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        [data-theme="dark"] .ich-compliance {
            background: linear-gradient(135deg, #1E3A5F, #1E40AF);
            border-color: #3B82F6;
        }

        .ich-compliance h4 {
            color: #1D4ED8;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        [data-theme="dark"] .ich-compliance h4 {
            color: #60A5FA;
        }

        .ich-compliance ul {
            list-style: none;
            margin-left: 0;
        }

        .ich-compliance li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--text-secondary);
        }

        .ich-compliance li::before {
            content: '\2713';
            position: absolute;
            left: 0;
            color: #10B981;
            font-weight: bold;
        }

        /* Navigation Links */
        .nav-links {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .nav-links h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .nav-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .nav-link {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Footer */
        .footer {
            background: var(--gradient-secondary);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
        }

        .footer-love {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .footer-blessing {
            color: var(--accent);
            font-weight: 500;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-hover);
        }

        .modal h3 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-option:hover {
            border-color: var(--primary);
        }

        .modal-option input {
            margin-right: 1rem;
        }

        .modal-option-content {
            flex: 1;
        }

        .modal-option-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-option-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-btn-cancel {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn-export {
            background: var(--gradient-primary);
            border: none;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .logo { flex-direction: column; gap: 1rem; }
            .back-link, .theme-toggle {
                position: static;
                margin: 0.5rem;
            }
            .header { padding-top: 4rem; }
            .trial-grid { grid-template-columns: 1fr; }
            .sample-size-value { font-size: 3rem; }
            .sample-breakdown { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="index.html" class="back-link">
                <span>&#8592;</span> Back to Main
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">&#9790;</span> Theme
            </button>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <div class="logo">
                <div>
                    <h1>Clinical Trials Sample Size Calculator</h1>
                    <p class="subtitle">Calculate sample sizes for Superiority, Non-inferiority, and Equivalence trials</p>
                </div>
            </div>
        </header>

        <!-- Navigation Links -->
        <section class="nav-links">
            <h4>Other Calculators:</h4>
            <div class="nav-grid">
                <a href="karmastat_power_analysis.html" class="nav-link">Power Analysis</a>
                <a href="karmastat_diagnostic.html" class="nav-link">Diagnostic Tests</a>
                <a href="karmastat_survival.html" class="nav-link">Survival Analysis</a>
                <a href="karmastat_bayesian.html" class="nav-link">Bayesian Analysis</a>
                <a href="karmastat_effect_size.html" class="nav-link">Effect Size</a>
                <a href="karmastat_meta_analysis.html" class="nav-link">Meta-Analysis</a>
            </div>
        </section>

        <!-- Trial Type Selection -->
        <section class="trial-selection">
            <h2>Select Trial Design Type</h2>
            <div class="trial-grid">
                <div class="trial-card active" data-trial="superiority" onclick="selectTrial('superiority')">
                    <div class="trial-card-icon">&#128200;</div>
                    <div class="trial-card-title">Superiority Trial</div>
                    <div class="trial-card-desc">Test if treatment is better than control (Binary or Continuous outcomes)</div>
                </div>
                <div class="trial-card" data-trial="noninferiority" onclick="selectTrial('noninferiority')">
                    <div class="trial-card-icon">&#8776;</div>
                    <div class="trial-card-title">Non-inferiority Trial</div>
                    <div class="trial-card-desc">Test if treatment is not worse than control by a specified margin</div>
                </div>
                <div class="trial-card" data-trial="equivalence" onclick="selectTrial('equivalence')">
                    <div class="trial-card-icon">&#8801;</div>
                    <div class="trial-card-title">Equivalence Trial</div>
                    <div class="trial-card-desc">Test if two treatments have equivalent effects within a margin</div>
                </div>
            </div>
        </section>

        <!-- Superiority Trial Calculator -->
        <section class="calculator-section active" id="superiority-calc">
            <div class="section-header">
                <div class="section-icon">&#128200;</div>
                <h3>Superiority Trial Sample Size</h3>
            </div>

            <!-- Outcome Type Tabs -->
            <div class="outcome-tabs">
                <button class="outcome-tab active" onclick="selectOutcome('binary')" id="tab-binary">Binary Outcome</button>
                <button class="outcome-tab" onclick="selectOutcome('continuous')" id="tab-continuous">Continuous Outcome</button>
            </div>

            <!-- Binary Outcome -->
            <div id="binary-inputs">
                <div class="formula-container">
                    <div class="formula-toggle" onclick="toggleFormula(this)">
                        <span class="formula-toggle-icon">&#9654;</span>
                        View Statistical Formula & Explanation
                    </div>
                    <div class="formula-content">
                        <div class="formula-display">
                            n = [(Z<sub>1-&#945;/2</sub> + Z<sub>1-&#946;</sub>)&#178; &times; (p&#8321;(1-p&#8321;) + p&#8322;(1-p&#8322;))] / (p&#8321; - p&#8322;)&#178;
                        </div>
                        <div class="formula-explanation">
                            <ul>
                                <li><span class="formula-var">n</span><span>Sample size per group</span></li>
                                <li><span class="formula-var">Z<sub>1-&#945;/2</sub></span><span>Z-value for two-sided Type I error</span></li>
                                <li><span class="formula-var">Z<sub>1-&#946;</sub></span><span>Z-value for desired power (1-&#946;)</span></li>
                                <li><span class="formula-var">p&#8321;</span><span>Expected proportion in treatment group</span></li>
                                <li><span class="formula-var">p&#8322;</span><span>Expected proportion in control group</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="input-grid">
                    <div class="input-group">
                        <label>Control Group Rate (p<sub>2</sub>) <span class="help-icon" title="Expected event rate in control group">&#9432;</span></label>
                        <input type="number" id="sup_p2" value="0.30" min="0.01" max="0.99" step="0.01">
                        <span class="input-hint">Enter as decimal (e.g., 0.30 for 30%)</span>
                    </div>
                    <div class="input-group">
                        <label>Treatment Group Rate (p<sub>1</sub>) <span class="help-icon" title="Expected event rate in treatment group">&#9432;</span></label>
                        <input type="number" id="sup_p1" value="0.20" min="0.01" max="0.99" step="0.01">
                        <span class="input-hint">Enter as decimal (e.g., 0.20 for 20%)</span>
                    </div>
                    <div class="input-group">
                        <label>Significance Level (&#945;) <span class="help-icon" title="Two-sided Type I error rate">&#9432;</span></label>
                        <select id="sup_alpha">
                            <option value="0.01">0.01 (1%)</option>
                            <option value="0.05" selected>0.05 (5%)</option>
                            <option value="0.10">0.10 (10%)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Power (1-&#946;) <span class="help-icon" title="Probability of detecting a true effect">&#9432;</span></label>
                        <select id="sup_power">
                            <option value="0.80">80%</option>
                            <option value="0.85">85%</option>
                            <option value="0.90" selected>90%</option>
                            <option value="0.95">95%</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Allocation Ratio <span class="help-icon" title="Ratio of treatment to control (1 = equal, 2 = 2:1)">&#9432;</span></label>
                        <input type="number" id="sup_ratio" value="1" min="0.5" max="4" step="0.5">
                        <span class="input-hint">1 = equal allocation, 2 = 2:1 treatment:control</span>
                    </div>
                    <div class="input-group">
                        <label>Dropout Rate (%) <span class="help-icon" title="Expected dropout/loss to follow-up rate">&#9432;</span></label>
                        <input type="number" id="sup_dropout" value="10" min="0" max="50" step="1">
                        <span class="input-hint">Adjust for anticipated dropouts</span>
                    </div>
                </div>
            </div>

            <!-- Continuous Outcome -->
            <div id="continuous-inputs" style="display: none;">
                <div class="formula-container">
                    <div class="formula-toggle" onclick="toggleFormula(this)">
                        <span class="formula-toggle-icon">&#9654;</span>
                        View Statistical Formula & Explanation
                    </div>
                    <div class="formula-content">
                        <div class="formula-display">
                            n = [(Z<sub>1-&#945;/2</sub> + Z<sub>1-&#946;</sub>)&#178; &times; 2&#963;&#178;] / &#916;&#178;
                        </div>
                        <div class="formula-explanation">
                            <ul>
                                <li><span class="formula-var">n</span><span>Sample size per group</span></li>
                                <li><span class="formula-var">Z<sub>1-&#945;/2</sub></span><span>Z-value for two-sided Type I error</span></li>
                                <li><span class="formula-var">Z<sub>1-&#946;</sub></span><span>Z-value for desired power</span></li>
                                <li><span class="formula-var">&#963;</span><span>Standard deviation (assumed equal in both groups)</span></li>
                                <li><span class="formula-var">&#916;</span><span>Clinically meaningful mean difference to detect</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="input-grid">
                    <div class="input-group">
                        <label>Mean Difference (&#916;) <span class="help-icon" title="Clinically meaningful difference to detect">&#9432;</span></label>
                        <input type="number" id="sup_cont_delta" value="5" min="0.01" step="0.1">
                        <span class="input-hint">Minimum clinically important difference</span>
                    </div>
                    <div class="input-group">
                        <label>Standard Deviation (&#963;) <span class="help-icon" title="Common SD in both groups">&#9432;</span></label>
                        <input type="number" id="sup_cont_sd" value="10" min="0.01" step="0.1">
                        <span class="input-hint">From pilot data or literature</span>
                    </div>
                    <div class="input-group">
                        <label>Significance Level (&#945;)</label>
                        <select id="sup_cont_alpha">
                            <option value="0.01">0.01 (1%)</option>
                            <option value="0.05" selected>0.05 (5%)</option>
                            <option value="0.10">0.10 (10%)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Power (1-&#946;)</label>
                        <select id="sup_cont_power">
                            <option value="0.80">80%</option>
                            <option value="0.85">85%</option>
                            <option value="0.90" selected>90%</option>
                            <option value="0.95">95%</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Allocation Ratio</label>
                        <input type="number" id="sup_cont_ratio" value="1" min="0.5" max="4" step="0.5">
                        <span class="input-hint">1 = equal allocation</span>
                    </div>
                    <div class="input-group">
                        <label>Dropout Rate (%)</label>
                        <input type="number" id="sup_cont_dropout" value="10" min="0" max="50" step="1">
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="calculate-btn" onclick="calculateSuperiority(this)">
                    <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="reset-btn" onclick="resetCalculator('superiority')">
                    <span>&#8634;</span> Reset
                </button>
            </div>
        </section>

        <!-- Non-inferiority Trial Calculator -->
        <section class="calculator-section" id="noninferiority-calc">
            <div class="section-header">
                <div class="section-icon">&#8776;</div>
                <h3>Non-inferiority Trial Sample Size</h3>
            </div>

            <div class="formula-container">
                <div class="formula-toggle" onclick="toggleFormula(this)">
                    <span class="formula-toggle-icon">&#9654;</span>
                    View Statistical Formula & Explanation
                </div>
                <div class="formula-content">
                    <div class="formula-display">
                        n = [(Z<sub>1-&#945;</sub> + Z<sub>1-&#946;</sub>)&#178; &times; (p&#8321;(1-p&#8321;) + p&#8322;(1-p&#8322;))] / (p&#8321; - p&#8322; + &#948;)&#178;
                    </div>
                    <div class="formula-explanation">
                        <ul>
                            <li><span class="formula-var">n</span><span>Sample size per group</span></li>
                            <li><span class="formula-var">Z<sub>1-&#945;</sub></span><span>Z-value for one-sided Type I error</span></li>
                            <li><span class="formula-var">Z<sub>1-&#946;</sub></span><span>Z-value for desired power</span></li>
                            <li><span class="formula-var">&#948;</span><span>Non-inferiority margin (clinically acceptable difference)</span></li>
                            <li><span class="formula-var">p&#8321;, p&#8322;</span><span>Expected rates in treatment and control groups</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Control Group Rate (p<sub>2</sub>) <span class="help-icon" title="Expected rate in active control">&#9432;</span></label>
                    <input type="number" id="ni_p2" value="0.70" min="0.01" max="0.99" step="0.01">
                    <span class="input-hint">Active control response rate</span>
                </div>
                <div class="input-group">
                    <label>Treatment Group Rate (p<sub>1</sub>) <span class="help-icon" title="Expected rate in new treatment">&#9432;</span></label>
                    <input type="number" id="ni_p1" value="0.70" min="0.01" max="0.99" step="0.01">
                    <span class="input-hint">Assumed equal or slightly less</span>
                </div>
                <div class="input-group">
                    <label>Non-inferiority Margin (&#948;) <span class="help-icon" title="Maximum acceptable difference">&#9432;</span></label>
                    <input type="number" id="ni_margin" value="0.10" min="0.01" max="0.30" step="0.01">
                    <span class="input-hint">Typically 10-15% of control rate</span>
                </div>
                <div class="input-group">
                    <label>Significance Level (&#945;, one-sided) <span class="help-icon" title="One-sided Type I error">&#9432;</span></label>
                    <select id="ni_alpha">
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.025" selected>0.025 (2.5%)</option>
                        <option value="0.05">0.05 (5%)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Power (1-&#946;)</label>
                    <select id="ni_power">
                        <option value="0.80">80%</option>
                        <option value="0.85">85%</option>
                        <option value="0.90" selected>90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Dropout Rate (%)</label>
                    <input type="number" id="ni_dropout" value="10" min="0" max="50" step="1">
                </div>
            </div>

            <div class="button-group">
                <button class="calculate-btn" onclick="calculateNonInferiority(this)">
                    <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="reset-btn" onclick="resetCalculator('noninferiority')">
                    <span>&#8634;</span> Reset
                </button>
            </div>
        </section>

        <!-- Equivalence Trial Calculator -->
        <section class="calculator-section" id="equivalence-calc">
            <div class="section-header">
                <div class="section-icon">&#8801;</div>
                <h3>Equivalence Trial Sample Size</h3>
            </div>

            <div class="formula-container">
                <div class="formula-toggle" onclick="toggleFormula(this)">
                    <span class="formula-toggle-icon">&#9654;</span>
                    View Statistical Formula & Explanation
                </div>
                <div class="formula-content">
                    <div class="formula-display">
                        n = [(Z<sub>1-&#945;</sub> + Z<sub>1-&#946;/2</sub>)&#178; &times; (p&#8321;(1-p&#8321;) + p&#8322;(1-p&#8322;))] / (&#948; - |p&#8321; - p&#8322;|)&#178;
                    </div>
                    <div class="formula-explanation">
                        <ul>
                            <li><span class="formula-var">n</span><span>Sample size per group</span></li>
                            <li><span class="formula-var">Z<sub>1-&#945;</sub></span><span>Z-value for Type I error (for TOST procedure)</span></li>
                            <li><span class="formula-var">Z<sub>1-&#946;/2</sub></span><span>Z-value adjusted for two one-sided tests</span></li>
                            <li><span class="formula-var">&#948;</span><span>Equivalence margin (symmetric: -&#948; to +&#948;)</span></li>
                            <li><span class="formula-var">p&#8321;, p&#8322;</span><span>Expected rates in test and reference groups</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Reference Rate (p<sub>2</sub>) <span class="help-icon" title="Expected rate in reference treatment">&#9432;</span></label>
                    <input type="number" id="eq_p2" value="0.50" min="0.01" max="0.99" step="0.01">
                    <span class="input-hint">Reference/standard treatment rate</span>
                </div>
                <div class="input-group">
                    <label>Test Rate (p<sub>1</sub>) <span class="help-icon" title="Expected rate in test treatment">&#9432;</span></label>
                    <input type="number" id="eq_p1" value="0.50" min="0.01" max="0.99" step="0.01">
                    <span class="input-hint">Usually assumed equal for equivalence</span>
                </div>
                <div class="input-group">
                    <label>Equivalence Margin (&#948;) <span class="help-icon" title="Symmetric margin for equivalence">&#9432;</span></label>
                    <input type="number" id="eq_margin" value="0.15" min="0.01" max="0.30" step="0.01">
                    <span class="input-hint">Both -&#948; and +&#948; boundaries</span>
                </div>
                <div class="input-group">
                    <label>Significance Level (&#945;) <span class="help-icon" title="For TOST procedure">&#9432;</span></label>
                    <select id="eq_alpha">
                        <option value="0.01">0.01 (1%)</option>
                        <option value="0.05" selected>0.05 (5%)</option>
                        <option value="0.10">0.10 (10%)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Power (1-&#946;)</label>
                    <select id="eq_power">
                        <option value="0.80">80%</option>
                        <option value="0.85">85%</option>
                        <option value="0.90" selected>90%</option>
                        <option value="0.95">95%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Dropout Rate (%)</label>
                    <input type="number" id="eq_dropout" value="10" min="0" max="50" step="1">
                </div>
            </div>

            <div class="button-group">
                <button class="calculate-btn" onclick="calculateEquivalence(this)">
                    <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                    <span class="karma-spinner">
                        <svg viewBox="0 0 24 24">
                            <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                    </span>
                </button>
                <button class="reset-btn" onclick="resetCalculator('equivalence')">
                    <span>&#8634;</span> Reset
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results">
            <div class="results-header">
                <div class="results-title">
                    <div class="section-icon">&#9989;</div>
                    <h3>Sample Size Results</h3>
                </div>
                <button class="export-btn" onclick="openExportModal()">
                    <span>&#128196;</span> Export PDF
                </button>
            </div>

            <div class="sample-size-display" id="sampleSizeDisplay">
                <div class="sample-size-value" id="totalSampleSize">--</div>
                <div class="sample-size-label">Total Sample Size Required</div>
                <div class="sample-breakdown">
                    <div class="breakdown-item">
                        <div class="breakdown-value" id="treatmentSize">--</div>
                        <div class="breakdown-label">Treatment Group</div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-value" id="controlSize">--</div>
                        <div class="breakdown-label">Control Group</div>
                    </div>
                </div>
            </div>

            <div class="results-grid" id="resultsGrid">
                <!-- Dynamic results will be inserted here -->
            </div>

            <div class="interpretation-guide" id="interpretationGuide">
                <h4>Interpretation</h4>
                <p id="interpretationText"></p>
            </div>

            <div class="ich-compliance">
                <h4>&#128203; ICH E9 Compliance Recommendations</h4>
                <ul id="ichRecommendations">
                    <li>Document all sample size assumptions in the statistical analysis plan</li>
                    <li>Pre-specify primary and secondary endpoints</li>
                    <li>Account for multiplicity adjustments if applicable</li>
                    <li>Consider interim analyses and adaptive designs</li>
                    <li>Plan for missing data handling strategies</li>
                </ul>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-love">Crafted with &#10084; by Karmayogi</div>
            <div class="footer-blessing">&#128591; Jai Shri Ram &#128591;</div>
        </footer>
    </div>

    <!-- PDF Theme Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>Export PDF Report</h3>
            <div class="modal-options">
                <label class="modal-option">
                    <input type="radio" name="pdfTheme" value="light" checked>
                    <div class="modal-option-content">
                        <div class="modal-option-title">Light Theme</div>
                        <div class="modal-option-desc">Clean white background with dark text</div>
                    </div>
                </label>
                <label class="modal-option">
                    <input type="radio" name="pdfTheme" value="dark">
                    <div class="modal-option-content">
                        <div class="modal-option-title">Dark Theme</div>
                        <div class="modal-option-desc">Dark background with light text</div>
                    </div>
                </label>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeExportModal()">Cancel</button>
                <button class="modal-btn modal-btn-export" onclick="exportToPDF()">Export PDF</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        // Global state for calculation results
        let calculationResults = null;
        let currentOutcome = 'binary';

        // Statistical Functions
        function normalQuantile(p) {
            if (p <= 0 || p >= 1) return NaN;

            const a = [
                -3.969683028665376e+01,  2.209460984245205e+02,
                -2.759285104469687e+02,  1.383577518672690e+02,
                -3.066479806614716e+01,  2.506628277459239e+00
            ];
            const b = [
                -5.447609879822406e+01,  1.615858368580409e+02,
                -1.556989798598866e+02,  6.680131188771972e+01,
                -1.328068155288572e+01
            ];
            const c = [
                -7.784894002430293e-03, -3.223964580411365e-01,
                -2.400758277161838e+00, -2.549732539343734e+00,
                 4.374664141464968e+00,  2.938163982698783e+00
            ];
            const d = [
                 7.784695709041462e-03,  3.224671290700398e-01,
                 2.445134137142996e+00,  3.754408661907416e+00
            ];

            const pLow = 0.02425;
            const pHigh = 1 - pLow;

            let q, r;

            if (p < pLow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) /
                       ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            } else if (p <= pHigh) {
                q = p - 0.5;
                r = q * q;
                return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q /
                       (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) /
                        ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            }
        }

        // Trial Type Selection
        function selectTrial(trialType) {
            document.querySelectorAll('.trial-card').forEach(card => card.classList.remove('active'));
            document.querySelector(`[data-trial="${trialType}"]`).classList.add('active');

            document.querySelectorAll('.calculator-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${trialType}-calc`).classList.add('active');

            document.getElementById('results').classList.remove('active');
        }

        // Outcome Type Selection (for Superiority)
        function selectOutcome(outcome) {
            currentOutcome = outcome;
            document.querySelectorAll('.outcome-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${outcome}`).classList.add('active');

            if (outcome === 'binary') {
                document.getElementById('binary-inputs').style.display = 'block';
                document.getElementById('continuous-inputs').style.display = 'none';
            } else {
                document.getElementById('binary-inputs').style.display = 'none';
                document.getElementById('continuous-inputs').style.display = 'block';
            }
        }

        // Calculate Superiority Trial
        function calculateSuperiority() {
            if (currentOutcome === 'binary') {
                calculateSuperiorityBinary();
            } else {
                calculateSuperiorityContinuous();
            }
        }

        function calculateSuperiorityBinary() {
            const p1 = parseFloat(document.getElementById('sup_p1').value);
            const p2 = parseFloat(document.getElementById('sup_p2').value);
            const alpha = parseFloat(document.getElementById('sup_alpha').value);
            const power = parseFloat(document.getElementById('sup_power').value);
            const ratio = parseFloat(document.getElementById('sup_ratio').value);
            const dropout = parseFloat(document.getElementById('sup_dropout').value) / 100;

            const zAlpha = normalQuantile(1 - alpha / 2);
            const zBeta = normalQuantile(power);
            const diff = Math.abs(p1 - p2);

            // Pooled proportion
            const pBar = (p1 + p2) / 2;

            // Variance components
            const var1 = p1 * (1 - p1);
            const var2 = p2 * (1 - p2);

            // Sample size per group (equal allocation formula, then adjust for ratio)
            const numerator = Math.pow(zAlpha + zBeta, 2) * (var1 + var2);
            const denominator = Math.pow(diff, 2);
            let nPerGroup = Math.ceil(numerator / denominator);

            // Adjust for unequal allocation
            let nTreatment, nControl;
            if (ratio !== 1) {
                const adjustedN = nPerGroup * ((1 + ratio) * (1 + ratio)) / (4 * ratio);
                nControl = Math.ceil(adjustedN);
                nTreatment = Math.ceil(nControl * ratio);
            } else {
                nTreatment = nPerGroup;
                nControl = nPerGroup;
            }

            // Adjust for dropout
            nTreatment = Math.ceil(nTreatment / (1 - dropout));
            nControl = Math.ceil(nControl / (1 - dropout));
            const totalN = nTreatment + nControl;

            // Calculate NNT
            const nnt = Math.ceil(1 / Math.abs(p1 - p2));

            // Store results globally
            calculationResults = {
                trialType: 'Superiority Trial',
                outcomeType: 'Binary',
                inputs: {
                    controlRate: p2,
                    treatmentRate: p1,
                    alpha: alpha,
                    power: power,
                    allocationRatio: ratio,
                    dropoutRate: dropout * 100
                },
                zScores: {
                    zAlpha: zAlpha,
                    zBeta: zBeta
                },
                calculations: {
                    effectSize: diff,
                    pooledProportion: pBar,
                    varianceTreatment: var1,
                    varianceControl: var2,
                    numerator: numerator,
                    denominator: denominator
                },
                results: {
                    treatmentSize: nTreatment,
                    controlSize: nControl,
                    totalSize: totalN,
                    nnt: nnt
                },
                formula: 'n = [(Z_{1-alpha/2} + Z_{1-beta})^2 * (p1(1-p1) + p2(1-p2))] / (p1 - p2)^2'
            };

            displayResults();
        }

        function calculateSuperiorityContinuous() {
            const delta = parseFloat(document.getElementById('sup_cont_delta').value);
            const sd = parseFloat(document.getElementById('sup_cont_sd').value);
            const alpha = parseFloat(document.getElementById('sup_cont_alpha').value);
            const power = parseFloat(document.getElementById('sup_cont_power').value);
            const ratio = parseFloat(document.getElementById('sup_cont_ratio').value);
            const dropout = parseFloat(document.getElementById('sup_cont_dropout').value) / 100;

            const zAlpha = normalQuantile(1 - alpha / 2);
            const zBeta = normalQuantile(power);

            // Cohen's d
            const cohenD = delta / sd;

            // Sample size per group
            const numerator = Math.pow(zAlpha + zBeta, 2) * 2 * Math.pow(sd, 2);
            const denominator = Math.pow(delta, 2);
            let nPerGroup = Math.ceil(numerator / denominator);

            // Adjust for unequal allocation
            let nTreatment, nControl;
            if (ratio !== 1) {
                const adjustedN = nPerGroup * ((1 + ratio) * (1 + ratio)) / (4 * ratio);
                nControl = Math.ceil(adjustedN);
                nTreatment = Math.ceil(nControl * ratio);
            } else {
                nTreatment = nPerGroup;
                nControl = nPerGroup;
            }

            // Adjust for dropout
            nTreatment = Math.ceil(nTreatment / (1 - dropout));
            nControl = Math.ceil(nControl / (1 - dropout));
            const totalN = nTreatment + nControl;

            calculationResults = {
                trialType: 'Superiority Trial',
                outcomeType: 'Continuous',
                inputs: {
                    meanDifference: delta,
                    standardDeviation: sd,
                    alpha: alpha,
                    power: power,
                    allocationRatio: ratio,
                    dropoutRate: dropout * 100
                },
                zScores: {
                    zAlpha: zAlpha,
                    zBeta: zBeta
                },
                calculations: {
                    effectSize: cohenD,
                    numerator: numerator,
                    denominator: denominator
                },
                results: {
                    treatmentSize: nTreatment,
                    controlSize: nControl,
                    totalSize: totalN
                },
                formula: 'n = [(Z_{1-alpha/2} + Z_{1-beta})^2 * 2*sigma^2] / delta^2'
            };

            displayResults();
        }

        // Calculate Non-inferiority Trial
        function calculateNonInferiority() {
            const p1 = parseFloat(document.getElementById('ni_p1').value);
            const p2 = parseFloat(document.getElementById('ni_p2').value);
            const margin = parseFloat(document.getElementById('ni_margin').value);
            const alpha = parseFloat(document.getElementById('ni_alpha').value);
            const power = parseFloat(document.getElementById('ni_power').value);
            const dropout = parseFloat(document.getElementById('ni_dropout').value) / 100;

            // One-sided test for NI
            const zAlpha = normalQuantile(1 - alpha);
            const zBeta = normalQuantile(power);

            const var1 = p1 * (1 - p1);
            const var2 = p2 * (1 - p2);
            const diff = p1 - p2;

            // NI sample size formula
            const numerator = Math.pow(zAlpha + zBeta, 2) * (var1 + var2);
            const denominator = Math.pow(margin - Math.abs(diff), 2);
            let nPerGroup = Math.ceil(numerator / denominator);

            // Adjust for dropout
            nPerGroup = Math.ceil(nPerGroup / (1 - dropout));
            const totalN = nPerGroup * 2;

            calculationResults = {
                trialType: 'Non-inferiority Trial',
                outcomeType: 'Binary',
                inputs: {
                    controlRate: p2,
                    treatmentRate: p1,
                    nonInferiorityMargin: margin,
                    alpha: alpha,
                    power: power,
                    dropoutRate: dropout * 100
                },
                zScores: {
                    zAlpha: zAlpha,
                    zBeta: zBeta
                },
                calculations: {
                    effectDifference: diff,
                    varianceTreatment: var1,
                    varianceControl: var2,
                    numerator: numerator,
                    denominator: denominator,
                    adjustedMargin: margin - Math.abs(diff)
                },
                results: {
                    treatmentSize: nPerGroup,
                    controlSize: nPerGroup,
                    totalSize: totalN
                },
                formula: 'n = [(Z_{1-alpha} + Z_{1-beta})^2 * (p1(1-p1) + p2(1-p2))] / (delta - |p1-p2|)^2'
            };

            displayResults();
        }

        // Calculate Equivalence Trial
        function calculateEquivalence() {
            const p1 = parseFloat(document.getElementById('eq_p1').value);
            const p2 = parseFloat(document.getElementById('eq_p2').value);
            const margin = parseFloat(document.getElementById('eq_margin').value);
            const alpha = parseFloat(document.getElementById('eq_alpha').value);
            const power = parseFloat(document.getElementById('eq_power').value);
            const dropout = parseFloat(document.getElementById('eq_dropout').value) / 100;

            // TOST procedure
            const zAlpha = normalQuantile(1 - alpha);
            const zBeta = normalQuantile(power);

            const var1 = p1 * (1 - p1);
            const var2 = p2 * (1 - p2);
            const diff = Math.abs(p1 - p2);

            // Equivalence sample size formula
            const numerator = Math.pow(zAlpha + zBeta, 2) * (var1 + var2);
            const denominator = Math.pow(margin - diff, 2);
            let nPerGroup = Math.ceil(numerator / denominator);

            // Adjust for dropout
            nPerGroup = Math.ceil(nPerGroup / (1 - dropout));
            const totalN = nPerGroup * 2;

            calculationResults = {
                trialType: 'Equivalence Trial',
                outcomeType: 'Binary',
                inputs: {
                    referenceRate: p2,
                    testRate: p1,
                    equivalenceMargin: margin,
                    alpha: alpha,
                    power: power,
                    dropoutRate: dropout * 100
                },
                zScores: {
                    zAlpha: zAlpha,
                    zBeta: zBeta
                },
                calculations: {
                    effectDifference: diff,
                    varianceTest: var1,
                    varianceReference: var2,
                    numerator: numerator,
                    denominator: denominator,
                    equivalenceBounds: `[-${margin}, +${margin}]`
                },
                results: {
                    treatmentSize: nPerGroup,
                    controlSize: nPerGroup,
                    totalSize: totalN
                },
                formula: 'n = [(Z_{1-alpha} + Z_{1-beta})^2 * (p1(1-p1) + p2(1-p2))] / (delta - |p1-p2|)^2'
            };

            displayResults();
        }

        // Display Results
        function displayResults() {
            const r = calculationResults;

            document.getElementById('results').classList.add('active');
            document.getElementById('totalSampleSize').textContent = r.results.totalSize;
            document.getElementById('treatmentSize').textContent = r.results.treatmentSize;
            document.getElementById('controlSize').textContent = r.results.controlSize;

            // Build results grid
            let gridHTML = '';

            // Add input parameters
            for (const [key, value] of Object.entries(r.inputs)) {
                const label = formatLabel(key);
                let displayValue = value;
                if (typeof value === 'number') {
                    displayValue = value < 1 ? (value * 100).toFixed(1) + '%' : value.toFixed(2);
                }
                gridHTML += `
                    <div class="result-card">
                        <div class="result-label">${label}</div>
                        <div class="result-value">${displayValue}</div>
                    </div>
                `;
            }

            // Add Z-scores
            gridHTML += `
                <div class="result-card">
                    <div class="result-label">Z (Alpha)</div>
                    <div class="result-value">${r.zScores.zAlpha.toFixed(4)}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Z (Beta/Power)</div>
                    <div class="result-value">${r.zScores.zBeta.toFixed(4)}</div>
                </div>
            `;

            // Add NNT for binary superiority
            if (r.results.nnt) {
                gridHTML += `
                    <div class="result-card">
                        <div class="result-label">Number Needed to Treat (NNT)</div>
                        <div class="result-value">${r.results.nnt}</div>
                    </div>
                `;
            }

            document.getElementById('resultsGrid').innerHTML = gridHTML;

            // Interpretation
            let interpretation = '';
            if (r.trialType === 'Superiority Trial') {
                if (r.outcomeType === 'Binary') {
                    interpretation = `To detect a difference of ${(Math.abs(r.inputs.treatmentRate - r.inputs.controlRate) * 100).toFixed(1)}% between treatment (${(r.inputs.treatmentRate * 100).toFixed(1)}%) and control (${(r.inputs.controlRate * 100).toFixed(1)}%) groups with ${(r.inputs.power * 100).toFixed(0)}% power at a ${(r.inputs.alpha * 100).toFixed(1)}% significance level (two-sided), you need ${r.results.totalSize} total participants (${r.results.treatmentSize} in treatment, ${r.results.controlSize} in control). The Number Needed to Treat (NNT) is ${r.results.nnt}, meaning ${r.results.nnt} patients need to be treated to prevent one additional event.`;
                } else {
                    interpretation = `To detect a mean difference of ${r.inputs.meanDifference} (SD = ${r.inputs.standardDeviation}, Cohen's d = ${r.calculations.effectSize.toFixed(3)}) with ${(r.inputs.power * 100).toFixed(0)}% power at a ${(r.inputs.alpha * 100).toFixed(1)}% significance level (two-sided), you need ${r.results.totalSize} total participants (${r.results.treatmentSize} in treatment, ${r.results.controlSize} in control).`;
                }
            } else if (r.trialType === 'Non-inferiority Trial') {
                interpretation = `To demonstrate that the new treatment is not worse than the control by more than ${(r.inputs.nonInferiorityMargin * 100).toFixed(1)}% (non-inferiority margin), with ${(r.inputs.power * 100).toFixed(0)}% power at a ${(r.inputs.alpha * 100).toFixed(1)}% one-sided significance level, you need ${r.results.totalSize} total participants (${r.results.treatmentSize} per group). If the lower bound of the 95% CI for the difference is above -${(r.inputs.nonInferiorityMargin * 100).toFixed(1)}%, non-inferiority is established.`;
            } else if (r.trialType === 'Equivalence Trial') {
                interpretation = `To demonstrate equivalence within margins of ${r.calculations.equivalenceBounds} (${(r.inputs.equivalenceMargin * 100).toFixed(1)}%), with ${(r.inputs.power * 100).toFixed(0)}% power at a ${(r.inputs.alpha * 100).toFixed(1)}% significance level using the TOST procedure, you need ${r.results.totalSize} total participants (${r.results.treatmentSize} per group). Both one-sided tests must be significant to claim equivalence.`;
            }
            document.getElementById('interpretationText').textContent = interpretation;

            // Update ICH recommendations based on trial type
            updateICHRecommendations(r.trialType);

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function formatLabel(key) {
            const labels = {
                controlRate: 'Control Rate',
                treatmentRate: 'Treatment Rate',
                referenceRate: 'Reference Rate',
                testRate: 'Test Rate',
                alpha: 'Alpha (Type I Error)',
                power: 'Power (1-Beta)',
                allocationRatio: 'Allocation Ratio',
                dropoutRate: 'Dropout Rate',
                nonInferiorityMargin: 'NI Margin',
                equivalenceMargin: 'Equivalence Margin',
                meanDifference: 'Mean Difference',
                standardDeviation: 'Standard Deviation'
            };
            return labels[key] || key;
        }

        function updateICHRecommendations(trialType) {
            const recommendations = {
                'Superiority Trial': [
                    'Clearly define superiority hypothesis and clinically meaningful difference',
                    'Pre-specify primary endpoint and its measurement',
                    'Document sample size assumptions including expected effect size',
                    'Plan for interim analyses with appropriate alpha spending',
                    'Establish data monitoring committee for safety oversight'
                ],
                'Non-inferiority Trial': [
                    'Justify non-inferiority margin based on historical control data',
                    'Document assay sensitivity and constancy assumption',
                    'Plan both ITT and per-protocol analyses (FDA guidance)',
                    'Consider switching to superiority testing if NI is established',
                    'Ensure adequate exposure in both treatment groups'
                ],
                'Equivalence Trial': [
                    'Pre-specify symmetric equivalence margins with clinical justification',
                    'Use TOST (Two One-Sided Tests) procedure for analysis',
                    'Document the 90% CI approach for equivalence assessment',
                    'Plan for adequate drug exposure and washout periods',
                    'Consider bioequivalence standards (80-125% for PK studies)'
                ]
            };

            const ul = document.getElementById('ichRecommendations');
            ul.innerHTML = recommendations[trialType].map(r => `<li>${r}</li>`).join('');
        }

        // Reset Calculator
        function resetCalculator(trialType) {
            if (trialType === 'superiority') {
                document.getElementById('sup_p1').value = '0.20';
                document.getElementById('sup_p2').value = '0.30';
                document.getElementById('sup_alpha').value = '0.05';
                document.getElementById('sup_power').value = '0.90';
                document.getElementById('sup_ratio').value = '1';
                document.getElementById('sup_dropout').value = '10';
                document.getElementById('sup_cont_delta').value = '5';
                document.getElementById('sup_cont_sd').value = '10';
                document.getElementById('sup_cont_alpha').value = '0.05';
                document.getElementById('sup_cont_power').value = '0.90';
                document.getElementById('sup_cont_ratio').value = '1';
                document.getElementById('sup_cont_dropout').value = '10';
            } else if (trialType === 'noninferiority') {
                document.getElementById('ni_p1').value = '0.70';
                document.getElementById('ni_p2').value = '0.70';
                document.getElementById('ni_margin').value = '0.10';
                document.getElementById('ni_alpha').value = '0.025';
                document.getElementById('ni_power').value = '0.90';
                document.getElementById('ni_dropout').value = '10';
            } else if (trialType === 'equivalence') {
                document.getElementById('eq_p1').value = '0.50';
                document.getElementById('eq_p2').value = '0.50';
                document.getElementById('eq_margin').value = '0.15';
                document.getElementById('eq_alpha').value = '0.05';
                document.getElementById('eq_power').value = '0.90';
                document.getElementById('eq_dropout').value = '10';
            }
            document.getElementById('results').classList.remove('active');
            calculationResults = null;
        }

        // Toggle Formula
        function toggleFormula(element) {
            element.classList.toggle('active');
            element.nextElementSibling.classList.toggle('active');
        }

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('karmastat-theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                document.getElementById('themeIcon').innerHTML = savedTheme === 'dark' ? '&#9728;' : '&#9790;';
            }
        });

        // Export Modal
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // Export to PDF
        function exportToPDF() {
            if (!calculationResults) {
                alert('Please calculate sample size first.');
                closeExportModal();
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const isDarkTheme = document.querySelector('input[name="pdfTheme"]:checked').value === 'dark';

            const r = calculationResults;
            let yPos = 20;

            // Colors
            const primaryColor = isDarkTheme ? [251, 191, 36] : [245, 158, 11];
            const bgColor = isDarkTheme ? [28, 25, 23] : [255, 255, 255];
            const textColor = isDarkTheme ? [243, 244, 246] : [31, 41, 55];
            const mutedColor = isDarkTheme ? [156, 163, 175] : [107, 114, 128];

            // Background
            if (isDarkTheme) {
                doc.setFillColor(...bgColor);
                doc.rect(0, 0, 210, 297, 'F');
            }

            // Header
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 35, 'F');

            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('KARMASTAT', 20, 18);

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Clinical Trials Sample Size Calculator', 20, 28);

            yPos = 45;

            // Trial Type
            doc.setFontSize(16);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text(r.trialType + (r.outcomeType ? ` (${r.outcomeType} Outcome)` : ''), 20, yPos);
            yPos += 12;

            // Main Results Box
            doc.setFillColor(isDarkTheme ? 41 : 255, isDarkTheme ? 37 : 251, isDarkTheme ? 36 : 235);
            doc.roundedRect(15, yPos, 180, 35, 5, 5, 'F');

            doc.setFontSize(28);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text(`${r.results.totalSize}`, 105, yPos + 18, { align: 'center' });

            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');
            doc.text('Total Sample Size Required', 105, yPos + 28, { align: 'center' });

            yPos += 45;

            // Sample breakdown
            doc.setFontSize(11);
            doc.setTextColor(...textColor);
            doc.text(`Treatment Group: ${r.results.treatmentSize}`, 30, yPos);
            doc.text(`Control Group: ${r.results.controlSize}`, 120, yPos);
            yPos += 12;

            // Input Parameters Section
            doc.setFontSize(14);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Input Parameters', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');

            const inputParams = Object.entries(r.inputs);
            let col = 0;
            inputParams.forEach(([key, value], index) => {
                const label = formatLabel(key);
                let displayValue = value;
                if (typeof value === 'number') {
                    displayValue = value < 1 && key !== 'allocationRatio' ? (value * 100).toFixed(1) + '%' : value.toFixed(2);
                }
                const xPos = col === 0 ? 25 : 115;
                doc.text(`${label}: ${displayValue}`, xPos, yPos);
                col = 1 - col;
                if (col === 0) yPos += 7;
            });
            if (col === 1) yPos += 7;
            yPos += 5;

            // Formula Section
            doc.setFontSize(14);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Formula Used', 20, yPos);
            yPos += 8;

            doc.setFillColor(isDarkTheme ? 41 : 245, isDarkTheme ? 37 : 243, isDarkTheme ? 36 : 243);
            doc.roundedRect(15, yPos, 180, 12, 3, 3, 'F');

            doc.setFontSize(9);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');
            doc.text(r.formula, 20, yPos + 8);
            yPos += 20;

            // Step-by-step Calculations
            doc.setFontSize(14);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Step-by-Step Calculation', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');

            const steps = [
                `1. Z-score for alpha: Z(1-alpha/2) = ${r.zScores.zAlpha.toFixed(4)}`,
                `2. Z-score for power: Z(1-beta) = ${r.zScores.zBeta.toFixed(4)}`,
                `3. Effect size/difference: ${r.calculations.effectSize ? r.calculations.effectSize.toFixed(4) : 'N/A'}`,
                `4. Numerator: ${r.calculations.numerator ? r.calculations.numerator.toFixed(4) : 'N/A'}`,
                `5. Denominator: ${r.calculations.denominator ? r.calculations.denominator.toFixed(4) : 'N/A'}`,
                `6. Base n per group: ${(r.calculations.numerator / r.calculations.denominator).toFixed(2)}`,
                `7. Adjusted for dropout (${r.inputs.dropoutRate}%): ${r.results.treatmentSize} treatment, ${r.results.controlSize} control`,
                `8. Final total: ${r.results.totalSize} participants`
            ];

            steps.forEach(step => {
                doc.text(step, 25, yPos);
                yPos += 6;
            });
            yPos += 5;

            // NNT if applicable
            if (r.results.nnt) {
                doc.setFontSize(11);
                doc.setTextColor(...primaryColor);
                doc.setFont(undefined, 'bold');
                doc.text(`Number Needed to Treat (NNT): ${r.results.nnt}`, 20, yPos);
                yPos += 10;
            }

            // Interpretation
            doc.setFontSize(14);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Interpretation', 20, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');
            const interpretation = document.getElementById('interpretationText').textContent;
            const splitInterpretation = doc.splitTextToSize(interpretation, 170);
            doc.text(splitInterpretation, 20, yPos);
            yPos += splitInterpretation.length * 5 + 8;

            // ICH E9 Compliance (new page if needed)
            if (yPos > 240) {
                doc.addPage();
                if (isDarkTheme) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
                yPos = 20;
            }

            doc.setFontSize(14);
            doc.setTextColor(59, 130, 246);
            doc.setFont(undefined, 'bold');
            doc.text('ICH E9 Compliance Recommendations', 20, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setTextColor(...textColor);
            doc.setFont(undefined, 'normal');
            const ichItems = document.querySelectorAll('#ichRecommendations li');
            ichItems.forEach(item => {
                const lines = doc.splitTextToSize('- ' + item.textContent, 170);
                doc.text(lines, 25, yPos);
                yPos += lines.length * 4 + 2;
            });
            yPos += 5;

            // Reference
            doc.setFontSize(10);
            doc.setTextColor(...mutedColor);
            doc.setFont(undefined, 'italic');
            doc.text('Reference: Chow SC, Shao J, Wang H, Lokhnygina Y. (2017).', 20, yPos);
            yPos += 5;
            doc.text('Sample Size Calculations in Clinical Research. 3rd ed. CRC Press.', 20, yPos);

            // Footer
            const footerY = 285;
            doc.setFillColor(...primaryColor);
            doc.rect(0, 280, 210, 17, 'F');

            doc.setFontSize(10);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('Generated by KARMASTAT - Crafted by Karmayogi', 105, footerY, { align: 'center' });

            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(new Date().toLocaleString(), 105, footerY + 6, { align: 'center' });

            // Save
            doc.save(`karmastat_clinical_trial_${r.trialType.toLowerCase().replace(/\s+/g, '_')}.pdf`);
            closeExportModal();
        }
    </script>
</body>
</html>
