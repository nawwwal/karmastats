<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Bayesian Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #F43F5E;
            --primary-dark: #E11D48;
            --primary-light: #FB7185;
            --secondary: #BE123C;
            --accent: #FFE4E6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --bg-primary: #FFFFFF;
            --bg-secondary: #FFF1F2;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(244, 63, 94, 0.15);
            --shadow-hover: 0 8px 25px rgba(244, 63, 94, 0.25);

            --gradient-primary: linear-gradient(135deg, #F43F5E, #FB7185, #FDA4AF);
            --gradient-secondary: linear-gradient(135deg, #BE123C, #E11D48, #F43F5E);
            --gradient-bg: linear-gradient(135deg, #FFF1F2, #FFE4E6, #FECDD3);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #FFF1F2);

            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', monospace;
        }

        [data-theme="dark"] {
            --bg-primary: #1C1917;
            --bg-secondary: #44403C;
            --bg-card: #292524;
            --text-primary: #F3F4F6;
            --text-secondary: #D1D5DB;
            --text-muted: #9CA3AF;
            --border-color: #57534E;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --gradient-bg: linear-gradient(135deg, #1C1917, #292524, #44403C);
            --gradient-card: linear-gradient(145deg, #292524, #44403C);
        }

        /* ============================================
           KARMASTAT LOADER SYSTEM
           ============================================ */

        /* Page Loader Overlay */
        .karma-page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .karma-page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .karma-page-loader .loader-content {
            text-align: center;
        }

        .karma-page-loader .loader-text {
            color: white;
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 2px;
            margin-top: 1.5rem;
            opacity: 0.9;
        }

        /* Karma Infinity Animation */
        .karma-infinity {
            width: 120px;
            height: 60px;
        }

        .karma-infinity svg {
            width: 100%;
            height: 100%;
        }

        .karma-path {
            stroke-dasharray: 300;
            stroke-dashoffset: 300;
            animation: karmaFlow 2s ease-in-out infinite;
        }

        @keyframes karmaFlow {
            0% { stroke-dashoffset: 300; opacity: 0.4; }
            50% { stroke-dashoffset: 0; opacity: 1; }
            100% { stroke-dashoffset: -300; opacity: 0.4; }
        }

        .karma-point {
            animation: karmaPulse 1.2s ease-in-out infinite;
        }

        .karma-point:nth-child(3) { animation-delay: 0.2s; }
        .karma-point:nth-child(4) { animation-delay: 0.4s; }

        @keyframes karmaPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        /* Button Loading State */
        .btn.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading .btn-text {
            visibility: hidden;
        }

        .btn.loading .karma-spinner {
            display: block;
        }

        .karma-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }

        .karma-spinner svg {
            width: 100%;
            height: 100%;
            animation: spinnerRotate 1.5s linear infinite;
        }

        @keyframes spinnerRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner-path {
            stroke-dasharray: 60;
            stroke-dashoffset: 15;
            animation: spinnerDash 1.2s ease-in-out infinite;
        }

        @keyframes spinnerDash {
            0% { stroke-dashoffset: 60; }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 60; }
        }

        /* Results Loading State */
        .results-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .results-loading .karma-infinity {
            width: 80px;
            height: 40px;
        }

        .results-loading .karma-path {
            stroke: var(--primary);
        }

        .results-loading .karma-point {
            fill: var(--primary-light);
        }

        .results-loading p {
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        .header {
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: 800;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle { font-size: 1.1rem; color: var(--text-secondary); }

        .theme-toggle, .back-link {
            position: absolute;
            top: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .theme-toggle { right: 1.5rem; }
        .back-link { left: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }

        .theme-toggle:hover, .back-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calc-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--gradient-card);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .calc-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .calc-tab:hover { border-color: var(--primary); }
        .calc-tab.active { background: var(--gradient-primary); color: white; border-color: var(--primary); }

        .calculator-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .calculator-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .section-header h3 { font-size: 1.5rem; font-weight: 700; }

        .formula-box {
            background: var(--gradient-secondary);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            font-family: var(--font-mono);
            text-align: center;
            border-radius: var(--radius);
        }

        .info-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h4 { color: var(--primary); margin-bottom: 0.5rem; }
        .info-box p { color: var(--text-secondary); }

        .prior-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .prior-card {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .prior-card:hover { border-color: var(--primary); }
        .prior-card.active { border-color: var(--primary); background: var(--accent); }
        .prior-card-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .prior-card-title { font-weight: 700; color: var(--text-primary); }
        .prior-card-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 0.5rem; }

        .input-group input, .input-group select {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
        }

        .input-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        .calculate-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .calculate-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        .results-section {
            display: none;
            background: var(--gradient-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .results-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .result-main {
            background: var(--gradient-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-value { font-size: 3.5rem; font-weight: 800; color: white; }
        .result-label { color: rgba(255,255,255,0.9); font-size: 1.1rem; }
        .result-sub { margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: var(--radius); color: white; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .result-card-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .result-card-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container h4 { text-align: center; margin-bottom: 1rem; }
        .chart-wrapper { position: relative; height: 300px; }

        .export-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .export-controls select {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover { background: #059669; transform: translateY(-2px); }

        .footer {
            background: var(--gradient-secondary);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-top: 2rem;
        }

        .footer-love { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .footer-blessing { color: var(--accent); }

        /* Calculation Steps Display */
        .calc-steps {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .calc-steps h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calc-step {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .calc-step:last-child { margin-bottom: 0; }

        .calc-step .step-num {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            font-family: var(--font-main);
        }

        /* References Section */
        .references-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--info);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .references-box h4 {
            color: var(--info);
            margin-bottom: 0.75rem;
        }

        .references-box ul {
            list-style: none;
            padding: 0;
        }

        .references-box li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .references-box li:last-child { border-bottom: none; }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 1.8rem; }
            .logo { flex-direction: column; }
            .back-link, .theme-toggle { position: static; margin: 0.5rem; }
            .header { padding-top: 4rem; }
            .result-value { font-size: 2.5rem; }
            .export-controls { flex-direction: column; width: 100%; }
            .export-controls select, .export-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- KARMASTAT Page Loader -->
    <div class="karma-page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="karma-infinity">
                <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="loaderGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                            <stop offset="50%" style="stop-color:#ffffff"/>
                            <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8"/>
                        </linearGradient>
                    </defs>
                    <path class="karma-path"
                          d="M20 30 C20 12, 40 12, 60 30 C80 48, 100 48, 100 30 C100 12, 80 12, 60 30 C40 48, 20 48, 20 30"
                          fill="none" stroke="url(#loaderGrad)" stroke-width="5" stroke-linecap="round"/>
                    <circle class="karma-point" cx="20" cy="30" r="5" fill="#FCD34D"/>
                    <circle class="karma-point" cx="60" cy="30" r="6" fill="white"/>
                    <circle class="karma-point" cx="100" cy="30" r="5" fill="#FCD34D"/>
                </svg>
            </div>
            <div class="loader-text">KARMASTAT</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <a href="karmastat_2_0_main.html" class="back-link">
                <span>&#8592;</span> Back to Main
            </a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">&#9790;</span> Theme
            </button>
            <div class="brand" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1rem;">
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 20 C6 11, 13 11, 20 20 C27 29, 34 29, 34 20 C34 11, 27 11, 20 20 C13 29, 6 29, 6 20"
                          fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="6" cy="20" r="2.5" fill="#FCD34D"/>
                    <circle cx="20" cy="20" r="3" fill="white"/>
                    <circle cx="34" cy="20" r="2.5" fill="#FCD34D"/>
                </svg>
                <span style="font-weight: 600; letter-spacing: 1px;">KARMASTAT</span>
            </div>
            <div class="logo">
                <div>
                    <h1>Bayesian Sample Size Calculator</h1>
                    <p class="subtitle">Prior-informed sample size determination using Bayesian approaches</p>
                </div>
            </div>
        </header>

        <div class="calc-tabs">
            <button class="calc-tab active" data-calc="apvc" onclick="selectCalc('apvc')">APVC Criterion</button>
            <button class="calc-tab" data-calc="acc" onclick="selectCalc('acc')">ACC Criterion</button>
            <button class="calc-tab" data-calc="hpd" onclick="selectCalc('hpd')">HPD Width</button>
            <button class="calc-tab" data-calc="bayes-factor" onclick="selectCalc('bayes-factor')">Bayes Factor</button>
            <button class="calc-tab" data-calc="assurance" onclick="selectCalc('assurance')">Assurance (PoS)</button>
        </div>

        <!-- APVC Criterion -->
        <section class="calculator-section active" id="apvc-calc">
            <div class="section-header">
                <div class="section-icon">&#963;</div>
                <h3>Average Posterior Variance Criterion (APVC)</h3>
            </div>

            <div class="formula-box">
                Find n such that E[Var(&theta;|data)] &le; target<br>
                <small>n = (1/&sigma;&sup2;<sub>target</sub> - 1/&sigma;&sup2;<sub>0</sub>) &times; &sigma;&sup2;<sub>data</sub></small>
            </div>

            <div class="info-box">
                <h4>About APVC</h4>
                <p>The Average Posterior Variance Criterion finds the sample size needed to achieve a target average posterior variance. This ensures the posterior distribution is sufficiently concentrated around the true parameter value.</p>
            </div>

            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Select Prior Type</h4>
            <div class="prior-selection">
                <div class="prior-card active" data-prior="flat" onclick="selectPrior(this, 'apvc')">
                    <div class="prior-card-icon">&#9634;</div>
                    <div class="prior-card-title">Non-informative</div>
                    <div class="prior-card-desc">Flat prior (Jeffrey's)</div>
                </div>
                <div class="prior-card" data-prior="weak" onclick="selectPrior(this, 'apvc')">
                    <div class="prior-card-icon">&#126;</div>
                    <div class="prior-card-title">Weakly Informative</div>
                    <div class="prior-card-desc">Regularizing prior</div>
                </div>
                <div class="prior-card" data-prior="informative" onclick="selectPrior(this, 'apvc')">
                    <div class="prior-card-icon">&#128202;</div>
                    <div class="prior-card-title">Informative</div>
                    <div class="prior-card-desc">Historical data based</div>
                </div>
                <div class="prior-card" data-prior="skeptical" onclick="selectPrior(this, 'apvc')">
                    <div class="prior-card-icon">&#63;</div>
                    <div class="prior-card-title">Skeptical</div>
                    <div class="prior-card-desc">Conservative prior</div>
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Prior Mean (&mu;<sub>0</sub>)</label>
                    <input type="number" id="apvc_prior_mean" value="0" step="0.1">
                </div>
                <div class="input-group">
                    <label>Prior SD (&sigma;<sub>0</sub>)</label>
                    <input type="number" id="apvc_prior_sd" value="10" min="0.01" step="0.1">
                    <span class="input-hint">Large = less informative</span>
                </div>
                <div class="input-group">
                    <label>Data SD (known or estimated)</label>
                    <input type="number" id="apvc_data_sd" value="1" min="0.01" step="0.1">
                </div>
                <div class="input-group">
                    <label>Target Posterior SD</label>
                    <input type="number" id="apvc_target_sd" value="0.2" min="0.01" step="0.01">
                    <span class="input-hint">Desired precision</span>
                </div>
                <div class="input-group">
                    <label>Credible Interval Level</label>
                    <select id="apvc_cred">
                        <option value="0.90">90%</option>
                        <option value="0.95" selected>95%</option>
                        <option value="0.99">99%</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateAPVC(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- ACC Criterion -->
        <section class="calculator-section" id="acc-calc">
            <div class="section-header">
                <div class="section-icon">&#8801;</div>
                <h3>Average Coverage Criterion (ACC)</h3>
            </div>

            <div class="formula-box">
                Find n such that P(Credible Interval covers &theta;) &ge; target<br>
                <small>n = (z<sub>cred</sub> &times; &sigma; / &epsilon;)&sup2;</small>
            </div>

            <div class="info-box">
                <h4>About ACC</h4>
                <p>The Average Coverage Criterion ensures the credible interval achieves the desired coverage probability on average across the prior distribution of the parameter.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Data SD</label>
                    <input type="number" id="acc_sd" value="1" min="0.01" step="0.1">
                </div>
                <div class="input-group">
                    <label>Target Half-Width (&epsilon;)</label>
                    <input type="number" id="acc_epsilon" value="0.3" min="0.01" step="0.01">
                    <span class="input-hint">Half of CI width</span>
                </div>
                <div class="input-group">
                    <label>Credible Level</label>
                    <select id="acc_cred">
                        <option value="0.90">90%</option>
                        <option value="0.95" selected>95%</option>
                        <option value="0.99">99%</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateACC(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- HPD Width -->
        <section class="calculator-section" id="hpd-calc">
            <div class="section-header">
                <div class="section-icon">&#8596;</div>
                <h3>Highest Posterior Density (HPD) Width</h3>
            </div>

            <div class="formula-box">
                Target HPD Width = 2 &times; z<sub>cred</sub> &times; &sigma;<sub>posterior</sub><br>
                <small>&sigma;<sub>posterior</sub> = 1/&radic;(1/&sigma;&sup2;<sub>0</sub> + n/&sigma;&sup2;)</small>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Prior SD</label>
                    <input type="number" id="hpd_prior_sd" value="5" min="0.01" step="0.1">
                </div>
                <div class="input-group">
                    <label>Data SD</label>
                    <input type="number" id="hpd_data_sd" value="1" min="0.01" step="0.1">
                </div>
                <div class="input-group">
                    <label>Target HPD Width</label>
                    <input type="number" id="hpd_target" value="0.5" min="0.01" step="0.01">
                </div>
                <div class="input-group">
                    <label>Credible Level</label>
                    <select id="hpd_cred">
                        <option value="0.90">90%</option>
                        <option value="0.95" selected>95%</option>
                        <option value="0.99">99%</option>
                    </select>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateHPD(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Bayes Factor -->
        <section class="calculator-section" id="bayes-factor-calc">
            <div class="section-header">
                <div class="section-icon">BF</div>
                <h3>Bayes Factor Sample Size</h3>
            </div>

            <div class="formula-box">
                Find n to achieve target Bayes Factor<br>
                <small>BF > 3 (moderate), > 10 (strong), > 100 (decisive)</small>
            </div>

            <div class="info-box">
                <h4>Bayes Factor Interpretation</h4>
                <p>
                    <strong>BF 1-3:</strong> Anecdotal evidence<br>
                    <strong>BF 3-10:</strong> Moderate evidence<br>
                    <strong>BF 10-30:</strong> Strong evidence<br>
                    <strong>BF 30-100:</strong> Very strong evidence<br>
                    <strong>BF > 100:</strong> Decisive evidence
                </p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Expected Effect Size (d)</label>
                    <input type="number" id="bf_effect" value="0.5" min="0.01" step="0.01">
                </div>
                <div class="input-group">
                    <label>Target Bayes Factor</label>
                    <select id="bf_target">
                        <option value="3">3 (Moderate)</option>
                        <option value="10" selected>10 (Strong)</option>
                        <option value="30">30 (Very Strong)</option>
                        <option value="100">100 (Decisive)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Prior Scale (Cauchy width)</label>
                    <input type="number" id="bf_scale" value="0.707" min="0.1" max="2" step="0.01">
                    <span class="input-hint">Default: sqrt(2)/2 = 0.707</span>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateBayesFactor(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Assurance / Probability of Success -->
        <section class="calculator-section" id="assurance-calc">
            <div class="section-header">
                <div class="section-icon">P</div>
                <h3>Assurance / Probability of Success</h3>
            </div>

            <div class="formula-box">
                Assurance = P(posterior favors treatment | prior, n)<br>
                <small>Bayesian analog of frequentist power</small>
            </div>

            <div class="info-box">
                <h4>About Assurance</h4>
                <p>Assurance (also called Bayesian power or predictive power) is the probability that the trial will demonstrate a treatment benefit, averaging over the prior distribution of the true effect.</p>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label>Prior Mean (Expected Effect)</label>
                    <input type="number" id="ass_prior_mean" value="0.4" step="0.01">
                </div>
                <div class="input-group">
                    <label>Prior SD (Uncertainty)</label>
                    <input type="number" id="ass_prior_sd" value="0.2" min="0.01" step="0.01">
                </div>
                <div class="input-group">
                    <label>Data SD</label>
                    <input type="number" id="ass_data_sd" value="1" min="0.01" step="0.1">
                </div>
                <div class="input-group">
                    <label>Target Assurance</label>
                    <select id="ass_target">
                        <option value="0.70">70%</option>
                        <option value="0.80" selected>80%</option>
                        <option value="0.90">90%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Decision Threshold (effect > 0)</label>
                    <input type="number" id="ass_threshold" value="0" step="0.01">
                    <span class="input-hint">Posterior P(effect > threshold)</span>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateAssurance(this)">
                <span class="btn-text"><span>&#9889;</span> Calculate Sample Size</span>
                <span class="karma-spinner">
                    <svg viewBox="0 0 24 24">
                        <path class="spinner-path" d="M4 12 C4 7, 8 7, 12 12 C16 17, 20 17, 20 12 C20 7, 16 7, 12 12 C8 17, 4 17, 4 12" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </span>
            </button>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="results">
            <div class="results-header">
                <h3>Bayesian Sample Size Results</h3>
                <div class="export-controls">
                    <select id="pdfTheme">
                        <option value="light">Light PDF Theme</option>
                        <option value="dark">Dark PDF Theme</option>
                    </select>
                    <button class="export-btn" onclick="exportToPDF()">
                        <span>&#128196;</span> Export PDF Report
                    </button>
                </div>
            </div>

            <div class="result-main">
                <div class="result-value" id="mainValue">--</div>
                <div class="result-label" id="mainLabel">Sample Size</div>
                <div class="result-sub" id="mainSub"></div>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <!-- Calculation Steps -->
            <div class="calc-steps" id="calcSteps">
                <h4>&#128203; Step-by-Step Calculation</h4>
                <div id="stepsContent"></div>
            </div>

            <div class="chart-container">
                <h4 id="chartTitle">Posterior Precision vs Sample Size</h4>
                <div class="chart-wrapper">
                    <canvas id="bayesChart"></canvas>
                </div>
            </div>

            <div class="info-box" id="interpretationBox">
                <h4>Interpretation</h4>
                <p id="interpretationText"></p>
            </div>

            <!-- Prior Recommendations -->
            <div class="info-box" id="priorRecommendations" style="border-left-color: var(--warning);">
                <h4 style="color: var(--warning);">Prior Specification Recommendations</h4>
                <p id="priorRecommendationsText"></p>
            </div>

            <!-- References -->
            <div class="references-box">
                <h4>&#128218; References</h4>
                <ul id="referencesList">
                    <li><strong>Spiegelhalter, D.J., Abrams, K.R., & Myles, J.P. (2004).</strong> Bayesian Approaches to Clinical Trials and Health-Care Evaluation. Wiley.</li>
                    <li><strong>Berry, S.M., Carlin, B.P., Lee, J.J., & Muller, P. (2010).</strong> Bayesian Adaptive Methods for Clinical Trials. CRC Press.</li>
                    <li><strong>O'Hagan, A., & Stevens, J.W. (2001).</strong> Bayesian assessment of sample size for clinical trials of cost-effectiveness. Medical Decision Making, 21(3), 219-230.</li>
                    <li><strong>Morey, R.D., & Rouder, J.N. (2011).</strong> Bayes Factor Approaches for Testing Interval Null Hypotheses. Psychological Methods, 16(4), 406-419.</li>
                </ul>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-love">Made with &#10084; by Karmayogi</div>
            <div class="footer-blessing">&#128591; Jai Shri Ram &#128591;</div>
        </footer>
    </div>

    <script>
        // ============================================
        // KARMASTAT LOADER SYSTEM
        // ============================================

        // Hide page loader when content is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                    pageLoader.classList.add('hidden');
                }
            }, 800);
        });

        // Button loading state functions
        function showButtonLoader(btn) {
            if (btn) btn.classList.add('loading');
        }

        function hideButtonLoader(btn) {
            if (btn) btn.classList.remove('loading');
        }

        // Wrap calculation with loader
        function withLoader(btn, calculationFn) {
            showButtonLoader(btn);
            setTimeout(function() {
                try {
                    calculationFn();
                } finally {
                    hideButtonLoader(btn);
                }
            }, 600);
        }

        let bayesChart = null;

        // Global calculation storage for PDF export
        let currentCalculation = {
            approachName: '',
            approachFullName: '',
            inputs: {},
            formula: '',
            steps: [],
            result: null,
            details: {},
            interpretation: '',
            priorRecommendations: '',
            chartData: null
        };

        function normalQuantile(p) {
            const a = [-3.969683028665376e+01, 2.209460984245205e+02, -2.759285104469687e+02,
                       1.383577518672690e+02, -3.066479806614716e+01, 2.506628277459239e+00];
            const b = [-5.447609879822406e+01, 1.615858368580409e+02, -1.556989798598866e+02,
                       6.680131188771972e+01, -1.328068155288572e+01];
            const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00,
                       -2.549732539343734e+00, 4.374664141464968e+00, 2.938163982698783e+00];
            const d = [7.784695709041462e-03, 3.224671290700398e-01, 2.445134137142996e+00, 3.754408661907416e+00];
            const pLow = 0.02425, pHigh = 1 - pLow;
            let q, r;
            if (p < pLow) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            } else if (p <= pHigh) {
                q = p - 0.5; r = q * q;
                return (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q / (((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5]) / ((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
            }
        }

        function normalCDF(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
            const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            const t = 1 / (1 + p * x);
            const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1) * t * Math.exp(-x*x);
            return 0.5 * (1 + sign * y);
        }

        function selectCalc(calcType) {
            document.querySelectorAll('.calc-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-calc="${calcType}"]`).classList.add('active');
            document.querySelectorAll('.calculator-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${calcType}-calc`).classList.add('active');
            document.getElementById('results').classList.remove('active');
        }

        function selectPrior(el, calcType) {
            el.parentElement.querySelectorAll('.prior-card').forEach(p => p.classList.remove('active'));
            el.classList.add('active');

            const prior = el.dataset.prior;
            const priorMean = document.getElementById(`${calcType}_prior_mean`);
            const priorSD = document.getElementById(`${calcType}_prior_sd`);

            if (prior === 'flat') {
                priorMean.value = 0;
                priorSD.value = 100;
            } else if (prior === 'weak') {
                priorMean.value = 0;
                priorSD.value = 10;
            } else if (prior === 'informative') {
                priorMean.value = 0.3;
                priorSD.value = 0.5;
            } else if (prior === 'skeptical') {
                priorMean.value = 0;
                priorSD.value = 0.3;
            }
        }

        function calculateAPVC() {
            const priorMean = parseFloat(document.getElementById('apvc_prior_mean').value);
            const priorSD = parseFloat(document.getElementById('apvc_prior_sd').value);
            const dataSD = parseFloat(document.getElementById('apvc_data_sd').value);
            const targetSD = parseFloat(document.getElementById('apvc_target_sd').value);
            const credLevel = parseFloat(document.getElementById('apvc_cred').value);

            const zCred = normalQuantile((1 + credLevel) / 2);
            const priorVar = priorSD * priorSD;
            const targetVar = targetSD * targetSD;
            const dataVar = dataSD * dataSD;

            const n = Math.max(1, Math.ceil((1/targetVar - 1/priorVar) * dataVar));

            const actualPosteriorVar = 1 / (1/priorVar + n/dataVar);
            const actualPosteriorSD = Math.sqrt(actualPosteriorVar);
            const credWidth = 2 * zCred * actualPosteriorSD;
            const priorContribution = ((priorVar / (priorVar + dataVar/n)) * 100).toFixed(1);

            // Store calculation for PDF export
            currentCalculation = {
                approachName: 'APVC',
                approachFullName: 'Average Posterior Variance Criterion (APVC)',
                inputs: {
                    'Prior Mean (mu_0)': priorMean,
                    'Prior SD (sigma_0)': priorSD,
                    'Data SD (sigma)': dataSD,
                    'Target Posterior SD': targetSD,
                    'Credible Level': (credLevel * 100) + '%'
                },
                formula: 'n = (1/sigma^2_target - 1/sigma^2_0) x sigma^2_data',
                steps: [
                    `Prior Variance: sigma^2_0 = ${priorSD}^2 = ${priorVar.toFixed(4)}`,
                    `Target Posterior Variance: sigma^2_target = ${targetSD}^2 = ${targetVar.toFixed(6)}`,
                    `Data Variance: sigma^2_data = ${dataSD}^2 = ${dataVar.toFixed(4)}`,
                    `Precision needed from data: 1/${targetVar.toFixed(6)} - 1/${priorVar.toFixed(4)} = ${(1/targetVar - 1/priorVar).toFixed(4)}`,
                    `Sample size: n = ${(1/targetVar - 1/priorVar).toFixed(4)} x ${dataVar.toFixed(4)} = ${((1/targetVar - 1/priorVar) * dataVar).toFixed(2)}`,
                    `Rounded up: n = ${n}`
                ],
                result: n,
                details: {
                    'Prior SD': priorSD.toFixed(3),
                    'Data SD': dataSD.toFixed(3),
                    'Target Posterior SD': targetSD.toFixed(4),
                    'Actual Posterior SD': actualPosteriorSD.toFixed(4),
                    'Credible Level': (credLevel * 100).toFixed(0) + '%',
                    [`${(credLevel * 100).toFixed(0)}% CI Width`]: credWidth.toFixed(4),
                    'Prior Contribution': priorContribution + '%'
                },
                interpretation: `A sample size of ${n} is needed to achieve the target posterior precision of SD = ${targetSD}. With this sample size, the posterior standard deviation will be ${actualPosteriorSD.toFixed(4)}, yielding a ${(credLevel * 100).toFixed(0)}% credible interval width of ${credWidth.toFixed(4)}. The prior information contributes ${priorContribution}% to the posterior precision, with the remaining information coming from the data.`,
                priorRecommendations: getPriorRecommendations('apvc', priorSD),
                chartParams: { priorSD, dataSD, type: 'apvc' }
            };

            displayResults(n, 'Sample Size (APVC)', currentCalculation.details, 'apvc', { priorSD, dataSD });
        }

        function calculateACC() {
            const sigma = parseFloat(document.getElementById('acc_sd').value);
            const epsilon = parseFloat(document.getElementById('acc_epsilon').value);
            const credLevel = parseFloat(document.getElementById('acc_cred').value);

            const zCred = normalQuantile((1 + credLevel) / 2);
            const n = Math.ceil(Math.pow(zCred * sigma / epsilon, 2));
            const actualWidth = zCred * sigma / Math.sqrt(n);

            currentCalculation = {
                approachName: 'ACC',
                approachFullName: 'Average Coverage Criterion (ACC)',
                inputs: {
                    'Data SD (sigma)': sigma,
                    'Target Half-Width (epsilon)': epsilon,
                    'Credible Level': (credLevel * 100) + '%'
                },
                formula: 'n = (z_cred x sigma / epsilon)^2',
                steps: [
                    `Critical value z for ${(credLevel * 100)}% CI: z = ${zCred.toFixed(4)}`,
                    `Required precision: z x sigma = ${zCred.toFixed(4)} x ${sigma} = ${(zCred * sigma).toFixed(4)}`,
                    `Sample size calculation: n = (${(zCred * sigma).toFixed(4)} / ${epsilon})^2`,
                    `n = ${Math.pow(zCred * sigma / epsilon, 2).toFixed(4)}`,
                    `Rounded up: n = ${n}`
                ],
                result: n,
                details: {
                    'Data SD': sigma.toFixed(3),
                    'Target Half-Width': epsilon.toFixed(4),
                    'Actual Half-Width': actualWidth.toFixed(4),
                    'Credible Level': (credLevel * 100).toFixed(0) + '%',
                    'Full CI Width': (2 * actualWidth).toFixed(4)
                },
                interpretation: `A sample size of ${n} ensures the credible interval achieves the target half-width of ${epsilon} on average. The actual half-width achieved will be ${actualWidth.toFixed(4)}, giving a full ${(credLevel * 100).toFixed(0)}% credible interval width of ${(2 * actualWidth).toFixed(4)}.`,
                priorRecommendations: getPriorRecommendations('acc', null),
                chartParams: { sigma, type: 'acc' }
            };

            displayResults(n, 'Sample Size (ACC)', currentCalculation.details, 'acc', { sigma });
        }

        function calculateHPD() {
            const priorSD = parseFloat(document.getElementById('hpd_prior_sd').value);
            const dataSD = parseFloat(document.getElementById('hpd_data_sd').value);
            const targetWidth = parseFloat(document.getElementById('hpd_target').value);
            const credLevel = parseFloat(document.getElementById('hpd_cred').value);

            const zCred = normalQuantile((1 + credLevel) / 2);
            const targetPosteriorSD = targetWidth / (2 * zCred);
            const priorVar = priorSD * priorSD;
            const dataVar = dataSD * dataSD;
            const targetPosteriorVar = targetPosteriorSD * targetPosteriorSD;

            const n = Math.max(1, Math.ceil((1/targetPosteriorVar - 1/priorVar) * dataVar));

            const actualPosteriorVar = 1 / (1/priorVar + n/dataVar);
            const actualPosteriorSD = Math.sqrt(actualPosteriorVar);
            const actualWidth = 2 * zCred * actualPosteriorSD;

            currentCalculation = {
                approachName: 'HPD Width',
                approachFullName: 'Highest Posterior Density (HPD) Width Criterion',
                inputs: {
                    'Prior SD (sigma_0)': priorSD,
                    'Data SD (sigma)': dataSD,
                    'Target HPD Width': targetWidth,
                    'Credible Level': (credLevel * 100) + '%'
                },
                formula: 'HPD Width = 2 x z_cred x sigma_posterior; sigma_posterior = 1/sqrt(1/sigma^2_0 + n/sigma^2)',
                steps: [
                    `Critical value z for ${(credLevel * 100)}% CI: z = ${zCred.toFixed(4)}`,
                    `Target posterior SD: ${targetWidth} / (2 x ${zCred.toFixed(4)}) = ${targetPosteriorSD.toFixed(6)}`,
                    `Target posterior variance: ${targetPosteriorSD.toFixed(6)}^2 = ${targetPosteriorVar.toFixed(8)}`,
                    `Prior variance: ${priorSD}^2 = ${priorVar.toFixed(4)}`,
                    `Data variance: ${dataSD}^2 = ${dataVar.toFixed(4)}`,
                    `n = (1/${targetPosteriorVar.toFixed(8)} - 1/${priorVar.toFixed(4)}) x ${dataVar.toFixed(4)}`,
                    `n = ${((1/targetPosteriorVar - 1/priorVar) * dataVar).toFixed(2)}`,
                    `Rounded up: n = ${n}`
                ],
                result: n,
                details: {
                    'Prior SD': priorSD.toFixed(3),
                    'Data SD': dataSD.toFixed(3),
                    'Target HPD Width': targetWidth.toFixed(4),
                    'Actual HPD Width': actualWidth.toFixed(4),
                    'Posterior SD': actualPosteriorSD.toFixed(4),
                    'Credible Level': (credLevel * 100).toFixed(0) + '%'
                },
                interpretation: `A sample size of ${n} is required to achieve the target HPD width of ${targetWidth}. With this sample size, the actual HPD width will be ${actualWidth.toFixed(4)} for a ${(credLevel * 100).toFixed(0)}% credible interval. The posterior standard deviation will be ${actualPosteriorSD.toFixed(4)}.`,
                priorRecommendations: getPriorRecommendations('hpd', priorSD),
                chartParams: { priorSD, dataSD, type: 'hpd' }
            };

            displayResults(n, 'Sample Size (HPD Width)', currentCalculation.details, 'hpd', { priorSD, dataSD });
        }

        function calculateBayesFactor() {
            const effect = parseFloat(document.getElementById('bf_effect').value);
            const targetBF = parseFloat(document.getElementById('bf_target').value);
            const scale = parseFloat(document.getElementById('bf_scale').value);

            let n = 10;
            let achievedBF = 0;
            for (let iter = 0; iter < 100; iter++) {
                const logBF = (n * effect * effect) / 2 - Math.log(n) / 2 - Math.log(scale * Math.sqrt(2 * Math.PI));
                achievedBF = Math.exp(logBF);
                if (achievedBF >= targetBF) break;
                n += 5;
            }

            const logBF = (n * effect * effect) / 2 - Math.log(n) / 2 - Math.log(scale * Math.sqrt(2 * Math.PI));
            achievedBF = Math.exp(logBF);

            let evidenceLevel = '';
            if (achievedBF < 3) evidenceLevel = 'Anecdotal';
            else if (achievedBF < 10) evidenceLevel = 'Moderate';
            else if (achievedBF < 30) evidenceLevel = 'Strong';
            else if (achievedBF < 100) evidenceLevel = 'Very Strong';
            else evidenceLevel = 'Decisive';

            currentCalculation = {
                approachName: 'Bayes Factor',
                approachFullName: 'Bayes Factor Target Sample Size',
                inputs: {
                    'Expected Effect Size (d)': effect,
                    'Target Bayes Factor': targetBF,
                    'Prior Scale (Cauchy width)': scale
                },
                formula: 'log(BF) approx= n x d^2 / 2 - log(n) / 2 - log(r x sqrt(2*pi))',
                steps: [
                    `Effect size: d = ${effect}`,
                    `Target Bayes Factor: BF = ${targetBF}`,
                    `Prior scale (r): ${scale}`,
                    `Using BIC approximation for Bayes Factor`,
                    `Iterative search for n where BF >= ${targetBF}`,
                    `At n = ${n}: log(BF) = ${logBF.toFixed(4)}`,
                    `Achieved BF = exp(${logBF.toFixed(4)}) = ${achievedBF.toFixed(2)}`,
                    `Evidence level: ${evidenceLevel}`
                ],
                result: n,
                details: {
                    'Expected Effect (d)': effect.toFixed(3),
                    'Target Bayes Factor': targetBF,
                    'Achieved BF (approx)': achievedBF.toFixed(1),
                    'Evidence Level': evidenceLevel,
                    'Prior Scale': scale.toFixed(3),
                    'Total N (two groups)': n * 2
                },
                interpretation: `A sample size of ${n} per group (${n * 2} total) is needed to achieve ${evidenceLevel.toLowerCase()} evidence (BF > ${targetBF}) for an expected effect of d = ${effect}. The achieved Bayes Factor of approximately ${achievedBF.toFixed(1)} provides ${evidenceLevel.toLowerCase()} evidence for the alternative hypothesis relative to the null.`,
                priorRecommendations: getPriorRecommendations('bf', scale),
                chartParams: { effect, type: 'bf' }
            };

            displayResults(n, 'Sample Size per Group', currentCalculation.details, 'bf', { effect });
        }

        function calculateAssurance() {
            const priorMean = parseFloat(document.getElementById('ass_prior_mean').value);
            const priorSD = parseFloat(document.getElementById('ass_prior_sd').value);
            const dataSD = parseFloat(document.getElementById('ass_data_sd').value);
            const targetAssurance = parseFloat(document.getElementById('ass_target').value);
            const threshold = parseFloat(document.getElementById('ass_threshold').value);

            let n = 10;
            let finalAssurance = 0;
            for (let iter = 0; iter < 200; iter++) {
                let successes = 0;
                const nSim = 1000;

                for (let i = 0; i < nSim; i++) {
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    const theta = priorMean + priorSD * z;

                    const u3 = Math.random();
                    const u4 = Math.random();
                    const z2 = Math.sqrt(-2 * Math.log(u3)) * Math.cos(2 * Math.PI * u4);
                    const xbar = theta + (dataSD / Math.sqrt(n)) * z2;

                    const priorVar = priorSD * priorSD;
                    const dataVar = dataSD * dataSD;
                    const posteriorVar = 1 / (1/priorVar + n/dataVar);
                    const posteriorMean = posteriorVar * (priorMean/priorVar + n*xbar/dataVar);
                    const posteriorSDCalc = Math.sqrt(posteriorVar);

                    const probSuccess = 1 - normalCDF((threshold - posteriorMean) / posteriorSDCalc);
                    if (probSuccess > 0.975) successes++;
                }

                finalAssurance = successes / nSim;
                if (finalAssurance >= targetAssurance) break;
                n += 5;
            }

            currentCalculation = {
                approachName: 'Assurance',
                approachFullName: 'Assurance / Probability of Success (PoS)',
                inputs: {
                    'Prior Mean (expected effect)': priorMean,
                    'Prior SD (uncertainty)': priorSD,
                    'Data SD': dataSD,
                    'Target Assurance': (targetAssurance * 100) + '%',
                    'Decision Threshold': threshold
                },
                formula: 'Assurance = E[P(posterior > threshold | data)] averaged over prior',
                steps: [
                    `Prior distribution: N(${priorMean}, ${priorSD}^2)`,
                    `Data likelihood: N(theta, ${dataSD}^2/n)`,
                    `Decision rule: Posterior P(theta > ${threshold}) > 97.5%`,
                    `Target assurance: ${(targetAssurance * 100)}%`,
                    `Monte Carlo simulation with 1000 iterations`,
                    `Iterative search for n where assurance >= ${(targetAssurance * 100)}%`,
                    `At n = ${n}: Estimated assurance = ${(finalAssurance * 100).toFixed(1)}%`
                ],
                result: n,
                details: {
                    'Prior Mean': priorMean.toFixed(3),
                    'Prior SD': priorSD.toFixed(3),
                    'Data SD': dataSD.toFixed(3),
                    'Target Assurance': (targetAssurance * 100).toFixed(0) + '%',
                    'Decision Threshold': threshold.toFixed(3),
                    'Per Group': n,
                    'Total (two groups)': n * 2
                },
                interpretation: `A sample size of ${n} per group (${n * 2} total) provides approximately ${(targetAssurance * 100).toFixed(0)}% assurance of demonstrating a treatment benefit (posterior probability > 97.5% that effect > ${threshold}). This accounts for uncertainty in the true effect size as represented by the prior distribution N(${priorMean}, ${priorSD}^2).`,
                priorRecommendations: getPriorRecommendations('assurance', priorSD),
                chartParams: { priorMean, priorSD, dataSD, type: 'assurance' }
            };

            displayResults(n, 'Sample Size (Assurance)', currentCalculation.details, 'assurance', { priorMean, priorSD, dataSD });
        }

        function getPriorRecommendations(type, priorParam) {
            const recommendations = {
                apvc: `For APVC calculations, the prior SD reflects your uncertainty about the parameter before seeing data. A non-informative prior (large SD > 10) lets the data dominate. Historical data from similar studies can inform more precise priors. Consider sensitivity analysis with different prior specifications. Reference: Spiegelhalter et al. (2004) Chapter 5.`,
                acc: `The ACC approach focuses on achieving desired credible interval precision. For clinical trials, consider what precision is clinically meaningful. The approach is relatively robust to prior specification as it primarily depends on data variance. Reference: Berry et al. (2010) Chapter 3.`,
                hpd: `HPD intervals provide the narrowest credible intervals for a given probability. The prior SD should reflect genuine prior knowledge - too narrow may bias results, too wide may be uninformative. Consider expert elicitation methods for prior specification. Reference: O'Hagan & Stevens (2001).`,
                bf: `For Bayes Factor analysis, the default Cauchy prior scale of 0.707 (sqrt(2)/2) is recommended for standardized effect sizes. Adjust based on domain knowledge - larger scales favor smaller effects. The JZS prior (Cauchy) is invariant under linear transformations. Reference: Morey & Rouder (2011).`,
                assurance: `Assurance calculations are sensitive to prior specification. Use meta-analyses or pilot data to inform the prior mean and SD. Consider optimistic, neutral, and skeptical scenarios. Assurance typically requires larger samples than frequentist power for the same effect. Reference: O'Hagan & Stevens (2001).`
            };
            return recommendations[type] || 'Consult methodological references for prior specification guidance.';
        }

        function displayResults(mainValue, mainLabel, details, type, params) {
            document.getElementById('results').classList.add('active');
            document.getElementById('mainValue').textContent = mainValue;
            document.getElementById('mainLabel').textContent = mainLabel;

            let subText = '';
            if (type === 'apvc' || type === 'hpd') {
                subText = 'Based on posterior precision criterion';
            } else if (type === 'acc') {
                subText = 'Based on coverage probability criterion';
            } else if (type === 'bf') {
                subText = 'Based on Bayes Factor threshold';
            } else if (type === 'assurance') {
                subText = 'Based on probability of success';
            }
            document.getElementById('mainSub').textContent = subText;

            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            for (const [key, val] of Object.entries(details)) {
                grid.innerHTML += `
                    <div class="result-card">
                        <div class="result-card-label">${key}</div>
                        <div class="result-card-value">${val}</div>
                    </div>
                `;
            }

            // Display calculation steps
            const stepsContent = document.getElementById('stepsContent');
            stepsContent.innerHTML = '';
            currentCalculation.steps.forEach((step, idx) => {
                stepsContent.innerHTML += `
                    <div class="calc-step">
                        <span class="step-num">${idx + 1}</span>
                        ${step}
                    </div>
                `;
            });

            document.getElementById('interpretationText').textContent = currentCalculation.interpretation;
            document.getElementById('priorRecommendationsText').textContent = currentCalculation.priorRecommendations;

            drawBayesChart(type, params, mainValue);

            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function drawBayesChart(type, params, targetN) {
            const ctx = document.getElementById('bayesChart').getContext('2d');

            if (bayesChart) bayesChart.destroy();

            const labels = [];
            const data = [];

            if (type === 'apvc' || type === 'hpd') {
                document.getElementById('chartTitle').textContent = 'Posterior SD vs Sample Size';
                const priorVar = params.priorSD * params.priorSD;
                const dataVar = params.dataSD * params.dataSD;

                for (let n = 10; n <= Math.max(200, targetN * 1.5); n += 10) {
                    labels.push(n);
                    const posteriorVar = 1 / (1/priorVar + n/dataVar);
                    data.push(Math.sqrt(posteriorVar).toFixed(4));
                }

                bayesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Posterior SD',
                            data: data,
                            borderColor: '#F43F5E',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Sample Size' } },
                            y: { title: { display: true, text: 'Posterior SD' } }
                        }
                    }
                });

                currentCalculation.chartData = { labels, data, type: 'posteriorSD' };

            } else if (type === 'bf') {
                document.getElementById('chartTitle').textContent = 'Bayes Factor vs Sample Size';
                const effect = params.effect;
                const scale = 0.707;

                for (let n = 10; n <= Math.max(200, targetN * 1.5); n += 10) {
                    labels.push(n);
                    const logBF = (n * effect * effect) / 2 - Math.log(n) / 2 - Math.log(scale * Math.sqrt(2 * Math.PI));
                    data.push(Math.min(1000, Math.exp(logBF)).toFixed(1));
                }

                bayesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Bayes Factor',
                            data: data,
                            borderColor: '#F43F5E',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Sample Size per Group' } },
                            y: { title: { display: true, text: 'Bayes Factor' }, type: 'logarithmic' }
                        }
                    }
                });

                currentCalculation.chartData = { labels, data, type: 'bayesFactor' };

            } else if (type === 'acc') {
                document.getElementById('chartTitle').textContent = 'CI Half-Width vs Sample Size';
                const sigma = params.sigma;
                const zCred = normalQuantile(0.975);

                for (let n = 10; n <= Math.max(200, targetN * 1.5); n += 10) {
                    labels.push(n);
                    const halfWidth = zCred * sigma / Math.sqrt(n);
                    data.push(halfWidth.toFixed(4));
                }

                bayesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'CI Half-Width',
                            data: data,
                            borderColor: '#F43F5E',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Sample Size' } },
                            y: { title: { display: true, text: 'Half-Width' } }
                        }
                    }
                });

                currentCalculation.chartData = { labels, data, type: 'ciWidth' };

            } else {
                document.getElementById('chartTitle').textContent = 'Sample Size Analysis';
                currentCalculation.chartData = null;
            }
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9790;' : '&#9728;';
            localStorage.setItem('karmastat-theme', isDark ? 'light' : 'dark');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saved = localStorage.getItem('karmastat-theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                document.getElementById('themeIcon').innerHTML = saved === 'dark' ? '&#9728;' : '&#9790;';
            }
        });

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pdfTheme = document.getElementById('pdfTheme').value;

            // Theme colors
            const isDark = pdfTheme === 'dark';
            const bgColor = isDark ? [28, 25, 23] : [255, 255, 255];
            const textColor = isDark ? [243, 244, 246] : [31, 41, 55];
            const mutedColor = isDark ? [156, 163, 175] : [107, 114, 128];
            const primaryColor = [244, 63, 94]; // Rose #F43F5E
            const accentBg = isDark ? [41, 37, 36] : [255, 241, 242];

            // Set background for dark theme
            if (isDark) {
                doc.setFillColor(...bgColor);
                doc.rect(0, 0, 210, 297, 'F');
            }

            let yPos = 15;

            // Header with gradient effect (simulated with rectangles)
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 4, 'F');

            // Logo and Title
            doc.setFillColor(...primaryColor);
            doc.circle(25, 22, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('K', 22.5, 26);

            doc.setTextColor(...primaryColor);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('KARMASTAT', 40, 20);

            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Bayesian Sample Size Analysis Report', 40, 28);

            yPos = 45;

            // Approach Name Box
            doc.setFillColor(...primaryColor);
            doc.roundedRect(15, yPos, 180, 12, 3, 3, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(currentCalculation.approachFullName, 105, yPos + 8, { align: 'center' });
            yPos += 20;

            // Main Result Box
            doc.setFillColor(...accentBg);
            doc.roundedRect(15, yPos, 180, 25, 3, 3, 'F');
            doc.setTextColor(...primaryColor);
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.text(String(currentCalculation.result), 105, yPos + 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setTextColor(...mutedColor);
            doc.text('Required Sample Size', 105, yPos + 22, { align: 'center' });
            yPos += 32;

            // Input Parameters Section
            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Input Parameters', 22, yPos + 7);
            yPos += 14;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            for (const [key, val] of Object.entries(currentCalculation.inputs)) {
                doc.setTextColor(...mutedColor);
                doc.text(key + ':', 22, yPos);
                doc.setTextColor(...textColor);
                doc.text(String(val), 100, yPos);
                yPos += 6;
            }
            yPos += 5;

            // Formula Section
            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Formula', 22, yPos + 7);
            yPos += 14;

            doc.setFillColor(...accentBg);
            doc.roundedRect(15, yPos, 180, 10, 2, 2, 'F');
            doc.setFontSize(9);
            doc.setFont('courier', 'normal');
            doc.setTextColor(...textColor);
            doc.text(currentCalculation.formula, 105, yPos + 7, { align: 'center' });
            yPos += 18;

            // Step-by-Step Calculation
            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Step-by-Step Calculation', 22, yPos + 7);
            yPos += 14;

            doc.setFontSize(9);
            doc.setFont('courier', 'normal');
            currentCalculation.steps.forEach((step, idx) => {
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }

                doc.setFillColor(...primaryColor);
                doc.circle(20, yPos - 1, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(7);
                doc.text(String(idx + 1), 18.5, yPos + 0.5);

                doc.setTextColor(...textColor);
                doc.setFontSize(9);
                doc.setFont('courier', 'normal');

                // Word wrap for long steps
                const maxWidth = 165;
                const lines = doc.splitTextToSize(step, maxWidth);
                lines.forEach((line, lineIdx) => {
                    doc.text(line, 28, yPos + (lineIdx * 5));
                });
                yPos += lines.length * 5 + 3;
            });
            yPos += 5;

            // Results Details
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Calculation Results', 22, yPos + 7);
            yPos += 14;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const detailEntries = Object.entries(currentCalculation.details);
            const colWidth = 90;
            let col = 0;
            let startY = yPos;

            detailEntries.forEach(([key, val], idx) => {
                const xOffset = 22 + (col * colWidth);
                doc.setTextColor(...mutedColor);
                doc.text(key + ':', xOffset, yPos);
                doc.setTextColor(...primaryColor);
                doc.setFont('helvetica', 'bold');
                doc.text(String(val), xOffset + 50, yPos);
                doc.setFont('helvetica', 'normal');

                if (col === 0) {
                    col = 1;
                } else {
                    col = 0;
                    yPos += 7;
                }
            });
            if (col === 1) yPos += 7;
            yPos += 8;

            // Interpretation Section
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(...primaryColor);
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Interpretation', 22, yPos + 7);
            yPos += 14;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const interpLines = doc.splitTextToSize(currentCalculation.interpretation, 175);
            interpLines.forEach(line => {
                if (yPos > 275) {
                    doc.addPage();
                    yPos = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }
                doc.text(line, 22, yPos);
                yPos += 5;
            });
            yPos += 8;

            // Prior Recommendations
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(245, 158, 11); // Warning color
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Prior Specification Recommendations', 22, yPos + 7);
            yPos += 14;

            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const priorLines = doc.splitTextToSize(currentCalculation.priorRecommendations, 175);
            priorLines.forEach(line => {
                if (yPos > 275) {
                    doc.addPage();
                    yPos = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }
                doc.text(line, 22, yPos);
                yPos += 5;
            });
            yPos += 8;

            // References Section
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
                if (isDark) {
                    doc.setFillColor(...bgColor);
                    doc.rect(0, 0, 210, 297, 'F');
                }
            }

            doc.setFillColor(59, 130, 246); // Info color
            doc.rect(15, yPos, 3, 10, 'F');
            doc.setTextColor(...textColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('References', 22, yPos + 7);
            yPos += 14;

            const references = [
                'Spiegelhalter, D.J., Abrams, K.R., & Myles, J.P. (2004). Bayesian Approaches to Clinical Trials and Health-Care Evaluation. Wiley.',
                'Berry, S.M., Carlin, B.P., Lee, J.J., & Muller, P. (2010). Bayesian Adaptive Methods for Clinical Trials. CRC Press.',
                "O'Hagan, A., & Stevens, J.W. (2001). Bayesian assessment of sample size for clinical trials of cost-effectiveness. Medical Decision Making, 21(3), 219-230.",
                'Morey, R.D., & Rouder, J.N. (2011). Bayes Factor Approaches for Testing Interval Null Hypotheses. Psychological Methods, 16(4), 406-419.'
            ];

            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            references.forEach((ref, idx) => {
                if (yPos > 275) {
                    doc.addPage();
                    yPos = 20;
                    if (isDark) {
                        doc.setFillColor(...bgColor);
                        doc.rect(0, 0, 210, 297, 'F');
                    }
                }
                const refLines = doc.splitTextToSize(`${idx + 1}. ${ref}`, 175);
                refLines.forEach(line => {
                    doc.text(line, 22, yPos);
                    yPos += 4;
                });
                yPos += 2;
            });

            // Footer
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Footer background
                doc.setFillColor(...primaryColor);
                doc.rect(0, 282, 210, 15, 'F');

                // Footer text
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text('Generated by KARMASTAT - Crafted by Karmayogi', 105, 289, { align: 'center' });

                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                const timestamp = new Date().toLocaleString();
                doc.text(`${timestamp} | Page ${i} of ${pageCount}`, 105, 294, { align: 'center' });
            }

            // Save PDF
            const filename = `KARMASTAT_Bayesian_${currentCalculation.approachName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);
        }
    </script>
</body>
</html>
