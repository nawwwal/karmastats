<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Advanced Comparative Epidemiological Study Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Enhanced CSS Variables for Academic Research Interface */
        :root {
            --primary: #FF8C42;
            --primary-dark: #E67A2F;
            --primary-light: #FFB570;
            --secondary: #2C5282;
            --accent: #F6AD55;
            --success: #38A169;
            --warning: #D69E2E;
            --danger: #E53E3E;
            --info: #3182CE;
            
            /* Light theme colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7FAFC;
            --bg-card: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-muted: #718096;
            --border-color: #E2E8F0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            
            /* Enhanced gradients for academic presentation */
            --gradient-primary: linear-gradient(135deg, #FF8C42, #F6AD55, #FFB570);
            --gradient-secondary: linear-gradient(135deg, #2C5282, #3182CE, #4299E1);
            --gradient-bg: linear-gradient(135deg, #FFF5F0, #FEEBC8, #FED7AA);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #F7FAFC);
            --gradient-magic: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-analytical: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-formula: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', 'Menlo', monospace;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #1A202C;
            --bg-secondary: #2D3748;
            --bg-card: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #E2E8F0;
            --text-muted: #A0AEC0;
            --border-color: #4A5568;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1A202C, #2D3748, #4A5568);
            --gradient-card: linear-gradient(145deg, #2D3748, #4A5568);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header Design */
        .header {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            max-width: 800px;
            margin: 0 auto;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Study Type Selection */
        .study-type-selection {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .study-type-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .study-type-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .study-type-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .study-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .study-type-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .study-type-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .study-type-card:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.2);
        }

        .study-type-card.active {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .study-type-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .study-type-card.active::after {
            content: '‚úì Selected';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .study-card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-analytical);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .study-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .study-card-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .study-card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-badge {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        /* Calculator Section */
        .calculator-section {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .calculator-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calculator-section:hover {
            box-shadow: var(--shadow-hover);
        }

        @keyframes slideInFromBottom {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: var(--shadow);
        }

        .section-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Enhanced Formula Display for Academic Reference */
        .formula-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin: 1.5rem 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .formula-toggle {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .formula-toggle:hover {
            background: var(--bg-secondary);
        }

        .formula-toggle-icon {
            margin-right: 1rem;
            transition: transform 0.3s ease;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .formula-toggle.active .formula-toggle-icon {
            transform: rotate(90deg);
        }

        .formula-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .formula-content.active {
            max-height: 800px;
        }

        .formula-display {
            background: var(--gradient-formula);
            color: white;
            padding: 1.5rem;
            margin: 1.5rem;
            font-family: var(--font-mono);
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .formula-explanation {
            padding: 0 1.5rem 1.5rem;
        }

        .formula-explanation h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .formula-explanation h5 {
            color: var(--secondary);
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .formula-explanation ul {
            list-style-type: none;
            padding: 0;
        }

        .formula-explanation li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .formula-explanation li:last-child {
            border-bottom: none;
        }

        .formula-var {
            font-family: var(--font-mono);
            font-weight: bold;
            color: var(--primary);
            min-width: 80px;
            font-size: 1.1rem;
        }

        .formula-desc {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .formula-note {
            background: rgba(255, 140, 66, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 1.5rem;
            border-radius: 6px;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Enhanced PDF Upload */
        .pdf-upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .pdf-upload-section:hover {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.03);
        }

        .pdf-upload-section.dragover {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-magic);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: var(--transition);
        }

        .pdf-upload-section:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        /* Advanced Intelligent Analysis Display */
        .magical-analysis-container {
            display: none;
            margin-top: 2rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        .magical-analysis-header {
            background: var(--gradient-magic);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .magical-analysis-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .magical-analysis-content {
            padding: 2rem;
        }

        .parameter-extraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .parameter-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
        }

        .parameter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .parameter-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .parameter-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .parameter-confidence {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--gradient-magic);
            transition: width 0.5s ease;
        }

        .parameter-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Enhanced Form Styles */
        .form-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .form-section h4 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.1);
            transform: translateY(-1px);
        }

        .input-help {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .calculate-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1.25rem 2rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .results-section.show {
            display: block;
        }

        .result-card {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .result-main {
            font-size: 4rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .detail-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: left;
        }

        .detail-card h4 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error styling */
        .error-message {
            background: #FED7D7;
            border: 1px solid #E53E3E;
            color: #C53030;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success-message {
            background: #C6F6D5;
            border: 1px solid #38A169;
            color: #2F855A;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 1rem;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
                align-self: center;
            }
            
            .study-type-grid {
                grid-template-columns: 1fr;
            }
            
            .parameter-extraction-grid {
                grid-template-columns: 1fr;
            }
            
            .result-main {
                font-size: 3rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Enhanced Header with Academic Branding -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">K</div>
                    <div>
                        <h1>KARMASTAT</h1>
                        <p class="subtitle">Advanced Comparative Epidemiological Study Calculator with Intelligent Academic Parameter Extraction</p>
                    </div>
                </div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <span id="themeIcon">üåô</span>
                <span id="themeText">Dark Mode</span>
            </div>
        </div>

        <!-- Study Type Selection -->
        <div class="study-type-selection">
            <div class="study-type-header">
                <h2 class="study-type-title">Select Comparative Study Design</h2>
                <p class="study-type-subtitle">Choose the appropriate analytical epidemiological design for your research objectives</p>
            </div>
            
            <div class="study-type-grid">
                <div class="study-type-card" id="caseControlCard" data-study="case-control" tabindex="0">
                    <div class="study-card-icon">üìã</div>
                    <h3 class="study-card-title">Case-Control Study</h3>
                    <p class="study-card-description">
                        Retrospective analytical design comparing exposure prevalence between disease cases and healthy controls. 
                        Optimal for investigating risk factors and etiological associations with rare diseases or outcomes requiring efficient resource utilization.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Odds Ratio Estimation</span>
                        <span class="feature-badge">Retrospective Design</span>
                        <span class="feature-badge">Efficient for Rare Diseases</span>
                        <span class="feature-badge">Case-Control Matching</span>
                    </div>
                </div>

                <div class="study-type-card" id="cohortCard" data-study="cohort" tabindex="0">
                    <div class="study-card-icon">üë•</div>
                    <h3 class="study-card-title">Cohort Study</h3>
                    <p class="study-card-description">
                        Prospective or retrospective longitudinal design following exposed and unexposed groups over time. 
                        Optimal for measuring disease incidence and establishing temporal relationships between exposure and outcome parameters.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Relative Risk Calculation</span>
                        <span class="feature-badge">Temporal Sequence</span>
                        <span class="feature-badge">Incidence Measurement</span>
                        <span class="feature-badge">Multiple Outcomes</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Case-Control Study Calculator -->
            <div class="calculator-section" id="caseControlCalculator">
                <div class="section-header">
                    <div class="section-icon">üìã</div>
                    <h3>Case-Control Study Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="caseControlFormulaToggle">
                        <span class="formula-toggle-icon">‚ñ∂</span>
                        <strong>Statistical Formula & Epidemiological Methodology</strong>
                    </div>
                    <div class="formula-content" id="caseControlFormulaContent">
                        <div class="formula-display">
                            n = [z(Œ±/2)‚àö{(1+1/k)pÃÑqÃÑ} + z(Œ≤)‚àö{p‚ÇÅq‚ÇÅ + p‚ÇÄq‚ÇÄ/k}]¬≤ / (p‚ÇÅ - p‚ÇÄ)¬≤
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Case-Control Studies:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required sample size per case group</span>
                                </li>
                                <li>
                                    <span class="formula-var">z(Œ±/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level (e.g., 1.96 for Œ±=0.05)</span>
                                </li>
                                <li>
                                    <span class="formula-var">z(Œ≤)</span>
                                    <span class="formula-desc">Critical value for statistical power (e.g., 0.84 for 80% power)</span>
                                </li>
                                <li>
                                    <span class="formula-var">k</span>
                                    <span class="formula-desc">Ratio of controls to cases (k:1 matching)</span>
                                </li>
                                <li>
                                    <span class="formula-var">p‚ÇÅ</span>
                                    <span class="formula-desc">Expected exposure proportion in cases</span>
                                </li>
                                <li>
                                    <span class="formula-var">p‚ÇÄ</span>
                                    <span class="formula-desc">Expected exposure proportion in controls</span>
                                </li>
                                <li>
                                    <span class="formula-var">pÃÑ, qÃÑ</span>
                                    <span class="formula-desc">Pooled proportions: pÃÑ = (p‚ÇÅ + kp‚ÇÄ)/(1+k), qÃÑ = 1-pÃÑ</span>
                                </li>
                            </ul>
                            <h5>Epidemiological Relationship:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                OR = [p‚ÇÅ/(1-p‚ÇÅ)] / [p‚ÇÄ/(1-p‚ÇÄ)] = (a √ó d) / (b √ó c)
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Fleiss, Levin & Paik (2003) with continuity correction applied for enhanced accuracy in small sample scenarios.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="caseControlPdfUploadSection">
                    <input type="file" id="caseControlPdfInput" class="file-input" accept=".pdf">
                    <label for="caseControlPdfInput">
                        <div class="upload-icon">üîÆ</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your case-control research paper for automated epidemiological parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="caseControlMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>‚ú®</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="caseControlProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing research methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="caseControlParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="caseControlApplyBtn">
                                <span>‚úì</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="caseControlReviewBtn">
                                <span>üìã</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="caseControlForm">
                    <div class="form-section">
                        <h4>üìà Case-Control Study Parameters</h4>
                        
                        <div class="input-group">
                            <label for="controlExposure">Exposure Prevalence in Controls (%)</label>
                            <input type="number" id="controlExposure" class="input-field" 
                                   min="0.1" max="99.9" step="0.1" value="20" required>
                            <div class="input-help">Expected proportion of controls with exposure history (baseline exposure rate in target population)</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="expectedOddsRatio">Expected Odds Ratio (OR)</label>
                            <input type="number" id="expectedOddsRatio" class="input-field" 
                                   min="0.1" step="0.1" value="2.0" required>
                            <div class="input-help">Minimum clinically significant odds ratio to detect (OR = 1.0 indicates no association)</div>
                        </div>

                        <div class="input-group">
                            <label for="caseControlRatio">Case:Control Matching Ratio</label>
                            <select id="caseControlRatio" class="input-field" required>
                                <option value="1" selected>1:1 (Equal Cases and Controls)</option>
                                <option value="2">1:2 (Two Controls per Case)</option>
                                <option value="3">1:3 (Three Controls per Case)</option>
                                <option value="4">1:4 (Four Controls per Case)</option>
                                <option value="0.5">2:1 (Two Cases per Control)</option>
                            </select>
                            <div class="input-help">Ratio of controls to cases (higher ratios increase statistical power with diminishing returns)</div>
                        </div>

                        <div class="input-group">
                            <label for="significanceLevel">Significance Level (Œ±)</label>
                            <select id="significanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="statisticalPower">Statistical Power (1-Œ≤)</label>
                            <select id="statisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="nonResponseCaseControl">Expected Non-Response Rate (%)</label>
                            <input type="number" id="nonResponseCaseControl" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of non-participating subjects requiring sample size inflation</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>üßÆ</span>
                        Calculate Case-Control Sample Size
                    </button>
                </form>
            </div>

            <!-- Cohort Study Calculator -->
            <div class="calculator-section" id="cohortCalculator">
                <div class="section-header">
                    <div class="section-icon">üë•</div>
                    <h3>Cohort Study Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="cohortFormulaToggle">
                        <span class="formula-toggle-icon">‚ñ∂</span>
                        <strong>Statistical Formula & Epidemiological Methodology</strong>
                    </div>
                    <div class="formula-content" id="cohortFormulaContent">
                        <div class="formula-display">
                            n = [z(Œ±/2)‚àö{(1+1/k)pÃÑqÃÑ} + z(Œ≤)‚àö{p‚ÇÅq‚ÇÅ + p‚ÇÄq‚ÇÄ/k}]¬≤ / (p‚ÇÅ - p‚ÇÄ)¬≤
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Cohort Studies:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required sample size per unexposed group</span>
                                </li>
                                <li>
                                    <span class="formula-var">z(Œ±/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level</span>
                                </li>
                                <li>
                                    <span class="formula-var">z(Œ≤)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                                <li>
                                    <span class="formula-var">k</span>
                                    <span class="formula-desc">Ratio of exposed to unexposed subjects</span>
                                </li>
                                <li>
                                    <span class="formula-var">p‚ÇÅ</span>
                                    <span class="formula-desc">Expected incidence proportion in exposed group</span>
                                </li>
                                <li>
                                    <span class="formula-var">p‚ÇÄ</span>
                                    <span class="formula-desc">Expected incidence proportion in unexposed group</span>
                                </li>
                                <li>
                                    <span class="formula-var">pÃÑ, qÃÑ</span>
                                    <span class="formula-desc">Pooled proportions: pÃÑ = (kp‚ÇÅ + p‚ÇÄ)/(k+1), qÃÑ = 1-pÃÑ</span>
                                </li>
                            </ul>
                            <h5>Epidemiological Measures:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                RR = p‚ÇÅ / p‚ÇÄ     AR = p‚ÇÅ - p‚ÇÄ     AR% = [(p‚ÇÅ - p‚ÇÄ) / p‚ÇÅ] √ó 100
                            </div>
                            <div class="formula-display" style="margin-top: 1rem;">
                                n' = n / (1 - L)¬≤
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Kelsey et al. (1996) with loss-to-follow-up adjustment where L = expected loss proportion. Sample size squared adjustment accounts for differential loss patterns.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="cohortPdfUploadSection">
                    <input type="file" id="cohortPdfInput" class="file-input" accept=".pdf">
                    <label for="cohortPdfInput">
                        <div class="upload-icon">üîÆ</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your cohort research paper for automated epidemiological parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="cohortMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>‚ú®</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="cohortProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing research methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="cohortParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="cohortApplyBtn">
                                <span>‚úì</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="cohortReviewBtn">
                                <span>üìã</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="cohortForm">
                    <div class="form-section">
                        <h4>üìà Cohort Study Parameters</h4>
                        
                        <div class="input-group">
                            <label for="unexposedIncidence">Incidence in Unexposed Group (%)</label>
                            <input type="number" id="unexposedIncidence" class="input-field" 
                                   min="0.1" max="99.9" step="0.1" value="10" required>
                            <div class="input-help">Expected disease incidence rate in the unexposed population (baseline risk)</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="expectedRelativeRisk">Expected Relative Risk (RR)</label>
                            <input type="number" id="expectedRelativeRisk" class="input-field" 
                                   min="0.1" step="0.1" value="2.0" required>
                            <div class="input-help">Minimum clinically significant relative risk to detect (RR = 1.0 indicates no association)</div>
                        </div>

                        <div class="input-group">
                            <label for="exposedUnexposedRatio">Exposed:Unexposed Allocation Ratio</label>
                            <select id="exposedUnexposedRatio" class="input-field" required>
                                <option value="1" selected>1:1 (Equal Groups)</option>
                                <option value="2">2:1 (More Exposed)</option>
                                <option value="0.5">1:2 (More Unexposed)</option>
                                <option value="3">3:1 (Three Exposed per Unexposed)</option>
                                <option value="0.33">1:3 (Three Unexposed per Exposed)</option>
                            </select>
                            <div class="input-help">Allocation ratio between exposed and unexposed groups</div>
                        </div>

                        <div class="input-group">
                            <label for="cohortSignificanceLevel">Significance Level (Œ±)</label>
                            <select id="cohortSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="cohortStatisticalPower">Statistical Power (1-Œ≤)</label>
                            <select id="cohortStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="lossToFollowUp">Expected Loss-to-Follow-up (%)</label>
                            <input type="number" id="lossToFollowUp" class="input-field" 
                                   min="0" max="50" step="1" value="15">
                            <div class="input-help">Expected proportion of subjects lost during follow-up period requiring sample size adjustment</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>üßÆ</span>
                        Calculate Cohort Sample Size
                    </button>
                </form>
            </div>

            <!-- Enhanced Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        class KarmastatAdvancedCalculator {
            constructor() {
                this.currentTheme = 'light';
                this.currentStudyType = null;
                this.extractedParams = {};
                this.intelligentAnalysisEngine = new AdvancedEpidemiologicalAnalysisEngine();
                this.init();
            }

            init() {
                console.log('üöÄ Initializing KARMASTAT Advanced Epidemiological Calculator...');
                
                try {
                    // Initialize PDF.js worker with enhanced configuration
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                    
                    this.setupEventListeners();
                    this.loadSavedTheme();
                    
                    console.log('‚úÖ KARMASTAT Advanced Calculator initialized successfully');
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showError('Failed to initialize calculator. Please refresh the page.');
                }
            }

            setupEventListeners() {
                // Theme toggle functionality
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
                
                // Study type selection with enhanced validation
                this.setupStudyTypeSelection();
                
                // Formula toggle functionality
                this.setupFormulaToggles();
                
                // PDF upload functionality with advanced processing
                this.setupPdfUploadHandlers();
                
                // Parameter application handlers with validation
                this.setupParameterHandlers();
                
                // Form submission handlers with comprehensive validation
                this.setupFormHandlers();
                
                // Drag and drop functionality with file validation
                this.setupDragAndDrop();
            }

            setupStudyTypeSelection() {
                const studyTypeCards = document.querySelectorAll('.study-type-card');
                studyTypeCards.forEach(card => {
                    const studyType = card.dataset.study;
                    if (studyType) {
                        card.addEventListener('click', () => this.selectStudyType(studyType));
                        card.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                this.selectStudyType(studyType);
                            }
                        });
                    }
                });
            }

            setupFormulaToggles() {
                const formulaToggles = [
                    { id: 'caseControlFormulaToggle', contentId: 'caseControlFormulaContent' },
                    { id: 'cohortFormulaToggle', contentId: 'cohortFormulaContent' }
                ];
                
                formulaToggles.forEach(({ id, contentId }) => {
                    const toggle = document.getElementById(id);
                    const content = document.getElementById(contentId);
                    
                    if (toggle && content) {
                        toggle.addEventListener('click', () => {
                            toggle.classList.toggle('active');
                            content.classList.toggle('active');
                        });
                    }
                });
            }

            setupPdfUploadHandlers() {
                // Case-control PDF upload with enhanced processing
                const caseControlPdfInput = document.getElementById('caseControlPdfInput');
                if (caseControlPdfInput) {
                    caseControlPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'case-control'));
                }
                
                // Cohort PDF upload with enhanced processing
                const cohortPdfInput = document.getElementById('cohortPdfInput');
                if (cohortPdfInput) {
                    cohortPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'cohort'));
                }
            }

            setupParameterHandlers() {
                const parameterHandlers = [
                    { applyId: 'caseControlApplyBtn', reviewId: 'caseControlReviewBtn', type: 'case-control' },
                    { applyId: 'cohortApplyBtn', reviewId: 'cohortReviewBtn', type: 'cohort' }
                ];
                
                parameterHandlers.forEach(({ applyId, reviewId, type }) => {
                    const applyBtn = document.getElementById(applyId);
                    const reviewBtn = document.getElementById(reviewId);
                    
                    if (applyBtn) {
                        applyBtn.addEventListener('click', () => this.applyExtractedParameters(type));
                    }
                    if (reviewBtn) {
                        reviewBtn.addEventListener('click', () => this.reviewExtractionDetails(type));
                    }
                });
            }

            setupFormHandlers() {
                // Case-control form with enhanced validation
                const caseControlForm = document.getElementById('caseControlForm');
                if (caseControlForm) {
                    caseControlForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'case-control'));
                }
                
                // Cohort form with enhanced validation
                const cohortForm = document.getElementById('cohortForm');
                if (cohortForm) {
                    cohortForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'cohort'));
                }
            }

            setupDragAndDrop() {
                const uploadSections = ['caseControlPdfUploadSection', 'cohortPdfUploadSection'];
                
                uploadSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (!section) return;
                    
                    section.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        section.classList.add('dragover');
                    });
                    
                    section.addEventListener('dragleave', () => {
                        section.classList.remove('dragover');
                    });
                    
                    section.addEventListener('drop', (e) => {
                        e.preventDefault();
                        section.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type === 'application/pdf') {
                            const studyType = sectionId.includes('caseControl') ? 'case-control' : 'cohort';
                            const inputId = studyType === 'case-control' ? 'caseControlPdfInput' : 'cohortPdfInput';
                            document.getElementById(inputId).files = files;
                            this.handlePdfUpload({ target: { files: files } }, studyType);
                        }
                    });
                });
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.currentTheme);
                
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                
                if (this.currentTheme === 'dark') {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark Mode';
                }
                
                localStorage.setItem('karmastat-theme', this.currentTheme);
            }

            loadSavedTheme() {
                const savedTheme = localStorage.getItem('karmastat-theme');
                if (savedTheme && savedTheme !== this.currentTheme) {
                    this.toggleTheme();
                }
            }

            selectStudyType(studyType) {
                console.log(`Selecting study type: ${studyType}`);
                
                try {
                    // Clear previous results
                    this.clearResults();
                    
                    // Update card selection with enhanced visual feedback
                    document.querySelectorAll('.study-type-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    const cardId = studyType === 'case-control' ? 'caseControlCard' : 'cohortCard';
                    const selectedCard = document.getElementById(cardId);
                    if (selectedCard) {
                        selectedCard.classList.add('active');
                    }
                    
                    // Hide all calculator sections
                    document.querySelectorAll('.calculator-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    // Show selected calculator with enhanced animation
                    const calculatorId = studyType === 'case-control' ? 'caseControlCalculator' : 'cohortCalculator';
                    const calculator = document.getElementById(calculatorId);
                    if (calculator) {
                        calculator.style.display = 'block';
                        calculator.classList.add('active');
                        this.currentStudyType = studyType;
                        
                        setTimeout(() => {
                            calculator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error selecting study type:', error);
                    this.showError('Error selecting study type. Please try again.');
                }
            }

            async handlePdfUpload(event, studyType) {
                const file = event.target.files[0];
                if (!file) return;

                console.log(`Processing PDF upload for ${studyType} study`);

                const analysisContainerId = studyType === 'case-control' ? 'caseControlMagicalAnalysis' : 'cohortMagicalAnalysis';
                const processingIndicatorId = studyType === 'case-control' ? 'caseControlProcessingIndicator' : 'cohortProcessingIndicator';
                
                const analysisContainer = document.getElementById(analysisContainerId);
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                // Show analysis container with enhanced feedback
                analysisContainer.style.display = 'block';
                processingIndicator.style.display = 'flex';
                processingIndicator.innerHTML = '<div class="spinner"></div><span>Analyzing research methodology...</span>';
                
                try {
                    // Process PDF with advanced intelligent analysis engine
                    const extractedData = await this.intelligentAnalysisEngine.analyzePDF(file, studyType);
                    
                    // Hide processing indicator
                    processingIndicator.style.display = 'none';
                    
                    // Display results with enhanced visualization
                    this.displayExtractionResults(extractedData, studyType);
                    this.extractedParams[studyType] = extractedData;
                    
                    console.log('Advanced PDF analysis completed successfully');
                    
                } catch (error) {
                    console.error('PDF analysis error:', error);
                    processingIndicator.innerHTML = '<span style="color: #E53E3E;">‚ùå Analysis failed. Please verify PDF quality and try again.</span>';
                }
            }

            displayExtractionResults(data, studyType) {
                const parameterGridId = studyType === 'case-control' ? 'caseControlParameterGrid' : 'cohortParameterGrid';
                const parameterGrid = document.getElementById(parameterGridId);
                
                if (!parameterGrid) return;
                
                parameterGrid.innerHTML = '';

                const parameterLabels = {
                    'case-control': {
                        controlExposure: 'Control Exposure Rate',
                        oddsRatio: 'Odds Ratio',
                        caseControlRatio: 'Case:Control Ratio',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    },
                    'cohort': {
                        unexposedIncidence: 'Unexposed Incidence',
                        relativeRisk: 'Relative Risk',
                        exposureRatio: 'Exposure Ratio',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    }
                };

                const labels = parameterLabels[studyType] || {};

                Object.entries(data.parameters || {}).forEach(([param, value]) => {
                    const source = data.sources?.[param] || {};
                    const confidence = source.confidence || 70;
                    
                    const card = document.createElement('div');
                    card.className = 'parameter-card';
                    
                    let displayValue = value;
                    if (['controlExposure', 'unexposedIncidence', 'significanceLevel', 'power'].includes(param)) {
                        displayValue = `${value}%`;
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                    }
                    
                    card.innerHTML = `
                        <div class="parameter-label">${labels[param] || param}</div>
                        <div class="parameter-value">${displayValue}</div>
                        <div class="parameter-confidence">
                            <span>Confidence: ${confidence}%</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                        <div class="parameter-source">
                            ${source.section || 'Document'} ‚Ä¢ Page ${source.page || 'N/A'}
                        </div>
                    `;
                    
                    parameterGrid.appendChild(card);
                });
            }

            applyExtractedParameters(studyType) {
                const params = this.extractedParams[studyType]?.parameters || {};
                
                if (Object.keys(params).length === 0) {
                    this.showError('No parameters available to apply. Please upload and analyze a PDF first.');
                    return;
                }
                
                // Enhanced parameter mapping with validation
                const fieldMappings = {
                    'case-control': {
                        controlExposure: 'controlExposure',
                        oddsRatio: 'expectedOddsRatio',
                        caseControlRatio: 'caseControlRatio',
                        significanceLevel: 'significanceLevel',
                        power: 'statisticalPower'
                    },
                    'cohort': {
                        unexposedIncidence: 'unexposedIncidence',
                        relativeRisk: 'expectedRelativeRisk',
                        exposureRatio: 'exposedUnexposedRatio',
                        significanceLevel: 'cohortSignificanceLevel',
                        power: 'cohortStatisticalPower'
                    }
                };

                const mappings = fieldMappings[studyType] || {};
                let appliedCount = 0;
                
                Object.entries(params).forEach(([param, value]) => {
                    const fieldId = mappings[param];
                    if (fieldId) {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = value;
                            appliedCount++;
                        }
                    }
                });
                
                // Enhanced success feedback
                const processingIndicatorId = studyType === 'case-control' ? 'caseControlProcessingIndicator' : 'cohortProcessingIndicator';
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                if (processingIndicator) {
                    processingIndicator.innerHTML = `<span style="color: #38A169;">‚úÖ Applied ${appliedCount} parameters successfully</span>`;
                    processingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        processingIndicator.style.display = 'none';
                    }, 3000);
                }
            }

            reviewExtractionDetails(studyType) {
                const data = this.extractedParams[studyType];
                if (!data) {
                    this.showError('No extraction data available. Please upload and analyze a PDF first.');
                    return;
                }
                
                const sources = data.sources || {};
                let detailsText = `Advanced Epidemiological Parameter Extraction Analysis (${studyType}):\n\n`;
                
                Object.entries(sources).forEach(([param, source]) => {
                    detailsText += `Parameter: ${param}\n`;
                    detailsText += `  Extracted Value: ${data.parameters[param]}\n`;
                    detailsText += `  Confidence Score: ${source.confidence}%\n`;
                    detailsText += `  Source Location: Page ${source.page}, ${source.section} section\n`;
                    detailsText += `  Context: "${source.context}"\n`;
                    detailsText += `  Validation Status: ${source.validated ? 'Validated' : 'Pending'}\n\n`;
                });
                
                alert(detailsText);
            }

            handleFormSubmission(event, studyType) {
                event.preventDefault();
                console.log(`Processing ${studyType} study calculation`);
                
                try {
                    // Collect form data with enhanced validation
                    const formData = this.collectFormData(studyType);
                    
                    // Validate parameters with epidemiological constraints
                    this.validateParameters(formData, studyType);
                    
                    // Calculate sample size using validated methodologies
                    const results = this.calculateSampleSize(formData, studyType);
                    
                    // Display results with comprehensive documentation
                    this.displayResults(results, studyType);
                    
                } catch (error) {
                    console.error(`Calculation error for ${studyType}:`, error);
                    this.showError(error.message);
                }
            }

            collectFormData(studyType) {
                if (studyType === 'case-control') {
                    return this.collectCaseControlData();
                } else if (studyType === 'cohort') {
                    return this.collectCohortData();
                }
                throw new Error('Invalid study type specified');
            }

            collectCaseControlData() {
                const elements = {
                    controlExposure: document.getElementById('controlExposure'),
                    expectedOddsRatio: document.getElementById('expectedOddsRatio'),
                    caseControlRatio: document.getElementById('caseControlRatio'),
                    significanceLevel: document.getElementById('significanceLevel'),
                    statisticalPower: document.getElementById('statisticalPower'),
                    nonResponseRate: document.getElementById('nonResponseCaseControl')
                };
                
                // Enhanced validation for element existence and values
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for case-control analysis`);
                    }
                }
                
                return {
                    controlExposure: parseFloat(elements.controlExposure.value) / 100,
                    expectedOddsRatio: parseFloat(elements.expectedOddsRatio.value),
                    caseControlRatio: parseFloat(elements.caseControlRatio.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    nonResponseRate: parseFloat(elements.nonResponseRate.value) / 100
                };
            }

            collectCohortData() {
                const elements = {
                    unexposedIncidence: document.getElementById('unexposedIncidence'),
                    expectedRelativeRisk: document.getElementById('expectedRelativeRisk'),
                    exposedUnexposedRatio: document.getElementById('exposedUnexposedRatio'),
                    significanceLevel: document.getElementById('cohortSignificanceLevel'),
                    statisticalPower: document.getElementById('cohortStatisticalPower'),
                    lossToFollowUp: document.getElementById('lossToFollowUp')
                };
                
                // Enhanced validation for element existence and values
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for cohort analysis`);
                    }
                }
                
                return {
                    unexposedIncidence: parseFloat(elements.unexposedIncidence.value) / 100,
                    expectedRelativeRisk: parseFloat(elements.expectedRelativeRisk.value),
                    exposedUnexposedRatio: parseFloat(elements.exposedUnexposedRatio.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    lossToFollowUp: parseFloat(elements.lossToFollowUp.value) / 100
                };
            }

            validateParameters(params, studyType) {
                // Enhanced validation with epidemiological constraints
                for (const [key, value] of Object.entries(params)) {
                    if (isNaN(value) || !isFinite(value)) {
                        throw new Error(`Invalid numerical value for ${key}: ${value}`);
                    }
                    if (value < 0) {
                        throw new Error(`${key} cannot be negative in epidemiological analysis`);
                    }
                }
                
                // Study-specific enhanced validations
                if (studyType === 'case-control') {
                    if (params.controlExposure >= 1) {
                        throw new Error('Control exposure rate cannot be 100% or greater');
                    }
                    if (params.expectedOddsRatio <= 0) {
                        throw new Error('Odds ratio must be positive for meaningful epidemiological analysis');
                    }
                } else if (studyType === 'cohort') {
                    if (params.unexposedIncidence >= 1) {
                        throw new Error('Unexposed incidence rate cannot be 100% or greater');
                    }
                    if (params.expectedRelativeRisk <= 0) {
                        throw new Error('Relative risk must be positive for meaningful epidemiological analysis');
                    }
                }
            }

            calculateSampleSize(params, studyType) {
                if (studyType === 'case-control') {
                    return this.calculateCaseControlSampleSize(params);
                } else if (studyType === 'cohort') {
                    return this.calculateCohortSampleSize(params);
                }
                throw new Error('Invalid study type for calculation');
            }

            calculateCaseControlSampleSize(params) {
                const { controlExposure, expectedOddsRatio, caseControlRatio, significanceLevel, statisticalPower, nonResponseRate } = params;
                
                // Calculate case exposure from odds ratio using epidemiological principles
                const p0 = controlExposure;
                const OR = expectedOddsRatio;
                const p1 = (OR * p0) / (1 + p0 * (OR - 1));
                
                if (p1 <= 0 || p1 >= 1) {
                    throw new Error('Parameter combination results in epidemiologically impossible case exposure rate');
                }
                
                // Get critical values using enhanced precision
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate pooled proportions following Fleiss methodology
                const k = caseControlRatio;
                const pBar = (p1 + k * p0) / (1 + k);
                const qBar = 1 - pBar;
                
                // Fleiss, Levin & Paik formula for case-control studies
                const numerator = Math.pow(
                    zAlpha * Math.sqrt((1 + 1/k) * pBar * qBar) + 
                    zBeta * Math.sqrt(p1 * (1-p1) + (p0 * (1-p0))/k), 2
                );
                
                const baseSize = numerator / Math.pow(p1 - p0, 2);
                
                // Apply continuity correction for enhanced accuracy
                const continuityCorrection = 1 + 2/(k + 1);
                const correctedSize = baseSize * continuityCorrection;
                
                // Adjust for non-response with proper epidemiological methodology
                const adjustedSize = correctedSize / (1 - nonResponseRate);
                
                const nCases = Math.ceil(adjustedSize);
                const nControls = Math.ceil(adjustedSize * k);
                
                return {
                    studyType: 'case-control',
                    cases: nCases,
                    controls: nControls,
                    totalSize: nCases + nControls,
                    baseSize: Math.ceil(baseSize),
                    correctedSize: Math.ceil(correctedSize),
                    parameters: {
                        ...params,
                        caseExposure: p1,
                        oddsRatio: OR,
                        effectSize: Math.abs(p1 - p0) / Math.sqrt(pBar * qBar)
                    },
                    statistics: {
                        zAlpha,
                        zBeta,
                        pBar,
                        qBar,
                        continuityCorrection
                    }
                };
            }

            calculateCohortSampleSize(params) {
                const { unexposedIncidence, expectedRelativeRisk, exposedUnexposedRatio, significanceLevel, statisticalPower, lossToFollowUp } = params;
                
                // Calculate exposed incidence with epidemiological constraints
                const p0 = unexposedIncidence;
                const RR = expectedRelativeRisk;
                const p1 = Math.min(p0 * RR, 0.99); // Prevent impossible probabilities
                
                // Get critical values using enhanced precision
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate pooled proportions following Kelsey methodology
                const k = exposedUnexposedRatio;
                const pBar = (k * p1 + p0) / (k + 1);
                const qBar = 1 - pBar;
                
                // Kelsey et al. formula for cohort studies
                const numerator = Math.pow(
                    zAlpha * Math.sqrt((1 + 1/k) * pBar * qBar) + 
                    zBeta * Math.sqrt(p1 * (1-p1) + (p0 * (1-p0))/k), 2
                );
                
                const baseSize = numerator / Math.pow(p1 - p0, 2);
                
                // Apply loss-to-follow-up adjustment with proper methodology
                const adjustedSize = baseSize / Math.pow(1 - lossToFollowUp, 2);
                
                const nUnexposed = Math.ceil(adjustedSize);
                const nExposed = Math.ceil(adjustedSize * k);
                
                return {
                    studyType: 'cohort',
                    unexposed: nUnexposed,
                    exposed: nExposed,
                    totalSize: nUnexposed + nExposed,
                    baseSize: Math.ceil(baseSize),
                    parameters: {
                        ...params,
                        exposedIncidence: p1,
                        relativeRisk: RR,
                        attributableRisk: p1 - p0,
                        attributableRiskPercent: ((p1 - p0) / p1) * 100,
                        populationAttributableRisk: ((pBar - p0) / pBar) * 100
                    },
                    statistics: {
                        zAlpha,
                        zBeta,
                        pBar,
                        qBar,
                        effectSize: Math.abs(p1 - p0) / Math.sqrt(pBar * qBar)
                    }
                };
            }

            displayResults(results, studyType) {
                const resultsSection = document.getElementById('resultsSection');
                
                let html = '';
                if (studyType === 'case-control') {
                    html = this.generateCaseControlResults(results);
                } else if (studyType === 'cohort') {
                    html = this.generateCohortResults(results);
                }
                
                resultsSection.innerHTML = html;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            generateCaseControlResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>üìä Case-Control Study Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Cases Required:</span><span class="detail-value">${results.cases.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Controls Required:</span><span class="detail-value">${results.controls.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Case:Control Ratio:</span><span class="detail-value">1:${results.parameters.caseControlRatio}</span></li>
                                    <li><span class="detail-label">Expected Odds Ratio:</span><span class="detail-value">${results.parameters.oddsRatio.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Control Exposure Rate:</span><span class="detail-value">${(results.parameters.controlExposure * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Case Exposure Rate:</span><span class="detail-value">${(results.parameters.caseExposure * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>üßÆ Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Significance Level (Œ±):</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (Œ±/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (Œ≤):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Effect Size:</span><span class="detail-value">${results.parameters.effectSize.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Continuity Correction:</span><span class="detail-value">${results.statistics.continuityCorrection.toFixed(3)}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>üìã Epidemiological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Matching Strategy:</span><span class="detail-value">Age, Sex, Geographic</span></li>
                                    <li><span class="detail-label">Selection Bias Mitigation:</span><span class="detail-value">Standardized Protocols</span></li>
                                    <li><span class="detail-label">Recall Bias Control:</span><span class="detail-value">Objective Measures</span></li>
                                    <li><span class="detail-label">Control Source:</span><span class="detail-value">Same Population Base</span></li>
                                    <li><span class="detail-label">Confounding Control:</span><span class="detail-value">Stratified Analysis</span></li>
                                    <li><span class="detail-label">Quality Assurance:</span><span class="detail-value">Validation Protocols</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF(${JSON.stringify(results).replace(/"/g, '&quot;')}, 'case-control')">
                                <span>üìÑ</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>üîÑ</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateCohortResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>üìä Cohort Study Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Unexposed Group:</span><span class="detail-value">${results.unexposed.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Exposed Group:</span><span class="detail-value">${results.exposed.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Allocation Ratio:</span><span class="detail-value">${results.parameters.exposedUnexposedRatio}:1</span></li>
                                    <li><span class="detail-label">Expected Relative Risk:</span><span class="detail-value">${results.parameters.relativeRisk.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Unexposed Incidence:</span><span class="detail-value">${(results.parameters.unexposedIncidence * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Exposed Incidence:</span><span class="detail-value">${(results.parameters.exposedIncidence * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>üßÆ Epidemiological Measures</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Attributable Risk:</span><span class="detail-value">${(results.parameters.attributableRisk * 100).toFixed(2)}%</span></li>
                                    <li><span class="detail-label">Attributable Risk %:</span><span class="detail-value">${results.parameters.attributableRiskPercent.toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Population AR:</span><span class="detail-value">${results.parameters.populationAttributableRisk.toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Effect Size:</span><span class="detail-value">${results.statistics.effectSize.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Loss-to-Follow-up:</span><span class="detail-value">${(results.parameters.lossToFollowUp * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>üìã Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Follow-up Strategy:</span><span class="detail-value">Regular Contact Protocol</span></li>
                                    <li><span class="detail-label">Outcome Assessment:</span><span class="detail-value">Standardized Criteria</span></li>
                                    <li><span class="detail-label">Confounding Control:</span><span class="detail-value">Collect Covariates</span></li>
                                    <li><span class="detail-label">Interim Analysis:</span><span class="detail-value">Plan Safety Reviews</span></li>
                                    <li><span class="detail-label">Attrition Monitoring:</span><span class="detail-value">Loss Pattern Analysis</span></li>
                                    <li><span class="detail-label">Data Quality:</span><span class="detail-value">Validation Procedures</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF(${JSON.stringify(results).replace(/"/g, '&quot;')}, 'cohort')">
                                <span>üìÑ</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>üîÑ</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            exportToPDF(results, studyType) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Enhanced header with academic formatting
                    doc.setFontSize(24);
                    doc.setTextColor(255, 140, 66);
                    doc.text('KARMASTAT', 105, 25, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    const studyTypeName = studyType === 'case-control' ? 'Case-Control' : 'Cohort';
                    doc.text(`${studyTypeName} Study Sample Size Calculation`, 105, 35, { align: 'center' });
                    
                    // Main result with emphasis
                    doc.setFontSize(28);
                    doc.setTextColor(255, 140, 66);
                    doc.text(`Total Required: ${results.totalSize.toLocaleString()}`, 105, 55, { align: 'center' });
                    
                    // Methodological validation statement
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    const methodNote = studyType === 'case-control' 
                        ? 'Calculated using Fleiss, Levin & Paik (2003) methodology with continuity correction'
                        : 'Calculated using Kelsey et al. (1996) methodology with loss-to-follow-up adjustment';
                    doc.text(methodNote, 105, 65, { align: 'center' });
                    
                    // Enhanced parameters section
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Epidemiological Study Parameters:', 20, 80);
                    
                    let y = 90;
                    let parameters = [];
                    
                    if (studyType === 'case-control') {
                        parameters = [
                            `Cases Required: ${results.cases.toLocaleString()}`,
                            `Controls Required: ${results.controls.toLocaleString()}`,
                            `Case:Control Ratio: 1:${results.parameters.caseControlRatio}`,
                            `Expected Odds Ratio: ${results.parameters.oddsRatio.toFixed(2)}`,
                            `Control Exposure Rate: ${(results.parameters.controlExposure * 100).toFixed(1)}%`,
                            `Case Exposure Rate: ${(results.parameters.caseExposure * 100).toFixed(1)}%`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Effect Size: ${results.parameters.effectSize.toFixed(3)}`,
                            `Continuity Correction: ${results.statistics.continuityCorrection.toFixed(3)}`
                        ];
                    } else {
                        parameters = [
                            `Unexposed Group: ${results.unexposed.toLocaleString()}`,
                            `Exposed Group: ${results.exposed.toLocaleString()}`,
                            `Allocation Ratio: ${results.parameters.exposedUnexposedRatio}:1`,
                            `Expected Relative Risk: ${results.parameters.relativeRisk.toFixed(2)}`,
                            `Unexposed Incidence: ${(results.parameters.unexposedIncidence * 100).toFixed(1)}%`,
                            `Exposed Incidence: ${(results.parameters.exposedIncidence * 100).toFixed(1)}%`,
                            `Attributable Risk: ${(results.parameters.attributableRisk * 100).toFixed(2)}%`,
                            `Population AR: ${results.parameters.populationAttributableRisk.toFixed(1)}%`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Loss-to-Follow-up: ${(results.parameters.lossToFollowUp * 100)}%`,
                            `Effect Size: ${results.statistics.effectSize.toFixed(3)}`
                        ];
                    }
                    
                    parameters.forEach(param => {
                        if (y > 250) {
                            doc.addPage();
                            y = 25;
                        }
                        doc.text(`‚Ä¢ ${param}`, 25, y);
                        y += 8;
                    });
                    
                    // Enhanced footer with academic citation
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Generated by KARMASTAT - Advanced Epidemiological Calculator', 105, 270, { align: 'center' });
                    doc.text(`${new Date().toLocaleDateString()} ‚Ä¢ ${new Date().toLocaleTimeString()}`, 105, 280, { align: 'center' });
                    
                    doc.save(`KARMASTAT-${studyTypeName}-Study-${new Date().toISOString().split('T')[0]}.pdf`);
                    
                } catch (error) {
                    console.error('PDF export error:', error);
                    this.showError('Error exporting PDF. Please try again.');
                }
            }

            newCalculation() {
                // Reset forms with enhanced cleanup
                const forms = ['caseControlForm', 'cohortForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) form.reset();
                });
                
                // Reset default values with academic standards
                const defaultValues = {
                    'controlExposure': '20',
                    'expectedOddsRatio': '2.0',
                    'unexposedIncidence': '10',
                    'expectedRelativeRisk': '2.0',
                    'nonResponseCaseControl': '10',
                    'lossToFollowUp': '15'
                };
                
                Object.entries(defaultValues).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });
                
                // Clear results and selections with enhanced cleanup
                this.clearResults();
                
                // Reset study type selection
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Hide analysis containers with complete cleanup
                ['caseControlMagicalAnalysis', 'cohortMagicalAnalysis'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.style.display = 'none';
                });
                
                // Reset internal state
                this.currentStudyType = null;
                this.extractedParams = {};
                
                // Smooth scroll to top for enhanced user experience
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            clearResults() {
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.classList.remove('show');
                    resultsSection.innerHTML = '';
                }
            }

            showError(message) {
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.innerHTML = `
                    <div class="result-card" style="border: 2px solid #E53E3E;">
                        <div style="text-align: center; color: #E53E3E;">
                            <h3>‚ö†Ô∏è Calculation Error</h3>
                            <div class="error-message">${message}</div>
                            <button class="btn-primary" onclick="calculator.newCalculation()" style="margin-top: 1rem;">
                                <span>üîÑ</span>Start New Calculation
                            </button>
                        </div>
                    </div>
                `;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            getZScore(confidence) {
                const zScores = {
                    50: 0.000, 55: 0.126, 60: 0.253, 65: 0.385, 70: 0.524,
                    75: 0.674, 80: 0.842, 85: 1.036, 90: 1.282, 91: 1.341,
                    92: 1.405, 93: 1.476, 94: 1.555, 95: 1.645, 96: 1.751,
                    97: 1.881, 97.5: 1.960, 98: 2.054, 99: 2.326, 99.5: 2.576,
                    99.9: 3.090, 99.95: 3.291, 99.99: 3.719
                };
                return zScores[confidence] || zScores[95];
            }
        }

        // Advanced Epidemiological Analysis Engine with Enhanced Intelligence
        class AdvancedEpidemiologicalAnalysisEngine {
            constructor() {
                this.enhancedPatterns = this.initializeAdvancedPatterns();
                this.contextValidators = this.initializeContextValidators();
                this.academicFilters = this.initializeAcademicFilters();
            }

            initializeAdvancedPatterns() {
                return {
                    // Enhanced Case-control specific patterns with academic precision
                    controlExposure: [
                        // Primary patterns with context validation
                        /(?:control(?:s)?|unexposed)\s+(?:group|participants|subjects)?\s*(?:had|with|showed?|demonstrated?|exhibited?)?\s*(?:exposure|exposed)?\s*(?:rate|proportion|prevalence)?\s*(?:of|was|were|at)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:of\s+)?(?:control(?:s)?|unexposed)\s+(?:group|participants|subjects)?\s*(?:were\s+)?(?:exposed|had\s+exposure)/gi,
                        /baseline\s+exposure\s+(?:rate|prevalence)?\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /control\s+group\s+exposure\s*(?::|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        // Advanced patterns to exclude references and page numbers
                        /(?<!(?:table|figure|ref(?:erence)?|page|p\.|\[\d+)\s*)(?:control(?:s)?)\s+(?:had|with|exposure)\s*(?:rate|prevalence)?\s*(?:of|was)?\s*(\d+\.?\d*)\s*(?:%|percent)(?!\s*(?:\]|\)|,\s*\d+))/gi
                    ],
                    
                    oddsRatio: [
                        // Enhanced OR patterns with validation
                        /(?:odds\s+ratio|OR)(?:\s+(?:was|is|of|equals?))?\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        /OR\s*[=:]\s*(\d+\.?\d*)\s*(?:\(|\[)?(?:\d+\.?\d*)?/gi,
                        /adjusted\s+(?:odds\s+ratio|OR)\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        /crude\s+(?:odds\s+ratio|OR)\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        // Exclude reference numbers and statistical notation
                        /(?<!(?:table|figure|ref|page|p\.|\[\d+|CI\s*)\s*)(?:odds\s+ratio|OR)(?:\s+(?:was|is))?\s*(?::|=)?\s*(\d+\.?\d*)(?!\s*(?:\]|\)|,\s*\d+|√ó|times))/gi
                    ],

                    caseControlRatio: [
                        // Enhanced ratio patterns with context validation
                        /(?:case(?:s)?(?:\s+to\s+|\s*:\s*)?control(?:s)?|control(?:s)?(?:\s+to\s+|\s*:\s*)?case(?:s)?)\s+ratio\s*(?:of|was|is)?\s*(\d+\.?\d*)\s*(?::|to)\s*(\d+\.?\d*)/gi,
                        /(\d+\.?\d*)\s*(?::|to)\s*(\d+\.?\d*)\s+(?:case(?:s)?(?:\s+to\s+)?control(?:s)?|control(?:s)?(?:\s+to\s+)?case(?:s)?)/gi,
                        /matched\s+(?:case(?:s)?|control(?:s)?)\s*(?:ratio|design)?\s*(?:of|at)?\s*(\d+\.?\d*)\s*(?::|to)\s*(\d+\.?\d*)/gi
                    ],
                    
                    // Enhanced Cohort specific patterns with academic precision
                    unexposedIncidence: [
                        /(?:unexposed|baseline|control|reference)\s+(?:group|participants|subjects)?\s*(?:had|with|showed?|demonstrated?)?\s*(?:incidence|risk|rate)?\s*(?:of|was|were|at)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /incidence\s+(?:in\s+the\s+)?(?:unexposed|baseline|control)\s+(?:group|participants)?\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /baseline\s+(?:incidence|risk)\s*(?:rate)?\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        // Exclude references and page numbers
                        /(?<!(?:table|figure|ref|page|p\.|\[\d+)\s*)(?:unexposed|baseline)\s+(?:incidence|risk)\s*(?:rate)?\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:%|percent)(?!\s*(?:\]|\)|,\s*\d+))/gi
                    ],
                    
                    relativeRisk: [
                        /(?:relative\s+risk|RR)(?:\s+(?:was|is|of|equals?))?\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        /RR\s*[=:]\s*(\d+\.?\d*)\s*(?:\(|\[)?/gi,
                        /risk\s+ratio\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        /adjusted\s+(?:relative\s+risk|RR)\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        // Exclude reference numbers
                        /(?<!(?:table|figure|ref|page|p\.|\[\d+)\s*)(?:relative\s+risk|RR)(?:\s+(?:was|is))?\s*(?::|=)?\s*(\d+\.?\d*)(?!\s*(?:\]|\)|,\s*\d+))/gi
                    ],
                    
                    // Enhanced common patterns with academic context validation
                    sampleSize: [
                        /(?:sample\s+size|n\s*=|total\s+(?:participants|subjects|patients))\s*(?:was|of|is)?\s*(\d+)/gi,
                        /(\d+)\s+(?:participants|subjects|patients|individuals|cases|controls)\s+(?:were\s+)?(?:enrolled|recruited|included)/gi,
                        /(?:study\s+included|enrolled|recruited)\s+(?:a\s+total\s+of\s+)?(\d+)\s+(?:participants|subjects|patients)/gi,
                        // Exclude age, years, percentages, and reference numbers
                        /(?<!(?:age|aged?|years?|%|\[\d+|table|figure|ref|page|p\.)\s*)(?:sample\s+size|n\s*=)\s*(?:was|of)?\s*(\d+)(?!\s*(?:years?|%|\]|\)|,\s*\d+))/gi
                    ],
                    
                    significanceLevel: [
                        /(?:significance\s+level|alpha|Œ±)\s*(?:was|of|set\s+at|=)?\s*(?:0?\.)?(\d+)\s*(?:%|percent)?/gi,
                        /Œ±\s*[=]\s*0?\.(\d+)/gi,
                        /p\s*[<]\s*0?\.(\d+)\s+(?:was\s+considered\s+)?(?:significant|statistically)/gi,
                        /two.?sided\s+test\s+(?:with\s+)?(?:Œ±|alpha)\s*[=]\s*0?\.(\d+)/gi,
                        // Enhanced pattern to exclude p-values and results
                        /(?<!(?:p\s*[<>=]|result|finding)\s*)(?:significance\s+level|Œ±|alpha)\s*(?:was|of|set)?\s*(?:=|at)?\s*0?\.(\d+)(?!\s*(?:for|in|and))/gi
                    ],
                    
                    power: [
                        /(?:statistical\s+)?power\s*(?:was|of|set\s+at|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:statistical\s+)?power/gi,
                        /power\s+analysis\s+(?:showed|indicated|revealed)?\s*(?:a\s+)?(?:power\s+of\s+)?(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /Œ≤\s*[=]\s*0?\.(\d+)/gi,
                        // Exclude power calculations from results
                        /(?<!(?:achieved|calculated|observed)\s*)(?:statistical\s+)?power\s*(?:was|of)?\s*(?:=|set)?\s*(\d+\.?\d*)\s*(?:%|percent)(?!\s*(?:was\s+achieved|calculated))/gi
                    ]
                };
            }

            initializeContextValidators() {
                return {
                    // Context validation rules to exclude false positives
                    excludePatterns: [
                        /(?:table|figure|fig\.?)\s+\d+/gi,
                        /(?:reference|ref\.?|citation)\s*\[?\d+\]?/gi,
                        /page\s+\d+/gi,
                        /p\.?\s*\d+/gi,
                        /\[\d+(?:\s*,\s*\d+)*\]/gi, // Reference citations
                        /\(\d+(?:\s*,\s*\d+)*\)/gi, // Reference citations in parentheses
                        /age\s+\d+/gi,
                        /years?\s+old/gi,
                        /\d+\s*(?:cm|mm|kg|mg|ml|g|years?|days?|months?|weeks?)/gi // Units
                    ],
                    
                    // Context indicators for valid epidemiological data
                    validContexts: [
                        /(?:method|design|analysis|result|finding|outcome|parameter)/gi,
                        /(?:study|research|investigation|trial|cohort|case.?control)/gi,
                        /(?:statistical|epidemiological|analytical)/gi,
                        /(?:sample|population|participant|subject|patient)/gi
                    ],
                    
                    // Section context validation
                    preferredSections: [
                        /(?:abstract|summary)/gi,
                        /(?:method|methodology|design)/gi,
                        /(?:result|finding|outcome)/gi,
                        /(?:statistic|analysis)/gi,
                        /(?:table|figure)/gi
                    ]
                };
            }

            initializeAcademicFilters() {
                return {
                    // Minimum confidence thresholds for different parameter types
                    confidenceThresholds: {
                        sampleSize: 60,
                        oddsRatio: 70,
                        relativeRisk: 70,
                        controlExposure: 65,
                        unexposedIncidence: 65,
                        significanceLevel: 75,
                        power: 75
                    },
                    
                    // Value range validation for academic plausibility
                    plausibilityRanges: {
                        sampleSize: { min: 10, max: 100000 },
                        oddsRatio: { min: 0.01, max: 100 },
                        relativeRisk: { min: 0.01, max: 100 },
                        controlExposure: { min: 0.1, max: 99.9 },
                        unexposedIncidence: { min: 0.01, max: 99.9 },
                        significanceLevel: { min: 0.1, max: 50 },
                        power: { min: 50, max: 99.9 }
                    }
                };
            }

            async analyzePDF(file, studyType) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    const extractedData = {
                        parameters: {},
                        sources: {},
                        confidence: 0,
                        extractionDate: new Date().toISOString(),
                        studyType,
                        processingStats: {
                            pagesProcessed: 0,
                            patternsMatched: 0,
                            validationsPerformed: 0,
                            confidenceAdjustments: 0
                        }
                    };
                    
                    // Enhanced PDF processing with intelligent page selection
                    const maxPages = Math.min(pdf.numPages, 15); // Process up to 15 pages for comprehensive analysis
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        // Enhanced section classification with academic context
                        const sectionType = this.classifyAcademicSection(pageText);
                        
                        // Advanced parameter extraction with context validation
                        await this.extractParametersWithValidation(pageText, pageNum, sectionType, extractedData, studyType);
                        
                        extractedData.processingStats.pagesProcessed++;
                    }
                    
                    // Advanced post-processing with academic validation
                    this.performAdvancedValidation(extractedData, studyType);
                    
                    // Calculate sophisticated confidence scores
                    this.calculateAdvancedConfidence(extractedData);
                    
                    return extractedData;
                    
                } catch (error) {
                    console.error('Advanced PDF analysis error:', error);
                    throw new Error('Failed to perform advanced PDF analysis: ' + error.message);
                }
            }

            classifyAcademicSection(text) {
                const lowerText = text.toLowerCase();
                
                // Enhanced academic section classification with priority scoring
                const sectionIndicators = {
                    'Methods': [
                        /(?:method|methodology|design|statistical\s+analysis)/gi,
                        /(?:study\s+design|research\s+design|analytical\s+approach)/gi,
                        /(?:sample\s+size|power\s+calculation|statistical\s+power)/gi
                    ],
                    'Results': [
                        /(?:result|finding|outcome|data\s+analysis)/gi,
                        /(?:statistical\s+result|epidemiological\s+finding)/gi,
                        /(?:odds\s+ratio|relative\s+risk|confidence\s+interval)/gi
                    ],
                    'Abstract': [
                        /(?:abstract|summary|background|objective|conclusion)/gi,
                        /(?:study\s+objective|research\s+aim|purpose)/gi
                    ],
                    'Table/Figure': [
                        /(?:table|figure|chart|graph)/gi,
                        /(?:supplementary|appendix)/gi
                    ],
                    'Discussion': [
                        /(?:discussion|interpretation|limitation|conclusion)/gi,
                        /(?:clinical\s+implication|public\s+health)/gi
                    ]
                };
                
                let bestSection = 'Other';
                let highestScore = 0;
                
                Object.entries(sectionIndicators).forEach(([section, patterns]) => {
                    let sectionScore = 0;
                    patterns.forEach(pattern => {
                        const matches = lowerText.match(pattern);
                        if (matches) {
                            sectionScore += matches.length;
                        }
                    });
                    
                    if (sectionScore > highestScore) {
                        highestScore = sectionScore;
                        bestSection = section;
                    }
                });
                
                return bestSection;
            }

            async extractParametersWithValidation(text, pageNum, sectionType, extractedData, studyType) {
                const relevantPatterns = this.getStudySpecificPatterns(studyType);
                
                for (const [paramName, patterns] of Object.entries(relevantPatterns)) {
                    for (const pattern of patterns) {
                        const matches = [...text.matchAll(pattern)];
                        
                        for (const match of matches) {
                            // Enhanced context validation
                            if (!this.validateContext(match[0], text)) {
                                continue;
                            }
                            
                            const value = this.extractAndValidateValue(match, paramName);
                            
                            if (value !== null && this.validateAcademicPlausibility(paramName, value)) {
                                const confidence = this.calculateContextualConfidence(
                                    paramName, 
                                    sectionType, 
                                    match[0], 
                                    studyType,
                                    text
                                );
                                
                                // Update if higher confidence or first occurrence
                                if (!extractedData.parameters[paramName] || 
                                    confidence > (extractedData.sources[paramName]?.confidence || 0)) {
                                    
                                    extractedData.parameters[paramName] = value;
                                    extractedData.sources[paramName] = {
                                        confidence: confidence,
                                        page: pageNum,
                                        context: match[0].substring(0, 150),
                                        section: sectionType,
                                        pattern: pattern.toString(),
                                        fullMatch: match[0],
                                        validated: true,
                                        extractionMethod: 'advanced_pattern_recognition'
                                    };
                                    
                                    extractedData.processingStats.patternsMatched++;
                                }
                            }
                            
                            extractedData.processingStats.validationsPerformed++;
                        }
                    }
                }
            }

            validateContext(match, fullText) {
                // Enhanced context validation to exclude false positives
                const matchLower = match.toLowerCase();
                
                // Check for exclusion patterns (references, page numbers, etc.)
                for (const excludePattern of this.contextValidators.excludePatterns) {
                    if (excludePattern.test(match)) {
                        return false;
                    }
                }
                
                // Check for valid epidemiological contexts
                let validContextFound = false;
                for (const validPattern of this.contextValidators.validContexts) {
                    if (validPattern.test(fullText)) {
                        validContextFound = true;
                        break;
                    }
                }
                
                // Additional validation for numeric values in academic context
                if (/\d+/.test(match)) {
                    // Exclude if it looks like an age, year, or measurement
                    if (/(?:age|aged?|years?|old|\d{4}|cm|mm|kg|mg|ml|g)\s*(?:\d+|\w)/gi.test(match)) {
                        return false;
                    }
                    
                    // Exclude if it's clearly a reference or page number
                    if (/(?:\[\d+\]|\(\d+\)|p\.\s*\d+|page\s+\d+|ref\s+\d+)/gi.test(match)) {
                        return false;
                    }
                }
                
                return validContextFound;
            }

            getStudySpecificPatterns(studyType) {
                const commonPatterns = {
                    sampleSize: this.enhancedPatterns.sampleSize,
                    significanceLevel: this.enhancedPatterns.significanceLevel,
                    power: this.enhancedPatterns.power
                };

                if (studyType === 'case-control') {
                    return {
                        ...commonPatterns,
                        controlExposure: this.enhancedPatterns.controlExposure,
                        oddsRatio: this.enhancedPatterns.oddsRatio,
                        caseControlRatio: this.enhancedPatterns.caseControlRatio
                    };
                } else if (studyType === 'cohort') {
                    return {
                        ...commonPatterns,
                        unexposedIncidence: this.enhancedPatterns.unexposedIncidence,
                        relativeRisk: this.enhancedPatterns.relativeRisk
                    };
                }
                
                return commonPatterns;
            }

            extractAndValidateValue(match, paramName) {
                if (!match[1]) return null;
                
                let value = parseFloat(match[1]);
                
                // Enhanced value extraction with parameter-specific handling
                switch (paramName) {
                    case 'significanceLevel':
                        // Handle different alpha formats with validation
                        if (match[0].toLowerCase().includes('Œ±') && value < 1) {
                            value = value * 100;
                        }
                        // Validate common significance levels
                        if (![1, 5, 10].includes(value) && ![0.01, 0.05, 0.1].includes(value)) {
                            // Check if it's a reasonable significance level
                            if (value > 0.5 && value < 1) {
                                value = value * 100;
                            }
                        }
                        break;
                        
                    case 'power':
                        // Handle power in different formats
                        if (value <= 1 && value > 0) {
                            value = value * 100;
                        }
                        // Validate reasonable power levels
                        if (value < 50 || value > 99) {
                            return null;
                        }
                        break;
                        
                    case 'controlExposure':
                    case 'unexposedIncidence':
                        // Handle proportion vs percentage with validation
                        if (value <= 1 && value > 0 && !match[0].includes('%')) {
                            value = value * 100;
                        }
                        // Validate reasonable epidemiological ranges
                        if (value > 100 || value < 0.01) {
                            return null;
                        }
                        break;
                        
                    case 'oddsRatio':
                    case 'relativeRisk':
                        // Validate reasonable effect size ranges
                        if (value < 0.01 || value > 100) {
                            return null;
                        }
                        break;
                        
                    case 'sampleSize':
                        // Validate reasonable sample size ranges
                        if (value < 10 || value > 100000) {
                            return null;
                        }
                        break;
                        
                    case 'caseControlRatio':
                        if (match[2]) {
                            const ratio1 = parseFloat(match[1]);
                            const ratio2 = parseFloat(match[2]);
                            value = ratio2 / ratio1;
                        }
                        break;
                }
                
                return isNaN(value) ? null : value;
            }

            validateAcademicPlausibility(paramName, value) {
                const ranges = this.academicFilters.plausibilityRanges[paramName];
                if (!ranges) return true;
                
                return value >= ranges.min && value <= ranges.max;
            }

            calculateContextualConfidence(paramName, sectionType, context, studyType, fullText) {
                let confidence = 50; // Base confidence
                
                // Enhanced section-based confidence adjustment
                const sectionWeights = {
                    'Methods': 35,
                    'Results': 30,
                    'Abstract': 25,
                    'Table/Figure': 20,
                    'Discussion': 10,
                    'Other': 0
                };
                
                confidence += sectionWeights[sectionType] || 0;
                
                // Enhanced context-based confidence adjustments
                const lowerContext = context.toLowerCase();
                const lowerFullText = fullText.toLowerCase();
                
                // High confidence indicators
                if (lowerContext.includes('calculated') || lowerContext.includes('computed')) confidence += 12;
                if (lowerContext.includes('determined') || lowerContext.includes('estimated')) confidence += 10;
                if (lowerContext.includes('sample size') && paramName === 'sampleSize') confidence += 20;
                if (lowerContext.includes('power analysis') && paramName === 'power') confidence += 20;
                if (lowerContext.includes('statistical significance') && paramName === 'significanceLevel') confidence += 15;
                
                // Study-specific confidence adjustments
                if (studyType === 'case-control') {
                    if (lowerFullText.includes('case-control') || lowerFullText.includes('case control')) confidence += 10;
                    if (paramName === 'oddsRatio' && (lowerContext.includes('adjusted') || lowerContext.includes('crude'))) confidence += 12;
                    if (paramName === 'controlExposure' && (lowerContext.includes('baseline') || lowerContext.includes('control group'))) confidence += 10;
                } else if (studyType === 'cohort') {
                    if (lowerFullText.includes('cohort') || lowerFullText.includes('prospective') || lowerFullText.includes('follow')) confidence += 10;
                    if (paramName === 'relativeRisk' && (lowerContext.includes('adjusted') || lowerContext.includes('crude'))) confidence += 12;
                    if (paramName === 'unexposedIncidence' && (lowerContext.includes('baseline') || lowerContext.includes('unexposed'))) confidence += 10;
                }
                
                // Parameter-specific advanced adjustments
                if (paramName.includes('Ratio') && lowerContext.includes('confidence interval')) confidence += 15;
                if (lowerContext.includes('95%') && (paramName.includes('significance') || paramName.includes('confidence'))) confidence += 10;
                if (lowerContext.includes('statistical test') || lowerContext.includes('hypothesis test')) confidence += 8;
                
                // Methodological rigor indicators
                if (lowerFullText.includes('randomized') || lowerFullText.includes('controlled')) confidence += 5;
                if (lowerFullText.includes('blinded') || lowerFullText.includes('masked')) confidence += 3;
                if (lowerFullText.includes('multivariate') || lowerFullText.includes('adjusted')) confidence += 5;
                
                return Math.min(confidence, 98); // Cap at 98% to maintain academic humility
            }

            performAdvancedValidation(extractedData, studyType) {
                console.log('Performing advanced epidemiological validation...');
                
                // Cross-validation of parameters
                this.crossValidateParameters(extractedData, studyType);
                
                // Remove low-confidence parameters
                this.filterLowConfidenceParameters(extractedData);
                
                // Validate parameter relationships
                this.validateParameterRelationships(extractedData, studyType);
                
                extractedData.processingStats.confidenceAdjustments++;
            }

            crossValidateParameters(extractedData, studyType) {
                // Study-specific cross-validation
                if (studyType === 'case-control') {
                    // Validate OR and exposure relationship
                    const { controlExposure, oddsRatio } = extractedData.parameters;
                    if (controlExposure && oddsRatio) {
                        const p0 = controlExposure / 100;
                        const OR = oddsRatio;
                        const expectedCaseExposure = (OR * p0) / (1 + p0 * (OR - 1)) * 100;
                        
                        if (expectedCaseExposure > 100 || expectedCaseExposure < 0) {
                            // Reduce confidence for implausible combinations
                            if (extractedData.sources.oddsRatio) {
                                extractedData.sources.oddsRatio.confidence = Math.max(
                                    extractedData.sources.oddsRatio.confidence - 25, 
                                    30
                                );
                            }
                        }
                    }
                } else if (studyType === 'cohort') {
                    // Validate RR and incidence relationship
                    const { unexposedIncidence, relativeRisk } = extractedData.parameters;
                    if (unexposedIncidence && relativeRisk) {
                        const p0 = unexposedIncidence / 100;
                        const RR = relativeRisk;
                        const expectedExposedIncidence = p0 * RR * 100;
                        
                        if (expectedExposedIncidence > 100) {
                            // Reduce confidence for implausible combinations
                            if (extractedData.sources.relativeRisk) {
                                extractedData.sources.relativeRisk.confidence = Math.max(
                                    extractedData.sources.relativeRisk.confidence - 25, 
                                    30
                                );
                            }
                        }
                    }
                }
            }

            filterLowConfidenceParameters(extractedData) {
                // Remove parameters below confidence threshold
                Object.keys(extractedData.parameters).forEach(param => {
                    const threshold = this.academicFilters.confidenceThresholds[param] || 50;
                    if (extractedData.sources[param]?.confidence < threshold) {
                        console.log(`Removing ${param} due to low confidence: ${extractedData.sources[param]?.confidence}%`);
                        delete extractedData.parameters[param];
                        delete extractedData.sources[param];
                    }
                });
            }

            validateParameterRelationships(extractedData, studyType) {
                // Validate statistical consistency
                const { significanceLevel, power } = extractedData.parameters;
                
                if (significanceLevel && power) {
                    // Check for reasonable statistical combinations
                    if (significanceLevel > 10 && power > 90) {
                        console.warn('Unusual combination of high significance level and high power detected');
                    }
                }
                
                // Add parameter relationship validation specific to study type
                if (studyType === 'case-control') {
                    this.validateCaseControlRelationships(extractedData);
                } else if (studyType === 'cohort') {
                    this.validateCohortRelationships(extractedData);
                }
            }

            validateCaseControlRelationships(extractedData) {
                // Additional case-control specific validations
                const { controlExposure, oddsRatio, caseControlRatio } = extractedData.parameters;
                
                if (controlExposure && controlExposure > 80) {
                    console.warn('High control exposure rate detected - may indicate selection bias');
                }
                
                if (oddsRatio && (oddsRatio > 20 || oddsRatio < 0.1)) {
                    console.warn('Extreme odds ratio detected - verify clinical plausibility');
                }
            }

            validateCohortRelationships(extractedData) {
                // Additional cohort specific validations
                const { unexposedIncidence, relativeRisk } = extractedData.parameters;
                
                if (unexposedIncidence && unexposedIncidence > 50) {
                    console.warn('High baseline incidence detected - verify study population');
                }
                
                if (relativeRisk && (relativeRisk > 20 || relativeRisk < 0.1)) {
                    console.warn('Extreme relative risk detected - verify clinical plausibility');
                }
            }

            calculateAdvancedConfidence(extractedData) {
                // Calculate sophisticated overall confidence score
                const confidenceValues = Object.values(extractedData.sources).map(s => s.confidence);
                
                if (confidenceValues.length === 0) {
                    extractedData.confidence = 0;
                    return;
                }
                
                // Weighted confidence calculation
                const weightedSum = confidenceValues.reduce((sum, conf, index) => {
                    const weight = this.getParameterWeight(Object.keys(extractedData.parameters)[index]);
                    return sum + (conf * weight);
                }, 0);
                
                const totalWeight = confidenceValues.length;
                extractedData.confidence = Math.round(weightedSum / totalWeight);
                
                // Apply study-specific confidence adjustments
                if (extractedData.parameters.sampleSize && extractedData.parameters.power) {
                    extractedData.confidence += 5; // Bonus for having both key statistical parameters
                }
                
                // Cap confidence at reasonable academic level
                extractedData.confidence = Math.min(extractedData.confidence, 95);
            }

            getParameterWeight(paramName) {
                // Parameter importance weights for confidence calculation
                const weights = {
                    sampleSize: 1.3,
                    oddsRatio: 1.2,
                    relativeRisk: 1.2,
                    power: 1.1,
                    significanceLevel: 1.1,
                    controlExposure: 1.0,
                    unexposedIncidence: 1.0,
                    caseControlRatio: 0.8
                };
                
                return weights[paramName] || 1.0;
            }
        }

        // Initialize the advanced calculator
        const calculator = new KarmastatAdvancedCalculator();
        
        // Make globally available for PDF export and other functions
        window.calculator = calculator;
        
        console.log('üéØ KARMASTAT Advanced Calculator with Intelligent Academic Analysis loaded successfully');
    </script>
</body>
</html>
