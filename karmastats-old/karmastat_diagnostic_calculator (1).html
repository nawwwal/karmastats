<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Advanced Diagnostic Test Accuracy Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Enhanced CSS Variables for Academic Research Interface */
        :root {
            --primary: #FF8C42;
            --primary-dark: #E67A2F;
            --primary-light: #FFB570;
            --secondary: #2C5282;
            --accent: #F6AD55;
            --success: #38A169;
            --warning: #D69E2E;
            --danger: #E53E3E;
            --info: #3182CE;
            
            /* Light theme colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7FAFC;
            --bg-card: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-muted: #718096;
            --border-color: #E2E8F0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            
            /* Enhanced gradients for academic presentation */
            --gradient-primary: linear-gradient(135deg, #FF8C42, #F6AD55, #FFB570);
            --gradient-secondary: linear-gradient(135deg, #2C5282, #3182CE, #4299E1);
            --gradient-bg: linear-gradient(135deg, #FFF5F0, #FEEBC8, #FED7AA);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #F7FAFC);
            --gradient-magic: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-analytical: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-formula: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-diagnostic: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', 'Menlo', monospace;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #1A202C;
            --bg-secondary: #2D3748;
            --bg-card: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #E2E8F0;
            --text-muted: #A0AEC0;
            --border-color: #4A5568;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1A202C, #2D3748, #4A5568);
            --gradient-card: linear-gradient(145deg, #2D3748, #4A5568);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header Design */
        .header {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-diagnostic);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-diagnostic);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-diagnostic);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            max-width: 800px;
            margin: 0 auto;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Study Type Selection */
        .study-type-selection {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .study-type-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .study-type-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .study-type-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .study-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .study-type-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .study-type-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .study-type-card:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.2);
        }

        .study-type-card.active {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .study-type-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-diagnostic);
        }

        .study-type-card.active::after {
            content: '✓ Selected';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .study-card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-diagnostic);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .study-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .study-card-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .study-card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-badge {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        /* Calculator Section */
        .calculator-section {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .calculator-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calculator-section:hover {
            box-shadow: var(--shadow-hover);
        }

        @keyframes slideInFromBottom {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-diagnostic);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: var(--shadow);
        }

        .section-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Enhanced Formula Display for Academic Reference */
        .formula-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin: 1.5rem 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .formula-toggle {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .formula-toggle:hover {
            background: var(--bg-secondary);
        }

        .formula-toggle-icon {
            margin-right: 1rem;
            transition: transform 0.3s ease;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .formula-toggle.active .formula-toggle-icon {
            transform: rotate(90deg);
        }

        .formula-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .formula-content.active {
            max-height: 1000px;
        }

        .formula-display {
            background: var(--gradient-formula);
            color: white;
            padding: 1.5rem;
            margin: 1.5rem;
            font-family: var(--font-mono);
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .formula-explanation {
            padding: 0 1.5rem 1.5rem;
        }

        .formula-explanation h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .formula-explanation h5 {
            color: var(--secondary);
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .formula-explanation ul {
            list-style-type: none;
            padding: 0;
        }

        .formula-explanation li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .formula-explanation li:last-child {
            border-bottom: none;
        }

        .formula-var {
            font-family: var(--font-mono);
            font-weight: bold;
            color: var(--primary);
            min-width: 80px;
            font-size: 1.1rem;
        }

        .formula-desc {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .formula-note {
            background: rgba(255, 140, 66, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 1.5rem;
            border-radius: 6px;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Enhanced PDF Upload */
        .pdf-upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .pdf-upload-section:hover {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.03);
        }

        .pdf-upload-section.dragover {
            border-color: var(--primary);
            background: rgba(255, 140, 66, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-magic);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: var(--transition);
        }

        .pdf-upload-section:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        /* Advanced Intelligent Analysis Display */
        .magical-analysis-container {
            display: none;
            margin-top: 2rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        .magical-analysis-header {
            background: var(--gradient-magic);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .magical-analysis-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .magical-analysis-content {
            padding: 2rem;
        }

        .parameter-extraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .parameter-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
        }

        .parameter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .parameter-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .parameter-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .parameter-confidence {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--gradient-magic);
            transition: width 0.5s ease;
        }

        .parameter-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Enhanced Form Styles */
        .form-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .form-section h4 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.1);
            transform: translateY(-1px);
        }

        .input-help {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .calculate-btn {
            width: 100%;
            background: var(--gradient-diagnostic);
            color: white;
            border: none;
            padding: 1.25rem 2rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .results-section.show {
            display: block;
        }

        .result-card {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .result-main {
            font-size: 4rem;
            font-weight: 800;
            background: var(--gradient-diagnostic);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .detail-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: left;
        }

        .detail-card h4 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background: var(--gradient-diagnostic);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error styling */
        .error-message {
            background: #FED7D7;
            border: 1px solid #E53E3E;
            color: #C53030;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success-message {
            background: #C6F6D5;
            border: 1px solid #38A169;
            color: #2F855A;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 1rem;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
                align-self: center;
            }
            
            .study-type-grid {
                grid-template-columns: 1fr;
            }
            
            .parameter-extraction-grid {
                grid-template-columns: 1fr;
            }
            
            .result-main {
                font-size: 3rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Enhanced Header with Academic Branding -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">K</div>
                    <div>
                        <h1>KARMASTAT</h1>
                        <p class="subtitle">Advanced Diagnostic Test Accuracy Calculator with Intelligent Academic Parameter Extraction</p>
                    </div>
                </div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <span id="themeIcon">🌙</span>
                <span id="themeText">Dark Mode</span>
            </div>
        </div>

        <!-- Study Type Selection -->
        <div class="study-type-selection">
            <div class="study-type-header">
                <h2 class="study-type-title">Select Diagnostic Study Design</h2>
                <p class="study-type-subtitle">Choose the appropriate diagnostic test accuracy methodology for your research objectives</p>
            </div>
            
            <div class="study-type-grid">
                <div class="study-type-card" id="singleTestCard" data-study="single-test" tabindex="0">
                    <div class="study-card-icon">🔬</div>
                    <h3 class="study-card-title">Single Test Evaluation</h3>
                    <p class="study-card-description">
                        Evaluate the diagnostic performance of a single test by estimating sensitivity, specificity, and predictive values. 
                        Optimal for establishing baseline diagnostic accuracy parameters and developing clinical cutoff values for new diagnostic tools.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Sensitivity Estimation</span>
                        <span class="feature-badge">Specificity Estimation</span>
                        <span class="feature-badge">Prevalence Integration</span>
                        <span class="feature-badge">Buderer Methodology</span>
                    </div>
                </div>

                <div class="study-type-card" id="comparativeTestCard" data-study="comparative-test" tabindex="0">
                    <div class="study-card-icon">⚖️</div>
                    <h3 class="study-card-title">Comparative Test Study</h3>
                    <p class="study-card-description">
                        Compare diagnostic accuracy between two or more tests using paired or unpaired designs. 
                        Essential for determining which test performs better and establishing clinical superiority or equivalence between diagnostic methods.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Paired Design</span>
                        <span class="feature-badge">Unpaired Design</span>
                        <span class="feature-badge">McNemar Testing</span>
                        <span class="feature-badge">Sensitivity Comparison</span>
                    </div>
                </div>

                <div class="study-type-card" id="rocAnalysisCard" data-study="roc-analysis" tabindex="0">
                    <div class="study-card-icon">📈</div>
                    <h3 class="study-card-title">ROC Curve Analysis</h3>
                    <p class="study-card-description">
                        Receiver Operating Characteristic analysis for evaluating diagnostic test performance across all possible thresholds. 
                        Optimal for determining optimal cutoff values and comparing overall diagnostic discrimination ability using Area Under the Curve.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">AUC Estimation</span>
                        <span class="feature-badge">Optimal Cutoff</span>
                        <span class="feature-badge">Youden Index</span>
                        <span class="feature-badge">DeLong Method</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Single Test Evaluation Calculator -->
            <div class="calculator-section" id="singleTestCalculator">
                <div class="section-header">
                    <div class="section-icon">🔬</div>
                    <h3>Single Test Evaluation Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="singleTestFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Diagnostic Test Methodology</strong>
                    </div>
                    <div class="formula-content" id="singleTestFormulaContent">
                        <div class="formula-display">
                            n = [Z²Se(1-Se) / d²] × [1/P] for Sensitivity<br>
                            n = [Z²Sp(1-Sp) / d²] × [1/(1-P)] for Specificity
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Single Test Evaluation:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required sample size for test evaluation</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z</span>
                                    <span class="formula-desc">Critical value for desired confidence level (e.g., 1.96 for 95%)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Se</span>
                                    <span class="formula-desc">Expected sensitivity (true positive rate)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Sp</span>
                                    <span class="formula-desc">Expected specificity (true negative rate)</span>
                                </li>
                                <li>
                                    <span class="formula-var">d</span>
                                    <span class="formula-desc">Desired margin of error (half-width of confidence interval)</span>
                                </li>
                                <li>
                                    <span class="formula-var">P</span>
                                    <span class="formula-desc">Disease prevalence in study population</span>
                                </li>
                            </ul>
                            <h5>Clinical Interpretation:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                Total n = max(n_sensitivity, n_specificity)
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Buderer (1996) incorporating disease prevalence. Higher sample size from sensitivity or specificity calculation determines final requirement. Accounts for binomial distribution of diagnostic test results.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="singleTestPdfUploadSection">
                    <input type="file" id="singleTestPdfInput" class="file-input" accept=".pdf">
                    <label for="singleTestPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your diagnostic test research paper for automated parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="singleTestMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="singleTestProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing diagnostic methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="singleTestParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="singleTestApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="singleTestReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="singleTestForm">
                    <div class="form-section">
                        <h4>🔬 Single Test Evaluation Parameters</h4>
                        
                        <div class="input-group">
                            <label for="expectedSensitivity">Expected Sensitivity (%)</label>
                            <input type="number" id="expectedSensitivity" class="input-field" 
                                   min="1" max="100" step="0.1" value="85" required>
                            <div class="input-help">Expected sensitivity (true positive rate) of the diagnostic test</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="expectedSpecificity">Expected Specificity (%)</label>
                            <input type="number" id="expectedSpecificity" class="input-field" 
                                   min="1" max="100" step="0.1" value="90" required>
                            <div class="input-help">Expected specificity (true negative rate) of the diagnostic test</div>
                        </div>

                        <div class="input-group">
                            <label for="diseasePrevalence">Disease Prevalence (%)</label>
                            <input type="number" id="diseasePrevalence" class="input-field" 
                                   min="0.1" max="99.9" step="0.1" value="15" required>
                            <div class="input-help">Expected disease prevalence in the study population</div>
                        </div>

                        <div class="input-group">
                            <label for="marginOfError">Margin of Error (%)</label>
                            <input type="number" id="marginOfError" class="input-field" 
                                   min="0.1" max="20" step="0.1" value="5" required>
                            <div class="input-help">Desired precision (half-width of 95% confidence interval)</div>
                        </div>

                        <div class="input-group">
                            <label for="confidenceLevel">Confidence Level</label>
                            <select id="confidenceLevel" class="input-field" required>
                                <option value="95" selected>95%</option>
                                <option value="90">90%</option>
                                <option value="99">99%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="dropoutRate">Expected Dropout Rate (%)</label>
                            <input type="number" id="dropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of participants lost to follow-up</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Single Test Sample Size
                    </button>
                </form>
            </div>

            <!-- Comparative Test Study Calculator -->
            <div class="calculator-section" id="comparativeTestCalculator">
                <div class="section-header">
                    <div class="section-icon">⚖️</div>
                    <h3>Comparative Test Study Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display -->
                <div class="formula-container">
                    <div class="formula-toggle" id="comparativeTestFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Comparative Test Methodology</strong>
                    </div>
                    <div class="formula-content" id="comparativeTestFormulaContent">
                        <div class="formula-display">
                            Paired: n = (Z(α/2) + Z(β))² × [S₁(1-S₁) + S₂(1-S₂) - 2ρ√(S₁(1-S₁)S₂(1-S₂))] / (S₁-S₂)²<br>
                            Unpaired: n = 2(Z(α/2) + Z(β))² × [S₁(1-S₁) + S₂(1-S₂)] / (S₁-S₂)²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Comparative Studies:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">S₁, S₂</span>
                                    <span class="formula-desc">Expected sensitivity/specificity for Test 1 and Test 2</span>
                                </li>
                                <li>
                                    <span class="formula-var">ρ</span>
                                    <span class="formula-desc">Correlation between tests (paired design only)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance test</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                            </ul>
                            <div class="formula-note">
                                <strong>Design Choice:</strong> Paired designs are more efficient but require both tests on same subjects. Correlation ρ reduces required sample size - higher correlation means fewer subjects needed.
                            </div>
                        </div>
                    </div>
                </div>

                <form id="comparativeTestForm">
                    <div class="form-section">
                        <h4>⚖️ Comparative Test Study Parameters</h4>
                        
                        <div class="input-group">
                            <label for="studyDesign">Study Design</label>
                            <select id="studyDesign" class="input-field" required>
                                <option value="">Select design type</option>
                                <option value="paired">Paired Design (Same subjects, both tests)</option>
                                <option value="unpaired">Unpaired Design (Independent groups)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="comparisonMetric">Comparison Metric</label>
                            <select id="comparisonMetric" class="input-field" required>
                                <option value="">Select metric to compare</option>
                                <option value="sensitivity">Sensitivity</option>
                                <option value="specificity">Specificity</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="test1Performance">Test 1 Performance (%)</label>
                            <input type="number" id="test1Performance" class="input-field" 
                                   min="1" max="100" step="0.1" value="80" required>
                            <div class="input-help">Expected sensitivity or specificity of Test 1</div>
                        </div>

                        <div class="input-group">
                            <label for="test2Performance">Test 2 Performance (%)</label>
                            <input type="number" id="test2Performance" class="input-field" 
                                   min="1" max="100" step="0.1" value="90" required>
                            <div class="input-help">Expected sensitivity or specificity of Test 2</div>
                        </div>

                        <div id="correlationGroup" class="input-group" style="display:none;">
                            <label for="testCorrelation">Test Correlation (ρ)</label>
                            <input type="number" id="testCorrelation" class="input-field" 
                                   min="0" max="1" step="0.1" value="0.5">
                            <div class="input-help">Correlation between test results (0 = independent, 1 = perfect correlation)</div>
                        </div>

                        <div class="input-group">
                            <label for="compPrevalence">Disease Prevalence (%)</label>
                            <input type="number" id="compPrevalence" class="input-field" 
                                   min="0.1" max="99.9" step="0.1" value="20" required>
                            <div class="input-help">Disease prevalence in study population</div>
                        </div>

                        <div class="input-group">
                            <label for="compSignificanceLevel">Significance Level (α)</label>
                            <select id="compSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="compStatisticalPower">Statistical Power (1-β)</label>
                            <select id="compStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="compDropoutRate">Expected Dropout Rate (%)</label>
                            <input type="number" id="compDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="15">
                            <div class="input-help">Expected loss to follow-up percentage</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Comparative Study Sample Size
                    </button>
                </form>
            </div>

            <!-- ROC Analysis Calculator -->
            <div class="calculator-section" id="rocAnalysisCalculator">
                <div class="section-header">
                    <div class="section-icon">📈</div>
                    <h3>ROC Curve Analysis Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display -->
                <div class="formula-container">
                    <div class="formula-toggle" id="rocAnalysisFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & ROC Analysis Methodology</strong>
                    </div>
                    <div class="formula-content" id="rocAnalysisFormulaContent">
                        <div class="formula-display">
                            n = (Z(α/2) + Z(β))² × [AUC₀(1-AUC₀) + AUC₁(1-AUC₁)] / (AUC₁-AUC₀)²<br>
                            Total n = n × (1 + k) / P where k = negative/positive ratio
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for ROC Analysis:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">AUC₁</span>
                                    <span class="formula-desc">Expected Area Under the Curve for the test</span>
                                </li>
                                <li>
                                    <span class="formula-var">AUC₀</span>
                                    <span class="formula-desc">Null hypothesis AUC (0.5 for no discrimination)</span>
                                </li>
                                <li>
                                    <span class="formula-var">k</span>
                                    <span class="formula-desc">Ratio of negative to positive cases</span>
                                </li>
                                <li>
                                    <span class="formula-var">P</span>
                                    <span class="formula-desc">Disease prevalence (proportion of positive cases)</span>
                                </li>
                            </ul>
                            <h5>AUC Interpretation:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                AUC = 0.5: No discrimination ability<br>
                                AUC = 0.7-0.8: Acceptable discrimination<br>
                                AUC = 0.8-0.9: Excellent discrimination<br>
                                AUC > 0.9: Outstanding discrimination
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Based on Hanley & McNeil methodology with DeLong variance estimation. Sample size calculation ensures adequate power to detect clinically meaningful differences in diagnostic discrimination ability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="rocAnalysisPdfUploadSection">
                    <input type="file" id="rocAnalysisPdfInput" class="file-input" accept=".pdf">
                    <label for="rocAnalysisPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your ROC analysis research paper for automated parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="rocAnalysisMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="rocAnalysisProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing ROC methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="rocAnalysisParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="rocAnalysisApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="rocAnalysisReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <form id="rocAnalysisForm">
                    <div class="form-section">
                        <h4>📈 ROC Curve Analysis Parameters</h4>
                        
                        <div class="input-group">
                            <label for="analysisType">Analysis Type</label>
                            <select id="analysisType" class="input-field" required>
                                <option value="">Select analysis type</option>
                                <option value="single">Single Test ROC Curve</option>
                                <option value="comparison">Compare Two ROC Curves</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="expectedAUC">Expected AUC</label>
                            <input type="number" id="expectedAUC" class="input-field" 
                                   min="0.5" max="1.0" step="0.01" value="0.80" required>
                            <div class="input-help">Expected Area Under the ROC Curve for the diagnostic test</div>
                        </div>

                        <div id="comparisonAUCGroup" class="input-group" style="display:none;">
                            <label for="comparisonAUC">Comparison Test AUC</label>
                            <input type="number" id="comparisonAUC" class="input-field" 
                                   min="0.5" max="1.0" step="0.01" value="0.65">
                            <div class="input-help">AUC of the comparison test (for comparative studies)</div>
                        </div>

                        <div class="input-group">
                            <label for="nullAUC">Null Hypothesis AUC</label>
                            <input type="number" id="nullAUC" class="input-field" 
                                   min="0.5" max="1.0" step="0.01" value="0.50" required>
                            <div class="input-help">AUC under null hypothesis (0.5 = no discrimination)</div>
                        </div>

                        <div class="input-group">
                            <label for="rocPrevalence">Disease Prevalence (%)</label>
                            <input type="number" id="rocPrevalence" class="input-field" 
                                   min="0.1" max="99.9" step="0.1" value="25" required>
                            <div class="input-help">Proportion of positive cases in study population</div>
                        </div>

                        <div class="input-group">
                            <label for="negativePositiveRatio">Negative:Positive Ratio</label>
                            <select id="negativePositiveRatio" class="input-field" required>
                                <option value="1">1:1 (Equal groups)</option>
                                <option value="2" selected>2:1 (Twice as many negatives)</option>
                                <option value="3">3:1 (Three times as many negatives)</option>
                                <option value="4">4:1 (Four times as many negatives)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="rocSignificanceLevel">Significance Level (α)</label>
                            <select id="rocSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5%</option>
                                <option value="0.01">1%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="rocStatisticalPower">Statistical Power (1-β)</label>
                            <select id="rocStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="rocDropoutRate">Expected Dropout Rate (%)</label>
                            <input type="number" id="rocDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected participant dropout percentage</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate ROC Analysis Sample Size
                    </button>
                </form>
            </div>

            <!-- Enhanced Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        class KarmastatDiagnosticCalculator {
            constructor() {
                this.currentTheme = 'light';
                this.currentStudyType = null;
                this.extractedParams = {};
                this.diagnosticAnalysisEngine = new AdvancedDiagnosticAnalysisEngine();
                this.init();
            }

            init() {
                console.log('🚀 Initializing KARMASTAT Diagnostic Test Accuracy Calculator...');
                
                try {
                    // Initialize PDF.js worker
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                    
                    this.setupEventListeners();
                    this.loadSavedTheme();
                    
                    console.log('✅ KARMASTAT Diagnostic Calculator initialized successfully');
                } catch (error) {
                    console.error('❌ Initialization error:', error);
                    this.showError('Failed to initialize calculator. Please refresh the page.');
                }
            }

            setupEventListeners() {
                // Theme toggle
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
                
                // Study type selection
                this.setupStudyTypeSelection();
                
                // Formula toggles
                this.setupFormulaToggles();
                
                // Form handlers
                this.setupFormHandlers();
                
                // Dynamic form behaviors
                this.setupDynamicBehaviors();
                
                // PDF upload functionality
                this.setupPdfUploadHandlers();
            }

            setupStudyTypeSelection() {
                const studyTypeCards = document.querySelectorAll('.study-type-card');
                studyTypeCards.forEach(card => {
                    const studyType = card.dataset.study;
                    if (studyType) {
                        card.addEventListener('click', () => this.selectStudyType(studyType));
                        card.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                this.selectStudyType(studyType);
                            }
                        });
                    }
                });
            }

            setupFormulaToggles() {
                const formulaToggles = [
                    { id: 'singleTestFormulaToggle', contentId: 'singleTestFormulaContent' },
                    { id: 'comparativeTestFormulaToggle', contentId: 'comparativeTestFormulaContent' },
                    { id: 'rocAnalysisFormulaToggle', contentId: 'rocAnalysisFormulaContent' }
                ];
                
                formulaToggles.forEach(({ id, contentId }) => {
                    const toggle = document.getElementById(id);
                    const content = document.getElementById(contentId);
                    
                    if (toggle && content) {
                        toggle.addEventListener('click', () => {
                            toggle.classList.toggle('active');
                            content.classList.toggle('active');
                        });
                    }
                });
            }

            setupFormHandlers() {
                // Single test form
                const singleTestForm = document.getElementById('singleTestForm');
                if (singleTestForm) {
                    singleTestForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'single-test'));
                }
                
                // Comparative test form
                const comparativeTestForm = document.getElementById('comparativeTestForm');
                if (comparativeTestForm) {
                    comparativeTestForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'comparative-test'));
                }
                
                // ROC analysis form
                const rocAnalysisForm = document.getElementById('rocAnalysisForm');
                if (rocAnalysisForm) {
                    rocAnalysisForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'roc-analysis'));
                }
            }

            setupDynamicBehaviors() {
                // Study design change for comparative tests
                const studyDesign = document.getElementById('studyDesign');
                const correlationGroup = document.getElementById('correlationGroup');
                
                if (studyDesign && correlationGroup) {
                    studyDesign.addEventListener('change', () => {
                        if (studyDesign.value === 'paired') {
                            correlationGroup.style.display = 'block';
                        } else {
                            correlationGroup.style.display = 'none';
                        }
                    });
                }

                // Analysis type change for ROC analysis
                const analysisType = document.getElementById('analysisType');
                const comparisonAUCGroup = document.getElementById('comparisonAUCGroup');
                
                if (analysisType && comparisonAUCGroup) {
                    analysisType.addEventListener('change', () => {
                        if (analysisType.value === 'comparison') {
                            comparisonAUCGroup.style.display = 'block';
                        } else {
                            comparisonAUCGroup.style.display = 'none';
                        }
                    });
                }
            }

            setupPdfUploadHandlers() {
                const singleTestPdfInput = document.getElementById('singleTestPdfInput');
                if (singleTestPdfInput) {
                    singleTestPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'single-test'));
                }

                const comparativeTestPdfInput = document.getElementById('comparativeTestPdfInput');
                if (comparativeTestPdfInput) {
                    comparativeTestPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'comparative-test'));
                }

                const rocAnalysisPdfInput = document.getElementById('rocAnalysisPdfInput');
                if (rocAnalysisPdfInput) {
                    rocAnalysisPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'roc-analysis'));
                }
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.currentTheme);
                
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                
                if (this.currentTheme === 'dark') {
                    themeIcon.textContent = '☀️';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = '🌙';
                    themeText.textContent = 'Dark Mode';
                }
                
                localStorage.setItem('karmastat-theme', this.currentTheme);
            }

            loadSavedTheme() {
                const savedTheme = localStorage.getItem('karmastat-theme');
                if (savedTheme && savedTheme !== this.currentTheme) {
                    this.toggleTheme();
                }
            }

            selectStudyType(studyType) {
                console.log(`Selecting study type: ${studyType}`);
                
                try {
                    this.clearResults();
                    
                    // Update card selection
                    document.querySelectorAll('.study-type-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    const cardMap = {
                        'single-test': 'singleTestCard',
                        'comparative-test': 'comparativeTestCard',
                        'roc-analysis': 'rocAnalysisCard'
                    };
                    
                    const selectedCard = document.getElementById(cardMap[studyType]);
                    if (selectedCard) {
                        selectedCard.classList.add('active');
                    }
                    
                    // Hide all calculator sections
                    document.querySelectorAll('.calculator-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    // Show selected calculator
                    const calculatorMap = {
                        'single-test': 'singleTestCalculator',
                        'comparative-test': 'comparativeTestCalculator',
                        'roc-analysis': 'rocAnalysisCalculator'
                    };
                    
                    const calculator = document.getElementById(calculatorMap[studyType]);
                    if (calculator) {
                        calculator.style.display = 'block';
                        calculator.classList.add('active');
                        this.currentStudyType = studyType;
                        
                        setTimeout(() => {
                            calculator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error selecting study type:', error);
                    this.showError('Error selecting study type. Please try again.');
                }
            }

            handleFormSubmission(event, studyType) {
                event.preventDefault();
                console.log(`Processing ${studyType} calculation`);
                
                try {
                    const formData = this.collectFormData(studyType);
                    this.validateParameters(formData, studyType);
                    const results = this.calculateSampleSize(formData, studyType);
                    this.displayResults(results, studyType);
                    
                } catch (error) {
                    console.error(`Calculation error for ${studyType}:`, error);
                    this.showError(error.message);
                }
            }

            collectFormData(studyType) {
                switch (studyType) {
                    case 'single-test':
                        return this.collectSingleTestData();
                    case 'comparative-test':
                        return this.collectComparativeTestData();
                    case 'roc-analysis':
                        return this.collectROCAnalysisData();
                    default:
                        throw new Error('Invalid study type specified');
                }
            }

            collectSingleTestData() {
                return {
                    expectedSensitivity: parseFloat(document.getElementById('expectedSensitivity').value) / 100,
                    expectedSpecificity: parseFloat(document.getElementById('expectedSpecificity').value) / 100,
                    diseasePrevalence: parseFloat(document.getElementById('diseasePrevalence').value) / 100,
                    marginOfError: parseFloat(document.getElementById('marginOfError').value) / 100,
                    confidenceLevel: parseInt(document.getElementById('confidenceLevel').value),
                    dropoutRate: parseFloat(document.getElementById('dropoutRate').value) / 100
                };
            }

            collectComparativeTestData() {
                return {
                    studyDesign: document.getElementById('studyDesign').value,
                    comparisonMetric: document.getElementById('comparisonMetric').value,
                    test1Performance: parseFloat(document.getElementById('test1Performance').value) / 100,
                    test2Performance: parseFloat(document.getElementById('test2Performance').value) / 100,
                    testCorrelation: document.getElementById('studyDesign').value === 'paired' ? 
                        parseFloat(document.getElementById('testCorrelation').value) : 0,
                    diseasePrevalence: parseFloat(document.getElementById('compPrevalence').value) / 100,
                    significanceLevel: parseFloat(document.getElementById('compSignificanceLevel').value),
                    statisticalPower: parseFloat(document.getElementById('compStatisticalPower').value),
                    dropoutRate: parseFloat(document.getElementById('compDropoutRate').value) / 100
                };
            }

            collectROCAnalysisData() {
                return {
                    analysisType: document.getElementById('analysisType').value,
                    expectedAUC: parseFloat(document.getElementById('expectedAUC').value),
                    comparisonAUC: document.getElementById('analysisType').value === 'comparison' ? 
                        parseFloat(document.getElementById('comparisonAUC').value) : null,
                    nullAUC: parseFloat(document.getElementById('nullAUC').value),
                    diseasePrevalence: parseFloat(document.getElementById('rocPrevalence').value) / 100,
                    negativePositiveRatio: parseFloat(document.getElementById('negativePositiveRatio').value),
                    significanceLevel: parseFloat(document.getElementById('rocSignificanceLevel').value),
                    statisticalPower: parseFloat(document.getElementById('rocStatisticalPower').value),
                    dropoutRate: parseFloat(document.getElementById('rocDropoutRate').value) / 100
                };
            }

            validateParameters(params, studyType) {
                // Basic validation
                for (const [key, value] of Object.entries(params)) {
                    if (value === null || value === undefined || (typeof value === 'number' && isNaN(value))) {
                        throw new Error(`Invalid value for ${key}: ${value}`);
                    }
                }

                // Study-specific validations
                if (studyType === 'single-test') {
                    if (params.expectedSensitivity <= 0 || params.expectedSensitivity >= 1) {
                        throw new Error('Sensitivity must be between 0 and 100%');
                    }
                    if (params.expectedSpecificity <= 0 || params.expectedSpecificity >= 1) {
                        throw new Error('Specificity must be between 0 and 100%');
                    }
                }
            }

            calculateSampleSize(params, studyType) {
                switch (studyType) {
                    case 'single-test':
                        return this.calculateSingleTestSampleSize(params);
                    case 'comparative-test':
                        return this.calculateComparativeTestSampleSize(params);
                    case 'roc-analysis':
                        return this.calculateROCAnalysisSampleSize(params);
                    default:
                        throw new Error('Invalid study type for calculation');
                }
            }

            calculateSingleTestSampleSize(params) {
                const { expectedSensitivity, expectedSpecificity, diseasePrevalence, 
                        marginOfError, confidenceLevel, dropoutRate } = params;
                
                // Get Z-score
                const zScore = this.getZScore(confidenceLevel);
                
                // Calculate sample size for sensitivity
                const nSensitivity = Math.ceil(
                    (Math.pow(zScore, 2) * expectedSensitivity * (1 - expectedSensitivity)) / 
                    (Math.pow(marginOfError, 2) * diseasePrevalence)
                );
                
                // Calculate sample size for specificity
                const nSpecificity = Math.ceil(
                    (Math.pow(zScore, 2) * expectedSpecificity * (1 - expectedSpecificity)) / 
                    (Math.pow(marginOfError, 2) * (1 - diseasePrevalence))
                );
                
                // Take the larger sample size
                const baseSize = Math.max(nSensitivity, nSpecificity);
                
                // Adjust for dropouts
                const adjustedSize = Math.ceil(baseSize / (1 - dropoutRate));
                
                // Calculate disease positive and negative counts
                const diseasePositive = Math.ceil(adjustedSize * diseasePrevalence);
                const diseaseNegative = adjustedSize - diseasePositive;

                return {
                    studyType: 'single-test',
                    totalSize: adjustedSize,
                    diseasePositive,
                    diseaseNegative,
                    baseSize,
                    nSensitivity,
                    nSpecificity,
                    parameters: params,
                    statistics: { zScore }
                };
            }

            calculateComparativeTestSampleSize(params) {
                const { studyDesign, test1Performance, test2Performance, testCorrelation,
                        diseasePrevalence, significanceLevel, statisticalPower, dropoutRate } = params;
                
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                let baseSize;
                
                if (studyDesign === 'paired') {
                    // Paired design with correlation
                    const s1 = test1Performance;
                    const s2 = test2Performance;
                    const rho = testCorrelation;
                    
                    baseSize = Math.ceil(
                        Math.pow(zAlpha + zBeta, 2) * 
                        (s1 * (1 - s1) + s2 * (1 - s2) - 2 * rho * Math.sqrt(s1 * (1 - s1) * s2 * (1 - s2))) /
                        Math.pow(s1 - s2, 2)
                    );
                } else {
                    // Unpaired design
                    baseSize = Math.ceil(
                        2 * Math.pow(zAlpha + zBeta, 2) * 
                        (test1Performance * (1 - test1Performance) + test2Performance * (1 - test2Performance)) /
                        Math.pow(test1Performance - test2Performance, 2)
                    );
                }
                
                // Adjust for dropouts
                const adjustedSize = Math.ceil(baseSize / (1 - dropoutRate));
                
                // Calculate total based on prevalence
                const totalSize = Math.ceil(adjustedSize / diseasePrevalence);

                return {
                    studyType: 'comparative-test',
                    baseSize,
                    adjustedSize,
                    totalSize,
                    parameters: params,
                    statistics: { zAlpha, zBeta }
                };
            }

            calculateROCAnalysisSampleSize(params) {
                const { expectedAUC, nullAUC, diseasePrevalence, negativePositiveRatio,
                        significanceLevel, statisticalPower, dropoutRate } = params;
                
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Basic AUC sample size calculation
                const baseSize = Math.ceil(
                    Math.pow(zAlpha + zBeta, 2) * 
                    (expectedAUC * (1 - expectedAUC) + nullAUC * (1 - nullAUC)) /
                    Math.pow(expectedAUC - nullAUC, 2)
                );
                
                // Adjust for negative:positive ratio and prevalence
                const totalSize = Math.ceil(baseSize * (1 + negativePositiveRatio) / diseasePrevalence);
                
                // Adjust for dropouts
                const adjustedSize = Math.ceil(totalSize / (1 - dropoutRate));
                
                const positiveSize = Math.ceil(adjustedSize * diseasePrevalence);
                const negativeSize = adjustedSize - positiveSize;

                return {
                    studyType: 'roc-analysis',
                    totalSize: adjustedSize,
                    positiveSize,
                    negativeSize,
                    baseSize,
                    parameters: params,
                    statistics: { zAlpha, zBeta }
                };
            }

            displayResults(results, studyType) {
                const resultsSection = document.getElementById('resultsSection');
                
                // Store results for PDF export
                this.currentResults = results;
                this.currentStudyType = studyType;
                
                let html = '';
                switch (studyType) {
                    case 'single-test':
                        html = this.generateSingleTestResults(results);
                        break;
                    case 'comparative-test':
                        html = this.generateComparativeTestResults(results);
                        break;
                    case 'roc-analysis':
                        html = this.generateROCAnalysisResults(results);
                        break;
                }
                
                resultsSection.innerHTML = html;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });

                // Set up export button handlers after DOM is updated
                setTimeout(() => this.setupExportHandlers(), 100);
            }

            setupExportHandlers() {
                const exportBtn = document.getElementById('exportPdfBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportToPDF(this.currentResults, this.currentStudyType);
                    });
                }

                const newCalcBtn = document.getElementById('newCalculationBtn');
                if (newCalcBtn) {
                    newCalcBtn.addEventListener('click', () => {
                        this.newCalculation();
                    });
                }
            }

            generateSingleTestResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>🔬 Single Test Evaluation Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Disease Positive:</span><span class="detail-value">${results.diseasePositive.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Disease Negative:</span><span class="detail-value">${results.diseaseNegative.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Expected Sensitivity:</span><span class="detail-value">${(results.parameters.expectedSensitivity * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Expected Specificity:</span><span class="detail-value">${(results.parameters.expectedSpecificity * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Disease Prevalence:</span><span class="detail-value">${(results.parameters.diseasePrevalence * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Confidence Level:</span><span class="detail-value">${results.parameters.confidenceLevel}%</span></li>
                                    <li><span class="detail-label">Margin of Error:</span><span class="detail-value">±${(results.parameters.marginOfError * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Z-score:</span><span class="detail-value">${results.statistics.zScore.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Sample for Sensitivity:</span><span class="detail-value">${results.nSensitivity.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Sample for Specificity:</span><span class="detail-value">${results.nSpecificity.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Dropout Adjustment:</span><span class="detail-value">${(results.parameters.dropoutRate * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Diagnostic Study Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Reference Standard:</span><span class="detail-value">Gold Standard Required</span></li>
                                    <li><span class="detail-label">Blinding Strategy:</span><span class="detail-value">Assessor Blinding</span></li>
                                    <li><span class="detail-label">Patient Selection:</span><span class="detail-value">Consecutive Enrollment</span></li>
                                    <li><span class="detail-label">Cutoff Determination:</span><span class="detail-value">Pre-specified Threshold</span></li>
                                    <li><span class="detail-label">Quality Assurance:</span><span class="detail-value">STARD Guidelines</span></li>
                                    <li><span class="detail-label">Data Analysis:</span><span class="detail-value">2x2 Contingency Table</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" id="exportPdfBtn">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" id="newCalculationBtn">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateComparativeTestResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>⚖️ Comparative Test Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Study Design:</span><span class="detail-value">${results.parameters.studyDesign}</span></li>
                                    <li><span class="detail-label">Comparison Metric:</span><span class="detail-value">${results.parameters.comparisonMetric}</span></li>
                                    <li><span class="detail-label">Test 1 Performance:</span><span class="detail-value">${(results.parameters.test1Performance * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Test 2 Performance:</span><span class="detail-value">${(results.parameters.test2Performance * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Performance Difference:</span><span class="detail-value">${(Math.abs(results.parameters.test1Performance - results.parameters.test2Performance) * 100).toFixed(1)}%</span></li>
                                    ${results.parameters.studyDesign === 'paired' ? 
                                      `<li><span class="detail-label">Test Correlation:</span><span class="detail-value">${results.parameters.testCorrelation.toFixed(2)}</span></li>` : ''}
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 Statistical Analysis</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Adjusted Sample Size:</span><span class="detail-value">${results.adjustedSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Significance Level:</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Study Design Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Statistical Test:</span><span class="detail-value">${results.parameters.studyDesign === 'paired' ? 'McNemar Test' : 'Chi-square Test'}</span></li>
                                    <li><span class="detail-label">Randomization:</span><span class="detail-value">Test Order Randomization</span></li>
                                    <li><span class="detail-label">Blinding:</span><span class="detail-value">Reader/Interpreter Blinding</span></li>
                                    <li><span class="detail-label">Quality Control:</span><span class="detail-value">Inter-reader Agreement</span></li>
                                    <li><span class="detail-label">Analysis Plan:</span><span class="detail-value">Intention-to-Diagnose</span></li>
                                    <li><span class="detail-label">Reporting:</span><span class="detail-value">STARD-compliant</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" id="exportPdfBtn">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" id="newCalculationBtn">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateROCAnalysisResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>📈 ROC Analysis Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Positive Cases:</span><span class="detail-value">${results.positiveSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Negative Cases:</span><span class="detail-value">${results.negativeSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Expected AUC:</span><span class="detail-value">${results.parameters.expectedAUC.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Null Hypothesis AUC:</span><span class="detail-value">${results.parameters.nullAUC.toFixed(3)}</span></li>
                                    <li><span class="detail-label">AUC Difference:</span><span class="detail-value">${(results.parameters.expectedAUC - results.parameters.nullAUC).toFixed(3)}</span></li>
                                    <li><span class="detail-label">Negative:Positive Ratio:</span><span class="detail-value">${results.parameters.negativePositiveRatio}:1</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 ROC Statistical Analysis</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Disease Prevalence:</span><span class="detail-value">${(results.parameters.diseasePrevalence * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Significance Level:</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 ROC Study Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Curve Construction:</span><span class="detail-value">Non-parametric (Empirical)</span></li>
                                    <li><span class="detail-label">AUC Calculation:</span><span class="detail-value">DeLong Method</span></li>
                                    <li><span class="detail-label">Optimal Cutoff:</span><span class="detail-value">Youden Index (J)</span></li>
                                    <li><span class="detail-label">Confidence Intervals:</span><span class="detail-value">Bootstrap Method</span></li>
                                    <li><span class="detail-label">Comparison Testing:</span><span class="detail-value">DeLong Test</span></li>
                                    <li><span class="detail-label">Software Tools:</span><span class="detail-value">R pROC, MedCalc</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF(${JSON.stringify(results).replace(/"/g, '&quot;')}, 'roc-analysis')">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            exportToPDF(results, studyType) {
                try {
                    // Check if jsPDF is available
                    if (typeof window.jspdf === 'undefined') {
                        throw new Error('PDF library not loaded');
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Header
                    doc.setFontSize(24);
                    doc.setTextColor(255, 140, 66);
                    doc.text('KARMASTAT', 105, 25, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    const studyTypeName = {
                        'single-test': 'Single Test Evaluation',
                        'comparative-test': 'Comparative Test Study',
                        'roc-analysis': 'ROC Curve Analysis'
                    }[studyType] || studyType;
                    doc.text(`${studyTypeName} Sample Size Calculation`, 105, 35, { align: 'center' });
                    
                    // Main result
                    doc.setFontSize(28);
                    doc.setTextColor(250, 114, 154);
                    doc.text(`Total Required: ${results.totalSize ? results.totalSize.toLocaleString() : 'N/A'}`, 105, 55, { align: 'center' });
                    
                    // Methodology note
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    const methodNote = `Calculated using ${studyTypeName} methodology with academic validation`;
                    doc.text(methodNote, 105, 65, { align: 'center' });
                    
                    // Parameters section
                    doc.setFontSize(14);
                    doc.text('Diagnostic Study Parameters:', 20, 80);
                    
                    let y = 90;
                    let params = [];
                    
                    if (studyType === 'single-test') {
                        params = [
                            `Disease Positive Cases: ${results.diseasePositive ? results.diseasePositive.toLocaleString() : 'N/A'}`,
                            `Disease Negative Cases: ${results.diseaseNegative ? results.diseaseNegative.toLocaleString() : 'N/A'}`,
                            `Expected Sensitivity: ${results.parameters && results.parameters.expectedSensitivity ? (results.parameters.expectedSensitivity * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Expected Specificity: ${results.parameters && results.parameters.expectedSpecificity ? (results.parameters.expectedSpecificity * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Disease Prevalence: ${results.parameters && results.parameters.diseasePrevalence ? (results.parameters.diseasePrevalence * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Margin of Error: ${results.parameters && results.parameters.marginOfError ? '±' + (results.parameters.marginOfError * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Confidence Level: ${results.parameters && results.parameters.confidenceLevel ? results.parameters.confidenceLevel + '%' : 'N/A'}`,
                            `Base Sample Size: ${results.baseSize ? results.baseSize.toLocaleString() : 'N/A'}`,
                            `Dropout Adjustment: ${results.parameters && results.parameters.dropoutRate ? (results.parameters.dropoutRate * 100) + '%' : 'N/A'}`
                        ];
                    } else if (studyType === 'comparative-test') {
                        params = [
                            `Study Design: ${results.parameters && results.parameters.studyDesign ? results.parameters.studyDesign : 'N/A'}`,
                            `Comparison Metric: ${results.parameters && results.parameters.comparisonMetric ? results.parameters.comparisonMetric : 'N/A'}`,
                            `Test 1 Performance: ${results.parameters && results.parameters.test1Performance ? (results.parameters.test1Performance * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Test 2 Performance: ${results.parameters && results.parameters.test2Performance ? (results.parameters.test2Performance * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Statistical Power: ${results.parameters && results.parameters.statisticalPower ? (results.parameters.statisticalPower * 100) + '%' : 'N/A'}`,
                            `Significance Level: ${results.parameters && results.parameters.significanceLevel ? (results.parameters.significanceLevel * 100) + '%' : 'N/A'}`,
                            `Base Sample Size: ${results.baseSize ? results.baseSize.toLocaleString() : 'N/A'}`,
                            `Adjusted Sample Size: ${results.adjustedSize ? results.adjustedSize.toLocaleString() : 'N/A'}`
                        ];
                    } else if (studyType === 'roc-analysis') {
                        params = [
                            `Positive Cases: ${results.positiveSize ? results.positiveSize.toLocaleString() : 'N/A'}`,
                            `Negative Cases: ${results.negativeSize ? results.negativeSize.toLocaleString() : 'N/A'}`,
                            `Expected AUC: ${results.parameters && results.parameters.expectedAUC ? results.parameters.expectedAUC.toFixed(3) : 'N/A'}`,
                            `Null Hypothesis AUC: ${results.parameters && results.parameters.nullAUC ? results.parameters.nullAUC.toFixed(3) : 'N/A'}`,
                            `Disease Prevalence: ${results.parameters && results.parameters.diseasePrevalence ? (results.parameters.diseasePrevalence * 100).toFixed(1) + '%' : 'N/A'}`,
                            `Negative:Positive Ratio: ${results.parameters && results.parameters.negativePositiveRatio ? results.parameters.negativePositiveRatio + ':1' : 'N/A'}`,
                            `Statistical Power: ${results.parameters && results.parameters.statisticalPower ? (results.parameters.statisticalPower * 100) + '%' : 'N/A'}`,
                            `Base Sample Size: ${results.baseSize ? results.baseSize.toLocaleString() : 'N/A'}`
                        ];
                    }
                    
                    params.forEach(param => {
                        if (y > 250) {
                            doc.addPage();
                            y = 25;
                        }
                        doc.text(`• ${param}`, 25, y);
                        y += 8;
                    });
                    
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Generated by KARMASTAT - Diagnostic Test Accuracy Calculator', 105, 270, { align: 'center' });
                    doc.text(`${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString()}`, 105, 280, { align: 'center' });
                    
                    const fileName = `KARMASTAT-${studyTypeName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);
                    
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('Error exporting PDF: ' + error.message + '. Please ensure the page is fully loaded and try again.');
                }
            }

            newCalculation() {
                // Reset forms
                const forms = ['singleTestForm', 'comparativeTestForm', 'rocAnalysisForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) form.reset();
                });
                
                // Reset default values
                const defaultValues = {
                    'expectedSensitivity': '85',
                    'expectedSpecificity': '90',
                    'diseasePrevalence': '15',
                    'marginOfError': '5',
                    'dropoutRate': '10',
                    'test1Performance': '80',
                    'test2Performance': '90',
                    'compPrevalence': '20',
                    'compDropoutRate': '15',
                    'expectedAUC': '0.80',
                    'nullAUC': '0.50',
                    'rocPrevalence': '25',
                    'rocDropoutRate': '10'
                };
                
                Object.entries(defaultValues).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });
                
                this.clearResults();
                
                // Reset study type selection
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Reset internal state
                this.currentStudyType = null;
                this.extractedParams = {};
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            clearResults() {
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.classList.remove('show');
                    resultsSection.innerHTML = '';
                }
            }

            showError(message) {
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.innerHTML = `
                    <div class="result-card" style="border: 2px solid #E53E3E;">
                        <div style="text-align: center; color: #E53E3E;">
                            <h3>⚠️ Calculation Error</h3>
                            <div class="error-message">${message}</div>
                            <button class="btn-primary" onclick="calculator.newCalculation()" style="margin-top: 1rem;">
                                <span>🔄</span>Start New Calculation
                            </button>
                        </div>
                    </div>
                `;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            getZScore(confidence) {
                const zScores = {
                    50: 0.000, 55: 0.126, 60: 0.253, 65: 0.385, 70: 0.524,
                    75: 0.674, 80: 0.842, 85: 1.036, 90: 1.282, 91: 1.341,
                    92: 1.405, 93: 1.476, 94: 1.555, 95: 1.645, 96: 1.751,
                    97: 1.881, 97.5: 1.960, 98: 2.054, 99: 2.326, 99.5: 2.576,
                    99.9: 3.090, 99.95: 3.291, 99.99: 3.719
                };
                return zScores[confidence] || zScores[95];
            }

            async handlePdfUpload(event, studyType) {
                const file = event.target.files[0];
                if (!file) return;

                console.log(`Processing PDF upload for ${studyType} study`);

                const containerMappings = {
                    'single-test': {
                        analysisContainerId: 'singleTestMagicalAnalysis',
                        processingIndicatorId: 'singleTestProcessingIndicator'
                    },
                    'comparative-test': {
                        analysisContainerId: 'comparativeTestMagicalAnalysis',
                        processingIndicatorId: 'comparativeTestProcessingIndicator'
                    },
                    'roc-analysis': {
                        analysisContainerId: 'rocAnalysisMagicalAnalysis',
                        processingIndicatorId: 'rocAnalysisProcessingIndicator'
                    }
                };

                const mapping = containerMappings[studyType];
                if (!mapping) {
                    console.error('Invalid study type for PDF upload');
                    return;
                }

                const analysisContainer = document.getElementById(mapping.analysisContainerId);
                const processingIndicator = document.getElementById(mapping.processingIndicatorId);
                
                if (!analysisContainer || !processingIndicator) {
                    console.error('Required elements not found for PDF analysis');
                    return;
                }
                
                analysisContainer.style.display = 'block';
                processingIndicator.style.display = 'flex';
                processingIndicator.innerHTML = '<div class="spinner"></div><span>Analyzing diagnostic methodology...</span>';
                
                try {
                    const extractedData = await this.diagnosticAnalysisEngine.analyzePDF(file, studyType);
                    
                    processingIndicator.style.display = 'none';
                    this.displayExtractionResults(extractedData, studyType);
                    this.extractedParams[studyType] = extractedData;
                    
                    console.log('Diagnostic PDF analysis completed successfully');
                    
                } catch (error) {
                    console.error('PDF analysis error:', error);
                    processingIndicator.innerHTML = '<span style="color: #E53E3E;">❌ Analysis failed. Please verify PDF quality and try again.</span>';
                }
            }

            displayExtractionResults(data, studyType) {
                const gridMappings = {
                    'single-test': 'singleTestParameterGrid',
                    'comparative-test': 'comparativeTestParameterGrid',
                    'roc-analysis': 'rocAnalysisParameterGrid'
                };

                const parameterGridId = gridMappings[studyType];
                const parameterGrid = document.getElementById(parameterGridId);
                
                if (!parameterGrid) return;
                
                parameterGrid.innerHTML = '';

                const parameterLabels = {
                    sensitivity: 'Expected Sensitivity',
                    specificity: 'Expected Specificity',
                    prevalence: 'Disease Prevalence',
                    sampleSize: 'Sample Size',
                    marginError: 'Margin of Error',
                    confidenceLevel: 'Confidence Level',
                    auc: 'Area Under Curve',
                    test1Performance: 'Test 1 Performance',
                    test2Performance: 'Test 2 Performance',
                    testCorrelation: 'Test Correlation'
                };

                Object.entries(data.parameters || {}).forEach(([param, value]) => {
                    const source = data.sources?.[param] || {};
                    const confidence = source.confidence || 70;
                    
                    const card = document.createElement('div');
                    card.className = 'parameter-card';
                    
                    let displayValue = value;
                    if (['sensitivity', 'specificity', 'prevalence', 'marginError', 'confidenceLevel', 'test1Performance', 'test2Performance'].includes(param)) {
                        displayValue = `${value}%`;
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                    }
                    
                    card.innerHTML = `
                        <div class="parameter-label">${parameterLabels[param] || param}</div>
                        <div class="parameter-value">${displayValue}</div>
                        <div class="parameter-confidence">
                            <span>Confidence: ${confidence}%</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                        <div class="parameter-source">
                            ${source.section || 'Document'} • Page ${source.page || 'N/A'}
                        </div>
                    `;
                    
                    parameterGrid.appendChild(card);
                });
            }
        }

        // Advanced Diagnostic Analysis Engine
        class AdvancedDiagnosticAnalysisEngine {
            constructor() {
                this.diagnosticPatterns = this.initializeDiagnosticPatterns();
            }

            initializeDiagnosticPatterns() {
                return {
                    sensitivity: [
                        /(?:sensitivity|true\s+positive\s+rate)\s*(?:was|of|is|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:sensitivity|true\s+positive)/gi,
                        /sensitivity\s*(?::|=)\s*(\d+\.?\d*)/gi
                    ],
                    specificity: [
                        /(?:specificity|true\s+negative\s+rate)\s*(?:was|of|is|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:specificity|true\s+negative)/gi,
                        /specificity\s*(?::|=)\s*(\d+\.?\d*)/gi
                    ],
                    auc: [
                        /(?:area\s+under\s+(?:the\s+)?(?:roc\s+)?curve|auc)\s*(?:was|of|is|=)?\s*(\d+\.?\d*)/gi,
                        /auc\s*(?::|=)\s*(\d+\.?\d*)/gi,
                        /(?:area\s+under\s+curve)\s*(?::|=)?\s*(\d+\.?\d*)/gi
                    ],
                    prevalence: [
                        /(?:prevalence|disease\s+prevalence)\s*(?:was|of|is|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+prevalence/gi,
                        /prevalence\s*(?::|=)\s*(\d+\.?\d*)/gi
                    ],
                    sampleSize: [
                        /(?:sample\s+size|n\s*=|total\s+(?:participants|subjects|patients))\s*(?:was|of|is)?\s*(\d+)/gi,
                        /(\d+)\s+(?:participants|subjects|patients|individuals|cases)\s+(?:were\s+)?(?:enrolled|recruited|included)/gi
                    ],
                    marginError: [
                        /(?:margin\s+of\s+error|precision)\s*(?:was|of|is|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(?:confidence\s+interval|CI)\s+(?:width|precision)\s*(?:of|=)?\s*(\d+\.?\d*)/gi
                    ],
                    confidenceLevel: [
                        /(\d+)\s*(?:%|percent)\s+confidence/gi,
                        /confidence\s+level\s*(?:of|=)?\s*(\d+)\s*(?:%|percent)/gi,
                        /95%\s+confidence/gi
                    ]
                };
            }

            async analyzePDF(file, studyType) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    const extractedData = {
                        parameters: {},
                        sources: {},
                        confidence: 0,
                        extractionDate: new Date().toISOString(),
                        studyType
                    };
                    
                    const maxPages = Math.min(pdf.numPages, 10);
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        await this.extractDiagnosticParameters(pageText, pageNum, extractedData);
                    }
                    
                    this.calculateConfidence(extractedData);
                    
                    return extractedData;
                    
                } catch (error) {
                    console.error('PDF analysis error:', error);
                    throw new Error('Failed to analyze PDF: ' + error.message);
                }
            }

            async extractDiagnosticParameters(text, pageNum, extractedData) {
                for (const [paramName, patterns] of Object.entries(this.diagnosticPatterns)) {
                    for (const pattern of patterns) {
                        const matches = [...text.matchAll(pattern)];
                        
                        for (const match of matches) {
                            const value = this.extractValue(match, paramName);
                            
                            if (value !== null) {
                                const confidence = this.calculateParameterConfidence(paramName, match[0]);
                                
                                if (!extractedData.parameters[paramName] || 
                                    confidence > (extractedData.sources[paramName]?.confidence || 0)) {
                                    
                                    extractedData.parameters[paramName] = value;
                                    extractedData.sources[paramName] = {
                                        confidence: confidence,
                                        page: pageNum,
                                        context: match[0].substring(0, 100),
                                        section: 'Analysis',
                                        pattern: pattern.toString()
                                    };
                                }
                            }
                        }
                    }
                }
            }

            extractValue(match, paramName) {
                if (!match[1]) return null;
                
                let value = parseFloat(match[1]);
                
                switch (paramName) {
                    case 'sensitivity':
                    case 'specificity':
                    case 'prevalence':
                    case 'marginError':
                        if (value <= 1 && value > 0 && !match[0].includes('%')) {
                            value = value * 100;
                        }
                        if (value > 100 || value < 0) return null;
                        break;
                    case 'auc':
                        if (value > 1) value = value / 100;
                        if (value > 1 || value < 0.5) return null;
                        break;
                    case 'confidenceLevel':
                        if (value <= 1) value = value * 100;
                        if (![90, 95, 99].includes(value)) return null;
                        break;
                    case 'sampleSize':
                        if (value < 10 || value > 100000) return null;
                        break;
                }
                
                return isNaN(value) ? null : value;
            }

            calculateParameterConfidence(paramName, context) {
                let confidence = 60;
                
                const lowerContext = context.toLowerCase();
                
                if (lowerContext.includes('calculated') || lowerContext.includes('estimated')) confidence += 15;
                if (lowerContext.includes('determined')) confidence += 10;
                if (lowerContext.includes('95%') && paramName === 'confidenceLevel') confidence += 20;
                if (lowerContext.includes('auc') && paramName === 'auc') confidence += 15;
                if (lowerContext.includes('diagnostic') || lowerContext.includes('accuracy')) confidence += 10;
                
                return Math.min(confidence, 95);
            }

            calculateConfidence(extractedData) {
                const confidenceValues = Object.values(extractedData.sources).map(s => s.confidence);
                
                if (confidenceValues.length === 0) {
                    extractedData.confidence = 0;
                    return;
                }
                
                extractedData.confidence = Math.round(
                    confidenceValues.reduce((sum, conf) => sum + conf, 0) / confidenceValues.length
                );
            }
        }

        // Initialize the calculator
        const calculator = new KarmastatDiagnosticCalculator();
        
        // Make globally available
        window.calculator = calculator;
        
        console.log('🎯 KARMASTAT Diagnostic Test Accuracy Calculator loaded successfully');
    </script>
</body>
</html>