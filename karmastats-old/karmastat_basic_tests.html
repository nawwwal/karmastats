<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Advanced Basic Statistical Tests Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Enhanced CSS Variables for Academic Research Interface */
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --primary-light: #FF8A5B;
            --secondary: #2D5B87;
            --accent: #F7B267;
            --success: #2E8B57;
            --warning: #DAA520;
            --danger: #DC143C;
            --info: #4682B4;
            
            /* Light theme colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8FAFC;
            --bg-card: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-muted: #718096;
            --border-color: #E2E8F0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            
            /* Enhanced gradients for academic presentation */
            --gradient-primary: linear-gradient(135deg, #FF6B35, #F7B267, #FF8A5B);
            --gradient-secondary: linear-gradient(135deg, #2D5B87, #4682B4, #6495ED);
            --gradient-bg: linear-gradient(135deg, #FFF8F3, #FFF0E6, #FFE4D6);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #F8FAFC);
            --gradient-magic: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-analytical: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-formula: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', 'Menlo', monospace;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #1A202C;
            --bg-secondary: #2D3748;
            --bg-card: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #E2E8F0;
            --text-muted: #A0AEC0;
            --border-color: #4A5568;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1A202C, #2D3748, #4A5568);
            --gradient-card: linear-gradient(145deg, #2D3748, #4A5568);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header Design */
        .header {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            max-width: 800px;
            margin: 0 auto;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Study Type Selection */
        .study-type-selection {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .study-type-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .study-type-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .study-type-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .study-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .study-type-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .study-type-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .study-type-card:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .study-type-card.active {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .study-type-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .study-type-card.active::after {
            content: '✓ Selected';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .study-card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-analytical);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .study-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .study-card-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .study-card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-badge {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        /* Calculator Section */
        .calculator-section {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .calculator-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calculator-section:hover {
            box-shadow: var(--shadow-hover);
        }

        @keyframes slideInFromBottom {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: var(--shadow);
        }

        .section-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Enhanced Formula Display for Academic Reference */
        .formula-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin: 1.5rem 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .formula-toggle {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .formula-toggle:hover {
            background: var(--bg-secondary);
        }

        .formula-toggle-icon {
            margin-right: 1rem;
            transition: transform 0.3s ease;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .formula-toggle.active .formula-toggle-icon {
            transform: rotate(90deg);
        }

        .formula-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .formula-content.active {
            max-height: 1000px;
        }

        .formula-display {
            background: var(--gradient-formula);
            color: white;
            padding: 1.5rem;
            margin: 1.5rem;
            font-family: var(--font-mono);
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .formula-explanation {
            padding: 0 1.5rem 1.5rem;
        }

        .formula-explanation h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .formula-explanation h5 {
            color: var(--secondary);
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .formula-explanation ul {
            list-style-type: none;
            padding: 0;
        }

        .formula-explanation li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .formula-explanation li:last-child {
            border-bottom: none;
        }

        .formula-var {
            font-family: var(--font-mono);
            font-weight: bold;
            color: var(--primary);
            min-width: 80px;
            font-size: 1.1rem;
        }

        .formula-desc {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .formula-note {
            background: rgba(255, 107, 53, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 1.5rem;
            border-radius: 6px;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Enhanced PDF Upload */
        .pdf-upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .pdf-upload-section:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.03);
        }

        .pdf-upload-section.dragover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-magic);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: var(--transition);
        }

        .pdf-upload-section:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        /* Advanced Intelligent Analysis Display */
        .magical-analysis-container {
            display: none;
            margin-top: 2rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        .magical-analysis-header {
            background: var(--gradient-magic);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .magical-analysis-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .magical-analysis-content {
            padding: 2rem;
        }

        .parameter-extraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .parameter-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
        }

        .parameter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .parameter-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .parameter-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .parameter-confidence {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--gradient-magic);
            transition: width 0.5s ease;
        }

        .parameter-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Enhanced Form Styles */
        .form-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .form-section h4 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            transform: translateY(-1px);
        }

        .input-help {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .calculate-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1.25rem 2rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .results-section.show {
            display: block;
        }

        .result-card {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .result-main {
            font-size: 4rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .detail-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: left;
        }

        .detail-card h4 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error styling */
        .error-message {
            background: #FED7D7;
            border: 1px solid #E53E3E;
            color: #C53030;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success-message {
            background: #C6F6D5;
            border: 1px solid #2E8B57;
            color: #2F855A;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 1rem;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
                align-self: center;
            }
            
            .study-type-grid {
                grid-template-columns: 1fr;
            }
            
            .parameter-extraction-grid {
                grid-template-columns: 1fr;
            }
            
            .result-main {
                font-size: 3rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Enhanced Header with Academic Branding -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">K</div>
                    <div>
                        <h1>KARMASTAT</h1>
                        <p class="subtitle">Advanced Basic Statistical Tests Sample Size Calculator with Intelligent Academic Parameter Extraction</p>
                    </div>
                </div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <span id="themeIcon">🌙</span>
                <span id="themeText">Dark Mode</span>
            </div>
        </div>

        <!-- Study Type Selection -->
        <div class="study-type-selection">
            <div class="study-type-header">
                <h2 class="study-type-title">Select Statistical Test Design</h2>
                <p class="study-type-subtitle">Choose the appropriate fundamental statistical test for your research hypothesis and data structure</p>
            </div>
            
            <div class="study-type-grid">
                <div class="study-type-card" id="independentCard" data-study="independent" tabindex="0">
                    <div class="study-card-icon">⚡</div>
                    <h3 class="study-card-title">Independent Samples t-Test</h3>
                    <p class="study-card-description">
                        Compare means between two independent groups with unpaired observations. 
                        Optimal for between-subjects designs examining group differences in continuous variables with assumed normal distribution and equal variances.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Two Independent Groups</span>
                        <span class="feature-badge">Equal Variance Assumption</span>
                        <span class="feature-badge">Cohen's d Effect Size</span>
                        <span class="feature-badge">Pooled Standard Deviation</span>
                    </div>
                </div>

                <div class="study-type-card" id="pairedCard" data-study="paired" tabindex="0">
                    <div class="study-card-icon">🔗</div>
                    <h3 class="study-card-title">Paired Samples t-Test</h3>
                    <p class="study-card-description">
                        Compare means from the same subjects measured at two different time points or conditions. 
                        Optimal for within-subjects designs, before-after studies, and matched-pairs designs examining repeated measurements.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Paired Observations</span>
                        <span class="feature-badge">Difference Scores</span>
                        <span class="feature-badge">Reduced Error Variance</span>
                        <span class="feature-badge">Higher Power</span>
                    </div>
                </div>

                <div class="study-type-card" id="onesampleCard" data-study="onesample" tabindex="0">
                    <div class="study-card-icon">🎯</div>
                    <h3 class="study-card-title">One-Sample t-Test</h3>
                    <p class="study-card-description">
                        Compare sample mean against a known population value or theoretical expectation. 
                        Optimal for testing whether sample data significantly differs from established norms, standards, or hypothetical values.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Single Sample Group</span>
                        <span class="feature-badge">Population Comparison</span>
                        <span class="feature-badge">Hypothesis Testing</span>
                        <span class="feature-badge">Normative Standards</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Independent Samples t-Test Calculator -->
            <div class="calculator-section" id="independentCalculator">
                <div class="section-header">
                    <div class="section-icon">⚡</div>
                    <h3>Independent Samples t-Test Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="independentFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Mathematical Methodology</strong>
                    </div>
                    <div class="formula-content" id="independentFormulaContent">
                        <div class="formula-display">
                            n = 2 × [(Z(α/2) + Z(β))² × σₚ²] / (μ₁ - μ₂)²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Independent Samples t-Test:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required sample size per group (equal allocation)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level (e.g., 1.96 for α=0.05)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power (e.g., 0.84 for 80% power)</span>
                                </li>
                                <li>
                                    <span class="formula-var">σₚ</span>
                                    <span class="formula-desc">Pooled standard deviation assuming equal population variances</span>
                                </li>
                                <li>
                                    <span class="formula-var">μ₁ - μ₂</span>
                                    <span class="formula-desc">Expected difference between group means (effect size)</span>
                                </li>
                            </ul>
                            <h5>Effect Size Relationship:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                Cohen's d = (μ₁ - μ₂) / σₚ
                            </div>
                            <h5>Pooled Standard Deviation:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                σₚ = √[(σ₁² + σ₂²) / 2]
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Cohen (1988) and Rosner (2015) with equal allocation assumption. For unequal group sizes, multiply by [(r+1)²/4r] where r = n₂/n₁.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="independentPdfUploadSection">
                    <input type="file" id="independentPdfInput" class="file-input" accept=".pdf">
                    <label for="independentPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your research paper for automated statistical parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="independentMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="independentProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing research methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="independentParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="independentApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="independentReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="independentForm">
                    <div class="form-section">
                        <h4>📊 Independent Samples t-Test Parameters</h4>
                        
                        <div class="input-group">
                            <label for="group1Mean">Group 1 Expected Mean</label>
                            <input type="number" id="group1Mean" class="input-field" 
                                   step="any" value="10" required>
                            <div class="input-help">Expected mean value for the first group (control or treatment group)</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="group2Mean">Group 2 Expected Mean</label>
                            <input type="number" id="group2Mean" class="input-field" 
                                   step="any" value="12" required>
                            <div class="input-help">Expected mean value for the second group (control or treatment group)</div>
                        </div>

                        <div class="input-group">
                            <label for="pooledSD">Pooled Standard Deviation</label>
                            <input type="number" id="pooledSD" class="input-field" 
                                   min="0.001" step="any" value="3" required>
                            <div class="input-help">Common standard deviation assumed for both groups (√[(σ₁² + σ₂²)/2])</div>
                        </div>

                        <div class="input-group">
                            <label for="allocationRatio">Group Allocation Ratio</label>
                            <select id="allocationRatio" class="input-field" required>
                                <option value="1" selected>1:1 (Equal Groups)</option>
                                <option value="1.5">1:1.5 (Group 2 50% larger)</option>
                                <option value="2">1:2 (Group 2 twice as large)</option>
                                <option value="0.67">1.5:1 (Group 1 50% larger)</option>
                                <option value="0.5">2:1 (Group 1 twice as large)</option>
                            </select>
                            <div class="input-help">Ratio of sample sizes between groups (n₂/n₁)</div>
                        </div>

                        <div class="input-group">
                            <label for="independentSignificanceLevel">Significance Level (α)</label>
                            <select id="independentSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="independentStatisticalPower">Statistical Power (1-β)</label>
                            <select id="independentStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="independentDropoutRate">Expected Dropout Rate (%)</label>
                            <input type="number" id="independentDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of participants lost during study requiring sample size inflation</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Independent t-Test Sample Size
                    </button>
                </form>
            </div>

            <!-- Paired Samples t-Test Calculator -->
            <div class="calculator-section" id="pairedCalculator">
                <div class="section-header">
                    <div class="section-icon">🔗</div>
                    <h3>Paired Samples t-Test Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="pairedFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Mathematical Methodology</strong>
                    </div>
                    <div class="formula-content" id="pairedFormulaContent">
                        <div class="formula-display">
                            n = [(Z(α/2) + Z(β))² × σ²ᵈ] / (μᵈ)²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Paired Samples t-Test:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required number of pairs (subjects measured twice)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                                <li>
                                    <span class="formula-var">σᵈ</span>
                                    <span class="formula-desc">Standard deviation of paired differences (Within-subject variability)</span>
                                </li>
                                <li>
                                    <span class="formula-var">μᵈ</span>
                                    <span class="formula-desc">Expected mean difference between paired measurements</span>
                                </li>
                            </ul>
                            <h5>Effect Size for Paired Differences:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                Cohen's dᵖᵃⁱʳᵉᵈ = μᵈ / σᵈ
                            </div>
                            <h5>Relationship to Independent t-Test:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                σᵈ = σₚ × √[2(1-ρ)]
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Dupont & Plummer (1990) where ρ is the correlation between paired observations. Higher correlations reduce required sample size.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="pairedPdfUploadSection">
                    <input type="file" id="pairedPdfInput" class="file-input" accept=".pdf">
                    <label for="pairedPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your research paper for automated statistical parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="pairedMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="pairedProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing research methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="pairedParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="pairedApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="pairedReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="pairedForm">
                    <div class="form-section">
                        <h4>📊 Paired Samples t-Test Parameters</h4>
                        
                        <div class="input-group">
                            <label for="expectedMeanDifference">Expected Mean Difference</label>
                            <input type="number" id="expectedMeanDifference" class="input-field" 
                                   step="any" value="2" required>
                            <div class="input-help">Expected mean difference between paired measurements (μd = μ_after - μ_before)</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="standardDeviationDifference">Standard Deviation of Differences</label>
                            <input type="number" id="standardDeviationDifference" class="input-field" 
                                   min="0.001" step="any" value="3" required>
                            <div class="input-help">Standard deviation of the paired differences (within-subject variability)</div>
                        </div>

                        <div class="input-group">
                            <label for="correlationCoefficient">Expected Correlation (ρ)</label>
                            <input type="number" id="correlationCoefficient" class="input-field" 
                                   min="-1" max="1" step="0.01" value="0.5">
                            <div class="input-help">Expected correlation between paired measurements (0.5 = moderate correlation)</div>
                        </div>

                        <div class="input-group">
                            <label for="pairedSignificanceLevel">Significance Level (α)</label>
                            <select id="pairedSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="pairedStatisticalPower">Statistical Power (1-β)</label>
                            <select id="pairedStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="pairedDropoutRate">Expected Loss to Follow-up (%)</label>
                            <input type="number" id="pairedDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of participants lost during follow-up period</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Paired t-Test Sample Size
                    </button>
                </form>
            </div>

            <!-- One-Sample t-Test Calculator -->
            <div class="calculator-section" id="onesampleCalculator">
                <div class="section-header">
                    <div class="section-icon">🎯</div>
                    <h3>One-Sample t-Test Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="onesampleFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Mathematical Methodology</strong>
                    </div>
                    <div class="formula-content" id="onesampleFormulaContent">
                        <div class="formula-display">
                            n = [(Z(α/2) + Z(β))² × σ²] / (μ - μ₀)²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for One-Sample t-Test:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">n</span>
                                    <span class="formula-desc">Required sample size for single group</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                                <li>
                                    <span class="formula-var">σ</span>
                                    <span class="formula-desc">Population standard deviation (estimated from pilot data)</span>
                                </li>
                                <li>
                                    <span class="formula-var">μ</span>
                                    <span class="formula-desc">Expected sample mean</span>
                                </li>
                                <li>
                                    <span class="formula-var">μ₀</span>
                                    <span class="formula-desc">Hypothesized population mean (null hypothesis value)</span>
                                </li>
                            </ul>
                            <h5>Effect Size for One-Sample Test:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                Cohen's d = |μ - μ₀| / σ
                            </div>
                            <h5>Hypothesis Structure:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                H₀: μ = μ₀  vs  H₁: μ ≠ μ₀
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula assumes normal distribution. For small samples (n&lt;30), use t-distribution correction. Based on Cohen (1988) power analysis framework.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="onesamplePdfUploadSection">
                    <input type="file" id="onesamplePdfInput" class="file-input" accept=".pdf">
                    <label for="onesamplePdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your research paper for automated statistical parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="onesampleMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="onesampleProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing research methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="onesampleParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="onesampleApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="onesampleReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="onesampleForm">
                    <div class="form-section">
                        <h4>📊 One-Sample t-Test Parameters</h4>
                        
                        <div class="input-group">
                            <label for="expectedSampleMean">Expected Sample Mean (μ)</label>
                            <input type="number" id="expectedSampleMean" class="input-field" 
                                   step="any" value="12" required>
                            <div class="input-help">Expected mean value from your sample</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="hypothesizedMean">Hypothesized Population Mean (μ₀)</label>
                            <input type="number" id="hypothesizedMean" class="input-field" 
                                   step="any" value="10" required>
                            <div class="input-help">Known or hypothesized population mean for comparison (null hypothesis value)</div>
                        </div>

                        <div class="input-group">
                            <label for="populationSD">Population Standard Deviation (σ)</label>
                            <input type="number" id="populationSD" class="input-field" 
                                   min="0.001" step="any" value="3" required>
                            <div class="input-help">Population standard deviation (estimated from pilot studies or literature)</div>
                        </div>

                        <div class="input-group">
                            <label for="onesampleSignificanceLevel">Significance Level (α)</label>
                            <select id="onesampleSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="onesampleStatisticalPower">Statistical Power (1-β)</label>
                            <select id="onesampleStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="onesampleDropoutRate">Expected Dropout Rate (%)</label>
                            <input type="number" id="onesampleDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="5">
                            <div class="input-help">Expected proportion of participants lost during study</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate One-Sample t-Test Sample Size
                    </button>
                </form>
            </div>

            <!-- Enhanced Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        class KarmastatBasicTestsCalculator {
            constructor() {
                this.currentTheme = 'light';
                this.currentStudyType = null;
                this.extractedParams = {};
                this.intelligentAnalysisEngine = new AdvancedStatisticalAnalysisEngine();
                this.calculationResults = {};
                this.init();
            }

            init() {
                console.log('🚀 Initializing KARMASTAT Basic Statistical Tests Calculator...');
                
                try {
                    // Initialize PDF.js worker with enhanced configuration
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                    
                    this.setupEventListeners();
                    this.loadSavedTheme();
                    
                    console.log('✅ KARMASTAT Basic Tests Calculator initialized successfully');
                } catch (error) {
                    console.error('❌ Initialization error:', error);
                    this.showError('Failed to initialize calculator. Please refresh the page.');
                }
            }

            setupEventListeners() {
                // Theme toggle functionality
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
                
                // Study type selection with enhanced validation
                this.setupStudyTypeSelection();
                
                // Formula toggle functionality
                this.setupFormulaToggles();
                
                // PDF upload functionality with advanced processing
                this.setupPdfUploadHandlers();
                
                // Parameter application handlers with validation
                this.setupParameterHandlers();
                
                // Form submission handlers with comprehensive validation
                this.setupFormHandlers();
                
                // Drag and drop functionality with file validation
                this.setupDragAndDrop();
            }

            setupStudyTypeSelection() {
                const studyTypeCards = document.querySelectorAll('.study-type-card');
                studyTypeCards.forEach(card => {
                    const studyType = card.dataset.study;
                    if (studyType) {
                        card.addEventListener('click', () => this.selectStudyType(studyType));
                        card.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                this.selectStudyType(studyType);
                            }
                        });
                    }
                });
            }

            setupFormulaToggles() {
                const formulaToggles = [
                    { id: 'independentFormulaToggle', contentId: 'independentFormulaContent' },
                    { id: 'pairedFormulaToggle', contentId: 'pairedFormulaContent' },
                    { id: 'onesampleFormulaToggle', contentId: 'onesampleFormulaContent' }
                ];
                
                formulaToggles.forEach(({ id, contentId }) => {
                    const toggle = document.getElementById(id);
                    const content = document.getElementById(contentId);
                    
                    if (toggle && content) {
                        toggle.addEventListener('click', () => {
                            toggle.classList.toggle('active');
                            content.classList.toggle('active');
                        });
                    }
                });
            }

            setupPdfUploadHandlers() {
                // Independent PDF upload
                const independentPdfInput = document.getElementById('independentPdfInput');
                if (independentPdfInput) {
                    independentPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'independent'));
                }
                
                // Paired PDF upload
                const pairedPdfInput = document.getElementById('pairedPdfInput');
                if (pairedPdfInput) {
                    pairedPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'paired'));
                }
                
                // One-sample PDF upload
                const onesamplePdfInput = document.getElementById('onesamplePdfInput');
                if (onesamplePdfInput) {
                    onesamplePdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'onesample'));
                }
            }

            setupParameterHandlers() {
                const parameterHandlers = [
                    { applyId: 'independentApplyBtn', reviewId: 'independentReviewBtn', type: 'independent' },
                    { applyId: 'pairedApplyBtn', reviewId: 'pairedReviewBtn', type: 'paired' },
                    { applyId: 'onesampleApplyBtn', reviewId: 'onesampleReviewBtn', type: 'onesample' }
                ];
                
                parameterHandlers.forEach(({ applyId, reviewId, type }) => {
                    const applyBtn = document.getElementById(applyId);
                    const reviewBtn = document.getElementById(reviewId);
                    
                    if (applyBtn) {
                        applyBtn.addEventListener('click', () => this.applyExtractedParameters(type));
                    }
                    if (reviewBtn) {
                        reviewBtn.addEventListener('click', () => this.reviewExtractionDetails(type));
                    }
                });
            }

            setupFormHandlers() {
                // Independent form
                const independentForm = document.getElementById('independentForm');
                if (independentForm) {
                    independentForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'independent'));
                }
                
                // Paired form
                const pairedForm = document.getElementById('pairedForm');
                if (pairedForm) {
                    pairedForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'paired'));
                }
                
                // One-sample form
                const onesampleForm = document.getElementById('onesampleForm');
                if (onesampleForm) {
                    onesampleForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'onesample'));
                }
            }

            setupDragAndDrop() {
                const uploadSections = ['independentPdfUploadSection', 'pairedPdfUploadSection', 'onesamplePdfUploadSection'];
                
                uploadSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (!section) return;
                    
                    section.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        section.classList.add('dragover');
                    });
                    
                    section.addEventListener('dragleave', () => {
                        section.classList.remove('dragover');
                    });
                    
                    section.addEventListener('drop', (e) => {
                        e.preventDefault();
                        section.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type === 'application/pdf') {
                            const studyType = sectionId.includes('independent') ? 'independent' : 
                                            sectionId.includes('paired') ? 'paired' : 'onesample';
                            const inputId = studyType + 'PdfInput';
                            document.getElementById(inputId).files = files;
                            this.handlePdfUpload({ target: { files: files } }, studyType);
                        }
                    });
                });
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.currentTheme);
                
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                
                if (this.currentTheme === 'dark') {
                    themeIcon.textContent = '☀️';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = '🌙';
                    themeText.textContent = 'Dark Mode';
                }
                
                localStorage.setItem('karmastat-theme', this.currentTheme);
            }

            loadSavedTheme() {
                const savedTheme = localStorage.getItem('karmastat-theme');
                if (savedTheme && savedTheme !== this.currentTheme) {
                    this.toggleTheme();
                }
            }

            selectStudyType(studyType) {
                console.log(`Selecting study type: ${studyType}`);
                
                try {
                    // Clear previous results
                    this.clearResults();
                    
                    // Update card selection with enhanced visual feedback
                    document.querySelectorAll('.study-type-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    const cardId = studyType + 'Card';
                    const selectedCard = document.getElementById(cardId);
                    if (selectedCard) {
                        selectedCard.classList.add('active');
                    }
                    
                    // Hide all calculator sections
                    document.querySelectorAll('.calculator-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    // Show selected calculator with enhanced animation
                    const calculatorId = studyType + 'Calculator';
                    const calculator = document.getElementById(calculatorId);
                    if (calculator) {
                        calculator.style.display = 'block';
                        calculator.classList.add('active');
                        this.currentStudyType = studyType;
                        
                        setTimeout(() => {
                            calculator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error selecting study type:', error);
                    this.showError('Error selecting study type. Please try again.');
                }
            }

            async handlePdfUpload(event, studyType) {
                const file = event.target.files[0];
                if (!file) return;

                console.log(`Processing PDF upload for ${studyType} test`);

                const analysisContainerId = studyType + 'MagicalAnalysis';
                const processingIndicatorId = studyType + 'ProcessingIndicator';
                
                const analysisContainer = document.getElementById(analysisContainerId);
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                // Show analysis container with enhanced feedback
                analysisContainer.style.display = 'block';
                processingIndicator.style.display = 'flex';
                processingIndicator.innerHTML = '<div class="spinner"></div><span>Analyzing research methodology...</span>';
                
                try {
                    // Process PDF with advanced intelligent analysis engine
                    const extractedData = await this.intelligentAnalysisEngine.analyzePDF(file, studyType);
                    
                    // Hide processing indicator
                    processingIndicator.style.display = 'none';
                    
                    // Display results with enhanced visualization
                    this.displayExtractionResults(extractedData, studyType);
                    this.extractedParams[studyType] = extractedData;
                    
                    console.log('Advanced PDF analysis completed successfully');
                    
                } catch (error) {
                    console.error('PDF analysis error:', error);
                    processingIndicator.innerHTML = '<span style="color: #E53E3E;">❌ Analysis failed. Please verify PDF quality and try again.</span>';
                }
            }

            displayExtractionResults(data, studyType) {
                const parameterGridId = studyType + 'ParameterGrid';
                const parameterGrid = document.getElementById(parameterGridId);
                
                if (!parameterGrid) return;
                
                parameterGrid.innerHTML = '';

                const parameterLabels = {
                    'independent': {
                        group1Mean: 'Group 1 Mean',
                        group2Mean: 'Group 2 Mean',
                        pooledSD: 'Pooled Standard Deviation',
                        effectSize: 'Effect Size (Cohen\'s d)',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    },
                    'paired': {
                        meanDifference: 'Mean Difference',
                        sdDifference: 'SD of Differences',
                        correlation: 'Correlation Coefficient',
                        effectSize: 'Effect Size (Cohen\'s d)',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    },
                    'onesample': {
                        sampleMean: 'Sample Mean',
                        populationMean: 'Population Mean',
                        standardDeviation: 'Standard Deviation',
                        effectSize: 'Effect Size (Cohen\'s d)',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    }
                };

                const labels = parameterLabels[studyType] || {};

                Object.entries(data.parameters || {}).forEach(([param, value]) => {
                    const source = data.sources?.[param] || {};
                    const confidence = source.confidence || 70;
                    
                    const card = document.createElement('div');
                    card.className = 'parameter-card';
                    
                    let displayValue = value;
                    if (['significanceLevel', 'power'].includes(param)) {
                        displayValue = `${value}%`;
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                    }
                    
                    card.innerHTML = `
                        <div class="parameter-label">${labels[param] || param}</div>
                        <div class="parameter-value">${displayValue}</div>
                        <div class="parameter-confidence">
                            <span>Confidence: ${confidence}%</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                        <div class="parameter-source">
                            ${source.section || 'Document'} • Page ${source.page || 'N/A'}
                        </div>
                    `;
                    
                    parameterGrid.appendChild(card);
                });
            }

            applyExtractedParameters(studyType) {
                const params = this.extractedParams[studyType]?.parameters || {};
                
                if (Object.keys(params).length === 0) {
                    this.showError('No parameters available to apply. Please upload and analyze a PDF first.');
                    return;
                }
                
                // Enhanced parameter mapping with validation
                const fieldMappings = {
                    'independent': {
                        group1Mean: 'group1Mean',
                        group2Mean: 'group2Mean',
                        pooledSD: 'pooledSD',
                        significanceLevel: 'independentSignificanceLevel',
                        power: 'independentStatisticalPower'
                    },
                    'paired': {
                        meanDifference: 'expectedMeanDifference',
                        sdDifference: 'standardDeviationDifference',
                        correlation: 'correlationCoefficient',
                        significanceLevel: 'pairedSignificanceLevel',
                        power: 'pairedStatisticalPower'
                    },
                    'onesample': {
                        sampleMean: 'expectedSampleMean',
                        populationMean: 'hypothesizedMean',
                        standardDeviation: 'populationSD',
                        significanceLevel: 'onesampleSignificanceLevel',
                        power: 'onesampleStatisticalPower'
                    }
                };

                const mappings = fieldMappings[studyType] || {};
                let appliedCount = 0;
                
                Object.entries(params).forEach(([param, value]) => {
                    const fieldId = mappings[param];
                    if (fieldId) {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = value;
                            appliedCount++;
                        }
                    }
                });
                
                // Enhanced success feedback
                const processingIndicatorId = studyType + 'ProcessingIndicator';
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                if (processingIndicator) {
                    processingIndicator.innerHTML = `<span style="color: #2E8B57;">✅ Applied ${appliedCount} parameters successfully</span>`;
                    processingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        processingIndicator.style.display = 'none';
                    }, 3000);
                }
            }

            reviewExtractionDetails(studyType) {
                const data = this.extractedParams[studyType];
                if (!data) {
                    this.showError('No extraction data available. Please upload and analyze a PDF first.');
                    return;
                }
                
                const sources = data.sources || {};
                let detailsText = `Advanced Statistical Parameter Extraction Analysis (${studyType}):\n\n`;
                
                Object.entries(sources).forEach(([param, source]) => {
                    detailsText += `Parameter: ${param}\n`;
                    detailsText += `  Extracted Value: ${data.parameters[param]}\n`;
                    detailsText += `  Confidence Score: ${source.confidence}%\n`;
                    detailsText += `  Source Location: Page ${source.page}, ${source.section} section\n`;
                    detailsText += `  Context: "${source.context}"\n`;
                    detailsText += `  Validation Status: ${source.validated ? 'Validated' : 'Pending'}\n\n`;
                });
                
                alert(detailsText);
            }

            handleFormSubmission(event, studyType) {
                event.preventDefault();
                console.log(`Processing ${studyType} test calculation`);
                
                try {
                    // Collect form data with enhanced validation
                    const formData = this.collectFormData(studyType);
                    
                    // Validate parameters with statistical constraints
                    this.validateParameters(formData, studyType);
                    
                    // Calculate sample size using validated methodologies
                    const results = this.calculateSampleSize(formData, studyType);
                    
                    // Store results for PDF export
                    this.calculationResults = results;
                    
                    // Display results with comprehensive documentation
                    this.displayResults(results, studyType);
                    
                } catch (error) {
                    console.error(`Calculation error for ${studyType}:`, error);
                    this.showError(error.message);
                }
            }

            collectFormData(studyType) {
                if (studyType === 'independent') {
                    return this.collectIndependentData();
                } else if (studyType === 'paired') {
                    return this.collectPairedData();
                } else if (studyType === 'onesample') {
                    return this.collectOnesampleData();
                }
                throw new Error('Invalid study type specified');
            }

            collectIndependentData() {
                const elements = {
                    group1Mean: document.getElementById('group1Mean'),
                    group2Mean: document.getElementById('group2Mean'),
                    pooledSD: document.getElementById('pooledSD'),
                    allocationRatio: document.getElementById('allocationRatio'),
                    significanceLevel: document.getElementById('independentSignificanceLevel'),
                    statisticalPower: document.getElementById('independentStatisticalPower'),
                    dropoutRate: document.getElementById('independentDropoutRate')
                };
                
                // Enhanced validation for element existence and values
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for independent samples analysis`);
                    }
                }
                
                return {
                    group1Mean: parseFloat(elements.group1Mean.value),
                    group2Mean: parseFloat(elements.group2Mean.value),
                    pooledSD: parseFloat(elements.pooledSD.value),
                    allocationRatio: parseFloat(elements.allocationRatio.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            collectPairedData() {
                const elements = {
                    meanDifference: document.getElementById('expectedMeanDifference'),
                    sdDifference: document.getElementById('standardDeviationDifference'),
                    correlation: document.getElementById('correlationCoefficient'),
                    significanceLevel: document.getElementById('pairedSignificanceLevel'),
                    statisticalPower: document.getElementById('pairedStatisticalPower'),
                    dropoutRate: document.getElementById('pairedDropoutRate')
                };
                
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for paired samples analysis`);
                    }
                }
                
                return {
                    meanDifference: parseFloat(elements.meanDifference.value),
                    sdDifference: parseFloat(elements.sdDifference.value),
                    correlation: parseFloat(elements.correlation.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            collectOnesampleData() {
                const elements = {
                    sampleMean: document.getElementById('expectedSampleMean'),
                    populationMean: document.getElementById('hypothesizedMean'),
                    populationSD: document.getElementById('populationSD'),
                    significanceLevel: document.getElementById('onesampleSignificanceLevel'),
                    statisticalPower: document.getElementById('onesampleStatisticalPower'),
                    dropoutRate: document.getElementById('onesampleDropoutRate')
                };
                
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for one-sample analysis`);
                    }
                }
                
                return {
                    sampleMean: parseFloat(elements.sampleMean.value),
                    populationMean: parseFloat(elements.populationMean.value),
                    populationSD: parseFloat(elements.populationSD.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            validateParameters(params, studyType) {
                // Enhanced validation with statistical constraints
                for (const [key, value] of Object.entries(params)) {
                    if (isNaN(value) || !isFinite(value)) {
                        throw new Error(`Invalid numerical value for ${key}: ${value}`);
                    }
                }
                
                // Study-specific enhanced validations
                if (studyType === 'independent') {
                    if (params.pooledSD <= 0) {
                        throw new Error('Pooled standard deviation must be positive');
                    }
                    if (params.allocationRatio <= 0) {
                        throw new Error('Allocation ratio must be positive');
                    }
                } else if (studyType === 'paired') {
                    if (params.sdDifference <= 0) {
                        throw new Error('Standard deviation of differences must be positive');
                    }
                    if (Math.abs(params.correlation) > 1) {
                        throw new Error('Correlation coefficient must be between -1 and 1');
                    }
                } else if (studyType === 'onesample') {
                    if (params.populationSD <= 0) {
                        throw new Error('Population standard deviation must be positive');
                    }
                }
            }

            calculateSampleSize(params, studyType) {
                if (studyType === 'independent') {
                    return this.calculateIndependentSampleSize(params);
                } else if (studyType === 'paired') {
                    return this.calculatePairedSampleSize(params);
                } else if (studyType === 'onesample') {
                    return this.calculateOnesampleSampleSize(params);
                }
                throw new Error('Invalid study type for calculation');
            }

            calculateIndependentSampleSize(params) {
                const { group1Mean, group2Mean, pooledSD, allocationRatio, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Calculate effect size (Cohen's d)
                const meanDifference = Math.abs(group1Mean - group2Mean);
                const cohensD = meanDifference / pooledSD;
                
                // Get critical values using enhanced precision
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate base sample size for equal allocation
                const baseSize = 2 * Math.pow(zAlpha + zBeta, 2) * Math.pow(pooledSD, 2) / Math.pow(meanDifference, 2);
                
                // Adjust for unequal allocation
                const allocationFactor = Math.pow(allocationRatio + 1, 2) / (4 * allocationRatio);
                const adjustedSize = baseSize * allocationFactor;
                
                // Adjust for dropouts
                const finalSize = adjustedSize / (1 - dropoutRate);
                
                const n1 = Math.ceil(finalSize);
                const n2 = Math.ceil(finalSize * allocationRatio);
                
                return {
                    studyType: 'independent',
                    group1Size: n1,
                    group2Size: n2,
                    totalSize: n1 + n2,
                    baseSize: Math.ceil(baseSize),
                    adjustedSize: Math.ceil(finalSize),
                    parameters: {
                        ...params,
                        meanDifference,
                        cohensD,
                        effectSizeInterpretation: this.interpretEffectSize(cohensD)
                    },
                    statistics: {
                        zAlpha,
                        zBeta,
                        allocationFactor
                    }
                };
            }

            calculatePairedSampleSize(params) {
                const { meanDifference, sdDifference, correlation, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Calculate effect size for paired data
                const cohensD = Math.abs(meanDifference) / sdDifference;
                
                // Get critical values
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate base sample size
                const baseSize = Math.pow(zAlpha + zBeta, 2) * Math.pow(sdDifference, 2) / Math.pow(meanDifference, 2);
                
                // Adjust for dropouts
                const finalSize = baseSize / (1 - dropoutRate);
                
                const nPairs = Math.ceil(finalSize);
                
                return {
                    studyType: 'paired',
                    pairsSize: nPairs,
                    totalObservations: nPairs * 2,
                    baseSize: Math.ceil(baseSize),
                    parameters: {
                        ...params,
                        cohensD,
                        effectSizeInterpretation: this.interpretEffectSize(cohensD)
                    },
                    statistics: {
                        zAlpha,
                        zBeta
                    }
                };
            }

            calculateOnesampleSampleSize(params) {
                const { sampleMean, populationMean, populationSD, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Calculate effect size
                const meanDifference = Math.abs(sampleMean - populationMean);
                const cohensD = meanDifference / populationSD;
                
                // Get critical values
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate base sample size
                const baseSize = Math.pow(zAlpha + zBeta, 2) * Math.pow(populationSD, 2) / Math.pow(meanDifference, 2);
                
                // Adjust for dropouts
                const finalSize = baseSize / (1 - dropoutRate);
                
                const nSample = Math.ceil(finalSize);
                
                return {
                    studyType: 'onesample',
                    sampleSize: nSample,
                    baseSize: Math.ceil(baseSize),
                    parameters: {
                        ...params,
                        meanDifference,
                        cohensD,
                        effectSizeInterpretation: this.interpretEffectSize(cohensD)
                    },
                    statistics: {
                        zAlpha,
                        zBeta
                    }
                };
            }

            interpretEffectSize(d) {
                const absD = Math.abs(d);
                if (absD < 0.2) return 'Negligible';
                if (absD < 0.5) return 'Small';
                if (absD < 0.8) return 'Medium';
                return 'Large';
            }

            displayResults(results, studyType) {
                const resultsSection = document.getElementById('resultsSection');
                
                let html = '';
                if (studyType === 'independent') {
                    html = this.generateIndependentResults(results);
                } else if (studyType === 'paired') {
                    html = this.generatePairedResults(results);
                } else if (studyType === 'onesample') {
                    html = this.generateOnesampleResults(results);
                }
                
                resultsSection.innerHTML = html;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            generateIndependentResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>📊 Independent Samples t-Test Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Group 1 Size:</span><span class="detail-value">${results.group1Size.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Group 2 Size:</span><span class="detail-value">${results.group2Size.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Allocation Ratio:</span><span class="detail-value">1:${results.parameters.allocationRatio}</span></li>
                                    <li><span class="detail-label">Expected Mean Difference:</span><span class="detail-value">${results.parameters.meanDifference.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Pooled Standard Deviation:</span><span class="detail-value">${results.parameters.pooledSD.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Effect Size (Cohen's d):</span><span class="detail-value">${results.parameters.cohensD.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Effect Size Interpretation:</span><span class="detail-value">${results.parameters.effectSizeInterpretation}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Significance Level (α):</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize}</span></li>
                                    <li><span class="detail-label">Dropout Adjusted:</span><span class="detail-value">${results.adjustedSize}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Randomization:</span><span class="detail-value">Block Randomization</span></li>
                                    <li><span class="detail-label">Assumption Testing:</span><span class="detail-value">Normality & Equal Variance</span></li>
                                    <li><span class="detail-label">Alternative Analysis:</span><span class="detail-value">Welch's t-test if unequal variances</span></li>
                                    <li><span class="detail-label">Effect Size Reporting:</span><span class="detail-value">Report Cohen's d with 95% CI</span></li>
                                    <li><span class="detail-label">Data Collection:</span><span class="detail-value">Independent groups design</span></li>
                                    <li><span class="detail-label">Quality Control:</span><span class="detail-value">Blinding when feasible</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generatePairedResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.pairsSize.toLocaleString()}</div>
                        <div class="result-label">Required Number of Pairs</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>📊 Paired Samples t-Test Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Number of Pairs:</span><span class="detail-value">${results.pairsSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Total Observations:</span><span class="detail-value">${results.totalObservations.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Expected Mean Difference:</span><span class="detail-value">${results.parameters.meanDifference.toFixed(2)}</span></li>
                                    <li><span class="detail-label">SD of Differences:</span><span class="detail-value">${results.parameters.sdDifference.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Expected Correlation:</span><span class="detail-value">${results.parameters.correlation.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Effect Size (Cohen's d):</span><span class="detail-value">${results.parameters.cohensD.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Effect Size Interpretation:</span><span class="detail-value">${results.parameters.effectSizeInterpretation}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Significance Level (α):</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize}</span></li>
                                    <li><span class="detail-label">Dropout Rate:</span><span class="detail-value">${(results.parameters.dropoutRate * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Study Design:</span><span class="detail-value">Within-subjects/Repeated measures</span></li>
                                    <li><span class="detail-label">Data Collection:</span><span class="detail-value">Consistent measurement timing</span></li>
                                    <li><span class="detail-label">Assumption Testing:</span><span class="detail-value">Normality of differences</span></li>
                                    <li><span class="detail-label">Carry-over Effects:</span><span class="detail-value">Consider washout periods</span></li>
                                    <li><span class="detail-label">Missing Data:</span><span class="detail-value">Complete pairs analysis</span></li>
                                    <li><span class="detail-label">Alternative Analysis:</span><span class="detail-value">Wilcoxon if non-normal</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateOnesampleResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.sampleSize.toLocaleString()}</div>
                        <div class="result-label">Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>📊 One-Sample t-Test Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Sample Size:</span><span class="detail-value">${results.sampleSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Expected Sample Mean:</span><span class="detail-value">${results.parameters.sampleMean.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Hypothesized Mean:</span><span class="detail-value">${results.parameters.populationMean.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Mean Difference:</span><span class="detail-value">${results.parameters.meanDifference.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Population SD:</span><span class="detail-value">${results.parameters.populationSD.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Effect Size (Cohen's d):</span><span class="detail-value">${results.parameters.cohensD.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Effect Size Interpretation:</span><span class="detail-value">${results.parameters.effectSizeInterpretation}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>🧮 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Significance Level (α):</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSize}</span></li>
                                    <li><span class="detail-label">Dropout Rate:</span><span class="detail-value">${(results.parameters.dropoutRate * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Population Reference:</span><span class="detail-value">Well-established norm/standard</span></li>
                                    <li><span class="detail-label">Sampling Method:</span><span class="detail-value">Simple random sampling</span></li>
                                    <li><span class="detail-label">Assumption Testing:</span><span class="detail-value">Normality assessment</span></li>
                                    <li><span class="detail-label">Data Quality:</span><span class="detail-value">Outlier detection</span></li>
                                    <li><span class="detail-label">Alternative Analysis:</span><span class="detail-value">Wilcoxon if non-normal</span></li>
                                    <li><span class="detail-label">Confidence Intervals:</span><span class="detail-value">Report mean difference CI</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const results = this.calculationResults;
                    
                    if (!results) {
                        this.showError('No calculation results available for export.');
                        return;
                    }
                    
                    // Enhanced header with academic formatting
                    doc.setFontSize(24);
                    doc.setTextColor(255, 107, 53);
                    doc.text('KARMASTAT', 105, 25, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    const studyTypeName = results.studyType === 'independent' ? 'Independent Samples t-Test' : 
                                         results.studyType === 'paired' ? 'Paired Samples t-Test' : 
                                         'One-Sample t-Test';
                    doc.text(`${studyTypeName} Sample Size Calculation`, 105, 35, { align: 'center' });
                    
                    // Main result with emphasis
                    doc.setFontSize(28);
                    doc.setTextColor(255, 107, 53);
                    const mainResult = results.studyType === 'independent' ? results.totalSize.toLocaleString() :
                                      results.studyType === 'paired' ? `${results.pairsSize.toLocaleString()} pairs` :
                                      results.sampleSize.toLocaleString();
                    doc.text(`Required: ${mainResult}`, 105, 55, { align: 'center' });
                    
                    // Methodological validation statement
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    const methodNote = 'Calculated using Cohen (1988) methodology with normal distribution assumptions';
                    doc.text(methodNote, 105, 65, { align: 'center' });
                    
                    // Enhanced parameters section
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Statistical Study Parameters:', 20, 80);
                    
                    let y = 90;
                    let parameters = [];
                    
                    if (results.studyType === 'independent') {
                        parameters = [
                            `Group 1 Size: ${results.group1Size.toLocaleString()}`,
                            `Group 2 Size: ${results.group2Size.toLocaleString()}`,
                            `Total Sample Size: ${results.totalSize.toLocaleString()}`,
                            `Expected Mean Difference: ${results.parameters.meanDifference.toFixed(2)}`,
                            `Pooled Standard Deviation: ${results.parameters.pooledSD.toFixed(2)}`,
                            `Effect Size (Cohen's d): ${results.parameters.cohensD.toFixed(3)}`,
                            `Effect Size Interpretation: ${results.parameters.effectSizeInterpretation}`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Allocation Ratio: 1:${results.parameters.allocationRatio}`
                        ];
                    } else if (results.studyType === 'paired') {
                        parameters = [
                            `Number of Pairs: ${results.pairsSize.toLocaleString()}`,
                            `Total Observations: ${results.totalObservations.toLocaleString()}`,
                            `Expected Mean Difference: ${results.parameters.meanDifference.toFixed(2)}`,
                            `SD of Differences: ${results.parameters.sdDifference.toFixed(2)}`,
                            `Expected Correlation: ${results.parameters.correlation.toFixed(2)}`,
                            `Effect Size (Cohen's d): ${results.parameters.cohensD.toFixed(3)}`,
                            `Effect Size Interpretation: ${results.parameters.effectSizeInterpretation}`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Dropout Rate: ${(results.parameters.dropoutRate * 100)}%`
                        ];
                    } else {
                        parameters = [
                            `Sample Size: ${results.sampleSize.toLocaleString()}`,
                            `Expected Sample Mean: ${results.parameters.sampleMean.toFixed(2)}`,
                            `Hypothesized Mean: ${results.parameters.populationMean.toFixed(2)}`,
                            `Mean Difference: ${results.parameters.meanDifference.toFixed(2)}`,
                            `Population SD: ${results.parameters.populationSD.toFixed(2)}`,
                            `Effect Size (Cohen's d): ${results.parameters.cohensD.toFixed(3)}`,
                            `Effect Size Interpretation: ${results.parameters.effectSizeInterpretation}`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Dropout Rate: ${(results.parameters.dropoutRate * 100)}%`
                        ];
                    }
                    
                    parameters.forEach(param => {
                        if (y > 250) {
                            doc.addPage();
                            y = 25;
                        }
                        doc.text(`• ${param}`, 25, y);
                        y += 8;
                    });
                    
                    // Enhanced footer with academic citation
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Generated by KARMASTAT - Advanced Statistical Tests Calculator', 105, 270, { align: 'center' });
                    doc.text(`${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString()}`, 105, 280, { align: 'center' });
                    
                    doc.save(`KARMASTAT-${studyTypeName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
                    
                } catch (error) {
                    console.error('PDF export error:', error);
                    this.showError('Error exporting PDF. Please try again.');
                }
            }

            newCalculation() {
                // Reset forms with enhanced cleanup
                const forms = ['independentForm', 'pairedForm', 'onesampleForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) form.reset();
                });
                
                // Reset default values with academic standards
                const defaultValues = {
                    'group1Mean': '10',
                    'group2Mean': '12',
                    'pooledSD': '3',
                    'expectedMeanDifference': '2',
                    'standardDeviationDifference': '3',
                    'correlationCoefficient': '0.5',
                    'expectedSampleMean': '12',
                    'hypothesizedMean': '10',
                    'populationSD': '3',
                    'independentDropoutRate': '10',
                    'pairedDropoutRate': '10',
                    'onesampleDropoutRate': '5'
                };
                
                Object.entries(defaultValues).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });
                
                // Clear results and selections with enhanced cleanup
                this.clearResults();
                
                // Reset study type selection
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Hide analysis containers with complete cleanup
                ['independentMagicalAnalysis', 'pairedMagicalAnalysis', 'onesampleMagicalAnalysis'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.style.display = 'none';
                });
                
                // Reset internal state
                this.currentStudyType = null;
                this.extractedParams = {};
                this.calculationResults = {};
                
                // Smooth scroll to top for enhanced user experience
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            clearResults() {
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.classList.remove('show');
                    resultsSection.innerHTML = '';
                }
            }

            showError(message) {
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.innerHTML = `
                    <div class="result-card" style="border: 2px solid #DC143C;">
                        <div style="text-align: center; color: #DC143C;">
                            <h3>⚠️ Calculation Error</h3>
                            <div class="error-message">${message}</div>
                            <button class="btn-primary" onclick="calculator.newCalculation()" style="margin-top: 1rem;">
                                <span>🔄</span>Start New Calculation
                            </button>
                        </div>
                    </div>
                `;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            getZScore(confidence) {
                const zScores = {
                    50: 0.000, 55: 0.126, 60: 0.253, 65: 0.385, 70: 0.524,
                    75: 0.674, 80: 0.842, 85: 1.036, 90: 1.282, 91: 1.341,
                    92: 1.405, 93: 1.476, 94: 1.555, 95: 1.645, 96: 1.751,
                    97: 1.881, 97.5: 1.960, 98: 2.054, 99: 2.326, 99.5: 2.576,
                    99.9: 3.090, 99.95: 3.291, 99.99: 3.719
                };
                return zScores[confidence] || zScores[95];
            }
        }

        // Advanced Statistical Analysis Engine with Enhanced Intelligence
        class AdvancedStatisticalAnalysisEngine {
            constructor() {
                this.enhancedPatterns = this.initializeAdvancedPatterns();
                this.contextValidators = this.initializeContextValidators();
                this.academicFilters = this.initializeAcademicFilters();
            }

            initializeAdvancedPatterns() {
                return {
                    // Enhanced statistical patterns with academic precision
                    sampleSize: [
                        /(?:sample\s+size|n\s*=|total\s+(?:participants|subjects|patients))\s*(?:was|of|is)?\s*(\d+)/gi,
                        /(\d+)\s+(?:participants|subjects|patients|individuals)\s+(?:were\s+)?(?:enrolled|recruited|included)/gi,
                        /(?:study\s+included|enrolled|recruited)\s+(?:a\s+total\s+of\s+)?(\d+)\s+(?:participants|subjects|patients)/gi
                    ],
                    
                    meanValues: [
                        /(?:mean|average|μ)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /(?:group|treatment|control)\s+(?:\d+\s+)?(?:mean|average)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /(?:baseline|pre|post)\s+(?:mean|average)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi
                    ],
                    
                    standardDeviation: [
                        /(?:standard\s+deviation|SD|σ)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /(?:pooled\s+)?(?:standard\s+deviation|SD)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /SD\s*[=:]\s*(\d+\.?\d*)/gi
                    ],
                    
                    effectSize: [
                        /(?:effect\s+size|cohen'?s\s+d|cohen\s+d)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /d\s*[=:]\s*(\d+\.?\d*)/gi,
                        /(?:standardized\s+)?(?:effect\s+size)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi
                    ],
                    
                    correlation: [
                        /(?:correlation|r)\s*(?:was|is|of|=)?\s*(\d*\.?\d*)/gi,
                        /r\s*[=:]\s*(\d*\.?\d*)/gi,
                        /(?:pearson|spearman)\s+correlation\s*(?:was|is|of|=)?\s*(\d*\.?\d*)/gi
                    ],
                    
                    significanceLevel: [
                        /(?:significance\s+level|alpha|α)\s*(?:was|of|set\s+at|=)?\s*(?:0?\.)?(\d+)\s*(?:%|percent)?/gi,
                        /α\s*[=]\s*0?\.(\d+)/gi,
                        /p\s*[<]\s*0?\.(\d+)\s+(?:was\s+considered\s+)?(?:significant|statistically)/gi
                    ],
                    
                    power: [
                        /(?:statistical\s+)?power\s*(?:was|of|set\s+at|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:statistical\s+)?power/gi,
                        /power\s+analysis\s+(?:showed|indicated|revealed)?\s*(?:a\s+)?(?:power\s+of\s+)?(\d+\.?\d*)\s*(?:%|percent)/gi
                    ]
                };
            }

            initializeContextValidators() {
                return {
                    excludePatterns: [
                        /(?:table|figure|fig\.?)\s+\d+/gi,
                        /(?:reference|ref\.?|citation)\s*\[?\d+\]?/gi,
                        /page\s+\d+/gi,
                        /p\.?\s*\d+/gi,
                        /\[\d+(?:\s*,\s*\d+)*\]/gi,
                        /\(\d+(?:\s*,\s*\d+)*\)/gi,
                        /age\s+\d+/gi,
                        /years?\s+old/gi,
                        /\d+\s*(?:cm|mm|kg|mg|ml|g|years?|days?|months?|weeks?)/gi
                    ],
                    
                    validContexts: [
                        /(?:method|design|analysis|result|finding|outcome|parameter)/gi,
                        /(?:study|research|investigation|trial|experiment)/gi,
                        /(?:statistical|statistical analysis|t.?test|test)/gi,
                        /(?:sample|population|participant|subject|patient)/gi
                    ]
                };
            }

            initializeAcademicFilters() {
                return {
                    confidenceThresholds: {
                        sampleSize: 60,
                        meanValues: 65,
                        standardDeviation: 70,
                        effectSize: 75,
                        correlation: 70,
                        significanceLevel: 75,
                        power: 75
                    },
                    
                    plausibilityRanges: {
                        sampleSize: { min: 5, max: 50000 },
                        effectSize: { min: 0.01, max: 5.0 },
                        correlation: { min: -1, max: 1 },
                        significanceLevel: { min: 0.1, max: 50 },
                        power: { min: 50, max: 99.9 }
                    }
                };
            }

            async analyzePDF(file, studyType) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    const extractedData = {
                        parameters: {},
                        sources: {},
                        confidence: 0,
                        extractionDate: new Date().toISOString(),
                        studyType,
                        processingStats: {
                            pagesProcessed: 0,
                            patternsMatched: 0,
                            validationsPerformed: 0
                        }
                    };
                    
                    const maxPages = Math.min(pdf.numPages, 15);
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        const sectionType = this.classifyAcademicSection(pageText);
                        
                        await this.extractParametersWithValidation(pageText, pageNum, sectionType, extractedData, studyType);
                        
                        extractedData.processingStats.pagesProcessed++;
                    }
                    
                    this.performAdvancedValidation(extractedData, studyType);
                    this.calculateAdvancedConfidence(extractedData);
                    
                    return extractedData;
                    
                } catch (error) {
                    console.error('Advanced PDF analysis error:', error);
                    throw new Error('Failed to perform advanced PDF analysis: ' + error.message);
                }
            }

            classifyAcademicSection(text) {
                const lowerText = text.toLowerCase();
                
                const sectionIndicators = {
                    'Methods': [
                        /(?:method|methodology|design|statistical\s+analysis)/gi,
                        /(?:study\s+design|research\s+design|analytical\s+approach)/gi,
                        /(?:sample\s+size|power\s+calculation|statistical\s+power)/gi
                    ],
                    'Results': [
                        /(?:result|finding|outcome|data\s+analysis)/gi,
                        /(?:statistical\s+result|test\s+result)/gi,
                        /(?:t.?test|statistical\s+test|hypothesis\s+test)/gi
                    ],
                    'Abstract': [
                        /(?:abstract|summary|background|objective|conclusion)/gi,
                        /(?:study\s+objective|research\s+aim|purpose)/gi
                    ]
                };
                
                let bestSection = 'Other';
                let highestScore = 0;
                
                Object.entries(sectionIndicators).forEach(([section, patterns]) => {
                    let sectionScore = 0;
                    patterns.forEach(pattern => {
                        const matches = lowerText.match(pattern);
                        if (matches) {
                            sectionScore += matches.length;
                        }
                    });
                    
                    if (sectionScore > highestScore) {
                        highestScore = sectionScore;
                        bestSection = section;
                    }
                });
                
                return bestSection;
            }

            async extractParametersWithValidation(text, pageNum, sectionType, extractedData, studyType) {
                const relevantPatterns = this.getStudySpecificPatterns(studyType);
                
                for (const [paramName, patterns] of Object.entries(relevantPatterns)) {
                    for (const pattern of patterns) {
                        const matches = [...text.matchAll(pattern)];
                        
                        for (const match of matches) {
                            if (!this.validateContext(match[0], text)) {
                                continue;
                            }
                            
                            const value = this.extractAndValidateValue(match, paramName);
                            
                            if (value !== null && this.validateAcademicPlausibility(paramName, value)) {
                                const confidence = this.calculateContextualConfidence(
                                    paramName, 
                                    sectionType, 
                                    match[0], 
                                    studyType,
                                    text
                                );
                                
                                if (!extractedData.parameters[paramName] || 
                                    confidence > (extractedData.sources[paramName]?.confidence || 0)) {
                                    
                                    extractedData.parameters[paramName] = value;
                                    extractedData.sources[paramName] = {
                                        confidence: confidence,
                                        page: pageNum,
                                        context: match[0].substring(0, 150),
                                        section: sectionType,
                                        pattern: pattern.toString(),
                                        fullMatch: match[0],
                                        validated: true
                                    };
                                    
                                    extractedData.processingStats.patternsMatched++;
                                }
                            }
                            
                            extractedData.processingStats.validationsPerformed++;
                        }
                    }
                }
            }

            validateContext(match, fullText) {
                const matchLower = match.toLowerCase();
                
                for (const excludePattern of this.contextValidators.excludePatterns) {
                    if (excludePattern.test(match)) {
                        return false;
                    }
                }
                
                let validContextFound = false;
                for (const validPattern of this.contextValidators.validContexts) {
                    if (validPattern.test(fullText)) {
                        validContextFound = true;
                        break;
                    }
                }
                
                return validContextFound;
            }

            getStudySpecificPatterns(studyType) {
                const commonPatterns = {
                    sampleSize: this.enhancedPatterns.sampleSize,
                    significanceLevel: this.enhancedPatterns.significanceLevel,
                    power: this.enhancedPatterns.power
                };

                if (studyType === 'independent') {
                    return {
                        ...commonPatterns,
                        meanValues: this.enhancedPatterns.meanValues,
                        standardDeviation: this.enhancedPatterns.standardDeviation,
                        effectSize: this.enhancedPatterns.effectSize
                    };
                } else if (studyType === 'paired') {
                    return {
                        ...commonPatterns,
                        meanValues: this.enhancedPatterns.meanValues,
                        standardDeviation: this.enhancedPatterns.standardDeviation,
                        correlation: this.enhancedPatterns.correlation,
                        effectSize: this.enhancedPatterns.effectSize
                    };
                } else if (studyType === 'onesample') {
                    return {
                        ...commonPatterns,
                        meanValues: this.enhancedPatterns.meanValues,
                        standardDeviation: this.enhancedPatterns.standardDeviation,
                        effectSize: this.enhancedPatterns.effectSize
                    };
                }
                
                return commonPatterns;
            }

            extractAndValidateValue(match, paramName) {
                if (!match[1]) return null;
                
                let value = parseFloat(match[1]);
                
                switch (paramName) {
                    case 'significanceLevel':
                        if (match[0].toLowerCase().includes('α') && value < 1) {
                            value = value * 100;
                        }
                        if (![1, 5, 10].includes(value) && ![0.01, 0.05, 0.1].includes(value)) {
                            if (value > 0.5 && value < 1) {
                                value = value * 100;
                            }
                        }
                        break;
                        
                    case 'power':
                        if (value <= 1 && value > 0) {
                            value = value * 100;
                        }
                        if (value < 50 || value > 99) {
                            return null;
                        }
                        break;
                        
                    case 'correlation':
                        if (Math.abs(value) > 1) {
                            return null;
                        }
                        break;
                        
                    case 'effectSize':
                        if (value < 0.01 || value > 5) {
                            return null;
                        }
                        break;
                        
                    case 'sampleSize':
                        if (value < 5 || value > 50000) {
                            return null;
                        }
                        break;
                }
                
                return isNaN(value) ? null : value;
            }

            validateAcademicPlausibility(paramName, value) {
                const ranges = this.academicFilters.plausibilityRanges[paramName];
                if (!ranges) return true;
                
                return value >= ranges.min && value <= ranges.max;
            }

            calculateContextualConfidence(paramName, sectionType, context, studyType, fullText) {
                let confidence = 50;
                
                const sectionWeights = {
                    'Methods': 35,
                    'Results': 30,
                    'Abstract': 25,
                    'Other': 0
                };
                
                confidence += sectionWeights[sectionType] || 0;
                
                const lowerContext = context.toLowerCase();
                const lowerFullText = fullText.toLowerCase();
                
                if (lowerContext.includes('calculated') || lowerContext.includes('computed')) confidence += 12;
                if (lowerContext.includes('determined') || lowerContext.includes('estimated')) confidence += 10;
                if (lowerContext.includes('statistical test') || lowerContext.includes('t-test')) confidence += 15;
                
                if (lowerFullText.includes('t-test') || lowerFullText.includes('statistical test')) confidence += 10;
                
                return Math.min(confidence, 98);
            }

            performAdvancedValidation(extractedData, studyType) {
                console.log('Performing advanced statistical validation...');
                this.filterLowConfidenceParameters(extractedData);
            }

            filterLowConfidenceParameters(extractedData) {
                Object.keys(extractedData.parameters).forEach(param => {
                    const threshold = this.academicFilters.confidenceThresholds[param] || 50;
                    if (extractedData.sources[param]?.confidence < threshold) {
                        console.log(`Removing ${param} due to low confidence: ${extractedData.sources[param]?.confidence}%`);
                        delete extractedData.parameters[param];
                        delete extractedData.sources[param];
                    }
                });
            }

            calculateAdvancedConfidence(extractedData) {
                const confidenceValues = Object.values(extractedData.sources).map(s => s.confidence);
                
                if (confidenceValues.length === 0) {
                    extractedData.confidence = 0;
                    return;
                }
                
                const weightedSum = confidenceValues.reduce((sum, conf) => sum + conf, 0);
                extractedData.confidence = Math.round(weightedSum / confidenceValues.length);
                
                if (extractedData.parameters.sampleSize && extractedData.parameters.power) {
                    extractedData.confidence += 5;
                }
                
                extractedData.confidence = Math.min(extractedData.confidence, 95);
            }
        }

        // Initialize the advanced calculator
        const calculator = new KarmastatBasicTestsCalculator();
        
        // Make globally available for PDF export and other functions
        window.calculator = calculator;
        
        console.log('🎯 KARMASTAT Basic Statistical Tests Calculator loaded successfully');
    </script>
</body>
</html>