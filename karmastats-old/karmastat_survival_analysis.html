<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARMASTAT - Advanced Survival Analysis Sample Size Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Enhanced CSS Variables for Academic Research Interface */
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #059669;
            --accent: #F59E0B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            
            /* Light theme colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8FAFC;
            --bg-card: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            
            /* Enhanced gradients for academic presentation */
            --gradient-primary: linear-gradient(135deg, #8B5CF6, #A78BFA, #C4B5FD);
            --gradient-secondary: linear-gradient(135deg, #059669, #10B981, #34D399);
            --gradient-bg: linear-gradient(135deg, #FEFBFF, #F3F4F6, #EDE9FE);
            --gradient-card: linear-gradient(145deg, #FFFFFF, #F8FAFC);
            --gradient-magic: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-analytical: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-formula: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'Courier New', 'Monaco', 'Menlo', monospace;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #1F2937;
            --bg-secondary: #374151;
            --bg-card: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --border-color: #4B5563;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.4);
            --gradient-bg: linear-gradient(135deg, #1F2937, #374151, #4B5563);
            --gradient-card: linear-gradient(145deg, #374151, #4B5563);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            min-height: 100vh;
            background: var(--gradient-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header Design */
        .header {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: white;
            font-weight: 800;
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(20px);
            opacity: 0.3;
            z-index: -1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 500;
            max-width: 800px;
            margin: 0 auto;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Study Type Selection */
        .study-type-selection {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .study-type-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .study-type-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .study-type-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .study-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .study-type-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .study-type-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary);
        }

        .study-type-card:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .study-type-card.active {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .study-type-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .study-type-card.active::after {
            content: '✓ Selected';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .study-card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-analytical);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1.5rem;
        }

        .study-card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .study-card-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .study-card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-badge {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        /* Calculator Section */
        .calculator-section {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }

        .calculator-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calculator-section:hover {
            box-shadow: var(--shadow-hover);
        }

        @keyframes slideInFromBottom {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            box-shadow: var(--shadow);
        }

        .section-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Enhanced Formula Display for Academic Reference */
        .formula-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin: 1.5rem 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .formula-toggle {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            font-weight: 600;
            color: var(--text-primary);
        }

        .formula-toggle:hover {
            background: var(--bg-secondary);
        }

        .formula-toggle-icon {
            margin-right: 1rem;
            transition: transform 0.3s ease;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .formula-toggle.active .formula-toggle-icon {
            transform: rotate(90deg);
        }

        .formula-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .formula-content.active {
            max-height: 1200px;
        }

        .formula-display {
            background: var(--gradient-formula);
            color: white;
            padding: 1.5rem;
            margin: 1.5rem;
            font-family: var(--font-mono);
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .formula-explanation {
            padding: 0 1.5rem 1.5rem;
        }

        .formula-explanation h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .formula-explanation h5 {
            color: var(--secondary);
            margin-bottom: 0.75rem;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .formula-explanation ul {
            list-style-type: none;
            padding: 0;
        }

        .formula-explanation li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .formula-explanation li:last-child {
            border-bottom: none;
        }

        .formula-var {
            font-family: var(--font-mono);
            font-weight: bold;
            color: var(--primary);
            min-width: 80px;
            font-size: 1.1rem;
        }

        .formula-desc {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .formula-note {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 1.5rem;
            border-radius: 6px;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Enhanced PDF Upload */
        .pdf-upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            margin-bottom: 2rem;
            cursor: pointer;
        }

        .pdf-upload-section:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.03);
        }

        .pdf-upload-section.dragover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-magic);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            transition: var(--transition);
        }

        .pdf-upload-section:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        /* Advanced Intelligent Analysis Display */
        .magical-analysis-container {
            display: none;
            margin-top: 2rem;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        .magical-analysis-header {
            background: var(--gradient-magic);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .magical-analysis-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .magical-analysis-content {
            padding: 2rem;
        }

        .parameter-extraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .parameter-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
        }

        .parameter-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .parameter-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .parameter-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .parameter-confidence {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--gradient-magic);
            transition: width 0.5s ease;
        }

        .parameter-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.5rem;
        }

        /* Enhanced Form Styles */
        .form-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .form-section h4 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            transform: translateY(-1px);
        }

        .input-help {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .calculate-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1.25rem 2rem;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .results-section.show {
            display: block;
        }

        .result-card {
            background: var(--gradient-card);
            border-radius: var(--radius);
            padding: 3rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .result-main {
            font-size: 4rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .result-label {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .detail-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: left;
        }

        .detail-card h4 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error styling */
        .error-message {
            background: #FEE2E2;
            border: 1px solid #EF4444;
            color: #DC2626;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .success-message {
            background: #D1FAE5;
            border: 1px solid #10B981;
            color: #065F46;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .logo {
                flex-direction: column;
                gap: 1rem;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
                align-self: center;
            }
            
            .study-type-grid {
                grid-template-columns: 1fr;
            }
            
            .parameter-extraction-grid {
                grid-template-columns: 1fr;
            }
            
            .result-main {
                font-size: 3rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Enhanced Header with Academic Branding -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">K</div>
                    <div>
                        <h1>KARMASTAT</h1>
                        <p class="subtitle">Advanced Survival Analysis Sample Size Calculator with Intelligent Academic Parameter Extraction</p>
                    </div>
                </div>
            </div>
            <div class="theme-toggle" id="themeToggle">
                <span id="themeIcon">🌙</span>
                <span id="themeText">Dark Mode</span>
            </div>
        </div>

        <!-- Study Type Selection -->
        <div class="study-type-selection">
            <div class="study-type-header">
                <h2 class="study-type-title">Select Survival Analysis Design</h2>
                <p class="study-type-subtitle">Choose the appropriate survival analysis methodology for your time-to-event research objectives</p>
            </div>
            
            <div class="study-type-grid">
                <div class="study-type-card" id="logrankCard" data-study="logrank" tabindex="0">
                    <div class="study-card-icon">⚰️</div>
                    <h3 class="study-card-title">Log-Rank Test (Two Groups)</h3>
                    <p class="study-card-description">
                        Compare survival distributions between two independent groups using the non-parametric log-rank test. 
                        Optimal for clinical trials comparing treatment efficacy with time-to-event endpoints such as overall survival, progression-free survival, or time to recurrence.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Hazard Ratio Estimation</span>
                        <span class="feature-badge">Censoring Handling</span>
                        <span class="feature-badge">Kaplan-Meier Curves</span>
                        <span class="feature-badge">Event-Driven Design</span>
                    </div>
                </div>

                <div class="study-type-card" id="coxregressionCard" data-study="coxregression" tabindex="0">
                    <div class="study-card-icon">📈</div>
                    <h3 class="study-card-title">Cox Proportional Hazards Model</h3>
                    <p class="study-card-description">
                        Semi-parametric regression analysis for survival data with covariate adjustment capabilities. 
                        Optimal for multivariable survival analysis controlling for confounding factors and estimating adjusted hazard ratios with time-to-event outcomes.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Covariate Adjustment</span>
                        <span class="feature-badge">Partial Likelihood</span>
                        <span class="feature-badge">Proportional Hazards</span>
                        <span class="feature-badge">Multiple Factors</span>
                    </div>
                </div>

                <div class="study-type-card" id="onearmCard" data-study="onearm" tabindex="0">
                    <div class="study-card-icon">🎯</div>
                    <h3 class="study-card-title">One-Arm Survival Study</h3>
                    <p class="study-card-description">
                        Single-arm survival analysis comparing observed survival against historical controls or established benchmarks. 
                        Optimal for phase II trials, rare disease studies, and exploratory research where concurrent controls are not feasible or ethical.
                    </p>
                    <div class="study-card-features">
                        <span class="feature-badge">Historical Controls</span>
                        <span class="feature-badge">Single Group Design</span>
                        <span class="feature-badge">Median Survival</span>
                        <span class="feature-badge">Phase II Trials</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Log-Rank Test Calculator -->
            <div class="calculator-section" id="logrankCalculator">
                <div class="section-header">
                    <div class="section-icon">⚰️</div>
                    <h3>Log-Rank Test Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="logrankFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Survival Analysis Methodology</strong>
                    </div>
                    <div class="formula-content" id="logrankFormulaContent">
                        <div class="formula-display">
                            D = [(Z(α/2) + Z(β))² × (1 + 1/k)] / [ln(HR)]²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Log-Rank Test:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">D</span>
                                    <span class="formula-desc">Total number of events required across both groups</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level (e.g., 1.96 for α=0.05)</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power (e.g., 0.84 for 80% power)</span>
                                </li>
                                <li>
                                    <span class="formula-var">k</span>
                                    <span class="formula-desc">Allocation ratio between groups (n₂/n₁)</span>
                                </li>
                                <li>
                                    <span class="formula-var">HR</span>
                                    <span class="formula-desc">Hazard ratio (λ₂/λ₁) - ratio of instantaneous risk between groups</span>
                                </li>
                            </ul>
                            <h5>Sample Size Calculation:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                N = D / [p₁×π₁ + p₂×π₂]
                            </div>
                            <h5>Where Event Probabilities:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                π₁ = 1 - exp(-λ₁×T*)   |   π₂ = 1 - exp(-λ₂×T*)
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula based on Schoenfeld (1981) for log-rank test with exponential survival distributions. T* represents study duration including accrual and follow-up periods.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="logrankPdfUploadSection">
                    <input type="file" id="logrankPdfInput" class="file-input" accept=".pdf">
                    <label for="logrankPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your survival analysis research paper for automated parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="logrankMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="logrankProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing survival methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="logrankParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="logrankApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="logrankReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="logrankForm">
                    <div class="form-section">
                        <h4>⚰️ Log-Rank Test Parameters</h4>
                        
                        <div class="input-group">
                            <label for="medianSurvival1">Group 1 Median Survival (months)</label>
                            <input type="number" id="medianSurvival1" class="input-field" 
                                   min="0.1" step="0.1" value="12" required>
                            <div class="input-help">Expected median survival time for control/reference group</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="medianSurvival2">Group 2 Median Survival (months)</label>
                            <input type="number" id="medianSurvival2" class="input-field" 
                                   min="0.1" step="0.1" value="18" required>
                            <div class="input-help">Expected median survival time for treatment/experimental group</div>
                        </div>

                        <div class="input-group">
                            <label for="hazardRatio">Expected Hazard Ratio (HR)</label>
                            <input type="number" id="hazardRatio" class="input-field" 
                                   min="0.1" step="0.01" value="0.67" required>
                            <div class="input-help">Hazard ratio (Group 2 vs Group 1). HR < 1 favors Group 2, HR > 1 favors Group 1</div>
                        </div>

                        <div class="input-group">
                            <label for="accrualPeriod">Accrual Period (months)</label>
                            <input type="number" id="accrualPeriod" class="input-field" 
                                   min="1" step="1" value="24" required>
                            <div class="input-help">Duration of patient recruitment phase</div>
                        </div>

                        <div class="input-group">
                            <label for="followupPeriod">Additional Follow-up Period (months)</label>
                            <input type="number" id="followupPeriod" class="input-field" 
                                   min="0" step="1" value="12" required>
                            <div class="input-help">Additional follow-up time after completion of accrual</div>
                        </div>

                        <div class="input-group">
                            <label for="allocationRatio">Allocation Ratio (Group 2:Group 1)</label>
                            <select id="allocationRatio" class="input-field" required>
                                <option value="1" selected>1:1 (Equal Groups)</option>
                                <option value="1.5">1.5:1 (50% more in Group 2)</option>
                                <option value="2">2:1 (Twice as many in Group 2)</option>
                                <option value="0.67">1:1.5 (50% more in Group 1)</option>
                                <option value="0.5">1:2 (Twice as many in Group 1)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="logrankSignificanceLevel">Significance Level (α)</label>
                            <select id="logrankSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="logrankStatisticalPower">Statistical Power (1-β)</label>
                            <select id="logrankStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="logrankDropoutRate">Expected Loss to Follow-up (%)</label>
                            <input type="number" id="logrankDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of participants lost during study period</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Log-Rank Test Sample Size
                    </button>
                </form>
            </div>

            <!-- Cox Regression Calculator -->
            <div class="calculator-section" id="coxregressionCalculator">
                <div class="section-header">
                    <div class="section-icon">📈</div>
                    <h3>Cox Proportional Hazards Model Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="coxregressionFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Cox Regression Methodology</strong>
                    </div>
                    <div class="formula-content" id="coxregressionFormulaContent">
                        <div class="formula-display">
                            D = [(Z(α/2) + Z(β))² × (1 + VIF)] / [ln(HR)]²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for Cox Proportional Hazards Model:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">D</span>
                                    <span class="formula-desc">Total number of events required for adequate power</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                                <li>
                                    <span class="formula-var">VIF</span>
                                    <span class="formula-desc">Variance Inflation Factor for additional covariates</span>
                                </li>
                                <li>
                                    <span class="formula-var">HR</span>
                                    <span class="formula-desc">Hazard ratio for primary covariate of interest</span>
                                </li>
                            </ul>
                            <h5>Variance Inflation Factor:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                VIF = 1 / (1 - R²)
                            </div>
                            <h5>Cox Partial Likelihood:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                L(β) = ∏[exp(βᵀXᵢ) / Σⱼ∈R(tᵢ) exp(βᵀXⱼ)]
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Based on Hsieh & Lavori (2000) methodology for Cox regression with adjustment for multiple covariates. R² represents correlation between primary covariate and other model variables.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="coxregressionPdfUploadSection">
                    <input type="file" id="coxregressionPdfInput" class="file-input" accept=".pdf">
                    <label for="coxregressionPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your Cox regression research paper for automated parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="coxregressionMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="coxregressionProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing Cox regression methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="coxregressionParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="coxregressionApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="coxregressionReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="coxregressionForm">
                    <div class="form-section">
                        <h4>📈 Cox Proportional Hazards Parameters</h4>
                        
                        <div class="input-group">
                            <label for="primaryHazardRatio">Primary Covariate Hazard Ratio</label>
                            <input type="number" id="primaryHazardRatio" class="input-field" 
                                   min="0.1" step="0.01" value="1.5" required>
                            <div class="input-help">Expected hazard ratio for the primary covariate of interest</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="numberOfCovariates">Number of Additional Covariates</label>
                            <input type="number" id="numberOfCovariates" class="input-field" 
                                   min="0" max="20" step="1" value="3" required>
                            <div class="input-help">Number of additional covariates to be adjusted for in the model</div>
                        </div>

                        <div class="input-group">
                            <label for="rSquared">R² for Primary Covariate</label>
                            <input type="number" id="rSquared" class="input-field" 
                                   min="0" max="0.99" step="0.01" value="0.2" required>
                            <div class="input-help">Proportion of variance in primary covariate explained by other covariates</div>
                        </div>

                        <div class="input-group">
                            <label for="overallSurvivalRate">Overall Event Rate</label>
                            <input type="number" id="overallSurvivalRate" class="input-field" 
                                   min="0.1" max="1" step="0.01" value="0.6" required>
                            <div class="input-help">Expected proportion of subjects experiencing the event during study</div>
                        </div>

                        <div class="input-group">
                            <label for="coxregressionSignificanceLevel">Significance Level (α)</label>
                            <select id="coxregressionSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="coxregressionStatisticalPower">Statistical Power (1-β)</label>
                            <select id="coxregressionStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="coxregressionDropoutRate">Expected Loss to Follow-up (%)</label>
                            <input type="number" id="coxregressionDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="15">
                            <div class="input-help">Expected proportion of participants lost during follow-up period</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate Cox Regression Sample Size
                    </button>
                </form>
            </div>

            <!-- One-Arm Survival Calculator -->
            <div class="calculator-section" id="onearmCalculator">
                <div class="section-header">
                    <div class="section-icon">🎯</div>
                    <h3>One-Arm Survival Study Sample Size Calculator</h3>
                </div>

                <!-- Enhanced Formula Display for Academic Reference -->
                <div class="formula-container">
                    <div class="formula-toggle" id="onearmFormulaToggle">
                        <span class="formula-toggle-icon">▶</span>
                        <strong>Statistical Formula & Single-Arm Methodology</strong>
                    </div>
                    <div class="formula-content" id="onearmFormulaContent">
                        <div class="formula-display">
                            N = [(Z(α/2) + Z(β))² × p₀ × (1-p₀)] / (p₁ - p₀)²
                        </div>
                        <div class="formula-explanation">
                            <h4>Parameter Definitions for One-Arm Survival Study:</h4>
                            <ul>
                                <li>
                                    <span class="formula-var">N</span>
                                    <span class="formula-desc">Required total sample size for single arm study</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(α/2)</span>
                                    <span class="formula-desc">Critical value for two-sided significance level</span>
                                </li>
                                <li>
                                    <span class="formula-var">Z(β)</span>
                                    <span class="formula-desc">Critical value for statistical power</span>
                                </li>
                                <li>
                                    <span class="formula-var">p₀</span>
                                    <span class="formula-desc">Historical/expected survival probability (null hypothesis)</span>
                                </li>
                                <li>
                                    <span class="formula-var">p₁</span>
                                    <span class="formula-desc">Target survival probability (alternative hypothesis)</span>
                                </li>
                            </ul>
                            <h5>Survival Probability Calculation:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                S(t) = exp(-λt)   where   λ = ln(2)/median
                            </div>
                            <h5>Median Survival Relationship:</h5>
                            <div class="formula-display" style="margin-top: 1rem;">
                                HR = median₀/median₁
                            </div>
                            <div class="formula-note">
                                <strong>Methodological Note:</strong> Formula assumes exponential survival distribution for historical and target populations. Suitable for phase II trials and single-arm studies with historical controls.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced PDF Upload with Intelligent Analysis -->
                <div class="pdf-upload-section" id="onearmPdfUploadSection">
                    <input type="file" id="onearmPdfInput" class="file-input" accept=".pdf">
                    <label for="onearmPdfInput">
                        <div class="upload-icon">🔮</div>
                        <div class="upload-text">Intelligent Academic Parameter Extraction</div>
                        <div class="upload-subtext">Upload your single-arm survival research paper for automated parameter extraction using advanced algorithmic pattern recognition</div>
                    </label>
                </div>

                <!-- Intelligent Analysis Results -->
                <div class="magical-analysis-container" id="onearmMagicalAnalysis">
                    <div class="magical-analysis-header">
                        <div class="magical-analysis-title">
                            <span>✨</span>
                            <span>Intelligent Parameter Extraction</span>
                        </div>
                        <div class="processing-indicator" id="onearmProcessingIndicator">
                            <div class="spinner"></div>
                            <span>Analyzing single-arm methodology...</span>
                        </div>
                    </div>
                    <div class="magical-analysis-content">
                        <div class="parameter-extraction-grid" id="onearmParameterGrid">
                            <!-- Parameters will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button class="btn-primary" id="onearmApplyBtn">
                                <span>✓</span>
                                Apply Extracted Parameters
                            </button>
                            <button class="btn-secondary" id="onearmReviewBtn">
                                <span>📋</span>
                                Review Extraction Details
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Form -->
                <form id="onearmForm">
                    <div class="form-section">
                        <h4>🎯 One-Arm Survival Study Parameters</h4>
                        
                        <div class="input-group">
                            <label for="historicalMedianSurvival">Historical Median Survival (months)</label>
                            <input type="number" id="historicalMedianSurvival" class="input-field" 
                                   min="0.1" step="0.1" value="12" required>
                            <div class="input-help">Historical control median survival time from literature or previous studies</div>
                        </div>
                        
                        <div class="input-group">
                            <label for="targetMedianSurvival">Target Median Survival (months)</label>
                            <input type="number" id="targetMedianSurvival" class="input-field" 
                                   min="0.1" step="0.1" value="18" required>
                            <div class="input-help">Target median survival time for new treatment (alternative hypothesis)</div>
                        </div>

                        <div class="input-group">
                            <label for="timePoint">Analysis Time Point (months)</label>
                            <input type="number" id="timePoint" class="input-field" 
                                   min="1" step="1" value="24" required>
                            <div class="input-help">Time point at which survival will be evaluated (e.g., 2-year survival)</div>
                        </div>

                        <div class="input-group">
                            <label for="onearmSignificanceLevel">Significance Level (α)</label>
                            <select id="onearmSignificanceLevel" class="input-field" required>
                                <option value="0.05" selected>5% (Two-sided test)</option>
                                <option value="0.01">1% (Two-sided test)</option>
                                <option value="0.10">10% (Two-sided test)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="onearmStatisticalPower">Statistical Power (1-β)</label>
                            <select id="onearmStatisticalPower" class="input-field" required>
                                <option value="0.80" selected>80%</option>
                                <option value="0.85">85%</option>
                                <option value="0.90">90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="onearmDropoutRate">Expected Loss to Follow-up (%)</label>
                            <input type="number" id="onearmDropoutRate" class="input-field" 
                                   min="0" max="50" step="1" value="10">
                            <div class="input-help">Expected proportion of participants lost during study period</div>
                        </div>
                    </div>

                    <button type="submit" class="calculate-btn">
                        <span>🧮</span>
                        Calculate One-Arm Survival Sample Size
                    </button>
                </form>
            </div>

            <!-- Enhanced Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        class KarmastatSurvivalAnalysisCalculator {
            constructor() {
                this.currentTheme = 'light';
                this.currentStudyType = null;
                this.extractedParams = {};
                this.intelligentAnalysisEngine = new AdvancedSurvivalAnalysisEngine();
                this.calculationResults = {};
                this.init();
            }

            init() {
                console.log('🚀 Initializing KARMASTAT Survival Analysis Calculator...');
                
                try {
                    // Initialize PDF.js worker with enhanced configuration
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
                    
                    this.setupEventListeners();
                    this.loadSavedTheme();
                    
                    console.log('✅ KARMASTAT Survival Analysis Calculator initialized successfully');
                } catch (error) {
                    console.error('❌ Initialization error:', error);
                    this.showError('Failed to initialize calculator. Please refresh the page.');
                }
            }

            setupEventListeners() {
                // Theme toggle functionality
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
                
                // Study type selection with enhanced validation
                this.setupStudyTypeSelection();
                
                // Formula toggle functionality
                this.setupFormulaToggles();
                
                // PDF upload functionality with advanced processing
                this.setupPdfUploadHandlers();
                
                // Parameter application handlers with validation
                this.setupParameterHandlers();
                
                // Form submission handlers with comprehensive validation
                this.setupFormHandlers();
                
                // Drag and drop functionality with file validation
                this.setupDragAndDrop();
            }

            setupStudyTypeSelection() {
                const studyTypeCards = document.querySelectorAll('.study-type-card');
                studyTypeCards.forEach(card => {
                    const studyType = card.dataset.study;
                    if (studyType) {
                        card.addEventListener('click', () => this.selectStudyType(studyType));
                        card.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                this.selectStudyType(studyType);
                            }
                        });
                    }
                });
            }

            setupFormulaToggles() {
                const formulaToggles = [
                    { id: 'logrankFormulaToggle', contentId: 'logrankFormulaContent' },
                    { id: 'coxregressionFormulaToggle', contentId: 'coxregressionFormulaContent' },
                    { id: 'onearmFormulaToggle', contentId: 'onearmFormulaContent' }
                ];
                
                formulaToggles.forEach(({ id, contentId }) => {
                    const toggle = document.getElementById(id);
                    const content = document.getElementById(contentId);
                    
                    if (toggle && content) {
                        toggle.addEventListener('click', () => {
                            toggle.classList.toggle('active');
                            content.classList.toggle('active');
                        });
                    }
                });
            }

            setupPdfUploadHandlers() {
                // Log-rank PDF upload
                const logrankPdfInput = document.getElementById('logrankPdfInput');
                if (logrankPdfInput) {
                    logrankPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'logrank'));
                }
                
                // Cox regression PDF upload
                const coxregressionPdfInput = document.getElementById('coxregressionPdfInput');
                if (coxregressionPdfInput) {
                    coxregressionPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'coxregression'));
                }
                
                // One-arm PDF upload
                const onearmPdfInput = document.getElementById('onearmPdfInput');
                if (onearmPdfInput) {
                    onearmPdfInput.addEventListener('change', (e) => this.handlePdfUpload(e, 'onearm'));
                }
            }

            setupParameterHandlers() {
                const parameterHandlers = [
                    { applyId: 'logrankApplyBtn', reviewId: 'logrankReviewBtn', type: 'logrank' },
                    { applyId: 'coxregressionApplyBtn', reviewId: 'coxregressionReviewBtn', type: 'coxregression' },
                    { applyId: 'onearmApplyBtn', reviewId: 'onearmReviewBtn', type: 'onearm' }
                ];
                
                parameterHandlers.forEach(({ applyId, reviewId, type }) => {
                    const applyBtn = document.getElementById(applyId);
                    const reviewBtn = document.getElementById(reviewId);
                    
                    if (applyBtn) {
                        applyBtn.addEventListener('click', () => this.applyExtractedParameters(type));
                    }
                    if (reviewBtn) {
                        reviewBtn.addEventListener('click', () => this.reviewExtractionDetails(type));
                    }
                });
            }

            setupFormHandlers() {
                // Log-rank form
                const logrankForm = document.getElementById('logrankForm');
                if (logrankForm) {
                    logrankForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'logrank'));
                }
                
                // Cox regression form
                const coxregressionForm = document.getElementById('coxregressionForm');
                if (coxregressionForm) {
                    coxregressionForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'coxregression'));
                }
                
                // One-arm form
                const onearmForm = document.getElementById('onearmForm');
                if (onearmForm) {
                    onearmForm.addEventListener('submit', (e) => this.handleFormSubmission(e, 'onearm'));
                }
            }

            setupDragAndDrop() {
                const uploadSections = ['logrankPdfUploadSection', 'coxregressionPdfUploadSection', 'onearmPdfUploadSection'];
                
                uploadSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (!section) return;
                    
                    section.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        section.classList.add('dragover');
                    });
                    
                    section.addEventListener('dragleave', () => {
                        section.classList.remove('dragover');
                    });
                    
                    section.addEventListener('drop', (e) => {
                        e.preventDefault();
                        section.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type === 'application/pdf') {
                            const studyType = sectionId.includes('logrank') ? 'logrank' : 
                                            sectionId.includes('coxregression') ? 'coxregression' : 'onearm';
                            const inputId = studyType + 'PdfInput';
                            document.getElementById(inputId).files = files;
                            this.handlePdfUpload({ target: { files: files } }, studyType);
                        }
                    });
                });
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.currentTheme);
                
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                
                if (this.currentTheme === 'dark') {
                    themeIcon.textContent = '☀️';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = '🌙';
                    themeText.textContent = 'Dark Mode';
                }
                
                localStorage.setItem('karmastat-theme', this.currentTheme);
            }

            loadSavedTheme() {
                const savedTheme = localStorage.getItem('karmastat-theme');
                if (savedTheme && savedTheme !== this.currentTheme) {
                    this.toggleTheme();
                }
            }

            selectStudyType(studyType) {
                console.log(`Selecting study type: ${studyType}`);
                
                try {
                    // Clear previous results
                    this.clearResults();
                    
                    // Update card selection with enhanced visual feedback
                    document.querySelectorAll('.study-type-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    const cardId = studyType + 'Card';
                    const selectedCard = document.getElementById(cardId);
                    if (selectedCard) {
                        selectedCard.classList.add('active');
                    }
                    
                    // Hide all calculator sections
                    document.querySelectorAll('.calculator-section').forEach(section => {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });
                    
                    // Show selected calculator with enhanced animation
                    const calculatorId = studyType + 'Calculator';
                    const calculator = document.getElementById(calculatorId);
                    if (calculator) {
                        calculator.style.display = 'block';
                        calculator.classList.add('active');
                        this.currentStudyType = studyType;
                        
                        setTimeout(() => {
                            calculator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                    
                } catch (error) {
                    console.error('Error selecting study type:', error);
                    this.showError('Error selecting study type. Please try again.');
                }
            }

            async handlePdfUpload(event, studyType) {
                const file = event.target.files[0];
                if (!file) return;

                console.log(`Processing PDF upload for ${studyType} survival analysis`);

                const analysisContainerId = studyType + 'MagicalAnalysis';
                const processingIndicatorId = studyType + 'ProcessingIndicator';
                
                const analysisContainer = document.getElementById(analysisContainerId);
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                // Show analysis container with enhanced feedback
                analysisContainer.style.display = 'block';
                processingIndicator.style.display = 'flex';
                processingIndicator.innerHTML = '<div class="spinner"></div><span>Analyzing survival methodology...</span>';
                
                try {
                    // Process PDF with advanced intelligent analysis engine
                    const extractedData = await this.intelligentAnalysisEngine.analyzePDF(file, studyType);
                    
                    // Hide processing indicator
                    processingIndicator.style.display = 'none';
                    
                    // Display results with enhanced visualization
                    this.displayExtractionResults(extractedData, studyType);
                    this.extractedParams[studyType] = extractedData;
                    
                    console.log('Advanced PDF analysis completed successfully');
                    
                } catch (error) {
                    console.error('PDF analysis error:', error);
                    processingIndicator.innerHTML = '<span style="color: #EF4444;">❌ Analysis failed. Please verify PDF quality and try again.</span>';
                }
            }

            displayExtractionResults(data, studyType) {
                const parameterGridId = studyType + 'ParameterGrid';
                const parameterGrid = document.getElementById(parameterGridId);
                
                if (!parameterGrid) return;
                
                parameterGrid.innerHTML = '';

                const parameterLabels = {
                    'logrank': {
                        medianSurvival1: 'Group 1 Median Survival',
                        medianSurvival2: 'Group 2 Median Survival',
                        hazardRatio: 'Hazard Ratio',
                        accrualPeriod: 'Accrual Period',
                        followupPeriod: 'Follow-up Period',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    },
                    'coxregression': {
                        hazardRatio: 'Primary Hazard Ratio',
                        numberOfCovariates: 'Number of Covariates',
                        rSquared: 'R-squared',
                        eventRate: 'Event Rate',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    },
                    'onearm': {
                        historicalMedian: 'Historical Median',
                        targetMedian: 'Target Median',
                        timePoint: 'Analysis Time Point',
                        sampleSize: 'Sample Size',
                        significanceLevel: 'Significance Level',
                        power: 'Statistical Power'
                    }
                };

                const labels = parameterLabels[studyType] || {};

                Object.entries(data.parameters || {}).forEach(([param, value]) => {
                    const source = data.sources?.[param] || {};
                    const confidence = source.confidence || 70;
                    
                    const card = document.createElement('div');
                    card.className = 'parameter-card';
                    
                    let displayValue = value;
                    if (['significanceLevel', 'power'].includes(param)) {
                        displayValue = `${value}%`;
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                    }
                    
                    card.innerHTML = `
                        <div class="parameter-label">${labels[param] || param}</div>
                        <div class="parameter-value">${displayValue}</div>
                        <div class="parameter-confidence">
                            <span>Confidence: ${confidence}%</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                        <div class="parameter-source">
                            ${source.section || 'Document'} • Page ${source.page || 'N/A'}
                        </div>
                    `;
                    
                    parameterGrid.appendChild(card);
                });
            }

            applyExtractedParameters(studyType) {
                const params = this.extractedParams[studyType]?.parameters || {};
                
                if (Object.keys(params).length === 0) {
                    this.showError('No parameters available to apply. Please upload and analyze a PDF first.');
                    return;
                }
                
                // Enhanced parameter mapping with validation
                const fieldMappings = {
                    'logrank': {
                        medianSurvival1: 'medianSurvival1',
                        medianSurvival2: 'medianSurvival2',
                        hazardRatio: 'hazardRatio',
                        accrualPeriod: 'accrualPeriod',
                        followupPeriod: 'followupPeriod',
                        significanceLevel: 'logrankSignificanceLevel',
                        power: 'logrankStatisticalPower'
                    },
                    'coxregression': {
                        hazardRatio: 'primaryHazardRatio',
                        numberOfCovariates: 'numberOfCovariates',
                        rSquared: 'rSquared',
                        eventRate: 'overallSurvivalRate',
                        significanceLevel: 'coxregressionSignificanceLevel',
                        power: 'coxregressionStatisticalPower'
                    },
                    'onearm': {
                        historicalMedian: 'historicalMedianSurvival',
                        targetMedian: 'targetMedianSurvival',
                        timePoint: 'timePoint',
                        significanceLevel: 'onearmSignificanceLevel',
                        power: 'onearmStatisticalPower'
                    }
                };

                const mappings = fieldMappings[studyType] || {};
                let appliedCount = 0;
                
                Object.entries(params).forEach(([param, value]) => {
                    const fieldId = mappings[param];
                    if (fieldId) {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = value;
                            appliedCount++;
                        }
                    }
                });
                
                // Enhanced success feedback
                const processingIndicatorId = studyType + 'ProcessingIndicator';
                const processingIndicator = document.getElementById(processingIndicatorId);
                
                if (processingIndicator) {
                    processingIndicator.innerHTML = `<span style="color: #10B981;">✅ Applied ${appliedCount} parameters successfully</span>`;
                    processingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        processingIndicator.style.display = 'none';
                    }, 3000);
                }
            }

            reviewExtractionDetails(studyType) {
                const data = this.extractedParams[studyType];
                if (!data) {
                    this.showError('No extraction data available. Please upload and analyze a PDF first.');
                    return;
                }
                
                const sources = data.sources || {};
                let detailsText = `Advanced Survival Analysis Parameter Extraction (${studyType}):\n\n`;
                
                Object.entries(sources).forEach(([param, source]) => {
                    detailsText += `Parameter: ${param}\n`;
                    detailsText += `  Extracted Value: ${data.parameters[param]}\n`;
                    detailsText += `  Confidence Score: ${source.confidence}%\n`;
                    detailsText += `  Source Location: Page ${source.page}, ${source.section} section\n`;
                    detailsText += `  Context: "${source.context}"\n`;
                    detailsText += `  Validation Status: ${source.validated ? 'Validated' : 'Pending'}\n\n`;
                });
                
                alert(detailsText);
            }

            handleFormSubmission(event, studyType) {
                event.preventDefault();
                console.log(`Processing ${studyType} survival analysis calculation`);
                
                try {
                    // Collect form data with enhanced validation
                    const formData = this.collectFormData(studyType);
                    
                    // Validate parameters with survival analysis constraints
                    this.validateParameters(formData, studyType);
                    
                    // Calculate sample size using validated methodologies
                    const results = this.calculateSampleSize(formData, studyType);
                    
                    // Store results for PDF export
                    this.calculationResults = results;
                    
                    // Display results with comprehensive documentation
                    this.displayResults(results, studyType);
                    
                } catch (error) {
                    console.error(`Calculation error for ${studyType}:`, error);
                    this.showError(error.message);
                }
            }

            collectFormData(studyType) {
                if (studyType === 'logrank') {
                    return this.collectLogrankData();
                } else if (studyType === 'coxregression') {
                    return this.collectCoxregressionData();
                } else if (studyType === 'onearm') {
                    return this.collectOnearmData();
                }
                throw new Error('Invalid study type specified');
            }

            collectLogrankData() {
                const elements = {
                    medianSurvival1: document.getElementById('medianSurvival1'),
                    medianSurvival2: document.getElementById('medianSurvival2'),
                    hazardRatio: document.getElementById('hazardRatio'),
                    accrualPeriod: document.getElementById('accrualPeriod'),
                    followupPeriod: document.getElementById('followupPeriod'),
                    allocationRatio: document.getElementById('allocationRatio'),
                    significanceLevel: document.getElementById('logrankSignificanceLevel'),
                    statisticalPower: document.getElementById('logrankStatisticalPower'),
                    dropoutRate: document.getElementById('logrankDropoutRate')
                };
                
                // Enhanced validation for element existence and values
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for log-rank analysis`);
                    }
                }
                
                return {
                    medianSurvival1: parseFloat(elements.medianSurvival1.value),
                    medianSurvival2: parseFloat(elements.medianSurvival2.value),
                    hazardRatio: parseFloat(elements.hazardRatio.value),
                    accrualPeriod: parseFloat(elements.accrualPeriod.value),
                    followupPeriod: parseFloat(elements.followupPeriod.value),
                    allocationRatio: parseFloat(elements.allocationRatio.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            collectCoxregressionData() {
                const elements = {
                    primaryHazardRatio: document.getElementById('primaryHazardRatio'),
                    numberOfCovariates: document.getElementById('numberOfCovariates'),
                    rSquared: document.getElementById('rSquared'),
                    overallSurvivalRate: document.getElementById('overallSurvivalRate'),
                    significanceLevel: document.getElementById('coxregressionSignificanceLevel'),
                    statisticalPower: document.getElementById('coxregressionStatisticalPower'),
                    dropoutRate: document.getElementById('coxregressionDropoutRate')
                };
                
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for Cox regression analysis`);
                    }
                }
                
                return {
                    primaryHazardRatio: parseFloat(elements.primaryHazardRatio.value),
                    numberOfCovariates: parseInt(elements.numberOfCovariates.value),
                    rSquared: parseFloat(elements.rSquared.value),
                    overallSurvivalRate: parseFloat(elements.overallSurvivalRate.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            collectOnearmData() {
                const elements = {
                    historicalMedianSurvival: document.getElementById('historicalMedianSurvival'),
                    targetMedianSurvival: document.getElementById('targetMedianSurvival'),
                    timePoint: document.getElementById('timePoint'),
                    significanceLevel: document.getElementById('onearmSignificanceLevel'),
                    statisticalPower: document.getElementById('onearmStatisticalPower'),
                    dropoutRate: document.getElementById('onearmDropoutRate')
                };
                
                for (const [key, element] of Object.entries(elements)) {
                    if (!element || !element.value) {
                        throw new Error(`${key} parameter is required for one-arm survival analysis`);
                    }
                }
                
                return {
                    historicalMedianSurvival: parseFloat(elements.historicalMedianSurvival.value),
                    targetMedianSurvival: parseFloat(elements.targetMedianSurvival.value),
                    timePoint: parseFloat(elements.timePoint.value),
                    significanceLevel: parseFloat(elements.significanceLevel.value),
                    statisticalPower: parseFloat(elements.statisticalPower.value),
                    dropoutRate: parseFloat(elements.dropoutRate.value) / 100
                };
            }

            validateParameters(params, studyType) {
                // Enhanced validation with survival analysis constraints
                for (const [key, value] of Object.entries(params)) {
                    if (isNaN(value) || !isFinite(value)) {
                        throw new Error(`Invalid numerical value for ${key}: ${value}`);
                    }
                    if (value < 0) {
                        throw new Error(`${key} cannot be negative in survival analysis`);
                    }
                }
                
                // Study-specific enhanced validations
                if (studyType === 'logrank') {
                    if (params.hazardRatio <= 0) {
                        throw new Error('Hazard ratio must be positive for meaningful survival analysis');
                    }
                    if (params.medianSurvival1 <= 0 || params.medianSurvival2 <= 0) {
                        throw new Error('Median survival times must be positive');
                    }
                } else if (studyType === 'coxregression') {
                    if (params.primaryHazardRatio <= 0) {
                        throw new Error('Primary hazard ratio must be positive');
                    }
                    if (params.rSquared >= 1) {
                        throw new Error('R-squared must be less than 1.0');
                    }
                } else if (studyType === 'onearm') {
                    if (params.historicalMedianSurvival <= 0 || params.targetMedianSurvival <= 0) {
                        throw new Error('Median survival times must be positive');
                    }
                    if (params.timePoint <= 0) {
                        throw new Error('Analysis time point must be positive');
                    }
                }
            }

            calculateSampleSize(params, studyType) {
                if (studyType === 'logrank') {
                    return this.calculateLogrankSampleSize(params);
                } else if (studyType === 'coxregression') {
                    return this.calculateCoxregressionSampleSize(params);
                } else if (studyType === 'onearm') {
                    return this.calculateOnearmSampleSize(params);
                }
                throw new Error('Invalid study type for calculation');
            }

            calculateLogrankSampleSize(params) {
                const { medianSurvival1, medianSurvival2, hazardRatio, accrualPeriod, followupPeriod, allocationRatio, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Get critical values using enhanced precision
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate required number of events (Schoenfeld's formula)
                const numerator = Math.pow(zAlpha + zBeta, 2) * (1 + 1/allocationRatio);
                const denominator = Math.pow(Math.log(hazardRatio), 2);
                const requiredEvents = numerator / denominator;
                
                // Calculate hazard rates from median survival times
                const lambda1 = Math.log(2) / medianSurvival1;
                const lambda2 = Math.log(2) / medianSurvival2;
                
                // Calculate total study duration
                const totalStudyDuration = accrualPeriod + followupPeriod;
                
                // Calculate event probabilities for each group
                const prob1 = 1 - Math.exp(-lambda1 * totalStudyDuration);
                const prob2 = 1 - Math.exp(-lambda2 * totalStudyDuration);
                
                // Calculate weighted average event probability
                const p1 = 1 / (1 + allocationRatio);
                const p2 = allocationRatio / (1 + allocationRatio);
                const avgEventProb = p1 * prob1 + p2 * prob2;
                
                // Calculate total sample size
                const baseSampleSize = requiredEvents / avgEventProb;
                
                // Adjust for dropouts
                const adjustedSampleSize = baseSampleSize / (1 - dropoutRate);
                
                const n1 = Math.ceil(adjustedSampleSize * p1);
                const n2 = Math.ceil(adjustedSampleSize * p2);
                
                return {
                    studyType: 'logrank',
                    group1Size: n1,
                    group2Size: n2,
                    totalSize: n1 + n2,
                    requiredEvents: Math.ceil(requiredEvents),
                    baseSampleSize: Math.ceil(baseSampleSize),
                    parameters: {
                        ...params,
                        lambda1,
                        lambda2,
                        prob1,
                        prob2,
                        avgEventProb,
                        totalStudyDuration
                    },
                    statistics: {
                        zAlpha,
                        zBeta
                    }
                };
            }

            calculateCoxregressionSampleSize(params) {
                const { primaryHazardRatio, numberOfCovariates, rSquared, overallSurvivalRate, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Get critical values
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate variance inflation factor
                const vif = 1 / (1 - rSquared);
                
                // Calculate required number of events (Hsieh & Lavori formula)
                const numerator = Math.pow(zAlpha + zBeta, 2) * (1 + vif);
                const denominator = Math.pow(Math.log(primaryHazardRatio), 2);
                const requiredEvents = numerator / denominator;
                
                // Calculate total sample size based on event rate
                const baseSampleSize = requiredEvents / overallSurvivalRate;
                
                // Adjust for dropouts
                const adjustedSampleSize = baseSampleSize / (1 - dropoutRate);
                
                const totalSampleSize = Math.ceil(adjustedSampleSize);
                
                return {
                    studyType: 'coxregression',
                    totalSize: totalSampleSize,
                    requiredEvents: Math.ceil(requiredEvents),
                    baseSampleSize: Math.ceil(baseSampleSize),
                    parameters: {
                        ...params,
                        vif
                    },
                    statistics: {
                        zAlpha,
                        zBeta
                    }
                };
            }

            calculateOnearmSampleSize(params) {
                const { historicalMedianSurvival, targetMedianSurvival, timePoint, significanceLevel, statisticalPower, dropoutRate } = params;
                
                // Get critical values
                const zAlpha = this.getZScore((1 - significanceLevel/2) * 100);
                const zBeta = this.getZScore(statisticalPower * 100);
                
                // Calculate hazard rates from median survival times
                const lambda0 = Math.log(2) / historicalMedianSurvival;
                const lambda1 = Math.log(2) / targetMedianSurvival;
                
                // Calculate survival probabilities at analysis time point
                const p0 = Math.exp(-lambda0 * timePoint);
                const p1 = Math.exp(-lambda1 * timePoint);
                
                // Calculate sample size using normal approximation
                const numerator = Math.pow(zAlpha + zBeta, 2) * p0 * (1 - p0);
                const denominator = Math.pow(p1 - p0, 2);
                const baseSampleSize = numerator / denominator;
                
                // Adjust for dropouts
                const adjustedSampleSize = baseSampleSize / (1 - dropoutRate);
                
                const totalSampleSize = Math.ceil(adjustedSampleSize);
                
                return {
                    studyType: 'onearm',
                    totalSize: totalSampleSize,
                    baseSampleSize: Math.ceil(baseSampleSize),
                    parameters: {
                        ...params,
                        lambda0,
                        lambda1,
                        p0,
                        p1,
                        hazardRatio: lambda1/lambda0
                    },
                    statistics: {
                        zAlpha,
                        zBeta
                    }
                };
            }

            displayResults(results, studyType) {
                const resultsSection = document.getElementById('resultsSection');
                
                let html = '';
                if (studyType === 'logrank') {
                    html = this.generateLogrankResults(results);
                } else if (studyType === 'coxregression') {
                    html = this.generateCoxregressionResults(results);
                } else if (studyType === 'onearm') {
                    html = this.generateOnearmResults(results);
                }
                
                resultsSection.innerHTML = html;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            generateLogrankResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>⚰️ Log-Rank Test Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Group 1 Size:</span><span class="detail-value">${results.group1Size.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Group 2 Size:</span><span class="detail-value">${results.group2Size.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Required Events:</span><span class="detail-value">${results.requiredEvents}</span></li>
                                    <li><span class="detail-label">Allocation Ratio:</span><span class="detail-value">${results.parameters.allocationRatio}:1</span></li>
                                    <li><span class="detail-label">Hazard Ratio:</span><span class="detail-value">${results.parameters.hazardRatio.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Group 1 Median Survival:</span><span class="detail-value">${results.parameters.medianSurvival1} months</span></li>
                                    <li><span class="detail-label">Group 2 Median Survival:</span><span class="detail-value">${results.parameters.medianSurvival2} months</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📊 Study Design Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Accrual Period:</span><span class="detail-value">${results.parameters.accrualPeriod} months</span></li>
                                    <li><span class="detail-label">Follow-up Period:</span><span class="detail-value">${results.parameters.followupPeriod} months</span></li>
                                    <li><span class="detail-label">Total Study Duration:</span><span class="detail-value">${results.parameters.totalStudyDuration} months</span></li>
                                    <li><span class="detail-label">Group 1 Event Rate:</span><span class="detail-value">${(results.parameters.prob1 * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Group 2 Event Rate:</span><span class="detail-value">${(results.parameters.prob2 * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Average Event Rate:</span><span class="detail-value">${(results.parameters.avgEventProb * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Statistical & Methodological Notes</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Significance Level:</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Analysis Method:</span><span class="detail-value">Log-rank test (Mantel-Cox)</span></li>
                                    <li><span class="detail-label">Survival Curves:</span><span class="detail-value">Kaplan-Meier estimation</span></li>
                                    <li><span class="detail-label">Censoring:</span><span class="detail-value">Right censoring supported</span></li>
                                    <li><span class="detail-label">Event-driven Design:</span><span class="detail-value">${results.requiredEvents} events required</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateCoxregressionResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Total Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>📈 Cox Proportional Hazards Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Total Sample Size:</span><span class="detail-value">${results.totalSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Required Events:</span><span class="detail-value">${results.requiredEvents}</span></li>
                                    <li><span class="detail-label">Primary Hazard Ratio:</span><span class="detail-value">${results.parameters.primaryHazardRatio.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Number of Covariates:</span><span class="detail-value">${results.parameters.numberOfCovariates}</span></li>
                                    <li><span class="detail-label">R-squared:</span><span class="detail-value">${results.parameters.rSquared.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Variance Inflation Factor:</span><span class="detail-value">${results.parameters.vif.toFixed(2)}</span></li>
                                    <li><span class="detail-label">Overall Event Rate:</span><span class="detail-value">${(results.parameters.overallSurvivalRate * 100).toFixed(1)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📊 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Significance Level:</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSampleSize}</span></li>
                                    <li><span class="detail-label">Dropout Rate:</span><span class="detail-value">${(results.parameters.dropoutRate * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Model Type:</span><span class="detail-value">Semi-parametric Cox regression</span></li>
                                    <li><span class="detail-label">Baseline Hazard:</span><span class="detail-value">Non-parametric estimation</span></li>
                                    <li><span class="detail-label">Proportional Hazards:</span><span class="detail-value">Assumption required</span></li>
                                    <li><span class="detail-label">Partial Likelihood:</span><span class="detail-value">Maximum likelihood estimation</span></li>
                                    <li><span class="detail-label">Covariate Adjustment:</span><span class="detail-value">Multiple confounders</span></li>
                                    <li><span class="detail-label">Time-dependent Covariates:</span><span class="detail-value">Supported with extensions</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            generateOnearmResults(results) {
                return `
                    <div class="result-card">
                        <div class="result-main">${results.totalSize.toLocaleString()}</div>
                        <div class="result-label">Required Sample Size</div>
                        
                        <div class="result-details">
                            <div class="detail-card">
                                <h4>🎯 One-Arm Survival Study Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Total Sample Size:</span><span class="detail-value">${results.totalSize.toLocaleString()}</span></li>
                                    <li><span class="detail-label">Historical Median:</span><span class="detail-value">${results.parameters.historicalMedianSurvival} months</span></li>
                                    <li><span class="detail-label">Target Median:</span><span class="detail-value">${results.parameters.targetMedianSurvival} months</span></li>
                                    <li><span class="detail-label">Analysis Time Point:</span><span class="detail-value">${results.parameters.timePoint} months</span></li>
                                    <li><span class="detail-label">Historical Survival Rate:</span><span class="detail-value">${(results.parameters.p0 * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Target Survival Rate:</span><span class="detail-value">${(results.parameters.p1 * 100).toFixed(1)}%</span></li>
                                    <li><span class="detail-label">Hazard Ratio:</span><span class="detail-value">${results.parameters.hazardRatio.toFixed(3)}</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📊 Statistical Parameters</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Statistical Power:</span><span class="detail-value">${(results.parameters.statisticalPower * 100)}%</span></li>
                                    <li><span class="detail-label">Significance Level:</span><span class="detail-value">${(results.parameters.significanceLevel * 100)}%</span></li>
                                    <li><span class="detail-label">Z-score (α/2):</span><span class="detail-value">${results.statistics.zAlpha.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Z-score (β):</span><span class="detail-value">${results.statistics.zBeta.toFixed(3)}</span></li>
                                    <li><span class="detail-label">Base Sample Size:</span><span class="detail-value">${results.baseSampleSize}</span></li>
                                    <li><span class="detail-label">Dropout Rate:</span><span class="detail-value">${(results.parameters.dropoutRate * 100)}%</span></li>
                                </ul>
                            </div>
                            
                            <div class="detail-card">
                                <h4>📋 Methodological Recommendations</h4>
                                <ul class="detail-list">
                                    <li><span class="detail-label">Study Design:</span><span class="detail-value">Single-arm with historical controls</span></li>
                                    <li><span class="detail-label">Primary Analysis:</span><span class="detail-value">One-sample survival comparison</span></li>
                                    <li><span class="detail-label">Historical Data:</span><span class="detail-value">Well-established benchmark required</span></li>
                                    <li><span class="detail-label">Survival Estimation:</span><span class="detail-value">Kaplan-Meier method</span></li>
                                    <li><span class="detail-label">Confidence Intervals:</span><span class="detail-value">Log-log transformation</span></li>
                                    <li><span class="detail-label">Interim Analysis:</span><span class="detail-value">Consider for early stopping</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-primary" onclick="calculator.exportToPDF()">
                                <span>📄</span>Export to PDF
                            </button>
                            <button class="btn-secondary" onclick="calculator.newCalculation()">
                                <span>🔄</span>New Calculation
                            </button>
                        </div>
                    </div>
                `;
            }

            exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const results = this.calculationResults;
                    
                    if (!results) {
                        this.showError('No calculation results available for export.');
                        return;
                    }
                    
                    // Enhanced header with academic formatting
                    doc.setFontSize(24);
                    doc.setTextColor(139, 92, 246);
                    doc.text('KARMASTAT', 105, 25, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    const studyTypeName = results.studyType === 'logrank' ? 'Log-Rank Test' : 
                                         results.studyType === 'coxregression' ? 'Cox Proportional Hazards Model' : 
                                         'One-Arm Survival Study';
                    doc.text(`${studyTypeName} Sample Size Calculation`, 105, 35, { align: 'center' });
                    
                    // Main result with emphasis
                    doc.setFontSize(28);
                    doc.setTextColor(139, 92, 246);
                    const mainResult = results.studyType === 'logrank' ? results.totalSize.toLocaleString() :
                                      results.totalSize.toLocaleString();
                    doc.text(`Required Sample: ${mainResult}`, 105, 55, { align: 'center' });
                    
                    // Methodological validation statement
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    const methodNote = results.studyType === 'logrank' ? 'Calculated using Schoenfeld (1981) methodology for log-rank test' :
                                      results.studyType === 'coxregression' ? 'Calculated using Hsieh & Lavori (2000) methodology for Cox regression' :
                                      'Calculated using normal approximation for single-arm survival studies';
                    doc.text(methodNote, 105, 65, { align: 'center' });
                    
                    // Enhanced parameters section
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Survival Analysis Study Parameters:', 20, 80);
                    
                    let y = 90;
                    let parameters = [];
                    
                    if (results.studyType === 'logrank') {
                        parameters = [
                            `Total Sample Size: ${results.totalSize.toLocaleString()}`,
                            `Group 1 Size: ${results.group1Size.toLocaleString()}`,
                            `Group 2 Size: ${results.group2Size.toLocaleString()}`,
                            `Required Events: ${results.requiredEvents}`,
                            `Hazard Ratio: ${results.parameters.hazardRatio.toFixed(3)}`,
                            `Group 1 Median Survival: ${results.parameters.medianSurvival1} months`,
                            `Group 2 Median Survival: ${results.parameters.medianSurvival2} months`,
                            `Accrual Period: ${results.parameters.accrualPeriod} months`,
                            `Follow-up Period: ${results.parameters.followupPeriod} months`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Allocation Ratio: ${results.parameters.allocationRatio}:1`
                        ];
                    } else if (results.studyType === 'coxregression') {
                        parameters = [
                            `Total Sample Size: ${results.totalSize.toLocaleString()}`,
                            `Required Events: ${results.requiredEvents}`,
                            `Primary Hazard Ratio: ${results.parameters.primaryHazardRatio.toFixed(3)}`,
                            `Number of Covariates: ${results.parameters.numberOfCovariates}`,
                            `R-squared: ${results.parameters.rSquared.toFixed(3)}`,
                            `Variance Inflation Factor: ${results.parameters.vif.toFixed(2)}`,
                            `Overall Event Rate: ${(results.parameters.overallSurvivalRate * 100).toFixed(1)}%`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Dropout Rate: ${(results.parameters.dropoutRate * 100)}%`
                        ];
                    } else {
                        parameters = [
                            `Total Sample Size: ${results.totalSize.toLocaleString()}`,
                            `Historical Median Survival: ${results.parameters.historicalMedianSurvival} months`,
                            `Target Median Survival: ${results.parameters.targetMedianSurvival} months`,
                            `Analysis Time Point: ${results.parameters.timePoint} months`,
                            `Historical Survival Rate: ${(results.parameters.p0 * 100).toFixed(1)}%`,
                            `Target Survival Rate: ${(results.parameters.p1 * 100).toFixed(1)}%`,
                            `Hazard Ratio: ${results.parameters.hazardRatio.toFixed(3)}`,
                            `Statistical Power: ${(results.parameters.statisticalPower * 100)}%`,
                            `Significance Level: ${(results.parameters.significanceLevel * 100)}%`,
                            `Dropout Rate: ${(results.parameters.dropoutRate * 100)}%`
                        ];
                    }
                    
                    parameters.forEach(param => {
                        if (y > 250) {
                            doc.addPage();
                            y = 25;
                        }
                        doc.text(`• ${param}`, 25, y);
                        y += 8;
                    });
                    
                    // Enhanced footer with academic citation
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Generated by KARMASTAT - Advanced Survival Analysis Calculator', 105, 270, { align: 'center' });
                    doc.text(`${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString()}`, 105, 280, { align: 'center' });
                    
                    doc.save(`KARMASTAT-${studyTypeName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
                    
                } catch (error) {
                    console.error('PDF export error:', error);
                    this.showError('Error exporting PDF. Please try again.');
                }
            }

            newCalculation() {
                // Reset forms with enhanced cleanup
                const forms = ['logrankForm', 'coxregressionForm', 'onearmForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) form.reset();
                });
                
                // Reset default values with academic standards
                const defaultValues = {
                    'medianSurvival1': '12',
                    'medianSurvival2': '18',
                    'hazardRatio': '0.67',
                    'accrualPeriod': '24',
                    'followupPeriod': '12',
                    'primaryHazardRatio': '1.5',
                    'numberOfCovariates': '3',
                    'rSquared': '0.2',
                    'overallSurvivalRate': '0.6',
                    'historicalMedianSurvival': '12',
                    'targetMedianSurvival': '18',
                    'timePoint': '24',
                    'logrankDropoutRate': '10',
                    'coxregressionDropoutRate': '15',
                    'onearmDropoutRate': '10'
                };
                
                Object.entries(defaultValues).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });
                
                // Clear results and selections with enhanced cleanup
                this.clearResults();
                
                // Reset study type selection
                document.querySelectorAll('.study-type-card').forEach(card => card.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                // Hide analysis containers with complete cleanup
                ['logrankMagicalAnalysis', 'coxregressionMagicalAnalysis', 'onearmMagicalAnalysis'].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.style.display = 'none';
                });
                
                // Reset internal state
                this.currentStudyType = null;
                this.extractedParams = {};
                this.calculationResults = {};
                
                // Smooth scroll to top for enhanced user experience
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            clearResults() {
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.classList.remove('show');
                    resultsSection.innerHTML = '';
                }
            }

            showError(message) {
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.innerHTML = `
                    <div class="result-card" style="border: 2px solid #EF4444;">
                        <div style="text-align: center; color: #EF4444;">
                            <h3>⚠️ Calculation Error</h3>
                            <div class="error-message">${message}</div>
                            <button class="btn-primary" onclick="calculator.newCalculation()" style="margin-top: 1rem;">
                                <span>🔄</span>Start New Calculation
                            </button>
                        </div>
                    </div>
                `;
                resultsSection.classList.add('show');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            getZScore(confidence) {
                const zScores = {
                    50: 0.000, 55: 0.126, 60: 0.253, 65: 0.385, 70: 0.524,
                    75: 0.674, 80: 0.842, 85: 1.036, 90: 1.282, 91: 1.341,
                    92: 1.405, 93: 1.476, 94: 1.555, 95: 1.645, 96: 1.751,
                    97: 1.881, 97.5: 1.960, 98: 2.054, 99: 2.326, 99.5: 2.576,
                    99.9: 3.090, 99.95: 3.291, 99.99: 3.719
                };
                return zScores[confidence] || zScores[95];
            }
        }

        // Advanced Survival Analysis Engine with Enhanced Intelligence
        class AdvancedSurvivalAnalysisEngine {
            constructor() {
                this.enhancedPatterns = this.initializeAdvancedPatterns();
                this.contextValidators = this.initializeContextValidators();
                this.academicFilters = this.initializeAcademicFilters();
            }

            initializeAdvancedPatterns() {
                return {
                    // Enhanced survival analysis patterns with academic precision
                    medianSurvival: [
                        /(?:median\s+survival|median\s+(?:overall\s+)?survival\s+time)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)\s*(?:months?|years?|days?)/gi,
                        /(?:median\s+)?(?:OS|overall\s+survival|PFS|progression.?free\s+survival)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)\s*(?:months?|years?|days?)/gi,
                        /survival\s+time\s*(?:of|was|is)?\s*(\d+\.?\d*)\s*(?:months?|years?|days?)/gi
                    ],
                    
                    hazardRatio: [
                        /(?:hazard\s+ratio|HR)\s*(?:was|is|of|=)?\s*(\d+\.?\d*)/gi,
                        /HR\s*[=:]\s*(\d+\.?\d*)\s*(?:\(|\[)?/gi,
                        /adjusted\s+(?:hazard\s+ratio|HR)\s*(?::|=)?\s*(\d+\.?\d*)/gi,
                        /(?:crude|unadjusted)\s+(?:hazard\s+ratio|HR)\s*(?::|=)?\s*(\d+\.?\d*)/gi
                    ],

                    sampleSize: [
                        /(?:sample\s+size|n\s*=|total\s+(?:participants|subjects|patients))\s*(?:was|of|is)?\s*(\d+)/gi,
                        /(\d+)\s+(?:participants|subjects|patients|individuals)\s+(?:were\s+)?(?:enrolled|recruited|included)/gi,
                        /(?:study\s+included|enrolled|recruited)\s+(?:a\s+total\s+of\s+)?(\d+)\s+(?:participants|subjects|patients)/gi
                    ],
                    
                    events: [
                        /(?:total\s+)?(?:events?|deaths?)\s*(?:observed|occurred|was|were|=)?\s*(\d+)/gi,
                        /(\d+)\s+(?:events?|deaths?)\s+(?:observed|occurred|were\s+recorded)/gi,
                        /number\s+of\s+(?:events?|deaths?)\s*(?:was|=)?\s*(\d+)/gi
                    ],
                    
                    accrualPeriod: [
                        /(?:accrual|recruitment)\s+period\s*(?:was|of|lasted)?\s*(\d+\.?\d*)\s*(?:months?|years?)/gi,
                        /(?:enrolled|recruited)\s+over\s+(\d+\.?\d*)\s*(?:months?|years?)/gi,
                        /accrual\s+(?:duration|time)\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:months?|years?)/gi
                    ],
                    
                    followupPeriod: [
                        /(?:follow.?up|follow.up)\s+(?:period|time|duration)\s*(?:was|of)?\s*(\d+\.?\d*)\s*(?:months?|years?)/gi,
                        /(?:median\s+)?follow.?up\s*(?:was|of|time)?\s*(\d+\.?\d*)\s*(?:months?|years?)/gi,
                        /followed\s+for\s+(?:a\s+)?(?:median\s+of\s+)?(\d+\.?\d*)\s*(?:months?|years?)/gi
                    ],

                    significanceLevel: [
                        /(?:significance\s+level|alpha|α)\s*(?:was|of|set\s+at|=)?\s*(?:0?\.)?(\d+)\s*(?:%|percent)?/gi,
                        /α\s*[=]\s*0?\.(\d+)/gi,
                        /p\s*[<]\s*0?\.(\d+)\s+(?:was\s+considered\s+)?(?:significant|statistically)/gi
                    ],
                    
                    power: [
                        /(?:statistical\s+)?power\s*(?:was|of|set\s+at|=)?\s*(\d+\.?\d*)\s*(?:%|percent)/gi,
                        /(\d+\.?\d*)\s*(?:%|percent)\s+(?:statistical\s+)?power/gi,
                        /power\s+analysis\s+(?:showed|indicated|revealed)?\s*(?:a\s+)?(?:power\s+of\s+)?(\d+\.?\d*)\s*(?:%|percent)/gi
                    ],

                    covariates: [
                        /(?:covariates?|variables?|factors?)\s*(?:included|adjusted\s+for|controlled\s+for)?\s*(?:were|was)?\s*(\d+)/gi,
                        /adjusted\s+for\s+(\d+)\s+(?:covariates?|variables?|factors?)/gi,
                        /multivariable\s+(?:analysis|model)\s+(?:included|with)\s+(\d+)\s+(?:covariates?|variables?)/gi
                    ]
                };
            }

            initializeContextValidators() {
                return {
                    excludePatterns: [
                        /(?:table|figure|fig\.?)\s+\d+/gi,
                        /(?:reference|ref\.?|citation)\s*\[?\d+\]?/gi,
                        /page\s+\d+/gi,
                        /p\.?\s*\d+/gi,
                        /\[\d+(?:\s*,\s*\d+)*\]/gi,
                        /\(\d+(?:\s*,\s*\d+)*\)/gi,
                        /age\s+\d+/gi,
                        /years?\s+old/gi,
                        /\d+\s*(?:cm|mm|kg|mg|ml|g|years?|days?)/gi
                    ],
                    
                    validContexts: [
                        /(?:survival|kaplan.?meier|cox|log.?rank|hazard)/gi,
                        /(?:method|design|analysis|result|finding|outcome)/gi,
                        /(?:study|research|investigation|trial|clinical\s+trial)/gi,
                        /(?:sample|population|participant|subject|patient)/gi
                    ]
                };
            }

            initializeAcademicFilters() {
                return {
                    confidenceThresholds: {
                        medianSurvival: 70,
                        hazardRatio: 75,
                        sampleSize: 60,
                        events: 65,
                        accrualPeriod: 70,
                        followupPeriod: 70,
                        significanceLevel: 75,
                        power: 75,
                        covariates: 60
                    },
                    
                    plausibilityRanges: {
                        medianSurvival: { min: 0.1, max: 1000 },
                        hazardRatio: { min: 0.01, max: 100 },
                        sampleSize: { min: 10, max: 100000 },
                        events: { min: 5, max: 50000 },
                        accrualPeriod: { min: 1, max: 240 },
                        followupPeriod: { min: 0, max: 240 },
                        significanceLevel: { min: 0.1, max: 50 },
                        power: { min: 50, max: 99.9 },
                        covariates: { min: 0, max: 50 }
                    }
                };
            }

            async analyzePDF(file, studyType) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    const extractedData = {
                        parameters: {},
                        sources: {},
                        confidence: 0,
                        extractionDate: new Date().toISOString(),
                        studyType,
                        processingStats: {
                            pagesProcessed: 0,
                            patternsMatched: 0,
                            validationsPerformed: 0
                        }
                    };
                    
                    const maxPages = Math.min(pdf.numPages, 15);
                    
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        const sectionType = this.classifyAcademicSection(pageText);
                        
                        await this.extractParametersWithValidation(pageText, pageNum, sectionType, extractedData, studyType);
                        
                        extractedData.processingStats.pagesProcessed++;
                    }
                    
                    this.performAdvancedValidation(extractedData, studyType);
                    this.calculateAdvancedConfidence(extractedData);
                    
                    return extractedData;
                    
                } catch (error) {
                    console.error('Advanced PDF analysis error:', error);
                    throw new Error('Failed to perform advanced PDF analysis: ' + error.message);
                }
            }

            classifyAcademicSection(text) {
                const lowerText = text.toLowerCase();
                
                const sectionIndicators = {
                    'Methods': [
                        /(?:method|methodology|design|statistical\s+analysis)/gi,
                        /(?:study\s+design|research\s+design|survival\s+analysis)/gi,
                        /(?:sample\s+size|power\s+calculation|statistical\s+power)/gi
                    ],
                    'Results': [
                        /(?:result|finding|outcome|survival\s+data)/gi,
                        /(?:kaplan.?meier|cox\s+regression|log.?rank)/gi,
                        /(?:hazard\s+ratio|median\s+survival|overall\s+survival)/gi
                    ],
                    'Abstract': [
                        /(?:abstract|summary|background|objective|conclusion)/gi,
                        /(?:study\s+objective|research\s+aim|purpose)/gi
                    ]
                };
                
                let bestSection = 'Other';
                let highestScore = 0;
                
                Object.entries(sectionIndicators).forEach(([section, patterns]) => {
                    let sectionScore = 0;
                    patterns.forEach(pattern => {
                        const matches = lowerText.match(pattern);
                        if (matches) {
                            sectionScore += matches.length;
                        }
                    });
                    
                    if (sectionScore > highestScore) {
                        highestScore = sectionScore;
                        bestSection = section;
                    }
                });
                
                return bestSection;
            }

            async extractParametersWithValidation(text, pageNum, sectionType, extractedData, studyType) {
                const relevantPatterns = this.getStudySpecificPatterns(studyType);
                
                for (const [paramName, patterns] of Object.entries(relevantPatterns)) {
                    for (const pattern of patterns) {
                        const matches = [...text.matchAll(pattern)];
                        
                        for (const match of matches) {
                            if (!this.validateContext(match[0], text)) {
                                continue;
                            }
                            
                            const value = this.extractAndValidateValue(match, paramName);
                            
                            if (value !== null && this.validateAcademicPlausibility(paramName, value)) {
                                const confidence = this.calculateContextualConfidence(
                                    paramName, 
                                    sectionType, 
                                    match[0], 
                                    studyType,
                                    text
                                );
                                
                                if (!extractedData.parameters[paramName] || 
                                    confidence > (extractedData.sources[paramName]?.confidence || 0)) {
                                    
                                    extractedData.parameters[paramName] = value;
                                    extractedData.sources[paramName] = {
                                        confidence: confidence,
                                        page: pageNum,
                                        context: match[0].substring(0, 150),
                                        section: sectionType,
                                        pattern: pattern.toString(),
                                        fullMatch: match[0],
                                        validated: true
                                    };
                                    
                                    extractedData.processingStats.patternsMatched++;
                                }
                            }
                            
                            extractedData.processingStats.validationsPerformed++;
                        }
                    }
                }
            }

            validateContext(match, fullText) {
                const matchLower = match.toLowerCase();
                
                for (const excludePattern of this.contextValidators.excludePatterns) {
                    if (excludePattern.test(match)) {
                        return false;
                    }
                }
                
                let validContextFound = false;
                for (const validPattern of this.contextValidators.validContexts) {
                    if (validPattern.test(fullText)) {
                        validContextFound = true;
                        break;
                    }
                }
                
                return validContextFound;
            }

            getStudySpecificPatterns(studyType) {
                const commonPatterns = {
                    sampleSize: this.enhancedPatterns.sampleSize,
                    significanceLevel: this.enhancedPatterns.significanceLevel,
                    power: this.enhancedPatterns.power
                };

                if (studyType === 'logrank') {
                    return {
                        ...commonPatterns,
                        medianSurvival1: this.enhancedPatterns.medianSurvival,
                        medianSurvival2: this.enhancedPatterns.medianSurvival,
                        hazardRatio: this.enhancedPatterns.hazardRatio,
                        accrualPeriod: this.enhancedPatterns.accrualPeriod,
                        followupPeriod: this.enhancedPatterns.followupPeriod,
                        events: this.enhancedPatterns.events
                    };
                } else if (studyType === 'coxregression') {
                    return {
                        ...commonPatterns,
                        hazardRatio: this.enhancedPatterns.hazardRatio,
                        covariates: this.enhancedPatterns.covariates,
                        events: this.enhancedPatterns.events
                    };
                } else if (studyType === 'onearm') {
                    return {
                        ...commonPatterns,
                        historicalMedian: this.enhancedPatterns.medianSurvival,
                        targetMedian: this.enhancedPatterns.medianSurvival,
                        followupPeriod: this.enhancedPatterns.followupPeriod
                    };
                }
                
                return commonPatterns;
            }

            extractAndValidateValue(match, paramName) {
                if (!match[1]) return null;
                
                let value = parseFloat(match[1]);
                
                switch (paramName) {
                    case 'significanceLevel':
                        if (match[0].toLowerCase().includes('α') && value < 1) {
                            value = value * 100;
                        }
                        if (![1, 5, 10].includes(value) && ![0.01, 0.05, 0.1].includes(value)) {
                            if (value > 0.5 && value < 1) {
                                value = value * 100;
                            }
                        }
                        break;
                        
                    case 'power':
                        if (value <= 1 && value > 0) {
                            value = value * 100;
                        }
                        if (value < 50 || value > 99) {
                            return null;
                        }
                        break;
                        
                    case 'hazardRatio':
                        if (value < 0.01 || value > 100) {
                            return null;
                        }
                        break;
                        
                    case 'medianSurvival1':
                    case 'medianSurvival2':
                    case 'historicalMedian':
                    case 'targetMedian':
                    case 'accrualPeriod':
                    case 'followupPeriod':
                        // Convert years to months if necessary
                        if (match[0].toLowerCase().includes('year')) {
                            value = value * 12;
                        }
                        if (value <= 0 || value > 1000) {
                            return null;
                        }
                        break;
                        
                    case 'sampleSize':
                    case 'events':
                    case 'covariates':
                        if (value < 1 || value > 100000) {
                            return null;
                        }
                        break;
                }
                
                return isNaN(value) ? null : value;
            }

            validateAcademicPlausibility(paramName, value) {
                const ranges = this.academicFilters.plausibilityRanges[paramName];
                if (!ranges) return true;
                
                return value >= ranges.min && value <= ranges.max;
            }

            calculateContextualConfidence(paramName, sectionType, context, studyType, fullText) {
                let confidence = 50;
                
                const sectionWeights = {
                    'Methods': 35,
                    'Results': 30,
                    'Abstract': 25,
                    'Other': 0
                };
                
                confidence += sectionWeights[sectionType] || 0;
                
                const lowerContext = context.toLowerCase();
                const lowerFullText = fullText.toLowerCase();
                
                if (lowerContext.includes('calculated') || lowerContext.includes('computed')) confidence += 12;
                if (lowerContext.includes('determined') || lowerContext.includes('estimated')) confidence += 10;
                if (lowerContext.includes('survival analysis') || lowerContext.includes('kaplan-meier')) confidence += 15;
                if (lowerContext.includes('cox regression') || lowerContext.includes('hazard ratio')) confidence += 15;
                
                if (lowerFullText.includes('survival') || lowerFullText.includes('time-to-event')) confidence += 10;
                
                return Math.min(confidence, 98);
            }

            performAdvancedValidation(extractedData, studyType) {
                console.log('Performing advanced survival analysis validation...');
                this.filterLowConfidenceParameters(extractedData);
            }

            filterLowConfidenceParameters(extractedData) {
                Object.keys(extractedData.parameters).forEach(param => {
                    const threshold = this.academicFilters.confidenceThresholds[param] || 50;
                    if (extractedData.sources[param]?.confidence < threshold) {
                        console.log(`Removing ${param} due to low confidence: ${extractedData.sources[param]?.confidence}%`);
                        delete extractedData.parameters[param];
                        delete extractedData.sources[param];
                    }
                });
            }

            calculateAdvancedConfidence(extractedData) {
                const confidenceValues = Object.values(extractedData.sources).map(s => s.confidence);
                
                if (confidenceValues.length === 0) {
                    extractedData.confidence = 0;
                    return;
                }
                
                const weightedSum = confidenceValues.reduce((sum, conf) => sum + conf, 0);
                extractedData.confidence = Math.round(weightedSum / confidenceValues.length);
                
                if (extractedData.parameters.sampleSize && extractedData.parameters.power) {
                    extractedData.confidence += 5;
                }
                
                extractedData.confidence = Math.min(extractedData.confidence, 95);
            }
        }

        // Initialize the advanced calculator
        const calculator = new KarmastatSurvivalAnalysisCalculator();
        
        // Make globally available for PDF export and other functions
        window.calculator = calculator;
        
        console.log('🎯 KARMASTAT Survival Analysis Calculator loaded successfully');
    </script>
</body>
</html>
